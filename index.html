<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>ğŸ“Œ RelatÃ³rio de PontuaÃ§Ãµes - Processos de Estoque | Shoemix</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- 
ğŸš€ VERSÃƒO OTIMIZADA - CÃ‚MERA CORRIGIDA V8
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
âœ… CORREÃ‡ÃƒO CRÃTICA - FOTOS COM GOOGLE DRIVE:
   â€¢ SEMPRE salva fotos no IndexedDB primeiro (funciona 100%!)
   â€¢ Camera mÃ³vel funciona perfeitamente (sem travamento)
   â€¢ Ao salvar visita: transfere automaticamente para Drive
   â€¢ Se Drive falhar: fotos ficam seguras no IndexedDB

ğŸ“¸ FLUXO CORRIGIDO:
   1. UsuÃ¡rio tira foto â†’ Salva INSTANTANEAMENTE no IndexedDB âœ¨
   2. Foto aparece na tela (sem esperar upload)
   3. Pode tirar mais fotos sem aguardar
   4. Ao clicar "Salvar Visita" â†’ Transfere para Drive em background
   5. Se Drive falhar â†’ Fotos ficam no IndexedDB (nÃ£o perde nada!)

ğŸ¨ INDICADORES VISUAIS:
   â€¢ ğŸ’¾ Badge "Local" â†’ Foto temporÃ¡ria (recÃ©m tirada)
   â€¢ ğŸ’¾ Badge "IndexedDB" â†’ Foto salva localmente
   â€¢ â˜ï¸ Badge "Drive" â†’ Foto transferida com sucesso
   
ğŸ“Š MODAL DE SUCESSO:
   â€¢ Mostra quantas fotos foram transferidas
   â€¢ Exibe quanto espaÃ§o foi liberado no navegador
   â€¢ Confirma que fotos estÃ£o seguras no Drive

ğŸ§¹ LIMPEZA AUTOMÃTICA:
   â€¢ Fotos sÃ£o REMOVIDAS do IndexedDB apÃ³s upload no Drive
   â€¢ Libera espaÃ§o automaticamente no navegador
   â€¢ MantÃ©m IndexedDB sempre limpo e rÃ¡pido

ğŸ”§ BOTÃƒO DE LIMPEZA MANUAL:
   â€¢ "ğŸ’¾ Limpar Fotos" no menu "Mais"
   â€¢ Mostra espaÃ§o usado no IndexedDB
   â€¢ Permite limpar fotos antigas manualmente

ğŸ”§ PROBLEMAS RESOLVIDOS:
   â€¢ âŒ Camera travando ao conectar Drive
   â€¢ âŒ Fotos salvando como texto
   â€¢ âŒ Carregamento infinito
   â€¢ âŒ IndexedDB ficando cheio
   â€¢ âœ… Tudo funciona igual a quando nÃ£o tem Drive!
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
-->

<!-- ğŸ”§ CORREÃ‡ÃƒO: Suprime erro de postMessage quando executado via file:// -->
<script>
// Detecta se estÃ¡ rodando via file:// e suprime erros de postMessage
(function() {
    if (window.location.protocol === 'file:') {
        console.warn('âš ï¸ Executando via file:// - Alguns recursos podem ter limitaÃ§Ãµes');
        
        // Suprime erros de postMessage do console
        const originalError = console.error;
        console.error = function(...args) {
            const msg = args.join(' ');
            if (msg.includes('postMessage') && msg.includes('target origin')) {
                // Silencia esse erro especÃ­fico
                return;
            }
            originalError.apply(console, args);
        };
        
        // Adiciona informaÃ§Ã£o visual para o usuÃ¡rio
        window.addEventListener('DOMContentLoaded', () => {
            const aviso = document.createElement('div');
            aviso.style.cssText = 'position:fixed;bottom:10px;left:10px;background:#fff3cd;border:2px solid #ffc107;padding:8px 12px;border-radius:8px;font-size:0.85em;z-index:9999;max-width:300px;box-shadow:0 2px 8px rgba(0,0,0,0.2);';
            aviso.innerHTML = '<strong>â„¹ï¸ Modo Local</strong><br>Rodando via file://. Para melhor experiÃªncia, use um servidor web.';
            document.body.appendChild(aviso);
            
            // Remove o aviso apÃ³s 10 segundos
            setTimeout(() => aviso.remove(), 10000);
        });
    }
})();
</script>

<!-- ğŸ†• CORREÃ‡ÃƒO: Scripts do Google carregados com callbacks onload -->
<script src="https://apis.google.com/js/api.js" async defer onload="gapiLoaded()"></script>
<script src="https://accounts.google.com/gsi/client" async defer onload="gisLoaded()"></script>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
body{font-family:'Inter','Segoe UI',Arial,sans-serif;margin:0;color:#000;background:#fff}
header{background:#fff;color:#000;padding:20px;text-align:center;border-bottom:4px solid #f00;border-top:4px solid #f00}
.titulo-principal{
  font-size:2.6em;
  margin:0;
  color:#f00;
  font-weight:800;
  letter-spacing:0.5px;
  line-height:1.1;
}

.titulo-principal span{
  display:block;
  font-size:0.75em;
  color:#000;
  font-weight:600;
  margin-top:6px;
}

.subtitulo{
  margin-top:8px;
  font-weight:500;
  letter-spacing:2px;
  color:#444;
}
.tabs{display:flex;flex-wrap:wrap;background:#f5f5f5}
.tabs button{flex:1;border:none;padding:10px;background:#000;color:#fff;font-weight:600;cursor:pointer;transition:0.3s}
.tabs button.active{background:#f00;color:#fff}
.tabs button:hover{opacity:0.8}
.container{padding:22px}
.section{border:2px solid #f00;border-radius:8px;padding:18px;margin-bottom:18px;background:#fff}
.section h3{margin-top:0;color:#f00;font-size:1.3em}
label{display:block;margin:6px 0;font-weight:500}
.pergunta{margin:8px 0;font-weight:700;font-size:1.05em;color:#000;padding:8px;border-radius:6px;transition:all 0.3s ease}
.pergunta.resposta-boa{background-color:#d4edda;border-left:4px solid #28a745;animation:pulseGreen 0.5s ease}
.pergunta.resposta-boa:hover{background-color:#c3e6cb}
.pergunta.resposta-ruim{background-color:#f8d7da;border-left:4px solid #dc3545;animation:pulseRed 0.5s ease}
.pergunta.resposta-ruim:hover{background-color:#f5c6cb}
.pergunta.resposta-neutra{background-color:#fff3cd;border-left:4px solid #ffc107;animation:pulseYellow 0.5s ease}
.pergunta.resposta-neutra:hover{background-color:#ffe8a1}
@keyframes pulseGreen{0%{background-color:#fff}100%{background-color:#d4edda}}
@keyframes pulseRed{0%{background-color:#fff}100%{background-color:#f8d7da}}
@keyframes pulseYellow{0%{background-color:#fff}100%{background-color:#fff3cd}}
.opcoes label{margin-right:15px;font-weight:400;font-size:1em;color:#000}
textarea,input[type=text],input[type=number],select{width:100%;padding:8px;border:1px solid #000;border-radius:6px;background:#fff;color:#000}
#conclusao{min-height:400px;font-family:'Courier New',monospace;font-size:0.9em;line-height:1.6;white-space:pre-wrap}
/* â”â”â” TOOLBAR DE BOTÃ•ES â”â”â” */
.top-buttons {
  margin: 0;
  background: #fff;
  border-bottom: 2px solid #eee;
  padding: 0;
}
/* Faixa principal â€“ botÃµes importantes */
.toolbar-principal {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
  padding: 10px 12px;
  justify-content: center;
  background: #fff;
}
button.action {
  background: #f00;
  color: #fff;
  border: none;
  border-radius: 8px;
  padding: 9px 16px;
  cursor: pointer;
  font-weight: 600;
  transition: 0.2s;
  font-size: 0.9em;
  display: inline-flex;
  align-items: center;
  gap: 5px;
  white-space: nowrap;
}
button.action:hover {
  filter: brightness(0.88);
  transform: translateY(-1px);
  box-shadow: 0 4px 10px rgba(0,0,0,0.25);
}
button.action:active {
  transform: translateY(0);
  box-shadow: none;
}
/* BotÃ£o que abre/fecha a aba "mais" */
.btn-mais-toggle {
  background: #222;
  color: #fff;
  border: none;
  border-radius: 8px;
  padding: 9px 14px;
  cursor: pointer;
  font-weight: 600;
  font-size: 0.9em;
  display: inline-flex;
  align-items: center;
  gap: 5px;
  white-space: nowrap;
  transition: 0.2s;
  user-select: none;
  -webkit-user-select: none;
}
.btn-mais-toggle:hover {
  background: #444;
}
.btn-mais-toggle .arrow {
  display: inline-block;
  transition: transform 0.25s;
  font-size: 0.8em;
}
.btn-mais-toggle.aberto .arrow {
  transform: rotate(180deg);
}
/* Aba recolhÃ­vel â€“ botÃµes secundÃ¡rios */
.toolbar-mais {
  max-height: 0;
  overflow: hidden;
  transition: max-height 0.35s cubic-bezier(.4,0,.2,1);
  background: #f7f7f7;
  border-top: 1px solid #e0e0e0;
}
.toolbar-mais.aberto {
  max-height: 200px;
}
.toolbar-mais-interno {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
  padding: 10px 14px;
  justify-content: center;
}
.toolbar-mais-interno button.action {
  font-size: 0.82em;
  padding: 7px 12px;
  background: #555;
}
/* ğŸ†• Indicador de EspaÃ§o */
.storage-indicator{position:fixed;top:10px;right:10px;background:#fff;border:2px solid #f00;border-radius:8px;padding:8px 12px;box-shadow:0 2px 8px rgba(0,0,0,0.2);z-index:9999;font-size:0.85em}
.storage-bar{width:120px;height:8px;background:#e0e0e0;border-radius:4px;overflow:hidden;margin:5px 0}
.storage-fill{height:100%;background:#28a745;transition:all 0.3s}
.storage-fill.warning{background:#ffc107}
.storage-fill.danger{background:#dc3545;animation:pulse 1s infinite}
.storage-info{font-size:0.75em;color:#666;margin-top:3px}

/* ğŸ†• Indicador de SincronizaÃ§Ã£o */
.sync-indicator{position:fixed;top:10px;left:10px;background:#fff;border:2px solid #28a745;border-radius:8px;padding:10px 15px;box-shadow:0 2px 8px rgba(0,0,0,0.2);z-index:9999;font-size:0.9em;display:flex;align-items:center;gap:8px}
.sync-indicator.syncing{border-color:#ffc107}
.sync-indicator.error{border-color:#dc3545}
.sync-dot{width:10px;height:10px;border-radius:50%;background:#28a745}
.sync-dot.syncing{background:#ffc107;animation:pulse 1s infinite}
.sync-dot.error{background:#dc3545}
.summary{border:2px solid #f00;border-radius:10px;padding:18px;background:#fff;margin-top:10px;color:#000}
table{width:100%;border-collapse:collapse;margin-bottom:12px}
th,td{border:1px solid #000;padding:6px;text-align:center}
th{background:#f00;color:#fff}
tr:nth-child(even){background:#f9f9f9}
.actions button{margin:0 2px;padding:3px 6px;background:#000;color:#fff;border:none;border-radius:4px;cursor:pointer;transition:0.3s}
.actions button:hover{opacity:0.8}
.collapsible{background:#f00;color:#fff;cursor:pointer;padding:10px;border:none;width:100%;text-align:left;font-weight:600;border-radius:6px;margin-bottom:6px;transition:0.3s}
.collapsible:after{content:' â–¸';float:right}
.collapsible.active:after{content:' â–¾'}
.collapsible:hover{opacity:0.85}
/* ğŸ†• Estilo melhorado para input de fotos - Visual personalizado */
.foto-input {
    display: block;
    width: 100%;
    padding: 12px;
    border: 2px dashed #f00;
    border-radius: 8px;
    background: #fff;
    color: #f00;
    font-weight: 600;
    cursor: pointer;
    text-align: center;
    transition: all 0.3s ease;
    font-size: 0.95em;
}

.foto-input:hover {
    background: #fff5f5;
    border-color: #c00;
    transform: scale(1.02);
}

.foto-input::-webkit-file-upload-button {
    background: #f00;
    color: #fff;
    border: none;
    padding: 8px 16px;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
    margin-right: 10px;
    transition: 0.2s;
}

.foto-input::-webkit-file-upload-button:hover {
    background: #c00;
}

/* Para Firefox */
.foto-input::file-selector-button {
    background: #f00;
    color: #fff;
    border: none;
    padding: 8px 16px;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
    margin-right: 10px;
    transition: 0.2s;
}

.foto-input::file-selector-button:hover {
    background: #c00;
}

.fotos-preview{display:flex;flex-wrap:wrap;gap:10px;margin-top:10px}
.foto-item{position:relative;border:2px solid #000;border-radius:6px;padding:5px;background:#f9f9f9;width:150px;pointer-events:auto}
.foto-item img{width:100%;height:120px;object-fit:cover;border-radius:4px;cursor:pointer;transition:0.3s;pointer-events:auto}
.foto-item img:hover{opacity:0.8;transform:scale(1.05)}
.remover-foto{position:absolute;top:8px;right:8px;background:#f00;color:#fff;border:none;border-radius:50%;width:25px;height:25px;cursor:pointer;font-weight:bold;font-size:14px;z-index:10;display:flex;align-items:center;justify-content:center;line-height:1;user-select:none;-webkit-user-select:none;box-shadow:0 2px 4px rgba(0,0,0,0.3)}
.remover-foto:hover{background:#c00;transform:scale(1.1)}

.btn-flutuante-conclusao{position:fixed;bottom:30px;right:30px;z-index:9998;background:#17a2b8;color:#fff;border:none;border-radius:50px;padding:15px 30px;font-size:1.1em;font-weight:700;cursor:pointer;box-shadow:0 6px 20px rgba(23,162,184,0.5);transition:all 0.3s ease;animation:pulse-btn 2s infinite}
.btn-flutuante-conclusao:hover{background:#138496;transform:scale(1.1);box-shadow:0 8px 25px rgba(23,162,184,0.7)}
@keyframes pulse-btn{0%,100%{box-shadow:0 6px 20px rgba(23,162,184,0.5)}50%{box-shadow:0 6px 30px rgba(23,162,184,0.8)}}

/* ğŸ†• BotÃ£o Flutuante de Conectar Drive */
.btn-flutuante-conectar-drive{position:fixed;bottom:30px;left:30px;z-index:9998;background:#4285f4;color:#fff;border:none;border-radius:50px;padding:18px 35px;font-size:1.2em;font-weight:700;cursor:pointer;box-shadow:0 8px 25px rgba(66,133,244,0.6);transition:all 0.3s ease;animation:pulse-drive-forte 1.5s infinite;display:none}
.btn-flutuante-conectar-drive:hover{background:#3367d6;transform:scale(1.15);box-shadow:0 10px 35px rgba(66,133,244,0.9)}
@keyframes pulse-drive-forte{0%,100%{transform:scale(1);box-shadow:0 8px 25px rgba(66,133,244,0.6)}50%{transform:scale(1.08);box-shadow:0 10px 40px rgba(66,133,244,1)}}
.btn-flutuante-conectar-drive.mostrar{display:block;animation:aparecer-botao 0.5s ease}
@keyframes aparecer-botao{0%{opacity:0;transform:translateY(20px)}100%{opacity:1;transform:translateY(0)}}
.modal-foto{display:none;position:fixed;z-index:9999;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,0.9);justify-content:center;align-items:center}
.modal-foto img{max-width:90%;max-height:90%;border-radius:8px}
.fechar-modal{position:absolute;top:20px;right:40px;color:#fff;font-size:40px;font-weight:bold;cursor:pointer}
.fechar-modal:hover{color:#f00}
.modal-bonificacao{display:none;position:fixed;z-index:10000;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,0.8);justify-content:center;align-items:center;overflow-y:auto;padding:20px}
.modal-bonificacao-content{background:#fff;border-radius:12px;max-width:900px;width:100%;max-height:90vh;overflow-y:auto;position:relative;box-shadow:0 4px 20px rgba(0,0,0,0.3)}
.modal-bonificacao-header{background:#f00;color:#fff;padding:20px;border-radius:12px 12px 0 0;position:sticky;top:0;z-index:1}
.modal-bonificacao-header h2{margin:0;font-size:1.8em}
.modal-bonificacao-body{padding:25px}
.fechar-bonificacao{position:absolute;top:15px;right:20px;color:#fff;font-size:35px;font-weight:bold;cursor:pointer;background:rgba(0,0,0,0.2);width:40px;height:40px;border-radius:50%;display:flex;align-items:center;justify-content:center;transition:0.3s}
.fechar-bonificacao:hover{background:rgba(0,0,0,0.4);transform:scale(1.1)}
.card-bonificacao{border:2px solid #ddd;border-radius:10px;padding:20px;margin-bottom:20px;background:#f9f9f9}
.card-bonificacao.excelente{border-color:#28a745;background:#d4edda}
.card-bonificacao.bom{border-color:#17a2b8;background:#d1ecf1}
.card-bonificacao.regular{border-color:#ffc107;background:#fff3cd}
.card-bonificacao.insatisfatorio{border-color:#dc3545;background:#f8d7da}
.valor-bonus{font-size:2.5em;font-weight:700;color:#28a745;text-align:center;margin:15px 0}
.alerta-box{padding:15px;border-radius:8px;margin:15px 0;font-weight:600}
.alerta-amarelo{background:#fff3cd;border:2px solid #ffc107;color:#856404}
.alerta-vermelho{background:#f8d7da;border:2px solid #dc3545;color:#721c24;animation:pulse 2s infinite}
/* ğŸ†• ESTILOS PARA O RELATÃ“RIO DE DIRETORIA */
.relatorio-diretoria-content{background:#fff;border-radius:12px;max-width:1200px;width:100%;max-height:90vh;overflow-y:auto;position:relative;box-shadow:0 4px 20px rgba(0,0,0,0.3)}
.relatorio-diretoria-header{background:#000;color:#fff;padding:25px;border-radius:12px 12px 0 0;position:sticky;top:0;z-index:1;border-bottom:4px solid #f00}
.dashboard-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px;margin:20px 0}
.dashboard-card{background:#f9f9f9;border:2px solid #ddd;border-radius:10px;padding:20px;text-align:center;transition:0.3s}
.dashboard-card:hover{transform:translateY(-5px);box-shadow:0 6px 15px rgba(0,0,0,0.2)}
.dashboard-card .numero{font-size:3em;font-weight:700;color:#f00;margin:10px 0}
.dashboard-card .label{font-size:1.1em;color:#666;font-weight:600}
.grafico-barras{background:#fff;border:2px solid #f00;border-radius:10px;padding:20px;margin:20px 0}
.barra-container{margin:15px 0}
.barra-label{display:flex;justify-content:space-between;margin-bottom:5px;font-weight:600}
.barra{height:30px;background:#e0e0e0;border-radius:5px;overflow:hidden;position:relative}
.barra-preenchimento{height:100%;transition:width 0.5s ease;display:flex;align-items:center;justify-content:flex-end;padding-right:10px;color:#fff;font-weight:700}
.barra-excelente{background:linear-gradient(90deg,#28a745,#20c997)}
.barra-bom{background:linear-gradient(90deg,#17a2b8,#20c997)}
.barra-regular{background:linear-gradient(90deg,#ffc107,#ffdb4d)}
.barra-insatisfatorio{background:linear-gradient(90deg,#dc3545,#f56a79)}
.ranking-table{width:100%;margin:20px 0}
.ranking-table th{background:#000;color:#fff}
.ranking-position{font-size:1.5em;font-weight:700}
.pos-1{color:#ffd700}
.pos-2{color:#c0c0c0}
.pos-3{color:#cd7f32}
.tendencia{font-size:1.5em}
.tendencia-up{color:#28a745}
.tendencia-down{color:#dc3545}
.tendencia-stable{color:#ffc107}
.secao-relatorio{background:#fff;border:2px solid #f00;border-radius:10px;padding:25px;margin:20px 0}
.secao-relatorio h3{color:#f00;border-bottom:2px solid #f00;padding-bottom:10px;margin-top:0}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.7}}

/* â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” */
/* ğŸ†• MELHORIAS v2.1 */
/* â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” */
.toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:#28a745;color:#fff;padding:15px 30px;border-radius:8px;z-index:10001;font-weight:600;box-shadow:0 4px 12px rgba(0,0,0,0.3);animation:slideUp 0.3s ease,fadeOut 3s 2.7s forwards}
.toast.erro{background:#dc3545}
.toast.aviso{background:#ffc107;color:#000}
@keyframes slideUp{from{bottom:-50px;opacity:0}to{bottom:20px;opacity:1}}
@keyframes fadeOut{to{opacity:0;bottom:-50px}}
.campo-obrigatorio{border:2px solid #ffc107!important;background:#fff9e6!important;animation:pulse-warning 1s}
.campo-valido{border:2px solid #28a745!important;background:#f0fff4!important}
@keyframes pulse-warning{0%,100%{box-shadow:0 0 0 0 rgba(255,193,7,0.4)}50%{box-shadow:0 0 0 8px rgba(255,193,7,0)}}
.backup-status{position:fixed;top:70px;right:10px;background:#fff;border:2px solid #28a745;border-radius:8px;padding:8px 12px;box-shadow:0 2px 8px rgba(0,0,0,0.2);z-index:9998;font-size:0.8em;opacity:0;transition:opacity 0.3s}
.backup-status.show{opacity:1}
.backup-status.erro{border-color:#dc3545}
/* ğŸ†• Indicador de Auto-Save (aparece quando salva antes de tirar foto) */
.autosave-info{position:fixed;top:130px;right:10px;background:#fff;border:2px solid #17a2b8;border-radius:8px;padding:8px 12px;box-shadow:0 2px 8px rgba(0,0,0,0.2);z-index:9997;font-size:0.75em;max-width:200px;line-height:1.4}
.autosave-info strong{color:#17a2b8;display:block;margin-bottom:4px}
@media (max-width:768px){.autosave-info{font-size:0.7em;max-width:160px;padding:6px 10px}}

/* â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” */
/* ğŸŒ INDICADOR DE CONEXÃƒO ONLINE/OFFLINE */
/* â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” */

.indicador-conexao {
    position: fixed;
    top: 50%;
    right: -300px;
    transform: translateY(-50%);
    padding: 15px 25px;
    border-radius: 12px 0 0 12px;
    font-weight: 700;
    font-size: 1.1em;
    z-index: 10002;
    box-shadow: -4px 4px 15px rgba(0, 0, 0, 0.3);
    transition: right 0.4s ease, background 0.3s ease;
    display: flex;
    align-items: center;
    gap: 10px;
    cursor: pointer;
    user-select: none;
}

.indicador-conexao.show {
    right: 0;
}

.indicador-conexao.online {
    background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
    color: #fff;
    border: 3px solid #1e7e34;
}

.indicador-conexao.offline {
    background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
    color: #fff;
    border: 3px solid #bd2130;
    animation: pulse-offline 2s infinite;
}

.indicador-conexao:hover {
    right: 0 !important;
}

.status-icone {
    font-size: 1.5em;
    animation: pulse-icon 2s infinite;
}

.status-texto {
    letter-spacing: 1px;
    font-weight: 800;
}

/* AnimaÃ§Ãµes */
@keyframes pulse-offline {
    0%, 100% {
        box-shadow: -4px 4px 15px rgba(220, 53, 69, 0.4);
    }
    50% {
        box-shadow: -4px 4px 25px rgba(220, 53, 69, 0.8);
    }
}

@keyframes pulse-icon {
    0%, 100% {
        transform: scale(1);
    }
    50% {
        transform: scale(1.2);
    }
}

/* VersÃ£o mobile */
@media (max-width: 768px) {
    .indicador-conexao {
        top: auto;
        bottom: 80px;
        right: -250px;
        font-size: 0.9em;
        padding: 12px 20px;
    }
    
    .indicador-conexao.show {
        right: 0;
    }
}

/* Torna o indicador sempre visÃ­vel quando offline */
.indicador-conexao.offline.show {
    right: 0;
}

/* â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” */
/* ğŸ“Š DASHBOARD COM GRÃFICOS - TRANSFORMAÃ‡ÃƒO v3.0 */
/* â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” */
/* ğŸ“Š ESTILOS DO DASHBOARD - DESABILITADOS */
/* Dashboard removido conforme solicitaÃ§Ã£o do usuÃ¡rio */
/* â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” */

/*
.dashboard-moderno {
    background: #fff;
    border: 3px solid #f00;
    border-radius: 12px;
    padding: 30px;
    margin: 20px 0;
    box-shadow: 0 8px 24px rgba(0,0,0,0.12);
}

.dashboard-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
    padding-bottom: 15px;
    border-bottom: 3px solid #f00;
}

.dashboard-titulo {
    font-size: 2em;
    font-weight: 800;
    color: #f00;
    margin: 0;
}

.dashboard-periodo {
    background: #f00;
    color: #fff;
    padding: 8px 16px;
    border-radius: 20px;
    font-weight: 600;
    font-size: 0.9em;
}

/* Container do GrÃ¡fico */
.grafico-container {
    background: #fff;
    border: 2px solid #ddd;
    border-radius: 12px;
    padding: 25px;
    margin: 25px 0;
    min-height: 400px;
    position: relative;
}

.grafico-titulo {
    font-size: 1.4em;
    font-weight: 700;
    color: #000;
    margin: 0 0 20px 0;
    display: flex;
    align-items: center;
    gap: 10px;
}

#graficoEvolucao {
    max-height: 350px;
    width: 100% !important;
}

/* Cards de EstatÃ­sticas */
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin: 30px 0;
}

.stat-card-moderno {
    background: linear-gradient(135deg, #f9f9f9 0%, #fff 100%);
    border: 2px solid #ddd;
    border-radius: 12px;
    padding: 25px;
    text-align: center;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.stat-card-moderno::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 4px;
    background: linear-gradient(90deg, #f00, #ff4444);
}

.stat-card-moderno:hover {
    transform: translateY(-8px);
    box-shadow: 0 12px 24px rgba(255,0,0,0.15);
    border-color: #f00;
}

.stat-numero-grande {
    font-size: 3.5em;
    font-weight: 800;
    color: #f00;
    margin: 10px 0;
    line-height: 1;
}

.stat-label-moderno {
    font-size: 1em;
    color: #666;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 1px;
}

.stat-tendencia {
    margin-top: 10px;
    font-size: 1.2em;
    font-weight: 700;
}

.tendencia-positiva {
    color: #28a745;
}

.tendencia-negativa {
    color: #dc3545;
}

.tendencia-neutra {
    color: #ffc107;
}
*/

/* â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” */
/* ğŸ† RANKING DE LOJAS */
/* â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” */

.ranking-container {
    background: #fff;
    border: 3px solid #f00;
    border-radius: 12px;
    padding: 30px;
    margin: 30px 0;
    box-shadow: 0 8px 24px rgba(0,0,0,0.12);
}

.ranking-header {
    text-align: center;
    margin-bottom: 30px;
    padding-bottom: 20px;
    border-bottom: 3px solid #f00;
}

.ranking-titulo {
    font-size: 2.2em;
    font-weight: 800;
    color: #f00;
    margin: 0 0 10px 0;
}

.ranking-subtitulo {
    font-size: 1em;
    color: #666;
    font-weight: 500;
}

.ranking-lista {
    display: flex;
    flex-direction: column;
    gap: 25px;
}

/* Linha de posiÃ§Ã£o - contÃ©m todos os empatados */
.ranking-linha {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.ranking-linha-header {
    font-size: 1.8em;
    font-weight: 800;
    color: #f00;
    margin-bottom: 10px;
    padding: 10px;
    background: #f9f9f9;
    border-left: 5px solid #f00;
    border-radius: 5px;
}

.ranking-cards-container {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 15px;
}

.ranking-item {
    background: linear-gradient(135deg, #f9f9f9 0%, #fff 100%);
    border: 2px solid #ddd;
    border-radius: 12px;
    padding: 20px;
    display: flex;
    flex-direction: column;
    gap: 15px;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.ranking-item:hover {
    transform: translateY(-5px);
    box-shadow: 0 6px 20px rgba(0,0,0,0.1);
    border-color: #f00;
}

/* Layout interno do card */
.ranking-item-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 10px;
    padding-bottom: 10px;
    border-bottom: 2px solid #f0f0f0;
}

.ranking-posicao {
    font-size: 2.5em;
    font-weight: 800;
    min-width: 50px;
    text-align: center;
}
.ranking-item.posicao-1 {
    border-color: #ffd700;
    background: linear-gradient(135deg, #fff9e6 0%, #fff 100%);
}

.ranking-item.posicao-1::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 4px;
    background: linear-gradient(90deg, #ffd700, #ffed4e);
}

.ranking-item.posicao-2 {
    border-color: #c0c0c0;
    background: linear-gradient(135deg, #f5f5f5 0%, #fff 100%);
}

.ranking-item.posicao-2::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 4px;
    background: linear-gradient(90deg, #c0c0c0, #e0e0e0);
}

.ranking-item.posicao-3 {
    border-color: #cd7f32;
    background: linear-gradient(135deg, #fff5e6 0%, #fff 100%);
}

.ranking-item.posicao-3::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 4px;
    background: linear-gradient(90deg, #cd7f32, #e69a5a);
}

.ranking-posicao {
    font-size: 3em;
    font-weight: 800;
    min-width: 60px;
    text-align: center;
}

.medalha-ouro { color: #ffd700; }
.medalha-prata { color: #c0c0c0; }
.medalha-bronze { color: #cd7f32; }
.posicao-numero { color: #666; }

.ranking-info {
    flex: 1;
}

.ranking-loja-nome {
    font-size: 1.4em;
    font-weight: 700;
    color: #000;
    margin: 0 0 5px 0;
}

.ranking-loja-cidade {
    font-size: 0.9em;
    color: #666;
    font-weight: 500;
}

.ranking-pontuacao {
    display: flex;
    flex-direction: column;
    align-items: center;
    min-width: 100px;
}

.ranking-pontos {
    font-size: 2.5em;
    font-weight: 800;
    color: #f00;
    line-height: 1;
}

.ranking-pontos-max {
    font-size: 1em;
    color: #666;
    font-weight: 600;
}

.ranking-progresso {
    width: 100%;
    height: 8px;
    background: #e0e0e0;
    border-radius: 4px;
    overflow: hidden;
    margin-top: 5px;
}

.ranking-progresso-barra {
    height: 100%;
    background: linear-gradient(90deg, #f00, #ff4444);
    border-radius: 4px;
    transition: width 0.5s ease;
}

.ranking-tendencia {
    display: flex;
    flex-direction: column;
    align-items: center;
    min-width: 80px;
}

.ranking-seta {
    font-size: 2em;
}

.ranking-variacao {
    font-size: 0.9em;
    font-weight: 700;
    margin-top: 3px;
}

/* Badges de Status */
.badge-excelente {
    background: #28a745;
    color: #fff;
    padding: 5px 12px;
    border-radius: 20px;
    font-size: 0.85em;
    font-weight: 700;
    display: inline-block;
    margin-top: 5px;
}

.badge-bom {
    background: #17a2b8;
    color: #fff;
    padding: 5px 12px;
    border-radius: 20px;
    font-size: 0.85em;
    font-weight: 700;
    display: inline-block;
    margin-top: 5px;
}

.badge-regular {
    background: #ffc107;
    color: #000;
    padding: 5px 12px;
    border-radius: 20px;
    font-size: 0.85em;
    font-weight: 700;
    display: inline-block;
    margin-top: 5px;
}

.badge-insatisfatorio {
    background: #dc3545;
    color: #fff;
    padding: 5px 12px;
    border-radius: 20px;
    font-size: 0.85em;
    font-weight: 700;
    display: inline-block;
    margin-top: 5px;
}

/* AnimaÃ§Ãµes */
@keyframes slideInLeft {
    from {
        opacity: 0;
        transform: translateX(-50px);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}

.ranking-item {
    animation: slideInLeft 0.5s ease forwards;
}

.ranking-item:nth-child(1) { animation-delay: 0.1s; }
.ranking-item:nth-child(2) { animation-delay: 0.2s; }
.ranking-item:nth-child(3) { animation-delay: 0.3s; }
.ranking-item:nth-child(4) { animation-delay: 0.4s; }
.ranking-item:nth-child(5) { animation-delay: 0.5s; }

/* ComparaÃ§Ã£o Destacada */
.minha-loja {
    border: 3px solid #f00 !important;
    background: linear-gradient(135deg, #fff0f0 0%, #fff 100%) !important;
    box-shadow: 0 8px 24px rgba(255,0,0,0.2) !important;
}


/* Responsivo */
@media (max-width: 768px) {
    .ranking-item {
        flex-direction: column;
        text-align: center;
        gap: 15px;
    }
    
    .ranking-posicao {
        font-size: 2.5em;
    }
    
    .ranking-pontuacao,
    .ranking-tendencia {
        min-width: auto;
    }
    
    .dashboard-header {
        flex-direction: column;
        gap: 15px;
        text-align: center;
    }
    
    .stats-grid {
        grid-template-columns: 1fr;
    }
}

/* Loading Skeleton para GrÃ¡fico */
.grafico-loading {
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 400px;
    font-size: 1.2em;
    color: #666;
    animation: pulse 1.5s infinite;
}

@keyframes pulse {
    0%, 100% { opacity: 0.5; }
    50% { opacity: 1; }
}

@media print{
  @page{size:A4;margin:10mm}
  *{-webkit-print-color-adjust:exact;print-color-adjust:exact;box-sizing:border-box}
  body{width:100%;margin:0;padding:0;font-size:10pt;line-height:1.3}
  
  .tabs,.top-buttons,.toolbar-principal,.toolbar-mais,.btn-mais-toggle,.hist-table,.collapsible,.foto-input,.remover-foto,.hist-container,.btn-flutuante-conclusao{display:none!important}
  #resumoMensal,#resumoGeral{display:none!important}
  
  header{page-break-after:avoid;margin-bottom:5px;padding:8px;border-bottom:2px solid #f00}
  titulo-principal{font-size:1.6em}
  .subtitulo{font-size:0.9em}
  
  .container{padding:0}
  
  .section{
    page-break-inside:avoid;
    margin-bottom:6px;
    padding:6px;
    border:1px solid #f00;
    border-radius:4px
  }
  
  .section h3{
    font-size:1em;
    margin:0 0 4px 0;
    padding:3px 0;
    border-bottom:1px solid #f00
  }
  
  .pergunta{
    margin:3px 0;
    padding:3px;
    font-size:0.85em;
    line-height:1.1;
    page-break-inside:avoid
  }
  
  .opcoes{display:none!important}
  
  label{
    margin:2px 0;
    font-size:0.85em;
    font-weight:600
  }
  
  textarea,input[type=text],input[type=number],select{
    border:1px solid #000 !important;
    padding:3px 5px !important;
    font-size:0.85em !important;
    font-family:Arial, sans-serif !important;
    line-height:1.4 !important;
    min-height:0 !important;
    max-height:none !important;
    height:auto !important;
    width:100% !important;
    display:block !important;
    overflow:visible !important;
    page-break-inside:auto !important;
    white-space:pre-wrap !important;
    word-wrap:break-word !important;
  }
  
  #conclusao{
    display:none !important;
  }

#conclusao-impressao {
    display: block !important;
    font-size: 0.8em !important;
    font-family: Arial, sans-serif !important;
    line-height: 1.4 !important;
    padding: 10px !important;
    border: 2px solid #f00 !important;
    margin: 10px 0 20px 0 !important;
    white-space: pre-wrap !important;
    word-wrap: break-word !important;
    background: white !important;
  }
  
  .section:has(#conclusao) > label {
    display: none !important;
  }
  
  .section:has(#conclusao) {
    page-break-before:always !important;
    page-break-inside:auto !important;
    padding:10px !important;
  }

  .section > div[style*="background:#f0f0f0"]:not(:has(strong)){display:none!important}
  
  /* Esconde divs desnecessÃ¡rias na seÃ§Ã£o de conclusÃ£o, MAS mantÃ©m H3 e textarea */
  /* Esconde apenas a legenda/resumo que aparece antes das assinaturas */
  .section:has(#conclusao) > div[style*="margin-top:20px"][style*="padding:15px"] {
    display:none!important;
  }
  
  /* Garante que o tÃ­tulo, a conclusÃ£o e as assinaturas apareÃ§am */
  /* Mostra APENAS o tÃ­tulo (h3), a div de impressÃ£o e as assinaturas */
  .section:has(#conclusao) > h3 {
    display:block!important;
  }
  
  .section:has(#conclusao) > #conclusao-impressao {
    display:block!important;
  }
  
  .section:has(#conclusao) > div[style*="display:grid"][style*="grid-template-columns:1fr 1fr"] {
    display:grid!important;
  }
  
  /* ESCONDE TODOS os outros elementos filhos diretos da seÃ§Ã£o */
  .section:has(#conclusao) > *:not(h3):not(#conclusao-impressao):not([style*="display:grid"]) {
    display:none!important;
  }
  
  .section:has(#conclusao) > div[style*="display:grid"][style*="grid-template-columns:1fr 1fr"] {
    display:grid!important;
  }

  .section:has(#conclusao) > div[style*="display:grid"]{
    display:grid!important;
    page-break-inside:avoid !important;
    page-break-before:avoid !important;
    margin-top:20px !important;
  }
  
  #conclusao-impressao + div[style*="display:grid"]{
    page-break-before:avoid !important;
    margin-top:15px !important;
  }
  
  small{font-size:0.7em!important}
  
  .fotos-preview{
    display:grid!important;
    grid-template-columns:repeat(4,1fr);
    gap:3px;
    page-break-inside:avoid;
    margin-top:4px
  }
  
  .foto-item{
    width:100%;
    border:1px solid #000;
    padding:2px;
    page-break-inside:avoid
  }
  
  .foto-item img{
    max-width:100%;
    height:auto;
    max-height:100px;
    object-fit:contain
  }
  
  .summary{
    page-break-inside:avoid;
    padding:8px;
    margin-top:6px;
    border:1px solid #f00
  }
  
  .summary > div{
    font-size:0.85em;
    margin-bottom:4px
  }
  
  #totalDisplay{font-size:1.5em!important}
  #statusEmoji{font-size:1.3em!important}
  #statusText{font-size:1em!important;padding:4px 8px!important}
}

/* â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” */
/* ğŸ†• GOOGLE DRIVE - ESTILOS */
/* â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” */

.storage-indicator.drive-mode {
    border-color: #4285f4;
    background: linear-gradient(135deg, #e8f0fe 0%, #fff 100%);
}

.storage-fill.drive {
    background: linear-gradient(90deg, #4285f4, #34a853);
}

.config-drive-container {
    background: linear-gradient(135deg, #4285f4 0%, #34a853 100%);
    padding: 25px;
    border-radius: 12px;
    margin: 20px 0;
    color: #fff;
    border: 3px solid #1a73e8;
}

.config-drive-container h3 {
    margin: 0 0 15px 0;
    font-size: 1.5em;
    display: flex;
    align-items: center;
    gap: 10px;
}

.drive-status {
    background: rgba(255,255,255,0.2);
    padding: 15px;
    border-radius: 8px;
    margin: 15px 0;
}

.drive-status.ativo {
    background: rgba(76, 175, 80, 0.3);
    border: 2px solid #4caf50;
}

.drive-status.inativo {
    background: rgba(244, 67, 54, 0.3);
    border: 2px solid #f44336;
}

.btn-drive {
    background: #fff;
    color: #1a73e8;
    border: none;
    padding: 12px 24px;
    border-radius: 8px;
    font-weight: 700;
    cursor: pointer;
    font-size: 1em;
    transition: all 0.3s;
    margin: 5px;
}

.btn-drive:hover {
    background: #e8f0fe;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
}

.btn-drive.desconectar {
    background: #f44336;
    color: #fff;
}

.btn-drive.desconectar:hover {
    background: #d32f2f;
}

.upload-progress {
    background: rgba(255,255,255,0.9);
    color: #000;
    padding: 15px;
    border-radius: 8px;
    margin: 10px 0;
    display: none;
}

.progress-bar-container {
    background: #e0e0e0;
    height: 20px;
    border-radius: 10px;
    overflow: hidden;
    margin: 10px 0;
}

.progress-bar-fill {
    background: linear-gradient(90deg, #4285f4, #34a853);
    height: 100%;
    transition: width 0.3s;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #fff;
    font-weight: 700;
    font-size: 0.85em;
}

.drive-quota-info {
    background: rgba(255,255,255,0.15);
    padding: 12px;
    border-radius: 6px;
    font-size: 0.9em;
    margin-top: 10px;
}

</style>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<!-- ğŸ†• GOOGLE DRIVE API -->
<script src="https://apis.google.com/js/api.js"></script>
<script src="https://accounts.google.com/gsi/client" async defer></script>

</head>
<body>

<!-- ğŸ†• INDICADOR DE ARMAZENAMENTO -->
<div class="storage-indicator" id="storageIndicator">
  <div style="font-weight:700;margin-bottom:3px">ğŸ’¾ Armazenamento</div>
  <div class="storage-bar">
    <div class="storage-fill" id="storageFill"></div>
  </div>
  <div class="storage-info" id="storageInfo">Calculando...</div>
</div>

<!-- ğŸ†• INDICADOR DE SINCRONIZAÃ‡ÃƒO -->
<div class="sync-indicator" id="syncIndicator">
  <div class="sync-dot" id="syncDot"></div>
  <div>
    <div style="font-weight:700;font-size:0.85em">â˜ï¸ Google Drive</div>
    <div id="syncText" style="font-size:0.75em;color:#666">Iniciando...</div>
  </div>
</div>

<!-- ğŸ†• INDICADOR DE AUTO-SAVE (aparece temporariamente) -->
<div class="autosave-info" id="autosaveInfo">
  <strong>ğŸ’¾ Auto-Save Ativo</strong>
  Suas respostas sÃ£o salvas automaticamente. Pode tirar fotos sem medo!
</div>

<!-- ğŸ†• PAINEL DE STATUS DETALHADO DAS APIs -->
<div style="position:fixed;top:15px;left:15px;background:#fff;border:2px solid #4285f4;border-radius:12px;padding:15px;box-shadow:0 4px 12px rgba(0,0,0,0.15);z-index:9998;min-width:280px;font-size:0.9em;display:none" id="painelStatusAPIs">
  <div style="font-weight:700;font-size:1em;color:#4285f4;margin-bottom:12px;text-align:center">ğŸ“Š Status da ConexÃ£o</div>
  
  <div style="margin:8px 0;display:flex;align-items:center;gap:10px;padding:8px;background:#f9f9f9;border-radius:6px">
    <div style="width:12px;height:12px;border-radius:50%;background:#6c757d" id="statusDotAPIs"></div>
    <div style="flex:1">
      <div style="font-size:0.8em;color:#666">Carregando APIs...</div>
      <div style="font-size:0.75em;color:#999" id="statusTextAPIs">â³ Inicializando...</div>
    </div>
  </div>
  
  <div style="margin:8px 0;display:flex;align-items:center;gap:10px;padding:8px;background:#f9f9f9;border-radius:6px">
    <div style="width:12px;height:12px;border-radius:50%;background:#6c757d" id="statusDotGAPI"></div>
    <div style="flex:1">
      <div style="font-size:0.8em;color:#666">Google API (GAPI)</div>
      <div style="font-size:0.75em;color:#999" id="statusTextGAPI">â³ Aguardando...</div>
    </div>
  </div>
  
  <div style="margin:8px 0;display:flex;align-items:center;gap:10px;padding:8px;background:#f9f9f9;border-radius:6px">
    <div style="width:12px;height:12px;border-radius:50%;background:#6c757d" id="statusDotGIS"></div>
    <div style="flex:1">
      <div style="font-size:0.8em;color:#666">Google Identity (GIS)</div>
      <div style="font-size:0.75em;color:#999" id="statusTextGIS">â³ Aguardando...</div>
    </div>
  </div>
  
  <div style="margin:8px 0;display:flex;align-items:center;gap:10px;padding:8px;background:#f9f9f9;border-radius:6px">
    <div style="width:12px;height:12px;border-radius:50%;background:#6c757d" id="statusDotDrive"></div>
    <div style="flex:1">
      <div style="font-size:0.8em;color:#666">â˜ï¸ Google Drive</div>
      <div style="font-size:0.75em;color:#999" id="statusTextDrive">â³ NÃ£o conectado</div>
    </div>
  </div>
  
  <!-- BotÃ£o de DiagnÃ³stico -->
  <button onclick="executarDiagnostico()" style="margin-top:10px;width:100%;padding:10px;background:#4285f4;color:#fff;border:none;border-radius:6px;cursor:pointer;font-size:0.85em;font-weight:600">
    ğŸ” Executar DiagnÃ³stico Completo
  </button>
  
  <button onclick="document.getElementById('painelStatusAPIs').style.display='none'" style="margin-top:10px;width:100%;padding:8px;background:#f0f0f0;border:none;border-radius:6px;cursor:pointer;font-size:0.85em">Fechar</button>
</div>

<script>
// ğŸ†• FunÃ§Ã£o de diagnÃ³stico completo
function executarDiagnostico() {
    console.clear();
    console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
    console.log('ğŸ” DIAGNÃ“STICO COMPLETO DO GOOGLE DRIVE');
    console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
    console.log('');
    
    console.log('ğŸ“‹ 1. CREDENCIAIS:');
    console.log('  â€¢ Client ID:', CONFIG_DRIVE.clientId ? 'âœ… ' + CONFIG_DRIVE.clientId.substring(0, 40) + '...' : 'âŒ VAZIO');
    console.log('  â€¢ API Key:', CONFIG_DRIVE.apiKey ? 'âœ… ' + CONFIG_DRIVE.apiKey.substring(0, 30) + '...' : 'âŒ VAZIO');
    console.log('');
    
    console.log('ğŸ“‹ 2. APIS DO GOOGLE:');
    console.log('  â€¢ GAPI carregado:', typeof gapi !== 'undefined' ? 'âœ… SIM' : 'âŒ NÃƒO');
    console.log('  â€¢ GAPI inicializado:', gapiInited ? 'âœ… SIM' : 'âŒ NÃƒO');
    console.log('  â€¢ GIS carregado:', typeof google !== 'undefined' && google.accounts ? 'âœ… SIM' : 'âŒ NÃƒO');
    console.log('  â€¢ GIS inicializado:', gisInited ? 'âœ… SIM' : 'âŒ NÃƒO');
    console.log('  â€¢ Token Client:', tokenClient ? 'âœ… CRIADO' : 'âŒ NÃƒO CRIADO');
    console.log('');
    
    console.log('ğŸ“‹ 3. CONEXÃƒO:');
    console.log('  â€¢ Status:', CONFIG_DRIVE.conectado ? 'âœ… CONECTADO' : 'âŒ DESCONECTADO');
    console.log('  â€¢ Access Token:', CONFIG_DRIVE.accessToken ? 'âœ… ' + CONFIG_DRIVE.accessToken.substring(0, 30) + '...' : 'âŒ VAZIO');
    console.log('');
    
    console.log('ğŸ“‹ 4. INTERFACE:');
    const btnFlutante = document.getElementById('btnConectarDriveFlutante');
    console.log('  â€¢ BotÃ£o flutuante existe:', btnFlutante ? 'âœ… SIM' : 'âŒ NÃƒO');
    console.log('  â€¢ BotÃ£o flutuante visÃ­vel:', btnFlutante?.classList.contains('mostrar') ? 'âœ… SIM' : 'âŒ NÃƒO');
    console.log('');
    
    console.log('ğŸ“‹ 5. AMBIENTE:');
    console.log('  â€¢ Protocolo:', window.location.protocol);
    console.log('  â€¢ URL:', window.location.href);
    console.log('  â€¢ User Agent:', navigator.userAgent.substring(0, 80) + '...');
    console.log('');
    
    console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
    console.log('ğŸ’¡ PRÃ“XIMOS PASSOS:');
    
    if (!CONFIG_DRIVE.clientId || !CONFIG_DRIVE.apiKey) {
        console.log('  âš ï¸ Configure as credenciais no botÃ£o "â˜ï¸ CONFIGURAR GOOGLE DRIVE"');
    } else if (!gapiInited || !gisInited) {
        console.log('  â³ Aguarde as APIs do Google carregarem (pode levar atÃ© 30s)');
    } else if (!CONFIG_DRIVE.conectado) {
        console.log('  ğŸ”‘ Clique no botÃ£o azul "ğŸ”‘ CONECTAR AO DRIVE" para autenticar');
    } else {
        console.log('  âœ… Tudo funcionando! VocÃª pode usar o Google Drive normalmente.');
    }
    
    console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
    
    mostrarToast('ğŸ” DiagnÃ³stico executado! Veja o console (F12)', 'sucesso');
}
</script>

<!-- BotÃ£o para abrir painel -->
<button onclick="document.getElementById('painelStatusAPIs').style.display='block'" style="position:fixed;top:15px;left:15px;background:#4285f4;color:#fff;border:none;border-radius:50%;width:45px;height:45px;cursor:pointer;box-shadow:0 4px 8px rgba(66,133,244,0.4);z-index:9997;font-size:1.3em;display:flex;align-items:center;justify-content:center" title="Ver Status das APIs">
  â„¹ï¸
</button>

<!-- ğŸ†• BOTÃƒO FLUTUANTE PARA CONECTAR AO DRIVE -->
<button class="btn-flutuante-conectar-drive" id="btnConectarDriveFlutante" onclick="conectarDrive()">
  ğŸ”‘ CONECTAR AO DRIVE
</button>

<header>
  <h1 class="titulo-principal">
    ğŸ“Œ RelatÃ³rio de PontuaÃ§Ãµes<br>
    <span>Processos de Estoque</span>
  </h1>
  <h4 class="subtitulo">SHOEMIX CALÃ‡ADOS</h4>
</header>
<div class="top-buttons">
  <!-- Faixa principal: botÃµes importantes -->
  <div class="toolbar-principal">
    <button class="action" onclick="salvar(true)">ğŸ’¾ Salvar</button>
    <button class="action" id="btnNovaVisita" onclick="novaVisita()">ğŸ†• Nova Visita</button>
    <button class="action" onclick="exportarPDF()">ğŸ–¨ï¸ Imprimir</button>
    <button class="action" onclick="exportarJSON()">ğŸ“ Exportar JSON</button>
    <button class="action" onclick="carregarJSON()">ğŸ“‚ Carregar JSON</button>
    <button class="action" onclick="abrirBonificacao()" style="background:#28a745">ğŸ’° BonificaÃ§Ã£o Mensal</button>
    <button class="action" onclick="abrirRelatorioDiretoria()" style="background:#111">ğŸ“Š RelatÃ³rio Diretoria</button>
    <button class="action" id="btnCancelarEdicao" onclick="cancelarEdicao()" style="display:none;background:#666">âŒ Cancelar EdiÃ§Ã£o</button>
    <button class="btn-mais-toggle" id="btnMaisToogle" onclick="toggleMais()">â‹¯ Mais <span class="arrow">â–¾</span></button>
  </div>
  <!-- Aba recolhÃ­vel: botÃµes secundÃ¡rios -->
  <div class="toolbar-mais" id="toolbarMais">
    <div class="toolbar-mais-interno">
      <button class="action" onclick="toggleResumo('mensal')">ğŸ“Š Resumo Mensal</button>
      <button class="action" onclick="toggleResumo('geral')">ğŸ“Š Resumo Geral</button>
      <button class="action" onclick="limparHistorico()" style="background:#dc3545">ğŸ—‘ï¸ Limpar HistÃ³rico</button>
      <button class="action" onclick="limparFotosIndexedDB()" style="background:#ff9800">ğŸ’¾ Limpar Fotos</button>
      <button class="action" onclick="abrirDebug()" style="background:#6c757d">ğŸ” Debug</button>
      <button class="action" onclick="abrirConfigServidor()" style="background:#9c27b0">â˜ï¸ Servidor</button>
      <button class="action" onclick="abrirModalDrive()" style="background:#4285f4">â˜ï¸ Google Drive</button>
      <button class="action" onclick="sincronizarAgora()" style="background:#2196f3" id="btnSincronizar">â˜ï¸ Sincronizar</button>
    </div>
  </div>
</div>

<script>
function toggleMais() {
  const aba = document.getElementById('toolbarMais');
  const btn = document.getElementById('btnMaisToogle');
  aba.classList.toggle('aberto');
  btn.classList.toggle('aberto');
}
</script>
<div class="tabs" id="tabs"></div>
<div class="container" id="app"></div>
<div id="modalFoto" class="modal-foto"><span class="fechar-modal" onclick="fecharModal()">&times;</span><img id="imagemModal" src="" alt="Imagem"></div>
<div id="modalBonificacao" class="modal-bonificacao"><div class="modal-bonificacao-content"><div class="modal-bonificacao-header"><span class="fechar-bonificacao" onclick="fecharBonificacao()">&times;</span><h2>ğŸ’° Sistema de BonificaÃ§Ã£o Mensal</h2><p style="margin:5px 0 0 0;font-size:0.9em">AnÃ¡lise de Performance e Recompensas</p></div><div class="modal-bonificacao-body" id="conteudoBonificacao"></div></div></div>
<!-- ğŸ†• MODAL RELATÃ“RIO DIRETORIA -->
<div id="modalRelatorioDiretoria" class="modal-bonificacao">
  <div class="relatorio-diretoria-content">
    <div class="relatorio-diretoria-header">
      <span class="fechar-bonificacao" onclick="fecharRelatorioDiretoria()">&times;</span>
      <h2>ğŸ“Š RELATÃ“RIO EXECUTIVO MENSAL - DIRETORIA</h2>
      <p style="margin:5px 0 0 0;font-size:0.9em">AnÃ¡lise Consolidada de Performance Operacional</p>
    </div>
    <div class="modal-bonificacao-body" id="conteudoRelatorioDiretoria"></div>
  </div>
</div>
<div id="modalDebug" class="modal-bonificacao"><div class="modal-bonificacao-content"><div class="modal-bonificacao-header" style="background:#6c757d"><span class="fechar-bonificacao" onclick="fecharDebug()">&times;</span><h2>ğŸ” DiagnÃ³stico do Sistema</h2><p style="margin:5px 0 0 0;font-size:0.9em">InformaÃ§Ãµes TÃ©cnicas e Debug</p></div><div class="modal-bonificacao-body" id="conteudoDebug"></div></div></div>

<!-- ğŸ†• MODAL DE CONFIGURAÃ‡ÃƒO DO GOOGLE DRIVE -->
<div id="modalGoogleDrive" class="modal-bonificacao" style="display:none">
  <div class="modal-bonificacao-content">
    <div class="modal-bonificacao-header" style="background:linear-gradient(135deg, #4285f4 0%, #34a853 100%)">
      <span class="fechar-bonificacao" onclick="fecharModalDrive()">&times;</span>
      <h2>â˜ï¸ CONFIGURAÃ‡ÃƒO GOOGLE DRIVE</h2>
      <p style="margin:5px 0 0 0;font-size:0.9em">EspaÃ§o Ilimitado para Fotos</p>
    </div>
    <div class="modal-bonificacao-body" id="conteudoDrive">
      
      <!-- BENEFÃCIOS -->
      <div style="background:#e8f5e9;padding:20px;border-radius:8px;margin-bottom:20px;border-left:4px solid #4caf50">
        <h3 style="margin:0 0 10px 0;color:#2e7d32">ğŸ¯ POR QUE USAR O GOOGLE DRIVE?</h3>
        <ul style="line-height:1.8;margin:5px 0">
          <li>âœ… <strong>15 GB GRÃTIS</strong> (espaÃ§o para ~15.000 fotos)</li>
          <li>âœ… <strong>Armazenamento ilimitado</strong> com conta paga</li>
          <li>âœ… <strong>Fotos em alta qualidade</strong> sem compressÃ£o</li>
          <li>âœ… <strong>Acesso de qualquer dispositivo</strong></li>
          <li>âœ… <strong>Backup automÃ¡tico</strong> e seguro</li>
          <li>âœ… <strong>Compartilhamento fÃ¡cil</strong> de relatÃ³rios</li>
        </ul>
      </div>

      <!-- INSTRUÃ‡Ã•ES -->
      <div style="background:#e3f2fd;padding:20px;border-radius:8px;margin-bottom:20px;border-left:4px solid #2196f3">
        <h3 style="margin:0 0 15px 0;color:#1976d2">ğŸ“ COMO CONFIGURAR (4 PASSOS SIMPLES)</h3>
        
        <details open style="margin:10px 0;background:#fff;padding:15px;border-radius:6px">
          <summary style="cursor:pointer;font-weight:600;padding:5px;font-size:1.1em;color:#1976d2">
            ğŸ“Œ PASSO 1: Criar Projeto no Google Cloud
          </summary>
          <ol style="margin:10px 0 0 20px;line-height:1.8">
            <li>Acesse: <a href="https://console.cloud.google.com" target="_blank" style="color:#1976d2">console.cloud.google.com</a></li>
            <li>Clique em <strong>"Criar Projeto"</strong></li>
            <li>Nome: <code style="background:#f5f5f5;padding:2px 6px">Shoemix Fotos</code></li>
            <li>Clique em <strong>"Criar"</strong></li>
          </ol>
        </details>

        <details style="margin:10px 0;background:#fff;padding:15px;border-radius:6px">
          <summary style="cursor:pointer;font-weight:600;padding:5px;font-size:1.1em;color:#1976d2">
            ğŸ“Œ PASSO 2: Ativar API do Drive
          </summary>
          <ol style="margin:10px 0 0 20px;line-height:1.8">
            <li>No menu, vÃ¡ em <strong>"APIs e ServiÃ§os" > "Biblioteca"</strong></li>
            <li>Pesquise: <code style="background:#f5f5f5;padding:2px 6px">Google Drive API</code></li>
            <li>Clique na API e em <strong>"Ativar"</strong></li>
          </ol>
        </details>

        <details style="margin:10px 0;background:#fff;padding:15px;border-radius:6px">
          <summary style="cursor:pointer;font-weight:600;padding:5px;font-size:1.1em;color:#1976d2">
            ğŸ“Œ PASSO 3: Criar Credenciais OAuth
          </summary>
          <ol style="margin:10px 0 0 20px;line-height:1.8">
            <li>VÃ¡ em <strong>"Credenciais" > "+ Criar Credenciais"</strong></li>
            <li>Escolha <strong>"ID do cliente OAuth"</strong></li>
            <li>Tipo: <strong>"Aplicativo da Web"</strong></li>
            <li>Adicione em "Origens autorizadas": <code>http://localhost</code> e <code>file://</code></li>
            <li>ğŸ“‹ <strong>COPIE o Client ID gerado!</strong></li>
          </ol>
        </details>

        <details style="margin:10px 0;background:#fff;padding:15px;border-radius:6px">
          <summary style="cursor:pointer;font-weight:600;padding:5px;font-size:1.1em;color:#1976d2">
            ğŸ“Œ PASSO 4: Criar API Key
          </summary>
          <ol style="margin:10px 0 0 20px;line-height:1.8">
            <li>Ainda em <strong>"Credenciais" > "+ Criar Credenciais"</strong></li>
            <li>Escolha <strong>"Chave de API"</strong></li>
            <li>ğŸ“‹ <strong>COPIE a API Key gerada!</strong></li>
            <li><em>(Recomendado)</em> Clique em "Restringir chave" e selecione apenas "Google Drive API"</li>
          </ol>
        </details>

        <details style="margin:10px 0;background:#fff;padding:15px;border-radius:6px">
          <summary style="cursor:pointer;font-weight:600;padding:5px;font-size:1.1em;color:#1976d2">
            ğŸ“Œ PASSO 5: Cole as Credenciais Aqui Abaixo
          </summary>
          <p style="margin:10px 0 0 20px">Agora Ã© sÃ³ colar o Client ID e a API Key nos campos abaixo e clicar em "Salvar e Conectar"!</p>
        </details>
      </div>

      <!-- STATUS DA CONEXÃƒO -->
      <div class="drive-status inativo" id="driveStatus">
        <h4 style="margin:0 0 10px 0">ğŸ“Š Status da ConexÃ£o</h4>
        <div id="driveStatusText">
          <p style="margin:5px 0">âŒ <strong>NÃ£o configurado</strong></p>
          <p style="margin:5px 0;font-size:0.9em">Configure o Client ID abaixo para comeÃ§ar</p>
        </div>
        <div id="driveQuotaInfo" class="drive-quota-info" style="display:none"></div>
        
        <!-- ğŸ†• BotÃ£o para conectar manualmente -->
        <div id="btnConectarManual" style="display:none;margin-top:10px">
          <button class="btn-drive" onclick="conectarDrive()" style="width:100%;background:#28a745">
            ğŸ”‘ CONECTAR AGORA
          </button>
          <small style="display:block;margin-top:5px;color:#666">
            Clique aqui para autorizar o acesso ao Google Drive
          </small>
        </div>
      </div>

      <!-- FORMULÃRIO -->
      <div class="config-drive-container">
        <h3>ğŸ”§ Configurar Agora</h3>
        
        <div style="margin:15px 0">
          <label style="display:block;margin-bottom:8px;font-weight:600">
            Client ID do Google Drive:
          </label>
          <input 
            type="text" 
            id="driveClientId" 
            placeholder="Cole aqui o Client ID (Ex: 123456789-abc.apps.googleusercontent.com)"
            style="width:100%;padding:12px;border:2px solid #ddd;border-radius:6px;font-size:0.95em;font-family:monospace"
          />
          <small style="display:block;margin-top:5px;opacity:0.9">
            ğŸ’¡ Deve terminar com <code>.apps.googleusercontent.com</code>
          </small>
        </div>

        <div style="margin:15px 0">
          <label style="display:block;margin-bottom:8px;font-weight:600">
            API Key do Google Drive:
          </label>
          <input 
            type="text" 
            id="driveApiKey" 
            placeholder="Cole aqui a API Key (Ex: AIzaSyA...)"
            style="width:100%;padding:12px;border:2px solid #ddd;border-radius:6px;font-size:0.95em;font-family:monospace"
          />
          <small style="display:block;margin-top:5px;opacity:0.9">
            ğŸ’¡ Comece com <code>AIza</code>
          </small>
        </div>

        <div style="margin:20px 0;display:flex;gap:10px;flex-wrap:wrap">
          <button class="btn-drive" onclick="salvarConfigDrive()">
            âœ… SALVAR E CONECTAR
          </button>
          <button class="btn-drive desconectar" onclick="desconectarDrive()" id="btnDesconectar" style="display:none">
            ğŸ”Œ DESCONECTAR
          </button>
          <button class="btn-drive" onclick="testarConexaoDrive()" id="btnTestar" style="display:none;background:#4caf50;color:#fff">
            ğŸ§ª TESTAR CONEXÃƒO
          </button>
        </div>
        
        <!-- ğŸ†• AVISO IMPORTANTE -->
        <div style="background:#fff3cd;border:2px solid #ffc107;border-radius:8px;padding:15px;margin:15px 0">
          <h4 style="margin:0 0 10px 0;color:#856404">âš ï¸ IMPORTANTE APÃ“S SALVAR:</h4>
          <p style="margin:5px 0;color:#856404;line-height:1.6">
            1ï¸âƒ£ ApÃ³s clicar em "SALVAR E CONECTAR", a pÃ¡gina vai recarregar<br>
            2ï¸âƒ£ Um popup do Google vai aparecer pedindo autorizaÃ§Ã£o<br>
            3ï¸âƒ£ Clique em "Permitir" para autorizar o acesso<br>
            4ï¸âƒ£ O indicador ficarÃ¡ <strong style="color:#28a745">VERDE âœ…</strong> quando conectado
          </p>
        </div>
      </div>

      <!-- PROGRESSO -->
      <div class="upload-progress" id="uploadProgress">
        <h4 style="margin:0 0 10px 0">ğŸ“¤ Upload em Andamento</h4>
        <div id="uploadStatusText">Preparando...</div>
        <div class="progress-bar-container">
          <div class="progress-bar-fill" id="uploadProgressBar" style="width:0%">0%</div>
        </div>
        <small id="uploadDetails" style="color:#666">0 de 0 fotos enviadas</small>
      </div>

      <!-- FAQ -->
      <div style="background:#f5f5f5;padding:20px;border-radius:8px;margin-top:20px">
        <h4 style="margin:0 0 10px 0">â“ DÃºvidas RÃ¡pidas</h4>
        <p style="margin:8px 0"><strong>Ã‰ seguro?</strong> âœ… Sim! Usa OAuth 2.0 oficial do Google.</p>
        <p style="margin:8px 0"><strong>Ã‰ grÃ¡tis?</strong> âœ… Sim! 15 GB grÃ¡tis, mais que suficiente.</p>
        <p style="margin:8px 0"><strong>Perco as fotos antigas?</strong> âŒ NÃ£o! Ficam onde estÃ£o.</p>
      </div>

    </div>
  </div>
</div>


<!-- ğŸ†• MODAL CONFIGURAÃ‡ÃƒO SERVIDOR -->
<div id="modalServidor" class="modal-bonificacao">
  <div class="modal-bonificacao-content">
    <div class="modal-bonificacao-header" style="background:#9c27b0">
      <span class="fechar-bonificacao" onclick="fecharConfigServidor()">&times;</span>
      <h2>â˜ï¸ CONFIGURAÃ‡ÃƒO DE SINCRONIZAÃ‡ÃƒO</h2>
      <p style="margin:5px 0 0 0;font-size:0.9em">Backup AutomÃ¡tico em Nuvem</p>
    </div>
    <div class="modal-bonificacao-body" id="conteudoServidor">
      <div style="background:#f0f0f0;padding:20px;border-radius:8px;margin-bottom:20px">
        <h3 style="margin:0 0 10px 0;color:#9c27b0">ğŸ¯ BenefÃ­cios da SincronizaÃ§Ã£o</h3>
        <ul style="line-height:1.8">
          <li>âœ… EspaÃ§o ilimitado no servidor</li>
          <li>âœ… Backup automÃ¡tico de todas as visitas</li>
          <li>âœ… Acesso de qualquer dispositivo</li>
          <li>âœ… Nunca perca dados novamente</li>
          <li>âœ… SincronizaÃ§Ã£o em tempo real</li>
        </ul>
      </div>
      
      <!-- INSTRUÃ‡Ã•ES RÃPIDAS -->
      <div style="background:#e3f2fd;padding:15px;border-radius:8px;margin-bottom:20px;border-left:4px solid #2196f3">
        <h4 style="margin:0 0 10px 0;color:#1976d2">ğŸ“ COMO CONFIGURAR (PASSO A PASSO):</h4>
        <ol style="line-height:1.8;margin:5px 0">
          <li>Clique em <strong>"âš™ï¸ Configurar Google Sheets"</strong> abaixo</li>
          <li>Uma janela se abrirÃ¡ com um campo para colar a URL</li>
          <li>Cole a URL do seu <strong>Google Apps Script</strong></li>
          <li>Clique em <strong>"âœ… SALVAR E ATIVAR"</strong></li>
        </ol>
        <p style="margin:10px 0 0 0;font-size:0.9em;color:#666">
          <strong>ğŸ“Œ Importante:</strong> A URL deve comeÃ§ar com <code style="background:#fff;padding:2px 6px;border-radius:3px">https://script.google.com/macros/s/...</code>
        </p>
      </div>
      
      <div style="background:#fff;padding:20px;border:2px solid #9c27b0;border-radius:8px">
        <h3 style="margin:0 0 15px 0">Escolha o MÃ©todo de SincronizaÃ§Ã£o:</h3>
        
        <!-- OPÃ‡ÃƒO 1: GOOGLE SHEETS -->
        <div class="card-bonificacao" style="border-color:#4285f4;background:#e8f0fe;margin-bottom:15px">
          <h4 style="margin:0 0 10px 0;color:#4285f4">ğŸ“Š Google Sheets (RECOMENDADO)</h4>
          <p style="margin:0 0 10px 0;font-size:0.9em">Sincroniza automaticamente com uma planilha do Google</p>
          
          <div id="configGoogleSheetsSimples" style="display:none;margin-top:15px">
            <label style="display:block;margin-bottom:5px;font-weight:600">ğŸ“ Cole a URL do Google Apps Script:</label>
            <input type="text" id="googleScriptUrl" placeholder="https://script.google.com/macros/s/..." style="margin:10px 0;width:100%">
            <button class="action" onclick="salvarConfigGoogleSheets()" style="background:#28a745;width:100%;margin-top:10px">âœ… SALVAR E ATIVAR</button>
            <button class="action" onclick="cancelarConfigGoogleSheets()" style="background:#dc3545;width:100%;margin-top:5px">âŒ CANCELAR</button>
          </div>
          
          <button id="btnConfigGoogleSheets" class="action" onclick="mostrarConfigGoogleSheets()" style="background:#4285f4;width:100%">âš™ï¸ Configurar Google Sheets</button>
        </div>
        
        <!-- OPÃ‡ÃƒO 2: API PERSONALIZADA -->
        <div class="card-bonificacao" style="border-color:#ff9800;background:#fff3e0;margin-bottom:15px">
          <h4 style="margin:0 0 10px 0;color:#ff9800">ğŸ”§ API Personalizada</h4>
          <p style="margin:0 0 10px 0;font-size:0.9em">Para quem tem servidor prÃ³prio</p>
          <input type="text" id="apiUrl" placeholder="https://seuservidor.com/api/visitas" style="margin:10px 0">
          <input type="password" id="apiKey" placeholder="Chave de API (opcional)" style="margin:10px 0">
          <button class="action" onclick="configurarAPIPersonalizada()" style="background:#ff9800;width:100%">Salvar ConfiguraÃ§Ã£o</button>
        </div>
        
        <!-- OPÃ‡ÃƒO 3: EMAIL AUTOMÃTICO -->
        <div class="card-bonificacao" style="border-color:#4caf50;background:#e8f5e9">
          <h4 style="margin:0 0 10px 0;color:#4caf50">ğŸ“§ Email AutomÃ¡tico</h4>
          <p style="margin:0 0 10px 0;font-size:0.9em">Envia backup por email periodicamente</p>
          <input type="email" id="emailBackup" placeholder="seu@email.com" style="margin:10px 0">
          <button class="action" onclick="configurarEmailBackup()" style="background:#4caf50;width:100%">Configurar Email</button>
        </div>
      </div>
      
      <div style="margin-top:20px;padding:15px;background:#fff3cd;border:2px solid #ffc107;border-radius:8px">
        <strong>âš¡ Status da SincronizaÃ§Ã£o:</strong>
        <div id="statusSincronizacao" style="margin-top:10px;font-family:monospace">
          Nenhuma sincronizaÃ§Ã£o configurada
        </div>
      </div>
    </div>
  </div>
</div>

<button class="btn-flutuante-conclusao" onclick="scrollParaConclusao()" title="Gerar ConclusÃ£o AutomÃ¡tica">
ğŸ¤– GERAR CONCLUSÃƒO
</button>

<script>
// ==================== INDEXEDDB CONFIG ====================
const DB_NAME = 'ShoemixDB';
const DB_VERSION = 1;
const STORE_FOTOS = 'fotos';
const STORE_VISITAS = 'visitas';
let db = null;

async function initDB() {
  return new Promise((resolve, reject) => {
    const request = indexedDB.open(DB_NAME, DB_VERSION);
    
    request.onupgradeneeded = (event) => {
      const db = event.target.result;
      
      if (!db.objectStoreNames.contains(STORE_FOTOS)) {
        const fotoStore = db.createObjectStore(STORE_FOTOS, { keyPath: 'id', autoIncrement: true });
        fotoStore.createIndex('visitaId', 'visitaId', { unique: false });
        fotoStore.createIndex('secaoId', 'secaoId', { unique: false });
      }
      
      if (!db.objectStoreNames.contains(STORE_VISITAS)) {
        db.createObjectStore(STORE_VISITAS, { keyPath: 'id', autoIncrement: true });
      }
    };
    
    request.onsuccess = () => {
      db = request.result;
      console.log('âœ… IndexedDB pronto');
      resolve(db);
    };
    
    request.onerror = () => reject(request.error);
  });
}
// ============================================
// VERIFICAÃ‡ÃƒO E LIMPEZA DO LOCALSTORAGE
// ============================================
function verificarEspacoLocalStorage() {
    // âœ… Se tem sincronizaÃ§Ã£o configurada, sempre retorna true (espaÃ§o OK)
    const temSincronizacao = CONFIG_SYNC && CONFIG_SYNC.metodo;
    if (temSincronizacao) {
        console.log('âœ… SincronizaÃ§Ã£o ativa - espaÃ§o ilimitado');
        return true;
    }
    
    try {
        // Testa se hÃ¡ espaÃ§o disponÃ­vel
        const testKey = '__storage_test__';
        const testData = 'x'.repeat(1024 * 1024); // 1MB
        localStorage.setItem(testKey, testData);
        localStorage.removeItem(testKey);
        return true;
    } catch (e) {
        console.warn('âš ï¸ LocalStorage prÃ³ximo do limite');
        return false;
    }
}

function limparHistoricoAntigo(diasLimite = 90) {
    try {
        let totalRemovido = 0;
        const agora = Date.now();
        const limiteMs = diasLimite * 24 * 60 * 60 * 1000;
        
        lojas.forEach((loja, idx) => {
            const hist = JSON.parse(localStorage.getItem("hist_" + idx) || "[]");
            const histFiltrado = hist.filter(visita => {
                // Tenta extrair data da string "DD/MM/AAAA, HH:MM:SS"
                try {
                    const dataStr = visita.data || '';
                    const [datePart] = dataStr.split(',');
                    const [dia, mes, ano] = datePart.trim().split('/');
                    const dataVisita = new Date(ano, mes - 1, dia).getTime();
                    const idade = agora - dataVisita;
                    
                    if (idade > limiteMs) {
                        totalRemovido++;
                        return false; // Remove
                    }
                    return true; // MantÃ©m
                } catch (e) {
                    return true; // MantÃ©m em caso de erro
                }
            });
            
            if (histFiltrado.length < hist.length) {
                localStorage.setItem("hist_" + idx, JSON.stringify(histFiltrado));
                console.log(`ğŸ§¹ Loja ${idx}: removidas ${hist.length - histFiltrado.length} visitas antigas`);
            }
        });
        
        return totalRemovido;
    } catch (e) {
        console.error('âŒ Erro ao limpar histÃ³rico:', e);
        return 0;
    }
}

function limparHistorico() {
    // Primeiro mostra quanto espaÃ§o estÃ¡ sendo usado
    const { percentual, usadoMB, limiteEstimado } = calcularEspacoUsado();
    
    const opcao = prompt(
        'ğŸ—‘ï¸ GERENCIADOR DE ARMAZENAMENTO\n\n' +
        `ğŸ“Š Uso atual: ${usadoMB} MB (${percentual}%)\n` +
        `ğŸ’¾ Limite estimado: ${limiteEstimado} MB\n\n` +
        'Escolha uma opÃ§Ã£o:\n\n' +
        '1 - Remover visitas > 90 dias (recomendado)\n' +
        '2 - Remover visitas > 60 dias\n' +
        '3 - Remover visitas > 30 dias\n' +
        '4 - Exportar tudo e limpar completamente\n' +
        '5 - Cancelar\n\n' +
        'Digite o nÃºmero da opÃ§Ã£o:'
    );
    
    if (!opcao || opcao === '5') return;
    
    let dias = 90;
    let exportarAntes = false;
    
    switch(opcao) {
        case '1': dias = 90; break;
        case '2': dias = 60; break;
        case '3': dias = 30; break;
        case '4': 
            exportarAntes = true;
            dias = 0; // Remove tudo
            break;
        default:
            alert('âŒ OpÃ§Ã£o invÃ¡lida!');
            return;
    }
    
    const confirma = confirm(
        `âš ï¸ CONFIRMAÃ‡ÃƒO\n\n` +
        `Esta aÃ§Ã£o irÃ¡ ${dias > 0 ? 'remover visitas com mais de ' + dias + ' dias' : 'LIMPAR TODO O HISTÃ“RICO'}.\n\n` +
        `${exportarAntes ? 'ğŸ“ Os dados serÃ£o exportados antes de limpar.\n\n' : ''}` +
        'âš ï¸ As fotos das visitas removidas tambÃ©m serÃ£o excluÃ­das.\n\n' +
        'Deseja continuar?'
    );
    
    if (!confirma) return;
    
    // Exporta antes se solicitado
    if (exportarAntes) {
        exportarJSON();
        // Aguarda um pouco para garantir que o download iniciou
        setTimeout(() => {
            finalizarLimpeza(dias);
        }, 1000);
    } else {
        finalizarLimpeza(dias);
    }
}

function finalizarLimpeza(dias) {
    const removidos = limparHistoricoAntigo(dias);
    const { percentual, usadoMB } = calcularEspacoUsado();
    
    alert(
        `âœ… Limpeza concluÃ­da!\n\n` +
        `ğŸ—‘ï¸ ${removidos} visitas removidas\n` +
        `ğŸ’¾ EspaÃ§o atual: ${usadoMB} MB (${percentual}%)\n\n` +
        `${dias === 0 ? 'âš ï¸ Todo histÃ³rico foi removido!' : 'âœ… EspaÃ§o liberado!'}`
    );
    
    atualizarHistorico();
    atualizarIndicadorArmazenamento();
}

// ============================================
// ğŸ†• SISTEMA DE MONITORAMENTO DE ARMAZENAMENTO
// ============================================
function calcularEspacoUsado() {
    try {
        let totalBytes = 0;
        
        // Calcula o tamanho de todos os dados no localStorage
        for (let key in localStorage) {
            if (localStorage.hasOwnProperty(key)) {
                totalBytes += localStorage[key].length + key.length;
            }
        }
        
        // Converte para MB
        const usadoMB = (totalBytes / (1024 * 1024)).toFixed(2);
        
        // Limite estimado do localStorage (varia por navegador)
        // Chrome/Edge: ~10MB, Firefox: ~10MB, Safari: ~5MB
        const limiteEstimado = 10;
        
        // Calcula percentual
        const percentual = Math.min(100, Math.round((totalBytes / (limiteEstimado * 1024 * 1024)) * 100));
        
        return {
            totalBytes,
            usadoMB,
            limiteEstimado,
            percentual
        };
    } catch (e) {
        console.error('Erro ao calcular espaÃ§o:', e);
        return { totalBytes: 0, usadoMB: '0.00', limiteEstimado: 10, percentual: 0 };
    }
}

function atualizarIndicadorArmazenamento() {
    
    // ğŸ†• Verifica se estÃ¡ usando Google Drive
    if (CONFIG_DRIVE && CONFIG_DRIVE.conectado) {
        const indicator = document.getElementById('storageIndicator');
        const title = document.getElementById('storageTitle');
        const fill = document.getElementById('storageFill');
        const info = document.getElementById('storageInfo');
        
        if (indicator) indicator.classList.add('drive-mode');
        if (title) title.textContent = 'â˜ï¸ Google Drive';
        if (fill) {
            fill.className = 'storage-fill drive';
            fill.style.width = '100%';
        }
        if (info) {
            info.textContent = 'âœ… Ilimitado (15 GB grÃ¡tis)';
            info.style.color = '#4285f4';
            info.style.fontWeight = 'bold';
        }
        return;
    }
    
    // Remove classe drive-mode se nÃ£o estiver usando
    const indicator = document.getElementById('storageIndicator');
    if (indicator) indicator.classList.remove('drive-mode');

    try {
        const fill = document.getElementById('storageFill');
        const info = document.getElementById('storageInfo');
        
        if (!fill || !info) return;
        
        // Verifica se tem sincronizaÃ§Ã£o configurada
        const temSincronizacao = CONFIG_SYNC && CONFIG_SYNC.metodo;
        
        if (temSincronizacao) {
            // Mostra indicador de armazenamento em nuvem
            fill.style.width = '100%';
            fill.className = 'storage-fill';
            fill.style.background = '#4285f4'; // Azul para indicar nuvem
            info.textContent = 'â˜ï¸ Nuvem (Ilimitado)';
            info.style.color = '#4285f4';
            info.style.fontWeight = 'bold';
        } else {
            // Mostra uso local
            const { usadoMB, percentual } = calcularEspacoUsado();
            
            // Atualiza barra
            fill.style.width = percentual + '%';
            fill.style.background = ''; // Remove cor customizada
            
            // Muda cor baseado no percentual
            fill.className = 'storage-fill';
            if (percentual >= 90) {
                fill.classList.add('danger');
            } else if (percentual >= 70) {
                fill.classList.add('warning');
            }
            
            // Atualiza texto
            info.textContent = `${usadoMB} MB (${percentual}%)`;
            info.style.color = '';
            info.style.fontWeight = '';
            
            // Alerta se estiver crÃ­tico E nÃ£o tiver sincronizaÃ§Ã£o
            if (percentual >= 95) {
                mostrarAlertaArmazenamento();
            }
        }
    } catch (e) {
        console.error('Erro ao atualizar indicador:', e);
    }
}

function mostrarAlertaArmazenamento() {
    // Se tem sincronizaÃ§Ã£o configurada, nÃ£o mostra alerta
    const temSincronizacao = CONFIG_SYNC && CONFIG_SYNC.metodo;
    if (temSincronizacao) {
        console.log('âœ… SincronizaÃ§Ã£o ativa - sem limite de armazenamento');
        return;
    }
    
    const ultimoAlerta = localStorage.getItem('ultimo_alerta_storage');
    const agora = Date.now();
    
    // SÃ³ mostra alerta uma vez a cada hora
    if (ultimoAlerta && (agora - parseInt(ultimoAlerta)) < 3600000) {
        return;
    }
    
    localStorage.setItem('ultimo_alerta_storage', agora.toString());
    
    const { percentual } = calcularEspacoUsado();
    
    const acao = confirm(
        'ğŸš¨ ALERTA DE ARMAZENAMENTO LOCAL!\n\n' +
        `âš ï¸ Uso atual: ${percentual}%\n\n` +
        'O armazenamento LOCAL estÃ¡ quase cheio!\n\n' +
        'ğŸ’¡ SOLUÃ‡ÃƒO RECOMENDADA:\n' +
        'Configure a sincronizaÃ§Ã£o em nuvem para ter\n' +
        'armazenamento ILIMITADO!\n\n' +
        'Ou vocÃª pode:\n' +
        'â€¢ Limpar visitas antigas\n' +
        'â€¢ Exportar dados e limpar tudo\n\n' +
        'Deseja abrir o gerenciador de armazenamento agora?'
    );
    
    if (acao) {
        limparHistorico();
    }
}

// Atualiza indicador a cada 30 segundos
setInterval(atualizarIndicadorArmazenamento, 30000);

// ============================================
// ğŸ†• SISTEMA DE SINCRONIZAÃ‡ÃƒO COM SERVIDOR
// ============================================

// ConfiguraÃ§Ã£o de sincronizaÃ§Ã£o
const CONFIG_SYNC = {
    metodo: localStorage.getItem('sync_metodo') || null, // 'google_sheets', 'api', 'email'
    googleSheetsUrl: localStorage.getItem('sync_google_sheets_url') || null,
    scriptUrl: localStorage.getItem('sync_script_url') || null, // ğŸ†• URL do Google Apps Script para escrita
    sheetName: localStorage.getItem('sync_sheet_name') || 'Visitas', // ğŸ†• Nome da aba
    apiUrl: localStorage.getItem('sync_api_url') || null,
    apiKey: localStorage.getItem('sync_api_key') || null,
    email: localStorage.getItem('sync_email') || null,
    autoSync: localStorage.getItem('sync_auto') === 'true',
    ultimaSync: localStorage.getItem('sync_ultima') || null
};

// Abre modal de configuraÃ§Ã£o
function abrirConfigServidor() {
    document.getElementById('modalServidor').style.display = 'flex';
    atualizarStatusSincronizacao();
}

function fecharConfigServidor() {
    document.getElementById('modalServidor').style.display = 'none';
}

// Atualiza status da sincronizaÃ§Ã£o
function atualizarStatusSincronizacao() {
    const statusDiv = document.getElementById('statusSincronizacao');
    
    if (!CONFIG_SYNC.metodo) {
        statusDiv.innerHTML = 'âŒ Nenhuma sincronizaÃ§Ã£o configurada';
        return;
    }
    
    let html = '<div style="color:#28a745">';
    html += `âœ… <strong>MÃ©todo:</strong> ${CONFIG_SYNC.metodo.replace('_', ' ').toUpperCase()}<br>`;
    
    if (CONFIG_SYNC.ultimaSync) {
        const dataSync = new Date(CONFIG_SYNC.ultimaSync);
        html += `ğŸ• <strong>Ãšltima sincronizaÃ§Ã£o:</strong> ${dataSync.toLocaleString('pt-BR')}<br>`;
    }
    
    html += `ğŸ”„ <strong>SincronizaÃ§Ã£o automÃ¡tica:</strong> ${CONFIG_SYNC.autoSync ? 'ATIVA' : 'DESATIVADA'}`;
    html += '</div>';
    
    statusDiv.innerHTML = html;
}

// ============================================
// ğŸ†• FUNÃ‡Ã•ES SIMPLIFICADAS GOOGLE SHEETS
// ============================================
function mostrarConfigGoogleSheets() {
    // Esconde o botÃ£o e mostra o formulÃ¡rio
    document.getElementById('btnConfigGoogleSheets').style.display = 'none';
    document.getElementById('configGoogleSheetsSimples').style.display = 'block';
    
    // Se jÃ¡ tem configuraÃ§Ã£o, preenche
    if (CONFIG_SYNC.scriptUrl) {
        document.getElementById('googleScriptUrl').value = CONFIG_SYNC.scriptUrl;
    }
}

function cancelarConfigGoogleSheets() {
    // Volta ao estado inicial
    document.getElementById('btnConfigGoogleSheets').style.display = 'block';
    document.getElementById('configGoogleSheetsSimples').style.display = 'none';
    document.getElementById('googleScriptUrl').value = '';
}

function salvarConfigGoogleSheets() {
    console.log('ğŸ”§ FunÃ§Ã£o salvarConfigGoogleSheets chamada');
    
    const urlInput = document.getElementById('googleScriptUrl');
    console.log('ğŸ“ Campo de input encontrado:', urlInput ? 'SIM' : 'NÃƒO');
    
    const url = urlInput ? urlInput.value.trim() : '';
    console.log('ğŸ”— URL digitada:', url);
    
    if (!url) {
        console.log('âŒ URL vazia');
        alert('âŒ Por favor, cole a URL do Google Apps Script!');
        return;
    }
    
    // ValidaÃ§Ã£o bÃ¡sica da URL
    if (!url.startsWith('https://script.google.com/macros/s/')) {
        console.log('âŒ URL invÃ¡lida:', url);
        alert('âŒ URL invÃ¡lida! Deve comeÃ§ar com:\nhttps://script.google.com/macros/s/...');
        return;
    }
    
    console.log('âœ… URL vÃ¡lida, salvando...');
    
    // Mostra mensagem de processamento
    const statusDiv = document.getElementById('statusSincronizacao');
    if (statusDiv) {
        statusDiv.innerHTML = '<div style="color:#ffc107;font-weight:bold">â³ Salvando configuraÃ§Ã£o...</div>';
    }
    
    // Salva configuraÃ§Ã£o
    CONFIG_SYNC.metodo = 'google_sheets';
    CONFIG_SYNC.scriptUrl = url;
    CONFIG_SYNC.autoSync = true;
    
    localStorage.setItem('sync_metodo', 'google_sheets');
    localStorage.setItem('sync_script_url', url);
    localStorage.setItem('sync_auto', 'true');
    
    console.log('ğŸ’¾ Dados salvos no localStorage');
    
    // Atualiza status
    atualizarStatusSincronizacao();
    
    // Atualiza indicador visual se existir
    const syncIndicator = document.querySelector('.sync-indicator');
    if (syncIndicator) {
        syncIndicator.style.borderColor = '#28a745';
        syncIndicator.innerHTML = '<div class="sync-dot" style="background:#28a745"></div><span>ğŸ“Š Google Sheets Ativo</span>';
    }
    
    // Feedback visual forte
    console.log('âœ… Mostrando alerta de sucesso');
    alert('âœ… CONFIGURAÃ‡ÃƒO SALVA COM SUCESSO!\n\n' +
          'ğŸ“Š Google Sheets ATIVADO!\n\n' +
          'ğŸ”„ Agora seus dados serÃ£o sincronizados automaticamente.\n\n' +
          'ğŸ’¡ Dica: Salve uma visita para testar a sincronizaÃ§Ã£o!');
    
    // Reseta o formulÃ¡rio
    cancelarConfigGoogleSheets();
    
    console.log('âœ… ConfiguraÃ§Ã£o do Google Sheets salva:', url);
    
    // Tenta fazer primeira sincronizaÃ§Ã£o
    setTimeout(() => {
        if (typeof sincronizarComServidor === 'function') {
            console.log('ğŸ”„ Iniciando primeira sincronizaÃ§Ã£o...');
            sincronizarComServidor();
        }
    }, 1000);
}


// ============================================
// OPÃ‡ÃƒO 1: GOOGLE SHEETS
// ============================================
function configurarGoogleSheets() {
    const instrucoes = `
ğŸ“Š CONFIGURAÃ‡ÃƒO DO GOOGLE SHEETS

Para sincronizar com Google Sheets:

1ï¸âƒ£ Acesse: https://script.google.com
2ï¸âƒ£ Clique em "Novo Projeto"
3ï¸âƒ£ Cole o cÃ³digo que vou fornecer
4ï¸âƒ£ Clique em "Implantar" > "Nova implantaÃ§Ã£o"
5ï¸âƒ£ Escolha "Aplicativo da Web"
6ï¸âƒ£ Configure:
   â€¢ Executar como: Eu
   â€¢ Quem tem acesso: Qualquer pessoa
7ï¸âƒ£ Copie a URL fornecida
8ï¸âƒ£ Cole aqui no prÃ³ximo passo

Deseja continuar?
    `;
    
    if (!confirm(instrucoes)) return;
    
    // CÃ³digo do Google Apps Script
    const codigoScript = `
// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// ğŸ“Š SHOEMIX - GOOGLE APPS SCRIPT COMPLETO
// Suporta ENVIO (POST) e LEITURA (GET) de dados
// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

// ğŸ“¤ ENVIAR dados (POST)
function doPost(e) {
  try {
    const dados = JSON.parse(e.postData.contents);
    const planilha = SpreadsheetApp.getActiveSpreadsheet();
    let aba = planilha.getSheetByName('Visitas');
    
    // Cria aba se nÃ£o existir
    if (!aba) {
      aba = planilha.insertSheet('Visitas');
      aba.appendRow(['Data SincronizaÃ§Ã£o', 'Loja', 'Data Visita', 'Encarregado', 'Gerente', 'PontuaÃ§Ã£o', 'Status', 'Dados JSON']);
    }
    
    // Adiciona cada visita
    dados.visitas.forEach(visita => {
      aba.appendRow([
        new Date(),
        visita.loja,
        visita.data,
        visita.encarregado || '',
        visita.gerente || '',
        visita.pontuacao || 0,
        visita.status || '',
        JSON.stringify(visita.dados)
      ]);
    });
    
    return ContentService.createTextOutput(JSON.stringify({
      success: true,
      total: dados.visitas.length
    })).setMimeType(ContentService.MimeType.JSON);
    
  } catch(erro) {
    return ContentService.createTextOutput(JSON.stringify({
      success: false,
      erro: erro.toString()
    })).setMimeType(ContentService.MimeType.JSON);
  }
}

// ğŸ“¥ CARREGAR dados (GET)
function doGet(e) {
  try {
    const planilha = SpreadsheetApp.getActiveSpreadsheet();
    const aba = planilha.getSheetByName('Visitas');
    
    if (!aba) {
      return ContentService.createTextOutput(JSON.stringify({
        success: true,
        visitas: []
      })).setMimeType(ContentService.MimeType.JSON);
    }
    
    // Pega todos os dados (pula o cabeÃ§alho)
    const dados = aba.getDataRange().getValues();
    const visitas = [];
    
    // ComeÃ§a da linha 2 (pula cabeÃ§alho)
    for (let i = 1; i < dados.length; i++) {
      const linha = dados[i];
      
      // Pula linhas vazias
      if (!linha[1]) continue;
      
      try {
        const dadosJSON = linha[7] ? JSON.parse(linha[7]) : {};
        
        visitas.push({
          loja: linha[1],
          data: linha[2],
          encarregado: linha[3] || '',
          gerente: linha[4] || '',
          pontuacao: linha[5] || 0,
          status: linha[6] || '',
          dados: dadosJSON
        });
      } catch (erro) {
        console.error('Erro ao processar linha ' + i, erro);
      }
    }
    
    return ContentService.createTextOutput(JSON.stringify({
      success: true,
      total: visitas.length,
      visitas: visitas
    })).setMimeType(ContentService.MimeType.JSON);
    
  } catch(erro) {
    return ContentService.createTextOutput(JSON.stringify({
      success: false,
      erro: erro.toString()
    })).setMimeType(ContentService.MimeType.JSON);
  }
}`;
    
    // Mostra o cÃ³digo em um modal que nÃ£o fecha sozinho
    mostrarModalCodigo(codigoScript);
}

// Modal para exibir cÃ³digo do Google Apps Script
function mostrarModalCodigo(codigo) {
    // Cria overlay
    const overlay = document.createElement('div');
    overlay.id = 'modalCodigoOverlay';
    overlay.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);z-index:99998;display:flex;justify-content:center;align-items:center';
    
    // Cria modal
    const modal = document.createElement('div');
    modal.style.cssText = 'background:#fff;border-radius:12px;width:90%;max-width:900px;max-height:90vh;overflow:hidden;box-shadow:0 4px 20px rgba(0,0,0,0.5)';
    
    // CabeÃ§alho
    const header = document.createElement('div');
    header.style.cssText = 'background:#4285f4;color:#fff;padding:20px;display:flex;justify-content:space-between;align-items:center';
    header.innerHTML = `
        <div>
            <h2 style="margin:0;font-size:1.5em">ğŸ“‹ CÃ³digo do Google Apps Script</h2>
            <p style="margin:5px 0 0 0;font-size:0.9em">Copie este cÃ³digo e cole no Google Apps Script</p>
        </div>
        <button onclick="document.getElementById('modalCodigoOverlay').remove()" style="background:rgba(255,255,255,0.2);border:none;color:#fff;font-size:30px;cursor:pointer;width:40px;height:40px;border-radius:50%;line-height:1">&times;</button>
    `;
    
    // Corpo
    const body = document.createElement('div');
    body.style.cssText = 'padding:20px';
    
    // InstruÃ§Ãµes
    const instrucoes = document.createElement('div');
    instrucoes.style.cssText = 'background:#e8f0fe;padding:15px;border-radius:8px;margin-bottom:15px;border-left:4px solid #4285f4';
    instrucoes.innerHTML = `
        <strong style="color:#1967d2">ğŸ“ INSTRUÃ‡Ã•ES:</strong><br>
        1. Clique no botÃ£o "ğŸ“‹ COPIAR CÃ“DIGO" abaixo<br>
        2. Abra o Google Apps Script<br>
        3. Apague o cÃ³digo padrÃ£o que estÃ¡ lÃ¡<br>
        4. Cole este cÃ³digo (Ctrl+V)<br>
        5. Clique em "Salvar" ğŸ’¾
    `;
    
    // Ãrea de texto
    const textarea = document.createElement('textarea');
    textarea.value = codigo;
    textarea.style.cssText = 'width:100%;height:400px;font-family:monospace;font-size:13px;padding:15px;border:2px solid #4285f4;border-radius:8px;resize:vertical;line-height:1.5';
    textarea.readOnly = true;
    
    // BotÃµes
    const buttons = document.createElement('div');
    buttons.style.cssText = 'display:flex;gap:10px;margin-top:15px;justify-content:center';
    
    const btnCopiar = document.createElement('button');
    btnCopiar.textContent = 'ğŸ“‹ COPIAR CÃ“DIGO';
    btnCopiar.style.cssText = 'background:#4285f4;color:#fff;border:none;padding:15px 30px;border-radius:8px;font-size:16px;font-weight:bold;cursor:pointer;transition:0.3s';
    btnCopiar.onmouseover = () => btnCopiar.style.background = '#1967d2';
    btnCopiar.onmouseout = () => btnCopiar.style.background = '#4285f4';
    btnCopiar.onclick = () => {
        textarea.select();
        document.execCommand('copy');
        btnCopiar.textContent = 'âœ… COPIADO!';
        btnCopiar.style.background = '#28a745';
        setTimeout(() => {
            btnCopiar.textContent = 'ğŸ“‹ COPIAR CÃ“DIGO';
            btnCopiar.style.background = '#4285f4';
        }, 2000);
    };
    
    const btnProximo = document.createElement('button');
    btnProximo.textContent = 'â¡ï¸ PRÃ“XIMO PASSO';
    btnProximo.style.cssText = 'background:#28a745;color:#fff;border:none;padding:15px 30px;border-radius:8px;font-size:16px;font-weight:bold;cursor:pointer;transition:0.3s';
    btnProximo.onmouseover = () => btnProximo.style.background = '#218838';
    btnProximo.onmouseout = () => btnProximo.style.background = '#28a745';
    btnProximo.onclick = () => {
        console.log('ğŸš€ BotÃ£o PrÃ³ximo clicado - iniciando configuraÃ§Ã£o...');
        overlay.remove();
        
        // Aumenta timeout para dar tempo do modal fechar
        setTimeout(() => {
            console.log('â±ï¸ Timeout executado - mostrando prompts...');
            
            // 1. Primeiro pede a URL do Apps Script (para escrita)
            console.log('ğŸ“ Solicitando URL do Apps Script...');
            const scriptUrl = prompt(
                'ğŸ”— PASSO 1 de 3: COLE A URL DO APPS SCRIPT\n\n' +
                'Depois de:\n' +
                '1. Colar o cÃ³digo no Apps Script\n' +
                '2. Salvar o cÃ³digo (ğŸ’¾)\n' +
                '3. Clicar em "Implantar" â†’ "Nova implantaÃ§Ã£o"\n' +
                '4. Autorizar acesso\n\n' +
                'Cole aqui a URL do SCRIPT que foi gerada:\n' +
                '(Exemplo: https://script.google.com/macros/s/ABC.../exec)'
            );
            
            console.log('ğŸ“ Script URL recebida:', scriptUrl ? 'SIM' : 'NÃƒO');
            
            if (!scriptUrl || scriptUrl.trim() === '') {
                console.warn('âš ï¸ ConfiguraÃ§Ã£o cancelada - Script URL vazia');
                alert('âš ï¸ ConfiguraÃ§Ã£o cancelada!\n\nVocÃª precisa colar a URL do Apps Script.');
                return;
            }
            
            // 2. Depois pede a URL da planilha (para leitura)
            console.log('ğŸ“Š Solicitando URL da Planilha...');
            const sheetsUrl = prompt(
                'ğŸ“Š PASSO 2 de 3: COLE A URL DA PLANILHA\n\n' +
                'Agora cole a URL NORMAL da sua planilha do Google Sheets.\n\n' +
                'Exemplo:\n' +
                'https://docs.google.com/spreadsheets/d/ABC123.../edit\n\n' +
                'âš ï¸ IMPORTANTE:\n' +
                'Configure a planilha como "Qualquer pessoa com o link pode visualizar"\n\n' +
                'Cole a URL da planilha:'
            );
            
            console.log('ğŸ“Š Sheets URL recebida:', sheetsUrl ? 'SIM' : 'NÃƒO');
            
            if (!sheetsUrl || sheetsUrl.trim() === '') {
                console.warn('âš ï¸ ConfiguraÃ§Ã£o cancelada - Sheets URL vazia');
                alert('âš ï¸ ConfiguraÃ§Ã£o cancelada!\n\nVocÃª precisa colar a URL da planilha.');
                return;
            }
            
            // 3. Opcionalmente pede o nome da aba
            console.log('ğŸ“‘ Solicitando nome da aba...');
            let sheetName = prompt(
                'ğŸ“‘ PASSO 3 de 3: NOME DA ABA\n\n' +
                'Qual o nome da aba onde os dados serÃ£o salvos?\n\n' +
                'Deixe em branco ou digite "Visitas" (padrÃ£o):',
                'Visitas'
            );
            
            // Se usuÃ¡rio cancelou ou deixou vazio, usa "Visitas"
            if (!sheetName || sheetName.trim() === '') {
                sheetName = 'Visitas';
            }
            
            console.log('ğŸ“‘ Nome da aba:', sheetName);
            
            // Salva todas as configuraÃ§Ãµes
            console.log('ğŸ’¾ Salvando configuraÃ§Ãµes...');
            CONFIG_SYNC.metodo = 'google_sheets';
            CONFIG_SYNC.scriptUrl = scriptUrl.trim();           // Para escrita (POST)
            CONFIG_SYNC.googleSheetsUrl = sheetsUrl.trim();     // Para leitura (GET)
            CONFIG_SYNC.sheetName = sheetName.trim();           // Nome da aba
            CONFIG_SYNC.autoSync = true;
            
            localStorage.setItem('sync_metodo', 'google_sheets');
            localStorage.setItem('sync_script_url', scriptUrl.trim());
            localStorage.setItem('sync_google_sheets_url', sheetsUrl.trim());
            localStorage.setItem('sync_sheet_name', sheetName.trim());
            localStorage.setItem('sync_auto', 'true');
            
            console.log('âœ… ConfiguraÃ§Ãµes salvas!');
            console.log('ğŸ“‹ CONFIG_SYNC:', CONFIG_SYNC);
            
            alert(
                'âœ… Google Sheets configurado com sucesso!\n\n' +
                'ğŸ“ Script URL: ' + (scriptUrl.length > 50 ? scriptUrl.substring(0, 50) + '...' : scriptUrl) + '\n' +
                'ğŸ“Š Planilha: ' + (sheetsUrl.length > 50 ? sheetsUrl.substring(0, 50) + '...' : sheetsUrl) + '\n' +
                'ğŸ“‘ Aba: ' + sheetName + '\n\n' +
                'ğŸ”„ SincronizaÃ§Ã£o automÃ¡tica ATIVADA\n\n' +
                'ğŸ’¡ Agora toda vez que vocÃª salvar uma visita, ela serÃ¡ sincronizada automaticamente!\n\n' +
                'ğŸ§ª Teste clicando em "â˜ï¸ Sincronizar Agora"'
            );
            
            atualizarStatusSincronizacao();
            atualizarIndicadorArmazenamento();
            
            // Inicializa o indicador de sync
            if (typeof inicializarIndicadorSync === 'function') {
                inicializarIndicadorSync();
            }
            
            console.log('âœ… ConfiguraÃ§Ã£o concluÃ­da com sucesso!');
        }, 500);
    };
    
    buttons.appendChild(btnCopiar);
    buttons.appendChild(btnProximo);
    
    // Monta tudo
    body.appendChild(instrucoes);
    body.appendChild(textarea);
    body.appendChild(buttons);
    
    modal.appendChild(header);
    modal.appendChild(body);
    overlay.appendChild(modal);
    document.body.appendChild(overlay);
    
    // Seleciona texto automaticamente
    textarea.select();
}

// ============================================
// OPÃ‡ÃƒO 2: API PERSONALIZADA
// ============================================
function configurarAPIPersonalizada() {
    const apiUrl = document.getElementById('apiUrl').value;
    const apiKey = document.getElementById('apiKey').value;
    
    if (!apiUrl) {
        alert('âŒ Digite a URL da API!');
        return;
    }
    
    CONFIG_SYNC.metodo = 'api';
    CONFIG_SYNC.apiUrl = apiUrl;
    CONFIG_SYNC.apiKey = apiKey;
    CONFIG_SYNC.autoSync = true;
    
    localStorage.setItem('sync_metodo', 'api');
    localStorage.setItem('sync_api_url', apiUrl);
    localStorage.setItem('sync_api_key', apiKey);
    localStorage.setItem('sync_auto', 'true');
    
    alert('âœ… API configurada!\n\nğŸ”„ SincronizaÃ§Ã£o automÃ¡tica ATIVADA');
    atualizarStatusSincronizacao();
    atualizarIndicadorArmazenamento(); // Atualiza indicador para mostrar nuvem
}

// ============================================
// OPÃ‡ÃƒO 3: EMAIL BACKUP
// ============================================
function configurarEmailBackup() {
    const email = document.getElementById('emailBackup').value;
    
    if (!email || !email.includes('@')) {
        alert('âŒ Digite um email vÃ¡lido!');
        return;
    }
    
    CONFIG_SYNC.metodo = 'email';
    CONFIG_SYNC.email = email;
    CONFIG_SYNC.autoSync = true;
    
    localStorage.setItem('sync_metodo', 'email');
    localStorage.setItem('sync_email', email);
    localStorage.setItem('sync_auto', 'true');
    
    alert('âœ… Email configurado!\n\nğŸ“§ VocÃª receberÃ¡ backups automÃ¡ticos semanalmente');
    atualizarStatusSincronizacao();
    atualizarIndicadorArmazenamento(); // Atualiza indicador para mostrar nuvem
}

// ============================================
// SINCRONIZAÃ‡ÃƒO PRINCIPAL
// ============================================
async function sincronizarAgora() {
    if (!CONFIG_SYNC.metodo) {
        alert('âš ï¸ Configure a sincronizaÃ§Ã£o primeiro!\n\nClique em "â˜ï¸ CONFIGURAR SERVIDOR"');
        return;
    }
    
    const btn = document.getElementById('btnSincronizar');
    btn.disabled = true;
    btn.textContent = 'â³ Sincronizando...';
    
    try {
        // Coleta todas as visitas de todas as lojas
        const todasVisitas = [];
        
        for (let i = 0; i < lojas.length; i++) {
            const hist = JSON.parse(localStorage.getItem("hist_" + i) || "[]");
            
            hist.forEach(visita => {
                const pontos = calculaTotalPontos(visita.dados);
                todasVisitas.push({
                    loja: lojas[i],
                    data: visita.data,
                    encarregado: visita.dados.encarregado,
                    gerente: visita.dados.gerente,
                    pontuacao: pontos,
                    status: getStatus(pontos),
                    dados: visita.dados
                });
            });
        }
        
        console.log(`ğŸ“¦ Preparando ${todasVisitas.length} visitas para sincronizaÃ§Ã£o`);
        
        // Sincroniza de acordo com o mÃ©todo
        let resultado;
        
        switch(CONFIG_SYNC.metodo) {
            case 'google_sheets':
                resultado = await sincronizarGoogleSheets(todasVisitas);
                break;
            case 'api':
                resultado = await sincronizarAPI(todasVisitas);
                break;
            case 'email':
                resultado = await enviarEmailBackup(todasVisitas);
                break;
        }
        
        if (resultado.success) {
            CONFIG_SYNC.ultimaSync = new Date().toISOString();
            localStorage.setItem('sync_ultima', CONFIG_SYNC.ultimaSync);
            
            alert(`âœ… SincronizaÃ§Ã£o concluÃ­da!\n\nğŸ“Š ${todasVisitas.length} visitas enviadas\nğŸ• ${new Date().toLocaleString('pt-BR')}`);
            atualizarStatusSincronizacao();
        } else {
            throw new Error(resultado.erro || 'Erro desconhecido');
        }
        
    } catch (erro) {
        console.error('âŒ Erro na sincronizaÃ§Ã£o:', erro);
        alert('âŒ ERRO na sincronizaÃ§Ã£o:\n\n' + erro.message);
    } finally {
        btn.disabled = false;
        btn.textContent = 'â˜ï¸ Sincronizar Agora';
    }
}

// Sincroniza com Google Sheets
/**
 * âœ… FUNÃ‡ÃƒO CORRIGIDA - Sincroniza (ESCREVE) dados no Google Sheets
 * 
 * IMPORTANTE: Para ESCREVER dados, vocÃª precisa criar um Google Apps Script
 * 
 * Passos:
 * 1. Abra sua planilha
 * 2. Menu: ExtensÃµes â†’ Apps Script
 * 3. Cole o cÃ³digo fornecido no guia
 * 4. Implante como Aplicativo da Web
 * 5. Configure scriptUrl em CONFIG_SYNC
 */
async function sincronizarGoogleSheets(visitas) {
    // Verifica se tem script URL configurada
    const scriptUrl = CONFIG_SYNC.scriptUrl || CONFIG_SYNC.googleSheetsUrl;
    
    if (!scriptUrl) {
        console.warn('âš ï¸ Script URL nÃ£o configurada. Salvando apenas localmente.');
        mostrarToast('âš ï¸ Configure scriptUrl para sincronizar com Google Sheets', 'aviso');
        return { success: false, message: 'Script URL nÃ£o configurada' };
    }
    
    try {
        console.log('ğŸ“¤ Enviando dados para Google Sheets...');
        
        // Se for URL do Apps Script, usa POST
        if (scriptUrl.includes('script.google.com')) {
            const response = await fetch(scriptUrl, {
                method: 'POST',
                mode: 'no-cors', // Importante para Google Apps Script
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ 
                    acao: 'sincronizar',
                    visitas: visitas 
                })
            });
            
            // No-cors nÃ£o retorna resposta legÃ­vel, assumimos sucesso
            console.log('âœ… Dados enviados para Google Sheets');
            mostrarToast('âœ… Dados sincronizados com sucesso', 'sucesso');
            return { success: true };
            
        } else {
            // Se nÃ£o for script URL, apenas avisa
            console.warn('âš ï¸ URL fornecida nÃ£o Ã© um Google Apps Script. Configure scriptUrl.');
            mostrarToast('âš ï¸ Configure um Google Apps Script para sincronizaÃ§Ã£o', 'aviso');
            return { success: false, message: 'NÃ£o Ã© um Apps Script vÃ¡lido' };
        }
        
    } catch (error) {
        console.error('âŒ Erro ao sincronizar com Google Sheets:', error);
        mostrarToast(`âŒ Erro na sincronizaÃ§Ã£o: ${error.message}`, 'erro');
        return { success: false, error: error.message };
    }
}

/**
 * ğŸ†• Salva uma Ãºnica visita no Google Sheets
 */
async function salvarVisitaGoogleSheets(visitaData) {
    const scriptUrl = CONFIG_SYNC.scriptUrl;
    
    if (!scriptUrl || !scriptUrl.includes('script.google.com')) {
        console.warn('âš ï¸ Script URL nÃ£o configurada. Use a sincronizaÃ§Ã£o manual.');
        return false;
    }
    
    try {
        await fetch(scriptUrl, {
            method: 'POST',
            mode: 'no-cors',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                acao: 'adicionar',
                dados: visitaData
            })
        });
        
        console.log('âœ… Visita salva no Google Sheets');
        return true;
        
    } catch (error) {
        console.error('âŒ Erro ao salvar visita:', error);
        return false;
    }
}

// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// ğŸ“¥ CARREGAR DADOS DO GOOGLE SHEETS
// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

/**
 * âœ… FUNÃ‡ÃƒO CORRIGIDA - Carrega dados do Google Sheets
 * 
 * IMPORTANTE: Para funcionar, a planilha deve ter permissÃ£o:
 * "Qualquer pessoa com o link pode visualizar"
 * 
 * Formato esperado da URL:
 * https://docs.google.com/spreadsheets/d/SEU_ID_AQUI/edit
 */
async function carregarDadosGoogleSheets() {
    const url = CONFIG_SYNC.googleSheetsUrl;
    
    if (!url) {
        console.warn('âš ï¸ URL do Google Sheets nÃ£o configurada');
        atualizarIndicadorSync('error', 'URL nÃ£o configurada');
        return null;
    }
    
    try {
        console.log('ğŸ“¥ Carregando dados do Google Sheets...');
        atualizarIndicadorSync('syncing', 'Carregando...');
        
        // Extrai o ID da planilha da URL
        const spreadsheetId = extrairIdPlanilha(url);
        if (!spreadsheetId) {
            throw new Error('URL do Google Sheets invÃ¡lida');
        }
        
        // Nome da aba (pode ser configurÃ¡vel)
        const sheetName = CONFIG_SYNC.sheetName || 'Visitas';
        
        // Monta URL da API pÃºblica do Google Sheets
        // Formato: /gviz/tq retorna dados em formato JSON especial
        const apiUrl = `https://docs.google.com/spreadsheets/d/${spreadsheetId}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(sheetName)}`;
        
        console.log('ğŸ“¡ Requisitando:', apiUrl);
        
        const response = await fetch(apiUrl);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}. Verifique se a planilha estÃ¡ com permissÃ£o pÃºblica.`);
        }
        
        const text = await response.text();
        
        // O Google retorna um wrapper especial: google.visualization.Query.setResponse({...});
        // Precisamos extrair apenas o JSON
        const jsonMatch = text.match(/google\.visualization\.Query\.setResponse\((.*)\);?$/);
        if (!jsonMatch) {
            throw new Error('Formato de resposta invÃ¡lido do Google Sheets');
        }
        
        const jsonData = JSON.parse(jsonMatch[1]);
        
        if (!jsonData.table || !jsonData.table.rows) {
            console.warn('âš ï¸ Nenhum dado encontrado na planilha');
            atualizarIndicadorSync('idle', 'Sem dados');
            return [];
        }
        
        // Converte os dados do formato do Google para o formato do sistema
        // Assumindo colunas: Data | Loja | Encarregado | Gerente | PontuaÃ§Ã£o | Dados JSON
        const visitas = jsonData.table.rows.map(row => {
            const cells = row.c || [];
            
            try {
                return {
                    data: cells[0]?.v || '',
                    loja: cells[1]?.v || '',
                    encarregado: cells[2]?.v || 'NÃ£o informado',
                    gerente: cells[3]?.v || 'NÃ£o informado',
                    pontuacao: parseFloat(cells[4]?.v) || 0,
                    dados: cells[5]?.v ? JSON.parse(cells[5].v) : {}
                };
            } catch (e) {
                console.warn('âš ï¸ Erro ao processar linha:', e);
                return null;
            }
        }).filter(v => v !== null);
        
        console.log(`âœ… ${visitas.length} visitas carregadas do Google Sheets`);
        atualizarIndicadorSync('success', `âœ… ${visitas.length} visitas`);
        mostrarToast(`âœ… ${visitas.length} visitas sincronizadas`, 'sucesso');
        
        return visitas;
        
    } catch (error) {
        console.error('âŒ Erro ao carregar do Google Sheets:', error);
        atualizarIndicadorSync('error', `âŒ Erro: ${error.message.substring(0, 30)}...`);
        mostrarToast(`âŒ Erro: ${error.message}`, 'erro');
        return null;
    }
}

/**
 * Extrai o ID da planilha da URL do Google Sheets
 */
function extrairIdPlanilha(url) {
    if (!url) return null;
    
    // Formato: https://docs.google.com/spreadsheets/d/ID/edit
    const match = url.match(/\/d\/([a-zA-Z0-9-_]+)/);
    return match ? match[1] : null;
}

// Sincroniza com API personalizada
async function sincronizarAPI(visitas) {
    const url = CONFIG_SYNC.apiUrl;
    const headers = {
        'Content-Type': 'application/json'
    };
    
    if (CONFIG_SYNC.apiKey) {
        headers['Authorization'] = `Bearer ${CONFIG_SYNC.apiKey}`;
    }
    
    const response = await fetch(url, {
        method: 'POST',
        headers,
        body: JSON.stringify({ visitas })
    });
    
    if (!response.ok) {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }
    
    return await response.json();
}

// Envia backup por email
async function enviarEmailBackup(visitas) {
    // Gera arquivo JSON
    const dados = {
        exportado_em: new Date().toISOString(),
        total_visitas: visitas.length,
        visitas: visitas
    };
    
    const blob = new Blob([JSON.stringify(dados, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    
    // Cria link de download
    const a = document.createElement('a');
    a.href = url;
    a.download = `shoemix_backup_${new Date().toISOString().split('T')[0]}.json`;
    a.click();
    
    alert(`ğŸ“§ Arquivo de backup baixado!\n\nEnvie este arquivo para: ${CONFIG_SYNC.email}`);
    
    return { success: true };
}

// SincronizaÃ§Ã£o automÃ¡tica ao salvar
function sincronizarAposSalvar() {
    if (CONFIG_SYNC.autoSync && CONFIG_SYNC.metodo) {
        console.log('ğŸ”„ SincronizaÃ§Ã£o automÃ¡tica iniciada...');
        setTimeout(() => sincronizarAgora(), 2000);
    }
}




function manterHistoricoRecente(hist, maxVisitas = 50) {
    // MantÃ©m apenas as N visitas mais recentes
    if (hist.length > maxVisitas) {
        console.log(`ğŸ“¦ Limitando histÃ³rico: ${hist.length} â†’ ${maxVisitas}`);
        return hist.slice(-maxVisitas); // Pega as Ãºltimas N
    }
    return hist;
}

async function salvarFotoDB(blob, visitaId, secaoId) {
  return new Promise((resolve, reject) => {
    const tx = db.transaction([STORE_FOTOS], 'readwrite');
    const store = tx.objectStore(STORE_FOTOS);
    const request = store.add({
      blob: blob,
      visitaId: visitaId,
      secaoId: secaoId,
      timestamp: new Date().toISOString(),
      size: blob.size
    });
    request.onsuccess = () => resolve(request.result);
    request.onerror = () => reject(request.error);
  });
}

async function buscarFotosSecao(visitaId, secaoId) {
  return new Promise((resolve, reject) => {
    const tx = db.transaction([STORE_FOTOS], 'readonly');
    const store = tx.objectStore(STORE_FOTOS);
    const index = store.index('secaoId');
    const request = index.getAll(secaoId);
    request.onsuccess = () => {
      const todas = request.result;
      const filtradas = todas.filter(f => f.visitaId === visitaId);
      resolve(filtradas);
    };
    request.onerror = () => reject(request.error);
  });
}

async function removerFotoDB(id) {
  return new Promise((resolve, reject) => {
    const tx = db.transaction([STORE_FOTOS], 'readwrite');
    const request = tx.objectStore(STORE_FOTOS).delete(id);
    request.onsuccess = () => resolve();
    request.onerror = () => reject(request.error);
  });
}

// ğŸ†• TRANSFERE FOTOS DO INDEXEDDB PARA GOOGLE DRIVE
async function transferirFotosIndexedDBParaDrive(visitaId, modalProgresso = null) {
  console.log('ğŸ”„ Iniciando transferÃªncia de fotos do IndexedDB para Drive...');
  
  if (!CONFIG_DRIVE || !CONFIG_DRIVE.conectado) {
    console.log('âš ï¸ Drive nÃ£o conectado - fotos permanecem no IndexedDB');
    return { sucesso: false, motivo: 'Drive nÃ£o conectado' };
  }
  
  try {
    // 1ï¸âƒ£ ObtÃ©m pasta do Drive uma Ãºnica vez
    const folderId = await obterOuCriarPasta();
    console.log('ğŸ“ Pasta do Drive obtida:', folderId);
    
    let fotosTransferidas = 0;
    let fotosErro = 0;
    let espacoLiberado = 0; // em bytes
    
    // 2ï¸âƒ£ Conta total de fotos a transferir
    const secoes = document.querySelectorAll('.section[data-secao]');
    let totalFotos = 0;
    secoes.forEach(secao => {
      const fotosDivs = secao.querySelectorAll('.foto-item');
      fotosDivs.forEach(fotoDiv => {
        const dbId = fotoDiv.getAttribute('data-db-id');
        const driveId = fotoDiv.getAttribute('data-drive-id');
        if (dbId && !driveId) totalFotos++;
      });
    });
    
    console.log(`ğŸ“Š Total de fotos a transferir: ${totalFotos}`);
    
    // Se nÃ£o tem fotos para transferir, retorna sucesso
    if (totalFotos === 0) {
      return { sucesso: true, transferidas: 0, erros: 0, espacoLiberado: 0 };
    }
    
    let fotoAtual = 0;
    
    // 3ï¸âƒ£ Percorre cada seÃ§Ã£o e transfere fotos
    for (const secao of secoes) {
      const secaoId = secao.getAttribute('data-secao');
      const fotosDivs = secao.querySelectorAll('.foto-item');
      
      for (const fotoDiv of fotosDivs) {
        const dbId = fotoDiv.getAttribute('data-db-id');
        const driveId = fotoDiv.getAttribute('data-drive-id');
        
        // Se jÃ¡ estÃ¡ no Drive, pula
        if (driveId) {
          console.log(`   âœ… Foto jÃ¡ no Drive: ${driveId}`);
          continue;
        }
        
        // Se tem ID do IndexedDB, transfere para Drive
        if (dbId) {
          try {
            fotoAtual++;
            console.log(`   ğŸ“¤ [${fotoAtual}/${totalFotos}] Transferindo foto ${dbId}...`);
            
            // Atualiza modal de progresso
            if (modalProgresso) {
              atualizarModalProgresso(modalProgresso, fotoAtual, totalFotos);
            }
            
            // Busca foto no IndexedDB
            const fotoData = await buscarFotoPorId(parseInt(dbId));
            
            if (!fotoData || !fotoData.blob) {
              console.warn(`   âš ï¸ Foto ${dbId} nÃ£o encontrada no IndexedDB`);
              fotosErro++;
              continue;
            }
            
            // Guarda tamanho antes de deletar
            const tamanhoFoto = fotoData.blob.size;
            
            // Upload para Drive
            const nomeArquivo = `shoemix_sec${secaoId}_${Date.now()}.jpg`;
            const resultado = await uploadFotoParaDriveComPasta(fotoData.blob, nomeArquivo, folderId);
            
            // Atualiza DOM
            fotoDiv.setAttribute('data-drive-id', resultado.id);
            fotoDiv.setAttribute('data-drive-url', resultado.url);
            fotoDiv.removeAttribute('data-db-id');
            
            // ğŸ†• ATUALIZA BADGE VISUAL
            const badge = fotoDiv.querySelector('.storage-badge');
            if (badge) {
              badge.innerHTML = 'â˜ï¸ Drive';
              badge.style.background = 'rgba(52, 168, 83, 0.95)'; // Verde
            }
            
            // âœ… LIMPA DO INDEXEDDB (economiza espaÃ§o!)
            await removerFotoDB(parseInt(dbId));
            espacoLiberado += tamanhoFoto;
            
            fotosTransferidas++;
            console.log(`   âœ… Foto transferida e REMOVIDA do IndexedDB: ${dbId} â†’ Drive ${resultado.id} (${(tamanhoFoto/1024).toFixed(1)}KB liberados)`);
            
          } catch (erro) {
            console.error(`   âŒ Erro ao transferir foto ${dbId}:`, erro);
            fotosErro++;
            // MantÃ©m no IndexedDB como fallback (nÃ£o remove)
          }
        }
      }
    }
    
    console.log(`âœ… TransferÃªncia concluÃ­da: ${fotosTransferidas} fotos â†’ Drive, ${fotosErro} erros`);
    console.log(`ğŸ’¾ EspaÃ§o liberado no IndexedDB: ${(espacoLiberado/1024/1024).toFixed(2)} MB`);
    
    return { 
      sucesso: true, 
      transferidas: fotosTransferidas, 
      erros: fotosErro,
      espacoLiberado: espacoLiberado
    };
    
  } catch (erro) {
    console.error('âŒ Erro na transferÃªncia de fotos:', erro);
    return { sucesso: false, motivo: erro.message };
  }
}

// ğŸ†• BUSCA FOTO POR ID NO INDEXEDDB
async function buscarFotoPorId(id) {
  return new Promise((resolve, reject) => {
    const tx = db.transaction([STORE_FOTOS], 'readonly');
    const store = tx.objectStore(STORE_FOTOS);
    const request = store.get(id);
    request.onsuccess = () => resolve(request.result);
    request.onerror = () => reject(request.error);
  });
}

// ğŸ†• LIMPA FOTOS ANTIGAS DO INDEXEDDB
async function limparFotosIndexedDB() {
  const confirmar = confirm(
    'ğŸ’¾ LIMPEZA DE FOTOS DO INDEXEDDB\n\n' +
    'âš ï¸ Esta aÃ§Ã£o irÃ¡:\n' +
    'â€¢ Listar todas as fotos armazenadas localmente\n' +
    'â€¢ Mostrar quanto espaÃ§o estÃ¡ sendo usado\n' +
    'â€¢ Permitir que vocÃª escolha o que limpar\n\n' +
    'âœ… Fotos no Google Drive nÃ£o serÃ£o afetadas\n\n' +
    'Deseja continuar?'
  );
  
  if (!confirmar) return;
  
  try {
    // Busca todas as fotos do IndexedDB
    const todasFotos = await new Promise((resolve, reject) => {
      const tx = db.transaction([STORE_FOTOS], 'readonly');
      const store = tx.objectStore(STORE_FOTOS);
      const request = store.getAll();
      request.onsuccess = () => resolve(request.result);
      request.onerror = () => reject(request.error);
    });
    
    if (todasFotos.length === 0) {
      alert('âœ… Nenhuma foto no IndexedDB!\n\nTodas as fotos estÃ£o no Google Drive ou nÃ£o hÃ¡ fotos salvas.');
      return;
    }
    
    // Calcula espaÃ§o total
    let espacoTotal = 0;
    todasFotos.forEach(foto => {
      espacoTotal += foto.blob?.size || 0;
    });
    
    const espacoMB = (espacoTotal / 1024 / 1024).toFixed(2);
    
    const limparTodas = confirm(
      `ğŸ’¾ INFORMAÃ‡Ã•ES DO INDEXEDDB\n\n` +
      `ğŸ“Š Total de fotos: ${todasFotos.length}\n` +
      `ğŸ’¾ EspaÃ§o usado: ${espacoMB} MB\n\n` +
      `âš ï¸ ATENÃ‡ÃƒO:\n` +
      `â€¢ Limpar estas fotos liberarÃ¡ espaÃ§o no navegador\n` +
      `â€¢ Apenas limpe fotos que jÃ¡ foram enviadas ao Drive\n` +
      `â€¢ Fotos nÃ£o enviadas ao Drive serÃ£o PERDIDAS!\n\n` +
      `${CONFIG_DRIVE?.conectado ? 'âœ… Drive conectado - Pode limpar com seguranÃ§a' : 'âš ï¸ Drive NÃƒO conectado - NÃƒO limpe agora!'}\n\n` +
      `Deseja limpar TODAS as fotos do IndexedDB?`
    );
    
    if (!limparTodas) return;
    
    // Limpa todas as fotos
    let fotosRemovidas = 0;
    for (const foto of todasFotos) {
      try {
        await removerFotoDB(foto.id);
        fotosRemovidas++;
      } catch (erro) {
        console.error('Erro ao remover foto:', erro);
      }
    }
    
    alert(
      `âœ… LIMPEZA CONCLUÃDA!\n\n` +
      `ğŸ—‘ï¸ Fotos removidas: ${fotosRemovidas}\n` +
      `ğŸ’¾ EspaÃ§o liberado: ${espacoMB} MB\n\n` +
      `${CONFIG_DRIVE?.conectado ? 'âœ… Suas fotos estÃ£o seguras no Google Drive' : 'âš ï¸ Certifique-se de que tinha backup!'}`
    );
    
  } catch (erro) {
    console.error('âŒ Erro ao limpar IndexedDB:', erro);
    alert('âŒ Erro ao limpar fotos: ' + erro.message);
  }
}

const lojas=["LOJA 1-IBATE","LOJA 3-SÃƒO CARLOS","LOJA 4-ARARAQUARA","LOJA 5-SÃƒO CARLOS","LOJA 6-PIRASSUNUNGA","LOJA 7-ARARAQUARA","LOJA 8-ARARAQUARA","LOJA 9-A. BRASILIENSE"];
let lojaAtual=0,visitaEmEdicao=null;
function criarTabs(){const t=document.getElementById("tabs");t.innerHTML="";lojas.forEach((l,i)=>{const b=document.createElement("button");b.innerHTML=l.replace('-','<br>');b.onclick=()=>trocarLoja(i);if(i===lojaAtual)b.classList.add("active");t.appendChild(b)})}
function trocarLoja(i){lojaAtual=i;criarTabs();montarTela();carregar();atualizarHistorico();const rm=document.getElementById("resumoMensal"),rg=document.getElementById("resumoGeral");if(rm)rm.style.display="none";if(rg)rg.style.display="none";document.querySelectorAll('.pergunta').forEach(p=>{p.classList.remove('resposta-boa','resposta-ruim','resposta-neutra')})}
function simNao(txt,id,opcoes="padrao"){let html=`<div class="pergunta">- ${txt}<div class="opcoes">`;if(opcoes==="nf_cx"||opcoes==="etiquetar"){html+=`<label><input type="radio" name="${id}" value="Sim, fora do prazo" onchange="calcularPontuacaoSecao()"> Sim, fora do prazo</label><label><input type="radio" name="${id}" value="Sim, dentro do prazo" onchange="calcularPontuacaoSecao()"> Sim, dentro do prazo</label><label><input type="radio" name="${id}" value="NÃ£o" onchange="calcularPontuacaoSecao()"> NÃ£o</label>`}else if(opcoes==="impressora"){html+=`<label><input type="radio" name="${id}" value="Sim, solicitado conserto" onchange="calcularPontuacaoSecao()"> Sim, solicitado conserto</label><label><input type="radio" name="${id}" value="Sim, nÃ£o solicitado" onchange="calcularPontuacaoSecao()"> Sim, nÃ£o solicitado</label><label><input type="radio" name="${id}" value="NÃ£o" onchange="calcularPontuacaoSecao()"> NÃ£o</label>`}else if(opcoes==="remanejamento"||opcoes==="lotes"){html+=`<label><input type="radio" name="${id}" value="Sim" onchange="calcularPontuacaoSecao()"> Sim</label><label><input type="radio" name="${id}" value="Em Aberto, dentro do prazo" onchange="calcularPontuacaoSecao()"> Em Aberto, dentro do prazo</label><label><input type="radio" name="${id}" value="Em Aberto, fora do prazo" onchange="calcularPontuacaoSecao()"> Em Aberto, fora do prazo</label>`}else{html+=`<label><input type="radio" name="${id}" value="Sim" onchange="calcularPontuacaoSecao()"> Sim</label><label><input type="radio" name="${id}" value="NÃ£o" onchange="calcularPontuacaoSecao()"> NÃ£o</label>`}html+=`</div><textarea id="${id}" placeholder="Descreva quando necessÃ¡rio..."></textarea></div>`;return html}
function secao(n,t,c,secId){return`<div class="section" data-secao="${secId}"><h3>${n} â€“ ${t}</h3>${c}<label>PontuaÃ§Ã£o AutomÃ¡tica (0 a 3):<select class="pts" data-pts-id="pts_${secId}" disabled style="background:#f0f0f0;cursor:not-allowed"><option value="0">0 - InsatisfatÃ³rio</option><option value="1">1 - Regular</option><option value="2">2 - Bom</option><option value="3">3 - Excelente</option></select><small style="color:#666">ğŸ“Š PontuaÃ§Ã£o calculada automaticamente</small></label><label>ObservaÃ§Ãµes:</label><textarea id="obs_${secId}"></textarea><label>Anexo (Foto): <input type="file" accept="image/png,image/jpeg,image/jpg,image/webp" class="foto-input" onchange="anexarFoto(this)" onfocus="salvarAntesDeFoto()" onclick="salvarAntesDeFoto()" multiple></label><div class="fotos-preview"></div></div>`}
function montarTela(){document.getElementById("app").innerHTML=`<div class="section"><h3 style="color:#f00;text-align:center;margin:0 0 15px 0;padding:10px;background:#f5f5f5;border:2px solid #f00;border-radius:8px">ğŸª ${lojas[lojaAtual]}</h3><label>Data:<input type="text" id="data" placeholder="dd/mm/aaaa" oninput="formatarData(this)"></label><label>Objetivo da Visita:<select id="objetivo"><option value="">Selecione...</option><option>Acompanhamento de rotina</option><option>Auditoria de processos</option><option>Treinamento e capacitaÃ§Ã£o</option></select></label><label>Nome do Encarregado:<input type="text" id="encarregado"></label><label>Nome do Gerente ResponsÃ¡vel:<input type="text" id="gerente"></label><h3>ğŸ“‚ HistÃ³rico de Visitas</h3><button class="collapsible">Mostrar/Esconder HistÃ³rico</button><div class="hist-container" style="display:none"><table class="hist-table"><thead><tr><th>Data</th><th>Pontos</th><th>Status</th><th>AÃ§Ãµes</th></tr></thead><tbody id="historicoBody"></tbody></table></div></div>${secao(1,"Recebimento de Mercadorias",simNao("Existem Notas Fiscais aguardando recebimento no sistema?","nf","nf_cx")+simNao("Existem volumes com caixas fechadas?","cx","nf_cx")+simNao("Houve erros de recebimento que precisaram de cancelamento?","er"),"1")}${secao(2,"Etiquetagem de Produtos",simNao("Existem mercadorias a serem etiquetadas?","et","etiquetar")+simNao("Etiquetas estÃ£o sendo impressas corretamente?","imp")+simNao("Impressora Argox apresenta problemas?","arg","impressora"),"2")}${secao(3,"OrganizaÃ§Ã£o e Limpeza do Estoque",simNao("Estoque limpo e higienizado?","limpo")+simNao("Ãrea do computador organizada?","pc")+simNao("Checklist online sendo usado corretamente?","check"),"3")}${secao(4,"OrganizaÃ§Ã£o do Estoque â€“ Corredores",simNao("Corredores alinhados e puxados?","c1")+simNao("Corredores numerados conforme padrÃ£o?","c2")+simNao("Produtos organizados por setor?","c3")+simNao("Acesso livre e sem obstruÃ§Ãµes?","c4"),"4")}${secao(5,"OrganizaÃ§Ã£o de ConfecÃ§Ãµes e AcessÃ³rios",simNao("SetorizaÃ§Ã£o correta (Marcas e Modelos)?","f1")+simNao("Armazenamento adequado?","f2"),"5")}${secao(6,"Gatos e Defeitos",simNao("Produtos de gatos identificados e separados?","g1")+simNao("Defeitos transferidos para loja 99?","g2"),"6")}${secao(7,"TransferÃªncias e Remanejamentos",simNao("TransferÃªncias realizadas corretamente entre lojas?","t1")+simNao("Remanejamentos via sistema realizados corretamente?","t2","remanejamento")+simNao("Lotes em aberto entre lojas estÃ£o corretos?","t3","lotes")+simNao("SeparaÃ§Ã£o de pÃ©s de vitrine correta?","t4"),"7")}<div class="summary" id="summaryBox"><div style="text-align:center;font-size:1.8em;font-weight:700;margin-bottom:15px">ğŸ“Š RESULTADO DA AVALIAÃ‡ÃƒO</div><div style="display:flex;justify-content:space-around;align-items:center;flex-wrap:wrap;gap:20px"><div style="text-align:center"><div style="font-size:3em;font-weight:700;color:#f00" id="totalDisplay">0</div><div style="font-size:1.2em;color:#666">de 21 pontos</div></div><div style="text-align:center;flex:1;min-width:200px"><div style="font-size:2.5em;margin-bottom:10px" id="statusEmoji">âšª</div><div style="font-size:1.5em;font-weight:700;padding:10px 20px;border-radius:10px" id="statusText">Aguardando avaliaÃ§Ã£o</div></div></div><div style="margin-top:20px;padding:15px;background:#f9f9f9;border-radius:8px;font-size:0.9em"><strong>Legenda:</strong> ğŸŸ¢ 18â€“21 Excelente | ğŸ”µ 14â€“17 Bom | ğŸŸ¡ 10â€“13 Regular | ğŸ”´ 0â€“9 InsatisfatÃ³rio</div></div><button class="collapsible">ğŸ“Š Resumo Mensal</button><div id="resumoMensal" style="display:none;margin-top:10px"></div><button class="collapsible">ğŸ“Š Resumo Geral</button><div id="resumoGeral" style="display:none;margin-top:10px"></div><div class="section"><h3>ConclusÃ£o da Visita</h3><textarea id="conclusao"></textarea><div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-top:20px"><div><strong>Assinatura Coordenador:</strong><div style="border-bottom:2px solid #000;margin-top:40px"></div></div><div><strong>Assinatura Gerente:</strong><div style="border-bottom:2px solid #000;margin-top:40px"></div></div><div><strong>Assinatura Encarregado:</strong><div style="border-bottom:2px solid #000;margin-top:40px"></div></div></div></div>`;carregar();calcular();calcularPontuacaoSecao();atualizarHistorico();document.querySelectorAll(".collapsible").forEach(coll=>{coll.onclick=function(){this.classList.toggle("active");const content=this.nextElementSibling;content.style.display=(content.style.display==="block")?"none":"block";if(this.textContent.includes("Resumo Mensal"))resumoMensal();if(this.textContent.includes("Resumo Geral"))resumoGeral()}})}
function formatarData(el){let v=el.value.replace(/\D/g,'');if(v.length>=3)v=v.slice(0,2)+'/'+v.slice(2);if(v.length>=6)v=v.slice(0,5)+'/'+v.slice(5,9);el.value=v}
function comprimirImagem(file, callback) {
    const reader = new FileReader();
    reader.onload = function(e) {
        const img = new Image();
        img.onload = function() {
            const canvas = document.createElement('canvas');
            let width = img.width;
            let height = img.height;
            
            // Define tamanho mÃ¡ximo (1200px na maior dimensÃ£o)
            const maxSize = 1200;
            if (width > height) {
                if (width > maxSize) {
                    height *= maxSize / width;
                    width = maxSize;
                }
            } else {
                if (height > maxSize) {
                    width *= maxSize / height;
                    height = maxSize;
                }
            }
            
            canvas.width = width;
            canvas.height = height;
            
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, width, height);
            
            // Comprime para JPEG com qualidade 0.7 (70%)
            const compressed = canvas.toDataURL('image/jpeg', 0.7);
            callback(compressed);
        };
        img.src = e.target.result;
    };
    reader.readAsDataURL(file);
}

// ğŸ†• VersÃ£o moderna da compressÃ£o que retorna Promise (para usar com async/await)
function comprimirImagemModerna(file, qualidade = 0.7) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = function(e) {
            const img = new Image();
            img.onload = function() {
                try {
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;
                    
                    // ğŸ”¥ COMPRESSÃƒO INTELIGENTE: 800px para melhor qualidade visual
                    const maxSize = 800;
                    if (width > height) {
                        if (width > maxSize) {
                            height *= maxSize / width;
                            width = maxSize;
                        }
                    } else {
                        if (height > maxSize) {
                            width *= maxSize / height;
                            height = maxSize;
                        }
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    // ğŸš€ USA QUALIDADE PASSADA COMO PARÃ‚METRO (0.6 para cÃ¢mera, 0.7 para arquivo)
                    canvas.toBlob((blob) => {
                        if (blob) {
                            console.log('âœ… Imagem comprimida:', (blob.size/1024).toFixed(0)+'KB', 'Qualidade:', qualidade);
                            resolve(blob);
                        } else {
                            reject(new Error('Falha ao comprimir imagem'));
                        }
                    }, 'image/jpeg', qualidade);
                    
                } catch(error) {
                    reject(error);
                }
            };
            img.onerror = () => reject(new Error('Erro ao carregar imagem'));
            img.src = e.target.result;
        };
        reader.onerror = () => reject(new Error('Erro ao ler arquivo'));
        reader.readAsDataURL(file);
    });
}

// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// ğŸ†• SALVA AUTOMATICAMENTE ANTES DE TIRAR FOTO
// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
function salvarAntesDeFoto() {
    console.log('ğŸ“¸ UsuÃ¡rio vai tirar foto - salvando formulÃ¡rio automaticamente...');
    
    // Cria indicador visual
    const indicador = document.createElement('div');
    indicador.style.cssText = `
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: #28a745;
        color: white;
        padding: 12px 24px;
        border-radius: 8px;
        font-weight: 600;
        z-index: 10000;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        animation: slideDown 0.3s ease;
    `;
    indicador.innerHTML = 'ğŸ’¾ Salvando automaticamente...';
    document.body.appendChild(indicador);
    
    // Adiciona animaÃ§Ã£o
    const style = document.createElement('style');
    style.textContent = `
        @keyframes slideDown {
            from { transform: translateX(-50%) translateY(-30px); opacity: 0; }
            to { transform: translateX(-50%) translateY(0); opacity: 1; }
        }
    `;
    document.head.appendChild(style);
    
    // Salva sem mostrar alerta
    salvar(false);
    
    // Remove indicador apÃ³s 2 segundos
    setTimeout(() => {
        indicador.style.opacity = '0';
        indicador.style.transform = 'translateX(-50%) translateY(-30px)';
        indicador.style.transition = 'all 0.3s ease';
        setTimeout(() => indicador.remove(), 300);
    }, 2000);
}

async function anexarFoto(input){
    
    // ğŸ¯ NOVA ESTRATÃ‰GIA: SEMPRE salva no IndexedDB primeiro
    // Fotos serÃ£o transferidas para Drive automaticamente ao salvar a visita completa
    console.log('ğŸ“¸ Salvando foto no IndexedDB (serÃ¡ enviada ao Drive ao salvar visita)');
    
    // Continua com mÃ©todo IndexedDB (funciona sempre!)

    const secao=input.closest('.section');
    const secaoId=secao.getAttribute('data-secao');
    const preview=secao.querySelector('.fotos-preview');
    
    if(!input.files||input.files.length===0) return;
    
    const arquivos = Array.from(input.files);
    
    arquivos.forEach(file=>{
        if(!file.type.startsWith('image/')){
            alert('âš ï¸ Selecione apenas imagens.');
            return;
        }
        
        const loadingDiv = document.createElement('div');
        loadingDiv.className = 'foto-item';
        loadingDiv.innerHTML = '<div style="padding:20px;text-align:center;color:#666">ğŸ“¸ Processando...</div>';
        preview.appendChild(loadingDiv);
        
        // Converte para Blob (SEM compressÃ£o excessiva)
        const reader = new FileReader();
        reader.onload = async function(e) {
            try {
                const blob = new Blob([e.target.result], { type: file.type });
                const fotoId = 'foto_'+secaoId+'_'+Date.now()+'_'+Math.random().toString(36).substr(2,9);
                const url = URL.createObjectURL(blob);
                
                const div=document.createElement('div');
                div.className='foto-item';
                div.setAttribute('data-foto-id',fotoId);
                div.setAttribute('data-blob-url', url); // Guarda URL
                div.style.position = 'relative'; // Para posicionar badge
                
                // ğŸ†• BADGE indicando armazenamento temporÃ¡rio
                const badge = document.createElement('div');
                badge.className = 'storage-badge';
                badge.innerHTML = 'ğŸ’¾ Local';
                badge.style.cssText = `
                    position: absolute;
                    top: 5px;
                    left: 5px;
                    background: rgba(255, 152, 0, 0.95);
                    color: white;
                    padding: 4px 8px;
                    border-radius: 4px;
                    font-size: 0.7em;
                    font-weight: 600;
                    z-index: 10;
                    box-shadow: 0 2px 4px rgba(0,0,0,0.3);
                `;
                
                const btnRemover=document.createElement('button');
                btnRemover.className='remover-foto';
                btnRemover.type='button';
                btnRemover.innerHTML='Ã—';
                btnRemover.onclick=function(event){
                    event.stopPropagation();
                    removerFoto(fotoId,event);
                };
                
                const img=document.createElement('img');
                img.src=url;
                img.alt='Foto';
                img.setAttribute('data-foto-blob', JSON.stringify({ 
                    id: fotoId, 
                    size: blob.size,
                    type: blob.type
                }));
                img.onclick=function(){ampliarFoto(fotoId)};
                
                div.appendChild(badge); // Adiciona badge primeiro
                div.appendChild(btnRemover);
                div.appendChild(img);
                
                preview.removeChild(loadingDiv);
                preview.appendChild(div);
                
                // Guarda Blob temporariamente no objeto window
                if (!window.fotosTemporarias) window.fotosTemporarias = {};
                window.fotosTemporarias[fotoId] = blob;
                
                console.log('âœ… Foto preparada:', fotoId, (blob.size/1024).toFixed(1)+'KB');
                
            } catch(error) {
                console.error('âŒ Erro:', error);
                preview.removeChild(loadingDiv);
                alert('âš ï¸ Erro ao processar foto');
            }
        };
        reader.readAsArrayBuffer(file);
    });
    
    // ğŸ†• Limpa o input completamente para permitir novas seleÃ§Ãµes
    setTimeout(() => {
        input.value = '';
    }, 100);
}
function removerFoto(fotoId,event){if(event){event.stopPropagation();event.preventDefault()}if(!confirm('Deseja remover esta foto?'))return;const fotoItem=document.querySelector(`[data-foto-id="${fotoId}"]`);if(!fotoItem){alert('âŒ Erro ao localizar a foto.');return}fotoItem.remove();setTimeout(()=>{salvar(false)},100)}
function ampliarFoto(fotoId){const f=document.querySelector(`[data-foto-id="${fotoId}"]`);if(!f)return;const img=f.querySelector('img'),modal=document.getElementById('modalFoto'),modalImg=document.getElementById('imagemModal');modalImg.src=img.src;modal.style.display='flex'}
function fecharModal(){document.getElementById('modalFoto').style.display='none'}
function abrirBonificacao(){const hoje=new Date();gerarSeletorMesAno(hoje.getMonth(),hoje.getFullYear());document.getElementById('modalBonificacao').style.display='flex'}
function fecharBonificacao(){document.getElementById('modalBonificacao').style.display='none'}
// ğŸ†• FUNÃ‡Ã•ES DO RELATÃ“RIO DE DIRETORIA
function abrirRelatorioDiretoria(){
    const hoje=new Date();
    gerarRelatorioDiretoria(hoje.getMonth(),hoje.getFullYear());
    document.getElementById('modalRelatorioDiretoria').style.display='flex';
}

function fecharRelatorioDiretoria(){
    document.getElementById('modalRelatorioDiretoria').style.display='none';
}
// ğŸ†• FUNÃ‡ÃƒO PRINCIPAL DO RELATÃ“RIO DE DIRETORIA
function gerarRelatorioDiretoria(mesAtual, anoAtual) {
    const meses = ['Janeiro','Fevereiro','MarÃ§o','Abril','Maio','Junho','Julho','Agosto','Setembro','Outubro','Novembro','Dezembro'];
    const nomeMes = meses[mesAtual];
    
    // Coleta dados de todas as lojas
    const dadosLojas = [];
    let totalVisitasRede = 0;
    let totalPontosRede = 0;
    let lojasComVisita = 0;
    
    lojas.forEach((loja, index) => {
        const hist = JSON.parse(localStorage.getItem("hist_"+index) || "[]");
        const visitasMes = hist.filter(v => {
            let d;
            if(typeof v.data === 'string' && v.data.includes('/')) {
                const p = v.data.split(' ')[0].split('/');
                if(p.length === 3) d = new Date(parseInt(p[2]), parseInt(p[1])-1, parseInt(p[0]));
            } else {
                d = new Date(v.data);
            }
            return d && !isNaN(d.getTime()) && d.getMonth() === mesAtual && d.getFullYear() === anoAtual;
        });
        
        if(visitasMes.length > 0) {
            let somaPontos = 0;
            visitasMes.forEach(v => somaPontos += calculaTotalPontos(v.dados));
            const media = somaPontos / visitasMes.length;
            
            const ultimaVisita = visitasMes[visitasMes.length - 1];
            const encarregado = ultimaVisita.dados.encarregado || 'NÃ£o informado';
            const gerente = ultimaVisita.dados.gerente || 'NÃ£o informado';
            
            dadosLojas.push({
                nome: loja,
                index: index,
                visitas: visitasMes.length,
                media: media,
                encarregado: encarregado,
                gerente: gerente,
                ultimaVisita: ultimaVisita.data,
                historicoCompleto: visitasMes
            });
            
            totalVisitasRede += visitasMes.length;
            totalPontosRede += somaPontos;
            lojasComVisita++;
        } else {
            dadosLojas.push({
                nome: loja,
                index: index,
                visitas: 0,
                media: 0,
                encarregado: 'N/A',
                gerente: 'N/A',
                ultimaVisita: 'Sem visitas',
                historicoCompleto: []
            });
        }
    });
    
    // Ordena lojas por mÃ©dia (ranking)
    const ranking = [...dadosLojas].filter(l => l.visitas > 0).sort((a,b) => b.media - a.media);
    
    const mediaGeralRede = lojasComVisita > 0 ? totalPontosRede / totalVisitasRede : 0;
    
    // Classifica lojas por desempenho
    let excelentes = 0, boas = 0, regulares = 0, criticas = 0;
    dadosLojas.forEach(loja => {
        if(loja.media >= 18) excelentes++;
        else if(loja.media >= 14) boas++;
        else if(loja.media >= 10) regulares++;
        else if(loja.visitas > 0) criticas++;
    });
    
    // ============================================
    // MONTA O HTML DO RELATÃ“RIO
    // ============================================
    let html = `
    <!-- SELETOR DE MÃŠS/ANO -->
    <div style="background:#f5f5f5;padding:20px;border-radius:8px;margin-bottom:20px;border:2px solid #000">
        <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:15px">
            <div style="flex:1;min-width:250px">
                <h3 style="margin:0 0 15px 0;color:#000">ğŸ“… Selecione o PerÃ­odo</h3>
                <div style="display:flex;gap:10px">
                    <div style="flex:1">
                        <label style="display:block;margin-bottom:5px;font-weight:600">MÃªs:</label>
                        <select id="seletorMesDiretoria" style="width:100%;padding:10px;border:2px solid #000;border-radius:5px">
                            ${meses.map((m,i) => `<option value="${i}"${i===mesAtual?' selected':''}>${m}</option>`).join('')}
                        </select>
                    </div>
                    <div style="flex:1">
                        <label style="display:block;margin-bottom:5px;font-weight:600">Ano:</label>
                        <input type="number" id="seletorAnoDiretoria" value="${anoAtual}" min="2000" max="2099" 
                               style="width:100%;padding:10px;border:2px solid #000;border-radius:5px;font-size:1em">
                    </div>
                </div>
            </div>
            <div style="display:flex;gap:10px;flex-wrap:wrap">
                <button onclick="atualizarRelatorioDiretoria()" 
                        style="background:#000;color:#fff;border:none;padding:12px 24px;border-radius:5px;cursor:pointer;font-weight:600">
                    ğŸ”„ Atualizar
                </button>
                <button onclick="abrirModalMensagens()" 
                        style="background:#28a745;color:#fff;border:none;padding:12px 24px;border-radius:5px;cursor:pointer;font-weight:600">
                    ğŸ“± Gerar Mensagens
                </button>
                <button onclick="imprimirRelatorioDiretoria()" 
                        style="background:#f00;color:#fff;border:none;padding:12px 24px;border-radius:5px;cursor:pointer;font-weight:600">
                    ğŸ–¨ï¸ Imprimir
                </button>
            </div>
        </div>
    </div>
    
    <div id="conteudoRelatorioImpressao">
    
    <!-- CABEÃ‡ALHO -->
    <div style="text-align:center;margin-bottom:30px;padding:20px;background:#000;color:#fff;border-radius:10px;border:4px solid #f00">
        <h1 style="margin:0;font-size:2.2em;color:#f00">RELATÃ“RIO EXECUTIVO MENSAL</h1>
        <h2 style="margin:10px 0 0 0;font-size:1.4em">SHOEMIX CALÃ‡ADOS</h2>
        <p style="margin:10px 0 0 0;font-size:1.1em">PerÃ­odo: ${nomeMes} ${anoAtual}</p>
        <p style="margin:5px 0 0 0;font-size:0.9em">Gerado em: ${new Date().toLocaleString('pt-BR')}</p>
    </div>
    
    <!-- DASHBOARD DE INDICADORES -->
    <div class="secao-relatorio">
        <h3>ğŸ“Š INDICADORES GERAIS DA REDE</h3>
        <div class="dashboard-grid">
            <div class="dashboard-card">
                <div class="label">Total de Visitas</div>
                <div class="numero">${totalVisitasRede}</div>
            </div>
            <div class="dashboard-card">
                <div class="label">Lojas Auditadas</div>
                <div class="numero">${lojasComVisita}</div>
                <div style="font-size:0.9em;color:#666;margin-top:5px">de ${lojas.length} lojas</div>
            </div>
            <div class="dashboard-card">
                <div class="label">MÃ©dia Geral</div>
                <div class="numero">${mediaGeralRede.toFixed(1)}</div>
                <div style="font-size:0.9em;color:#666;margin-top:5px">de 21 pontos</div>
            </div>
            <div class="dashboard-card">
                <div class="label">Ãndice de Conformidade</div>
                <div class="numero">${((mediaGeralRede/21)*100).toFixed(0)}%</div>
            </div>
        </div>
    </div>
    
    <!-- DISTRIBUIÃ‡ÃƒO DE PERFORMANCE -->
    <div class="secao-relatorio">
        <h3>ğŸ¯ DISTRIBUIÃ‡ÃƒO DE PERFORMANCE</h3>
        <div class="dashboard-grid">
            <div class="dashboard-card" style="border-color:#28a745;background:#d4edda">
                <div class="label">ğŸŸ¢ Excelente</div>
                <div class="numero" style="color:#28a745">${excelentes}</div>
                <div style="font-size:0.9em;color:#666">18-21 pontos</div>
            </div>
            <div class="dashboard-card" style="border-color:#17a2b8;background:#d1ecf1">
                <div class="label">ğŸ”µ Bom</div>
                <div class="numero" style="color:#17a2b8">${boas}</div>
                <div style="font-size:0.9em;color:#666">14-17 pontos</div>
            </div>
            <div class="dashboard-card" style="border-color:#ffc107;background:#fff3cd">
                <div class="label">ğŸŸ¡ Regular</div>
                <div class="numero" style="color:#856404">${regulares}</div>
                <div style="font-size:0.9em;color:#666">10-13 pontos</div>
            </div>
            <div class="dashboard-card" style="border-color:#dc3545;background:#f8d7da">
                <div class="label">ğŸ”´ CrÃ­tico</div>
                <div class="numero" style="color:#dc3545">${criticas}</div>
                <div style="font-size:0.9em;color:#666">0-9 pontos</div>
            </div>
        </div>
    </div>
    
    <!-- RANKING DAS LOJAS -->
    <div class="secao-relatorio">
        <h3>ğŸ† RANKING DE PERFORMANCE</h3>
        <table class="ranking-table">
            <thead>
                <tr>
                    <th style="width:60px">Pos.</th>
                    <th>Loja</th>
                    <th>Encarregado</th>
                    <th>Visitas</th>
                    <th>MÃ©dia</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>`;
    
    // ğŸ†• Calcula posiÃ§Ãµes SEQUENCIAIS com empates (1Âº,1Âº,1Âº â†’ 2Âº,2Âº â†’ 3Âº)
    let posicaoAtual = 1;
    let mediaAnterior = null;
    
    ranking.forEach((loja, idx) => {
        // Se a mÃ©dia mudou, incrementa apenas 1 posiÃ§Ã£o (nÃ£o pula empates)
        if (mediaAnterior !== null && loja.media < mediaAnterior) {
            posicaoAtual++;
        }
        
        mediaAnterior = loja.media;
        
        let corStatus = '#dc3545';
        let textoStatus = 'CrÃ­tico';
        let emoji = 'ğŸ”´';
        
        if(loja.media >= 18) {
            corStatus = '#28a745';
            textoStatus = 'Excelente';
            emoji = 'ğŸŸ¢';
        } else if(loja.media >= 14) {
            corStatus = '#17a2b8';
            textoStatus = 'Bom';
            emoji = 'ğŸ”µ';
        } else if(loja.media >= 10) {
            corStatus = '#ffc107';
            textoStatus = 'Regular';
            emoji = 'ğŸŸ¡';
        }
        
        let posClass = '';
        if(posicaoAtual === 1) posClass = 'pos-1';
        else if(posicaoAtual === 2) posClass = 'pos-2';
        else if(posicaoAtual === 3) posClass = 'pos-3';
        
        html += `
            <tr>
                <td><span class="ranking-position ${posClass}">${posicaoAtual}Âº</span></td>
                <td style="text-align:left;font-weight:600">${loja.nome}</td>
                <td style="text-align:left">${loja.encarregado}</td>
                <td>${loja.visitas}</td>
                <td style="font-weight:700;font-size:1.2em;color:${corStatus}">${loja.media.toFixed(1)}</td>
                <td><span style="background:${corStatus};color:#fff;padding:5px 10px;border-radius:5px;font-weight:600">${emoji} ${textoStatus}</span></td>
            </tr>
        `;
    });
    
    html += `
            </tbody>
        </table>
    </div>
    
    <!-- GRÃFICO DE PERFORMANCE POR LOJA -->
    <div class="secao-relatorio">
        <h3>ğŸ“ˆ PERFORMANCE DETALHADA POR LOJA</h3>
        <div class="grafico-barras">`;
    
    dadosLojas.forEach(loja => {
        if(loja.visitas === 0) return;
        
        const percentual = (loja.media / 21) * 100;
        let corBarra = 'barra-insatisfatorio';
        
        if(loja.media >= 18) corBarra = 'barra-excelente';
        else if(loja.media >= 14) corBarra = 'barra-bom';
        else if(loja.media >= 10) corBarra = 'barra-regular';
        
        html += `
            <div class="barra-container">
                <div class="barra-label">
                    <span><strong>${loja.nome}</strong> - ${loja.encarregado}</span>
                    <span><strong>${loja.media.toFixed(1)}</strong>/21 pts (${loja.visitas} visita${loja.visitas>1?'s':''})</span>
                </div>
                <div class="barra">
                    <div class="barra-preenchimento ${corBarra}" style="width:${percentual}%">
                        ${percentual.toFixed(0)}%
                    </div>
                </div>
            </div>
        `;
    });
    
    html += `
        </div>
    </div>
    
    <!-- ANÃLISE DETALHADA POR LOJA -->
    <div class="secao-relatorio">
        <h3>ğŸ“‹ ANÃLISE DETALHADA - TODAS AS LOJAS</h3>
    `;
    
    dadosLojas.forEach(loja => {
        let corCard = '#f5f5f5';
        let corBorda = '#ddd';
        let emoji = 'âšª';
        let status = 'Sem dados';
        
        if(loja.visitas > 0) {
            if(loja.media >= 18) {
                corCard = '#d4edda';
                corBorda = '#28a745';
                emoji = 'ğŸŸ¢';
                status = 'EXCELENTE';
            } else if(loja.media >= 14) {
                corCard = '#d1ecf1';
                corBorda = '#17a2b8';
                emoji = 'ğŸ”µ';
                status = 'BOM';
            } else if(loja.media >= 10) {
                corCard = '#fff3cd';
                corBorda = '#ffc107';
                emoji = 'ğŸŸ¡';
                status = 'REGULAR';
            } else {
                corCard = '#f8d7da';
                corBorda = '#dc3545';
                emoji = 'ğŸ”´';
                status = 'CRÃTICO';
            }
        }
        
        html += `
        <div style="border:2px solid ${corBorda};border-radius:10px;padding:20px;margin-bottom:20px;background:${corCard};page-break-inside:avoid">
            <h4 style="margin:0 0 15px 0;font-size:1.3em">${emoji} ${loja.nome} - ${status}</h4>
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;margin-bottom:15px">
                <div>
                    <strong>ğŸ‘¤ Encarregado:</strong><br>${loja.encarregado}
                </div>
                <div>
                    <strong>ğŸ‘” Gerente:</strong><br>${loja.gerente}
                </div>
                <div>
                    <strong>ğŸ“… Ãšltima Visita:</strong><br>${loja.ultimaVisita}
                </div>
                <div>
                    <strong>ğŸ“Š Total de Visitas:</strong><br>${loja.visitas}
                </div>
                <div>
                    <strong>â­ MÃ©dia de Pontos:</strong><br><span style="font-size:1.5em;font-weight:700;color:${corBorda}">${loja.media.toFixed(1)}</span>/21
                </div>
                <div>
                    <strong>ğŸ“ˆ Taxa de Conformidade:</strong><br><span style="font-size:1.5em;font-weight:700">${((loja.media/21)*100).toFixed(0)}%</span>
                </div>
            </div>
        `;
        
        if(loja.visitas === 0) {
            html += `
                <div class="alerta-box alerta-vermelho">
                    <strong>âš ï¸ ALERTA: Loja sem visitas no perÃ­odo</strong><br>
                    Esta loja nÃ£o recebeu nenhuma auditoria durante o mÃªs. Ã‰ necessÃ¡rio realizar visita imediatamente.
                </div>
            `;
        } else if(loja.media < 10) {
            html += `
                <div class="alerta-box alerta-vermelho">
                    <strong>ğŸš¨ SITUAÃ‡ÃƒO CRÃTICA - AÃ‡ÃƒO IMEDIATA NECESSÃRIA</strong><br>
                    Performance abaixo do mÃ­nimo aceitÃ¡vel. Requer intervenÃ§Ã£o urgente da gestÃ£o.
                </div>
            `;
        } else if(loja.media < 14) {
            html += `
                <div class="alerta-box alerta-amarelo">
                    <strong>âš ï¸ ATENÃ‡ÃƒO - NECESSITA MELHORIA</strong><br>
                    Performance regular. Recomenda-se plano de aÃ§Ã£o para otimizaÃ§Ã£o dos processos.
                </div>
            `;
        }
        
        // HistÃ³rico de visitas da loja
        if(loja.historicoCompleto.length > 0) {
            html += `
            <div style="margin-top:15px">
                <strong>ğŸ“… HistÃ³rico de Visitas no PerÃ­odo:</strong>
                <table style="width:100%;margin-top:10px;font-size:0.9em">
                    <thead>
                        <tr>
                            <th>Data</th>
                            <th>PontuaÃ§Ã£o</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            loja.historicoCompleto.forEach(visita => {
                const pontos = calculaTotalPontos(visita.dados);
                const statusVisita = getStatus(pontos);
                html += `
                    <tr>
                        <td>${visita.data}</td>
                        <td style="font-weight:700">${pontos}/21</td>
                        <td>${statusVisita}</td>
                    </tr>
                `;
            });
            
            html += `
                    </tbody>
                </table>
            </div>
            `;
        }
        
        html += `</div>`;
    });
    
    html += `
    </div>
    
    <!-- CONCLUSÃ•ES E RECOMENDAÃ‡Ã•ES -->
    <div class="secao-relatorio">
        <h3>ğŸ’¡ CONCLUSÃ•ES E RECOMENDAÃ‡Ã•ES ESTRATÃ‰GICAS</h3>
        <div style="background:#f9f9f9;padding:20px;border-radius:8px;line-height:1.8">
    `;
    
    // AnÃ¡lise automÃ¡tica
    if(mediaGeralRede >= 18) {
        html += `
            <p><strong>âœ… EXCELENTE PERFORMANCE GERAL DA REDE</strong></p>
            <p>A rede apresenta desempenho excepcional com mÃ©dia de <strong>${mediaGeralRede.toFixed(1)} pontos</strong>. 
            Os processos operacionais estÃ£o consolidados e atingindo alto padrÃ£o de qualidade.</p>
        `;
    } else if(mediaGeralRede >= 14) {
        html += `
            <p><strong>ğŸ‘ BOA PERFORMANCE GERAL DA REDE</strong></p>
            <p>A rede apresenta desempenho satisfatÃ³rio com mÃ©dia de <strong>${mediaGeralRede.toFixed(1)} pontos</strong>. 
            HÃ¡ espaÃ§o para melhorias pontuais que podem elevar a performance para excelÃªncia.</p>
        `;
    } else if(mediaGeralRede >= 10) {
        html += `
            <p><strong>âš ï¸ PERFORMANCE REGULAR - REQUER ATENÃ‡ÃƒO</strong></p>
            <p>A rede apresenta mÃ©dia de <strong>${mediaGeralRede.toFixed(1)} pontos</strong>, indicando necessidade de 
            intervenÃ§Ã£o em processos-chave. Recomenda-se implementaÃ§Ã£o de planos de aÃ§Ã£o corretivos.</p>
        `;
    } else {
        html += `
            <p><strong>ğŸš¨ SITUAÃ‡ÃƒO CRÃTICA - INTERVENÃ‡ÃƒO URGENTE</strong></p>
            <p>A rede apresenta mÃ©dia de <strong>${mediaGeralRede.toFixed(1)} pontos</strong>, abaixo do mÃ­nimo aceitÃ¡vel. 
            Ã‰ necessÃ¡ria intervenÃ§Ã£o imediata com plano de recuperaÃ§Ã£o emergencial.</p>
        `;
    }
    
    html += `
            <p><strong>ğŸ“Š Destaques do PerÃ­odo:</strong></p>
            <ul>
                <li><strong>${excelentes}</strong> loja(s) com performance EXCELENTE (â‰¥18 pts)</li>
                <li><strong>${boas}</strong> loja(s) com performance BOA (14-17 pts)</li>
                <li><strong>${regulares}</strong> loja(s) com performance REGULAR (10-13 pts)</li>
                <li><strong>${criticas}</strong> loja(s) em situaÃ§Ã£o CRÃTICA (<10 pts)</li>
                <li><strong>${lojas.length - lojasComVisita}</strong> loja(s) SEM VISITA no perÃ­odo</li>
            </ul>
            
            <p><strong>ğŸ¯ RecomendaÃ§Ãµes EstratÃ©gicas:</strong></p>
            <ol>
    `;
    
    if(criticas > 0) {
        html += `<li><strong>PRIORIDADE MÃXIMA:</strong> IntervenÃ§Ã£o imediata nas ${criticas} loja(s) em situaÃ§Ã£o crÃ­tica com plano de aÃ§Ã£o emergencial e acompanhamento diÃ¡rio.</li>`;
    }
    
    if(lojas.length - lojasComVisita > 0) {
        html += `<li><strong>URGENTE:</strong> Realizar auditoria nas ${lojas.length - lojasComVisita} loja(s) sem visita no perÃ­odo.</li>`;
    }
    
    if(regulares > 0) {
        html += `<li>Desenvolver plano de melhoria para as ${regulares} loja(s) com performance regular, focando em treinamento e padronizaÃ§Ã£o.</li>`;
    }
    
    if(excelentes > 0) {
        html += `<li>Documentar e replicar as melhores prÃ¡ticas das ${excelentes} loja(s) com performance excelente para toda a rede.</li>`;
    }
    
    html += `
                <li>Manter frequÃªncia de auditorias mensais para monitoramento contÃ­nuo.</li>
                <li>Implementar sistema de reconhecimento para lojas de alta performance.</li>
                <li>Revisar processos crÃ­ticos identificados nas auditorias e atualizar procedimentos operacionais.</li>
            </ol>
            
            <p style="margin-top:20px;padding:15px;background:#fff;border-left:4px solid #f00">
                <strong>ğŸ“Œ PRÃ“XIMOS PASSOS:</strong><br>
                â€¢ ReuniÃ£o gerencial para anÃ¡lise detalhada atÃ©: ${new Date(new Date().setDate(new Date().getDate() + 7)).toLocaleDateString('pt-BR')}<br>
                â€¢ ImplementaÃ§Ã£o de planos de aÃ§Ã£o: ${new Date(new Date().setDate(new Date().getDate() + 15)).toLocaleDateString('pt-BR')}<br>
                â€¢ PrÃ³xima rodada de auditorias: ${getNomeMes((mesAtual+1)%12)} ${mesAtual===11?anoAtual+1:anoAtual}
            </p>
        </div>
    </div>
    
    </div>
    
    <!-- RODAPÃ‰ -->
    <div style="margin-top:30px;padding:20px;background:#f5f5f5;border-radius:8px;text-align:center;font-size:0.9em;color:#666">
        <strong>Sistema de GestÃ£o de Qualidade - Shoemix CalÃ§ados</strong><br>
        RelatÃ³rio gerado automaticamente em ${new Date().toLocaleString('pt-BR')}<br>
        Documento confidencial - Uso exclusivo da Diretoria
    </div>
    `;
    
    document.getElementById('conteudoRelatorioDiretoria').innerHTML = html;
}

function atualizarRelatorioDiretoria() {
    const mes = parseInt(document.getElementById('seletorMesDiretoria').value);
    const ano = parseInt(document.getElementById('seletorAnoDiretoria').value);
    gerarRelatorioDiretoria(mes, ano);
    
    // ğŸ†• Atualiza tambÃ©m o ranking dinÃ¢mico
    setTimeout(async () => {
        const rankingAntigo = document.getElementById('rankingDinamico');
        if (rankingAntigo) {
            const novoRanking = await criarRankingLojas(mes, ano);
            novoRanking.id = 'rankingDinamico';
            rankingAntigo.parentNode.replaceChild(novoRanking, rankingAntigo);
            console.log(`âœ… Ranking atualizado para ${mes+1}/${ano}`);
        }
    }, 500);
}

function imprimirRelatorioDiretoria() {
    const conteudo = document.getElementById('conteudoRelatorioImpressao').innerHTML;
    const mes = parseInt(document.getElementById('seletorMesDiretoria').value);
    const ano = parseInt(document.getElementById('seletorAnoDiretoria').value);
    const nomeMes = getNomeMes(mes);
    
    const w = window.open('', '_blank');
    w.document.write(`
    <!DOCTYPE html>
    <html>
    <head>
        <meta charset="UTF-8">
        <title>RelatÃ³rio Executivo ${nomeMes} ${ano}</title>
        <style>
            @page { size: A4; margin: 15mm; }
            * { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            body { font-family: Arial, sans-serif; margin: 0; padding: 20px; font-size: 11pt; line-height: 1.5; }
            h1, h2, h3 { color: #000; page-break-after: avoid; }
            table { width: 100%; border-collapse: collapse; margin: 15px 0; page-break-inside: avoid; }
            th, td { padding: 8px; border: 1px solid #ddd; text-align: left; }
            th { background: #f00; color: #fff; font-weight: 600; }
            .dashboard-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin: 15px 0; }
            .dashboard-card { border: 2px solid #ddd; border-radius: 8px; padding: 15px; text-align: center; page-break-inside: avoid; }
            .numero { font-size: 2em; font-weight: 700; color: #f00; }
            .secao-relatorio { margin: 20px 0; page-break-inside: avoid; }
            .barra { height: 25px; background: #e0e0e0; border-radius: 5px; margin: 10px 0; }
            .barra-preenchimento { height: 100%; color: #fff; font-weight: 700; padding: 0 10px; display: flex; align-items: center; justify-content: flex-end; }
            .barra-excelente { background: #28a745; }
            .barra-bom { background: #17a2b8; }
            .barra-regular { background: #ffc107; }
            .barra-insatisfatorio { background: #dc3545; }
            .alerta-box { padding: 12px; border-radius: 6px; margin: 10px 0; font-weight: 600; }
            .alerta-amarelo { background: #fff3cd; border: 2px solid #ffc107; }
            .alerta-vermelho { background: #f8d7da; border: 2px solid #dc3545; }
        </style>
    <scr`+`ipt src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></scr`+`ipt>
</head>
    <body>
        ${conteudo}
    </body>
    </html>
    `);
    w.document.close();
    w.focus();
    setTimeout(() => w.print(), 500);
}
function abrirDebug(){gerarDebug();document.getElementById('modalDebug').style.display='flex'}
function fecharDebug(){document.getElementById('modalDebug').style.display='none'}
function getNomeMes(m){return['Janeiro','Fevereiro','MarÃ§o','Abril','Maio','Junho','Julho','Agosto','Setembro','Outubro','Novembro','Dezembro'][m]}
function gerarSeletorMesAno(mesInicial,anoInicial){const meses=['Janeiro','Fevereiro','MarÃ§o','Abril','Maio','Junho','Julho','Agosto','Setembro','Outubro','Novembro','Dezembro'];let html=`<div style="background:#fff;padding:20px;border-radius:8px;margin-bottom:20px;border:2px solid #f00"><div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:15px"><div style="flex:1;min-width:250px"><h3 style="margin:0 0 15px 0;color:#f00">ğŸ“… Selecione o PerÃ­odo</h3><div style="display:flex;gap:10px"><div style="flex:1"><label style="display:block;margin-bottom:5px;font-weight:600">MÃªs:</label><select id="seletorMes" style="width:100%;padding:10px;border:2px solid #f00;border-radius:5px">${meses.map((m,i)=>`<option value="${i}"${i===mesInicial?' selected':''}>${m}</option>`).join('')}</select></div><div style="flex:1"><label style="display:block;margin-bottom:5px;font-weight:600">Ano:</label><input type="number" id="seletorAno" value="${anoInicial}" min="2000" max="2099" style="width:100%;padding:10px;border:2px solid #f00;border-radius:5px;font-size:1em"></div></div></div><div style="display:flex;gap:10px"><button onclick="atualizarBonificacao()" style="background:#f00;color:#fff;border:none;padding:12px 24px;border-radius:5px;cursor:pointer;font-weight:600">ğŸ”„ Atualizar</button><button onclick="imprimirBonificacao()" style="background:#28a745;color:#fff;border:none;padding:12px 24px;border-radius:5px;cursor:pointer;font-weight:600">ğŸ–¨ï¸ Imprimir</button></div></div></div><div id="resultadoBonificacao"></div>`;document.getElementById('conteudoBonificacao').innerHTML=html;calcularBonificacaoMensal(mesInicial,anoInicial)}
function atualizarBonificacao(){calcularBonificacaoMensal(parseInt(document.getElementById('seletorMes').value),parseInt(document.getElementById('seletorAno').value))}
function imprimirBonificacao(){const c=document.getElementById('resultadoBonificacao').innerHTML,mes=parseInt(document.getElementById('seletorMes').value),ano=parseInt(document.getElementById('seletorAno').value),nomeMes=getNomeMes(mes),w=window.open('','_blank');w.document.write(`<!DOCTYPE html><html><head><meta charset="UTF-8"><title>BonificaÃ§Ã£o ${nomeMes} ${ano}</title><style>@page{size:A4;margin:15mm}*{-webkit-print-color-adjust:exact}body{font-family:Arial;margin:0;padding:20px;font-size:11pt}.card-bonificacao{page-break-inside:avoid;margin-bottom:15px}table{width:100%;border-collapse:collapse}th,td{padding:8px;border:1px solid #ddd}th{background:#f00;color:#fff}</style><scr`+`ipt src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></scr`+`ipt>
</head><body><div style="text-align:center;margin-bottom:20px;border-bottom:3px solid #f00;padding-bottom:15px"><h1 style="color:#f00;margin:0">ğŸ’° BONIFICAÃ‡ÃƒO MENSAL - SHOEMIX</h1><h2 style="margin:5px 0">PerÃ­odo: ${nomeMes} ${ano}</h2></div>${c}</body></html>`);w.document.close();w.focus();setTimeout(()=>w.print(),500)}
function calcularBonificacaoMensal(mesAtual,anoAtual){let html='<h3 style="border-bottom:2px solid #f00;padding-bottom:10px">ğŸ“Š AnÃ¡lise por Loja</h3>';lojas.forEach((loja,index)=>{const hist=JSON.parse(localStorage.getItem("hist_"+index)||"[]"),visitasMes=hist.filter(v=>{let d;if(typeof v.data==='string'&&v.data.includes('/')){const p=v.data.split(' ')[0].split('/');if(p.length===3)d=new Date(parseInt(p[2]),parseInt(p[1])-1,parseInt(p[0]))}else d=new Date(v.data);return d&&!isNaN(d.getTime())&&d.getMonth()===mesAtual&&d.getFullYear()===anoAtual});   if(visitasMes.length===0){html+=`<div class="card-bonificacao" style="border-color:#999;background:#f5f5f5"><h4 style="margin:0 0 10px 0;color:#666">ğŸª ${loja}</h4><p style="margin:0;color:#666">âŒ Nenhuma visita registrada neste mÃªs</p></div>`;return}const ultimaVisita=visitasMes[visitasMes.length-1];const nomeEncarregado=ultimaVisita.dados.encarregado||'NÃ£o informado';let soma=0;visitasMes.forEach(v=>soma+=calculaTotalPontos(v.dados));const media=soma/visitasMes.length,mediaArr=Math.round(media*10)/10;let classe,bonus,corClasse,emoji,alertas;if(media>=18){classe="EXCELENTE";bonus=300;corClasse="excelente";emoji="ğŸŸ¢ ğŸ‰";alertas='<div style="background:#d4edda;padding:15px;border-radius:8px;margin-top:15px;border:2px solid #28a745"><strong style="color:#155724">âœ… ParabÃ©ns! Performance Excelente!</strong></div>'}else if(media>=14){classe="BOM";bonus=150;corClasse="bom";emoji="ğŸ”µ ğŸ‘";alertas='<div style="background:#d1ecf1;padding:15px;border-radius:8px;margin-top:15px;border:2px solid #17a2b8"><strong style="color:#0c5460">ğŸ‘ Bom desempenho!</strong></div>'}else if(media>=10){classe="REGULAR";bonus=0;corClasse="regular";emoji="ğŸŸ¡ âš ï¸";alertas='<div class="alerta-box alerta-amarelo"><strong>âš ï¸ ALERTA AMARELO - Performance Regular</strong><br>âš ï¸ AtenÃ§Ã£o necessÃ¡ria!</div>'}else{classe="INSATISFATÃ“RIO";bonus=0;corClasse="insatisfatorio";emoji="ğŸ”´ ğŸš¨";alertas='<div class="alerta-box alerta-vermelho"><strong>ğŸš¨ ALERTA CRÃTICO - Performance InsatisfatÃ³ria</strong><br>ğŸš¨ AÃ‡ÃƒO URGENTE NECESSÃRIA!</div>'}   html+=`<div class="card-bonificacao ${corClasse}"><h4 style="margin:0 0 5px 0">${emoji} ${loja}</h4><p style="margin:0 0 15px 0;font-size:0.9em;color:#666"><strong>ğŸ‘¤ Encarregado:</strong> ${nomeEncarregado}</p><div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:15px;margin-bottom:15px"><div style="text-align:center"><div style="font-size:0.9em;color:#666">Visitas</div><div style="font-size:2em;font-weight:700">${visitasMes.length}</div></div><div style="text-align:center"><div style="font-size:0.9em;color:#666">MÃ©dia</div><div style="font-size:2em;font-weight:700;color:#f00">${mediaArr}</div></div><div style="text-align:center"><div style="font-size:0.9em;color:#666">ClassificaÃ§Ã£o</div><div style="font-size:1.3em;font-weight:700">${classe}</div></div><div style="text-align:center"><div style="font-size:0.9em;color:#666">BonificaÃ§Ã£o</div><div class="valor-bonus" style="font-size:1.8em">R$ ${bonus.toFixed(2)}</div></div></div>${alertas}</div>`});let totalBonus=0,totalVisitas=0,excelentes=0,bons=0,regulares=0,insatisfatorios=0;lojas.forEach((loja,idx)=>{const hist=JSON.parse(localStorage.getItem("hist_"+idx)||"[]"),visitasMes=hist.filter(v=>{let d;if(typeof v.data==='string'&&v.data.includes('/')){const p=v.data.split(' ')[0].split('/');if(p.length===3)d=new Date(parseInt(p[2]),parseInt(p[1])-1,parseInt(p[0]))}else d=new Date(v.data);return d&&!isNaN(d.getTime())&&d.getMonth()===mesAtual&&d.getFullYear()===anoAtual});if(visitasMes.length>0){totalVisitas+=visitasMes.length;let s=0;visitasMes.forEach(v=>s+=calculaTotalPontos(v.dados));const m=s/visitasMes.length;if(m>=18){totalBonus+=300;excelentes++}else if(m>=14){totalBonus+=150;bons++}else if(m>=10)regulares++;else insatisfatorios++}});html+=`<div style="background:#000;color:#fff;padding:25px;border-radius:10px;margin-top:30px"><h3 style="color:#f00;text-align:center;font-size:1.6em;margin:0 0 20px 0">ğŸ’¼ RESUMO CONSOLIDADO</h3><div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px"><div style="text-align:center;padding:15px;background:rgba(255,255,255,0.1);border-radius:8px"><div style="font-size:0.9em">Total de Visitas</div><div style="font-size:2.5em;font-weight:700;color:#f00">${totalVisitas}</div></div><div style="text-align:center;padding:15px;background:rgba(255,255,255,0.1);border-radius:8px"><div style="font-size:0.9em">BonificaÃ§Ã£o Total</div><div style="font-size:2.5em;font-weight:700;color:#28a745">R$ ${totalBonus.toFixed(2)}</div></div></div><div style="margin-top:20px;padding:20px;background:rgba(255,255,255,0.05);border-radius:8px"><h4 style="margin:0 0 15px 0;color:#f00">ğŸ“Š DistribuiÃ§Ã£o:</h4><div style="display:grid;gap:10px"><div style="display:flex;justify-content:space-between;padding:8px;background:rgba(40,167,69,0.2);border-radius:5px"><span>ğŸŸ¢ Excelente</span><strong>${excelentes} loja(s)</strong></div><div style="display:flex;justify-content:space-between;padding:8px;background:rgba(23,162,184,0.2);border-radius:5px"><span>ğŸ”µ Bom</span><strong>${bons} loja(s)</strong></div><div style="display:flex;justify-content:space-between;padding:8px;background:rgba(255,193,7,0.2);border-radius:5px"><span>ğŸŸ¡ Regular</span><strong>${regulares} loja(s)</strong></div><div style="display:flex;justify-content:space-between;padding:8px;background:rgba(220,53,69,0.2);border-radius:5px"><span>ğŸ”´ InsatisfatÃ³rio</span><strong>${insatisfatorios} loja(s)</strong></div></div></div></div>`;document.getElementById('resultadoBonificacao').innerHTML=html}
function gerarDebug(){const hoje=new Date(),mesAtual=hoje.getMonth(),anoAtual=hoje.getFullYear();let html=`<div style="background:#f8f9fa;padding:15px;border-radius:8px"><h4 style="margin:0 0 10px 0;color:#6c757d">ğŸ“… InformaÃ§Ãµes do Sistema</h4><div style="font-family:monospace;font-size:0.9em"><strong>Data/Hora:</strong> ${hoje.toLocaleString('pt-BR')}<br><strong>MÃªs:</strong> ${getNomeMes(mesAtual)}<br><strong>Ano:</strong> ${anoAtual}<br><strong>Loja:</strong> ${lojas[lojaAtual]}</div></div><h3 style="border-bottom:2px solid #6c757d;padding-bottom:10px;color:#6c757d">ğŸª AnÃ¡lise Detalhada</h3>`;lojas.forEach((loja,index)=>{const hist=JSON.parse(localStorage.getItem("hist_"+index)||"[]");html+=`<div class="card-bonificacao" style="border-color:#6c757d;background:#f8f9fa"><h4 style="margin:0 0 15px 0;color:#6c757d">ğŸª ${loja}</h4><div style="font-family:monospace;font-size:0.85em;background:#fff;padding:15px;border-radius:5px"><strong>Total de Visitas:</strong> ${hist.length}`;if(hist.length===0)html+='<br><span style="color:#dc3545">âŒ Nenhuma visita</span>';else{const visitasMes=hist.filter(v=>{let d;if(typeof v.data==='string'&&v.data.includes('/')){const p=v.data.split(' ')[0].split('/');if(p.length===3)d=new Date(parseInt(p[2]),parseInt(p[1])-1,parseInt(p[0]))}else d=new Date(v.data);return d&&!isNaN(d.getTime())&&d.getMonth()===mesAtual&&d.getFullYear()===anoAtual});html+=`<br><strong>Visitas em ${getNomeMes(mesAtual)}/${anoAtual}:</strong> ${visitasMes.length}`;if(visitasMes.length>0){let s=0;visitasMes.forEach(v=>s+=calculaTotalPontos(v.dados));html+=`<br><strong>MÃ©dia:</strong> ${(s/visitasMes.length).toFixed(1)} pontos`}}html+='</div></div>'});document.getElementById('conteudoDebug').innerHTML=html}
function novaVisita(){
    if(!confirm("Iniciar nova visita? Dados nÃ£o salvos serÃ£o perdidos.")) return;
    
    visitaEmEdicao=null;
    document.getElementById("btnCancelarEdicao").style.display="none";
    document.getElementById("btnNovaVisita").style.background="#f00";
    
    // ğŸ†• Gera visitaId temporÃ¡rio para esta nova visita
    window.visitaIdTemporario = 'visita_' + lojaAtual + '_' + Date.now();
    console.log('ğŸ†• Nova visita iniciada com ID:', window.visitaIdTemporario);
    
    // Limpa todos os campos
    document.querySelectorAll("input,textarea,select").forEach(el=>{
        if(el.type==="radio") el.checked=false;
        else if(!el.classList.contains('pts')) el.value="";
    });
    
    // Limpa fotos
    document.querySelectorAll('.fotos-preview').forEach(p=>p.innerHTML='');
    
    // Remove cores das perguntas
    document.querySelectorAll('.pergunta').forEach(p=>{
        p.classList.remove('resposta-boa','resposta-ruim','resposta-neutra');
    });
    
    // Limpa localStorage da loja atual (rascunho)
    localStorage.removeItem("shoemix_"+lojaAtual);
    
    calcular();
    calcularPontuacaoSecao();
    
    alert("âœ… Nova visita iniciada! Preencha os campos e adicione fotos.\n\nğŸ’¡ Clique em ğŸ’¾ SALVAR quando terminar para adicionar ao histÃ³rico.");
}
async function salvar(aviso=false){
    // âœ… VERIFICAÃ‡ÃƒO DE ESPAÃ‡O ANTES DE SALVAR
    if (aviso && !verificarEspacoLocalStorage()) {
        const limpar = confirm(
            'âš ï¸ ARMAZENAMENTO QUASE CHEIO!\n\n' +
            'O histÃ³rico estÃ¡ prÃ³ximo do limite.\n\n' +
            'ğŸ’¡ Deseja remover visitas antigas (>90 dias) para liberar espaÃ§o?'
        );
        
        if (limpar) {
            const removidos = limparHistoricoAntigo(90);
            if (removidos > 0) {
                alert(`âœ… ${removidos} visitas antigas removidas!\n\nAgora vocÃª pode salvar.`);
            } else {
                alert('âš ï¸ NÃ£o hÃ¡ visitas antigas suficientes para remover.\n\nTente fazer backup e limpar manualmente.');
                return;
            }
        } else {
            return;
        }
    }
    
    const dados={};
    
    // Captura todos os campos de texto
    document.querySelectorAll("input[type=text],input[type=number],textarea,select").forEach(el=>{
        if(el.id && !el.classList.contains('pts'))
            dados[el.id]=el.value;
    });
    
    // Captura radios selecionados
    document.querySelectorAll("input[type=radio]:checked").forEach(r=>dados[r.name]=r.value);
    
    // Captura pontuaÃ§Ãµes e fotos de cada seÃ§Ã£o
    document.querySelectorAll(".section").forEach(sec=>{
        const secId=sec.getAttribute("data-secao");
        
        // Captura pontuaÃ§Ã£o
        const pts=sec.querySelector(".pts");
        if(pts && secId)
            dados["pts"+secId]=Number(pts.value||0);
        
        // âŒ REMOVIDO: NÃ£o captura mais fotos como Base64
        // As fotos agora ficam no IndexedDB
    });
    
    // Tenta salvar no localStorage com tratamento de erro
    try {
        localStorage.setItem("shoemix_"+lojaAtual, JSON.stringify(dados));
        console.log('âœ… Rascunho salvo no localStorage');
    } catch(e) {
        console.error('âŒ Erro ao salvar:', e);
        if(e.name === 'QuotaExceededError') {
            // Verifica se tem sincronizaÃ§Ã£o ativa
            const temSincronizacao = CONFIG_SYNC && CONFIG_SYNC.metodo;
            if (temSincronizacao) {
                // Com sincronizaÃ§Ã£o, tenta limpar rascunhos antigos e continua
                console.log('âš ï¸ localStorage cheio, mas sincronizaÃ§Ã£o estÃ¡ ativa - limpando rascunhos antigos');
                try {
                    // Remove rascunhos antigos de outras lojas para liberar espaÃ§o
                    lojas.forEach((l, idx) => {
                        if(idx !== lojaAtual) {
                            localStorage.removeItem("shoemix_"+idx);
                        }
                    });
                    // Tenta salvar novamente
                    localStorage.setItem("shoemix_"+lojaAtual, JSON.stringify(dados));
                    console.log('âœ… EspaÃ§o liberado e rascunho salvo');
                } catch(e2) {
                    // Se ainda assim falhar, apenas continua (os dados irÃ£o para o servidor)
                    console.log('âš ï¸ NÃ£o foi possÃ­vel salvar rascunho, mas dados serÃ£o salvos no servidor');
                }
            } else {
                // Sem sincronizaÃ§Ã£o, mostra erro
                alert('âš ï¸ ERRO: O armazenamento estÃ¡ cheio.\n\nğŸ’¡ Dica: Configure a sincronizaÃ§Ã£o em nuvem para ter espaÃ§o ilimitado!');
                return;
            }
        }
    }
    
    // Se for salvamento automÃ¡tico (foto), para aqui
    if(!aviso) {
        console.log('ğŸ’¾ Salvamento automÃ¡tico (rascunho)');
        return;
    }
    
    // VALIDAÃ‡ÃƒO para salvamento manual: precisa ter dados mÃ­nimos
    const temDadosMinimos = dados.data || dados.encarregado || dados.gerente;
    
    if(!temDadosMinimos){
        alert("âš ï¸ Preencha pelo menos a DATA, ENCARREGADO ou GERENTE antes de salvar!");
        return;
    }
    
    // ============================================
    // ğŸ†• NOVO: Salva fotos no IndexedDB ou registra fotos do Drive
    // ============================================
    let visitaId;
    
    try {
        // ğŸ†• Usa visitaId temporÃ¡rio se existir, senÃ£o gera novo
        if (window.visitaIdTemporario) {
            visitaId = window.visitaIdTemporario;
            console.log('ğŸ“ Usando visitaId temporÃ¡rio:', visitaId);
        } else {
            visitaId = 'visita_' + lojaAtual + '_' + Date.now();
            console.log('ğŸ†• Gerando novo visitaId:', visitaId);
        }
        
        dados.visitaId = visitaId; // Guarda no dados
        
        console.log('ğŸ“¸ Iniciando salvamento de fotos...');
        console.log('ğŸ” Status do Google Drive:', {
            CONFIG_DRIVE_existe: !!CONFIG_DRIVE,
            conectado: CONFIG_DRIVE?.conectado,
            clientId: CONFIG_DRIVE?.clientId ? 'Configurado' : 'NÃƒO configurado'
        });
        
        let totalFotosSalvas = 0;
        
        // Percorre cada seÃ§Ã£o e salva as fotos
        for (const secao of document.querySelectorAll('.section')) {
            const secaoId = secao.getAttribute('data-secao');
            if (!secaoId) continue;
            
            const fotosDivs = secao.querySelectorAll('.foto-item');
            
            // ğŸ’¾ SEMPRE salva no IndexedDB primeiro (funciona sem travar!)
            console.log(`ğŸ’¾ SeÃ§Ã£o ${secaoId}: Salvando fotos no IndexedDB`);
            
            for (const fotoDiv of fotosDivs) {
                const fotoId = fotoDiv.getAttribute('data-foto-id');
                const dbId = fotoDiv.getAttribute('data-db-id');
                const driveId = fotoDiv.getAttribute('data-drive-id');
                
                // Se jÃ¡ tem dbId ou driveId, pula (jÃ¡ estÃ¡ salva)
                if (dbId || driveId) {
                    console.log(`   âœ… Foto jÃ¡ salva: ${dbId || driveId}`);
                    totalFotosSalvas++;
                    continue;
                }
                
                // Verifica se tem foto temporÃ¡ria (recÃ©m anexada)
                const blob = window.fotosTemporarias?.[fotoId];
                
                if (blob) {
                    // Salva no IndexedDB
                    const newDbId = await salvarFotoDB(blob, visitaId, secaoId);
                    console.log(`âœ… Foto ${fotoId} â†’ IndexedDB ID: ${newDbId}`);
                    
                    // Marca como salva
                    fotoDiv.setAttribute('data-db-id', newDbId);
                    fotoDiv.removeAttribute('data-foto-id'); // Remove ID temporÃ¡rio
                    
                    // ğŸ†• ATUALIZA BADGE VISUAL
                    const badge = fotoDiv.querySelector('.storage-badge');
                    if (badge) {
                        badge.innerHTML = 'ğŸ’¾ IndexedDB';
                        badge.style.background = 'rgba(33, 150, 243, 0.95)'; // Azul
                    }
                    
                    totalFotosSalvas++;
                }
            }
        }
        
        // Limpa temporÃ¡rios apÃ³s salvar
        window.fotosTemporarias = {};
        
        console.log(`âœ… ${totalFotosSalvas} fotos salvas no IndexedDB para visita ${visitaId}`);
        
        // ğŸ”„ SE DRIVE CONECTADO: Transfere fotos do IndexedDB para Drive
        if (CONFIG_DRIVE && CONFIG_DRIVE.conectado) {
            console.log('â˜ï¸ Drive conectado - iniciando transferÃªncia de fotos...');
            
            // Mostra modal de progresso
            const modalProgresso = mostrarModalTransferencia();
            
            try {
                // â±ï¸ TIMEOUT de 30 segundos para evitar travamento infinito
                const timeoutPromise = new Promise((_, reject) => {
                    setTimeout(() => reject(new Error('Timeout: TransferÃªncia demorou mais de 30 segundos')), 30000);
                });
                
                const transferirPromise = transferirFotosIndexedDBParaDrive(visitaId, modalProgresso);
                
                const resultado = await Promise.race([transferirPromise, timeoutPromise]);
                
                // Remove modal de progresso
                if (modalProgresso && modalProgresso.parentNode) {
                    modalProgresso.remove();
                }
                
                if (resultado.sucesso) {
                    if (resultado.transferidas > 0) {
                        console.log(`âœ… ${resultado.transferidas} fotos transferidas para Drive!`);
                        
                        // ğŸ‰ MODAL DE SUCESSO COM INFORMAÃ‡Ã•ES DETALHADAS
                        mostrarModalSucessoTransferencia(resultado.transferidas, resultado.espacoLiberado);
                    } else {
                        console.log('â„¹ï¸ Nenhuma foto nova para transferir (jÃ¡ estavam no Drive)');
                    }
                    if (resultado.erros > 0) {
                        console.warn(`âš ï¸ ${resultado.erros} foto(s) permaneceram no IndexedDB`);
                        alert(`âš ï¸ ATENÃ‡ÃƒO:\n\n${resultado.erros} foto(s) nÃ£o puderam ser enviadas ao Drive e permaneceram salvas localmente.\n\nAs fotos nÃ£o foram perdidas!`);
                    }
                } else {
                    console.error('âŒ Falha na transferÃªncia:', resultado.motivo);
                    alert(`âš ï¸ NÃ£o foi possÃ­vel transferir fotos para o Drive.\n\nMotivo: ${resultado.motivo}\n\nAs fotos estÃ£o salvas localmente no navegador.`);
                }
                
            } catch (erro) {
                console.error('âŒ Erro ou timeout na transferÃªncia:', erro);
                
                // Remove modal de progresso
                if (modalProgresso && modalProgresso.parentNode) {
                    modalProgresso.remove();
                }
                
                alert(
                    'âš ï¸ A transferÃªncia de fotos demorou demais ou falhou.\n\n' +
                    'As fotos estÃ£o SALVAS LOCALMENTE no IndexedDB.\n\n' +
                    'ğŸ’¡ VocÃª pode:\n' +
                    '1. Tentar sincronizar novamente mais tarde\n' +
                    '2. Verificar sua conexÃ£o com internet\n' +
                    '3. Usar o botÃ£o "ğŸ’¾ Limpar Fotos" quando tiver certeza que foram transferidas'
                );
            }
        } else {
            console.log('ğŸ’¾ Drive nÃ£o conectado - fotos permanecem no IndexedDB');
        }
        
        const metodoSalvamento = (CONFIG_DRIVE && CONFIG_DRIVE.conectado) ? 'Google Drive + IndexedDB' : 'IndexedDB';
        console.log(`âœ… ${totalFotosSalvas} fotos salvas para visita ${visitaId}`);
        console.log(`ğŸ“ MÃ©todo de armazenamento: ${metodoSalvamento}`);
        
    } catch(error) {
        console.error('âŒ Erro ao salvar fotos:', error);
        alert('âš ï¸ Erro ao salvar fotos: ' + error.message);
        return; // NÃ£o continua se falhar
    }
    
    // ============================================
    // Carrega histÃ³rico e salva
    // ============================================
    let hist=JSON.parse(localStorage.getItem("hist_"+lojaAtual)||"[]");
    
    if(visitaEmEdicao!==null){
        // Modo ediÃ§Ã£o - atualiza visita existente
        hist[visitaEmEdicao]={
            data:hist[visitaEmEdicao].data,
            dados,
            visitaId: hist[visitaEmEdicao].visitaId || visitaId // MantÃ©m visitaId se jÃ¡ existir
        };
        visitaEmEdicao=null;
        document.getElementById("btnCancelarEdicao").style.display="none";
        document.getElementById("btnNovaVisita").style.background="#f00";
        alert("âœ… Visita atualizada no histÃ³rico!");
    } else {
        // Modo nova visita
        hist.push({
            data: new Date().toLocaleString(),
            dados,
            visitaId: visitaId
        });
        
        // ğŸ†• Limpa visitaId temporÃ¡rio apÃ³s salvar
        window.visitaIdTemporario = null;
        console.log('ğŸ§¹ visitaIdTemporario limpo apÃ³s salvamento');
        
        // âœ… CORREÃ‡ÃƒO: Limita a 50 visitas mais recentes
        hist = manterHistoricoRecente(hist, 50);
        
        // ğŸ†• Mensagem dinÃ¢mica baseada em onde as fotos foram salvas
        let mensagemFotos = '';
        if (CONFIG_DRIVE && CONFIG_DRIVE.conectado) {
            mensagemFotos = 'â˜ï¸ Fotos salvas no Google Drive';
        } else {
            mensagemFotos = 'ğŸ“¸ Fotos armazenadas no IndexedDB';
        }
        
        alert("âœ… Visita salva com sucesso!\n\n" + mensagemFotos + "\nğŸ“¦ Total de visitas: " + hist.length);
        
        // ğŸ†• OPÃ‡Ã•ES DE BACKUP ADICIONAL
        setTimeout(() => {
            const opcaoBackup = confirm(
                'ğŸ’¾ BACKUP ADICIONAL\n\n' +
                'âœ… Dados salvos com sucesso!\n' +
                'â˜ï¸ SincronizaÃ§Ã£o com Google Sheets ativa\n\n' +
                'ğŸ“¥ Deseja fazer um BACKUP adicional?\n\n' +
                'Clique OK para:\n' +
                'â€¢ Baixar arquivo JSON\n' +
                'â€¢ Enviar por email\n\n' +
                'Clique CANCELAR para continuar'
            );
            
            if (opcaoBackup) {
                // ğŸ”¥ BACKUP COMPLETO â€” coleta histÃ³rico + rascunho de TODAS as lojas
                const historicos = {};
                const rascunhos = {};

                for (let i = 0; i < lojas.length; i++) {
                    const h = localStorage.getItem("hist_" + i);
                    if (h) historicos[lojas[i]] = JSON.parse(h);

                    const r = localStorage.getItem("shoemix_" + i);
                    if (r) rascunhos[lojas[i]] = JSON.parse(r);
                }

                const dadosBackup = {
                    historicos: historicos,
                    rascunhos: rascunhos,
                    metadados: {
                        exportado_em: new Date().toLocaleString('pt-BR'),
                        versao: 'shoemix_v2',
                        total_lojas: lojas.length,
                        lojas: lojas
                    }
                };

                // 1. Download do JSON completo
                const jsonStr = JSON.stringify(dadosBackup, null, 2);
                const blob = new Blob([jsonStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `shoemix_backup_completo_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                // 2. Preparar email
                setTimeout(() => {
                    const assunto = encodeURIComponent(`Backup Visita - ${lojas[lojaAtual]} - ${new Date().toLocaleDateString()}`);
                    const corpo = encodeURIComponent(
                        `Segue backup da visita:\n\n` +
                        `Loja: ${lojas[lojaAtual]}\n` +
                        `Data: ${new Date().toLocaleString()}\n` +
                        `PontuaÃ§Ã£o: ${calculaTotalPontos(dados)} de 21\n\n` +
                        `ğŸ“ Arquivo JSON anexado\n\n` +
                        `IMPORTANTE: Salve o arquivo JSON que foi baixado e anexe neste email!`
                    );
                    
                    const emailLink = `mailto:?subject=${assunto}&body=${corpo}`;
                    
                    const enviarEmail = confirm(
                        'ğŸ“§ ENVIAR POR EMAIL\n\n' +
                        'âœ… Arquivo JSON baixado!\n\n' +
                        'Clique OK para:\n' +
                        'â€¢ Abrir seu programa de email\n' +
                        'â€¢ Anexar o arquivo JSON baixado\n' +
                        'â€¢ Enviar para o email desejado\n\n' +
                        'Dica: Envie para vocÃª mesmo ou para o supervisor!'
                    );
                    
                    if (enviarEmail) {
                        window.location.href = emailLink;
                        alert(
                            'âœ… Email preparado!\n\n' +
                            'ğŸ“ NÃ£o esqueÃ§a de anexar o arquivo JSON que foi baixado!\n\n' +
                            'Arquivo: ' + a.download
                        );
                    }
                }, 500);
            }
        }, 1000);
    }
    
    // Salva histÃ³rico com tratamento de erro
    try {
        localStorage.setItem("hist_"+lojaAtual, JSON.stringify(hist));
        
        // ğŸ†• Atualiza indicador de armazenamento
        atualizarIndicadorArmazenamento();

        console.log('âœ… HistÃ³rico salvo');
    } catch(e) {
        console.error('âŒ Erro ao salvar histÃ³rico:', e);
        
        if (e.name === 'QuotaExceededError') {
            alert(
                'âš ï¸ ERRO: Armazenamento cheio!\n\n' +
                'O histÃ³rico atingiu o limite.\n\n' +
                'ğŸ’¡ Clique em "Limpar HistÃ³rico Antigo" para liberar espaÃ§o.'
            );
        } else {
            alert('âš ï¸ ERRO: NÃ£o foi possÃ­vel salvar no histÃ³rico.\n\n' + e.message);
        }
        return;
    }
    
    atualizarHistorico();
    
    // ğŸ†• SincronizaÃ§Ã£o automÃ¡tica apÃ³s salvar
    sincronizarAposSalvar();
}

async function carregar(){
    const d=localStorage.getItem("shoemix_"+lojaAtual);
    if(!d) return;
    
    const dados=JSON.parse(d);
    
    // Limpa radios e cores
    document.querySelectorAll("input[type=radio]").forEach(r=>r.checked=false);
    document.querySelectorAll('.pergunta').forEach(p=>{
        p.classList.remove('resposta-boa','resposta-ruim','resposta-neutra');
    });
    
    // Preenche campos de texto
    Object.keys(dados).forEach(k=>{
        if(!k.startsWith("pts") && !k.startsWith("fotos_") && k !== "visitaId"){
            const el=document.getElementById(k);
            if(el && el.type!=="radio") el.value=dados[k]||"";
        }
    });
    
    // Preenche radios
    Object.keys(dados).forEach(k=>{
        if(!k.startsWith("pts") && !k.startsWith("fotos_") && k !== "visitaId"){
            const val=dados[k];
            if(val) {
                document.querySelectorAll(`input[type="radio"][name="${k}"]`).forEach(radio=>{
                    if(radio.value===val) radio.checked=true;
                });
            }
        }
    });
    
    // Preenche pontuaÃ§Ãµes
    document.querySelectorAll(".section").forEach(sec=>{
        const secId=sec.getAttribute("data-secao");
        const pts=sec.querySelector(".pts");
        if(pts && secId && dados["pts"+secId]!==undefined) {
            pts.value=Number(dados["pts"+secId]);
        }
    });
    
    // ============================================
    // ğŸ†• NOVO: Carrega fotos do IndexedDB
    // ============================================
    if (dados.visitaId) {
        console.log('ğŸ“¸ Carregando fotos da visita:', dados.visitaId);
        
        for (const secao of document.querySelectorAll(".section")) {
            const secaoId = secao.getAttribute("data-secao");
            if (!secaoId) continue;
            
            const preview = secao.querySelector('.fotos-preview');
            if (!preview) continue;
            
            try {
                // Busca fotos desta seÃ§Ã£o no IndexedDB
                const fotos = await buscarFotosSecao(dados.visitaId, secaoId);
                
                if (fotos.length > 0) {
                    preview.innerHTML = ''; // Limpa preview
                    
                    fotos.forEach(foto => {
                        // Cria URL do Blob
                        const url = URL.createObjectURL(foto.blob);
                        
                        // Cria elemento visual
                        const div = document.createElement('div');
                        div.className = 'foto-item';
                        div.setAttribute('data-db-id', foto.id); // ID do banco
                        
                        const btnRemover = document.createElement('button');
                        btnRemover.className = 'remover-foto';
                        btnRemover.type = 'button';
                        btnRemover.innerHTML = 'Ã—';
                        btnRemover.onclick = async function(event){
                            event.stopPropagation();
                            event.preventDefault();
                            
                            if(!confirm('Deseja remover esta foto?')) return;
                            
                            try {
                                await removerFotoDB(foto.id);
                                URL.revokeObjectURL(url); // Libera memÃ³ria
                                div.remove();
                                console.log('âœ… Foto removida do IndexedDB');
                            } catch(error) {
                                console.error('âŒ Erro ao remover foto:', error);
                                alert('âš ï¸ Erro ao remover foto');
                            }
                        };
                        
                        const img = document.createElement('img');
                        img.src = url;
                        img.alt = 'Foto';
                        img.onclick = function(){
                            const modal = document.getElementById('modalFoto');
                            const modalImg = document.getElementById('imagemModal');
                            modalImg.src = url;
                            modal.style.display = 'flex';
                        };
                        
                        div.appendChild(btnRemover);
                        div.appendChild(img);
                        preview.appendChild(div);
                    });
                    
                    console.log(`âœ… ${fotos.length} fotos carregadas da seÃ§Ã£o ${secaoId}`);
                }
                
            } catch(error) {
                console.error(`âŒ Erro ao carregar fotos da seÃ§Ã£o ${secaoId}:`, error);
            }
        }
    } else {
        console.log('â„¹ï¸ Sem visitaId - nÃ£o hÃ¡ fotos para carregar');
    }
    
    calcular();
    calcularPontuacaoSecao();
}
function atualizarHistorico(){const tbody=document.getElementById("historicoBody");if(!tbody)return;tbody.innerHTML="";const h=JSON.parse(localStorage.getItem("hist_"+lojaAtual)||"[]");h.forEach((v,i)=>{const totalP=calculaTotalPontos(v.dados),status=getStatus(totalP),tr=document.createElement("tr");tr.innerHTML=`<td>${v.data}</td><td>${totalP}</td><td>${status}</td><td class="actions"><button onclick="editarVisita(${i})">âœï¸ Editar</button><button onclick="excluirVisita(${i})">âŒ Excluir</button></td>`;tbody.appendChild(tr)})}
async function carregarVisita(i){
    const h=JSON.parse(localStorage.getItem("hist_"+lojaAtual)||"[]");
    const visita=h[i];
    const d=visita.dados;
    
    // Limpa interface
    document.querySelectorAll("input,textarea,select").forEach(el=>{
        if(el.type==="radio") el.checked=false;
        else if(!el.classList.contains('pts')) el.value="";
    });
    
    document.querySelectorAll('.fotos-preview').forEach(p=>p.innerHTML='');
    document.querySelectorAll('.pergunta').forEach(p=>{
        p.classList.remove('resposta-boa','resposta-ruim','resposta-neutra');
    });
    
    // Preenche campos de texto
    Object.keys(d).forEach(k=>{
        if(!k.startsWith("fotos_") && !k.startsWith("pts") && k !== "visitaId"){
            const el=document.getElementById(k);
            if(el && el.type!=="radio") el.value=d[k];
        }
    });
    
    // Preenche radios
    Object.keys(d).forEach(k=>{
        if(!k.startsWith("fotos_") && !k.startsWith("pts") && k !== "visitaId"){
            const val=d[k];
            if(val) {
                document.querySelectorAll(`input[type="radio"][name="${k}"]`).forEach(radio=>{
                    if(radio.value===val) radio.checked=true;
                });
            }
        }
    });
    
    // Preenche pontuaÃ§Ãµes
    document.querySelectorAll(".section").forEach(sec=>{
        const secId=sec.getAttribute("data-secao");
        const pts=sec.querySelector(".pts");
        if(pts && secId) pts.value=Number(d["pts"+secId]||0);
    });
    
    // ============================================
    // ğŸ†• CARREGA FOTOS DO GOOGLE DRIVE OU INDEXEDDB
    // ============================================
    const visitaId = visita.visitaId || d.visitaId;
    
    console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
    console.log('ğŸ” DEBUG: Carregando visita em ediÃ§Ã£o');
    console.log('   â€¢ visitaId:', visitaId);
    console.log('   â€¢ Drive conectado:', CONFIG_DRIVE?.conectado);
    console.log('   â€¢ Dados da visita:', d);
    console.log('   â€¢ Campos com "fotos_":', Object.keys(d).filter(k => k.startsWith('fotos_')));
    console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
    
    if (visitaId) {
        console.log('ğŸ“¸ Carregando fotos da visita em ediÃ§Ã£o:', visitaId);
        
        // Verifica se usa Google Drive ou IndexedDB
        if (CONFIG_DRIVE && CONFIG_DRIVE.conectado) {
            console.log('â˜ï¸ Carregando fotos do Google Drive...');
            
            // ğŸ†• PRIMEIRO: Tenta carregar a partir dos dados salvos (fotos_drive_X)
            let fotosCarregadasDeDados = false;
            
            for (const key of Object.keys(d)) {
                if (key.startsWith('fotos_drive_')) {
                    const secaoId = key.replace('fotos_drive_', '');
                    console.log(`ğŸ“‹ Encontrado campo ${key} com referÃªncias de fotos`);
                    
                    try {
                        const fotosIDs = JSON.parse(d[key]);
                        console.log(`   â€¢ ${fotosIDs.length} foto(s) referenciadas`);
                        
                        const secao = document.querySelector(`[data-secao="${secaoId}"]`);
                        if (!secao) {
                            console.log(`   âš ï¸ SeÃ§Ã£o ${secaoId} nÃ£o encontrada`);
                            continue;
                        }
                        
                        const preview = secao.querySelector('.fotos-preview');
                        if (!preview) {
                            console.log(`   âš ï¸ Preview nÃ£o encontrado`);
                            continue;
                        }
                        
                        preview.innerHTML = ''; // Limpa preview
                        
                        for (const fotoRef of fotosIDs) {
                            try {
                                // Cria loading
                                const divLoading = document.createElement('div');
                                divLoading.className = 'foto-item';
                                divLoading.innerHTML = '<div style="padding:20px;text-align:center;color:#666">ğŸ“¥ Carregando...</div>';
                                preview.appendChild(divLoading);
                                
                                // Baixa a imagem do Drive
                                const fileResponse = await fetch(
                                    `https://www.googleapis.com/drive/v3/files/${fotoRef.driveId}?alt=media`,
                                    {
                                        headers: {
                                            'Authorization': 'Bearer ' + CONFIG_DRIVE.accessToken
                                        }
                                    }
                                );
                                
                                if (!fileResponse.ok) {
                                    throw new Error('Erro ao baixar: ' + fileResponse.status);
                                }
                                
                                const blob = await fileResponse.blob();
                                const urlLocal = URL.createObjectURL(blob);
                                
                                // Remove loading
                                preview.removeChild(divLoading);
                                
                                // Cria preview
                                const div = document.createElement('div');
                                div.className = 'foto-item';
                                div.setAttribute('data-drive-id', fotoRef.driveId);
                                div.setAttribute('data-drive-url', fotoRef.driveUrl || '');
                                div.setAttribute('data-secao-id', secaoId);
                                div.style.cssText = 'position:relative;border:2px solid #000;border-radius:6px;padding:5px;background:#f9f9f9;width:150px;min-height:130px;display:inline-block;margin:5px';
                                
                                const img = document.createElement('img');
                                img.src = urlLocal;
                                img.alt = 'Foto do Drive';
                                img.style.cssText = 'width:100%;height:120px;object-fit:cover;border-radius:4px;cursor:pointer;display:block';
                                
                                img.onclick = function(){
                                    const modal = document.getElementById('modalFoto');
                                    const modalImg = document.getElementById('imagemModal');
                                    if (modal && modalImg) {
                                        modalImg.src = urlLocal;
                                        modal.style.display = 'flex';
                                    }
                                };
                                
                                const btnRemover = document.createElement('button');
                                btnRemover.className = 'remover-foto';
                                btnRemover.type = 'button';
                                btnRemover.innerHTML = 'Ã—';
                                btnRemover.onclick = async (e) => {
                                    e.stopPropagation();
                                    if (confirm('Remover esta foto do Google Drive?')) {
                                        try {
                                            await removerFotoDrive(fotoRef.driveId);
                                            URL.revokeObjectURL(urlLocal);
                                            div.remove();
                                            mostrarToast('âœ… Foto removida!', 'sucesso');
                                        } catch(error) {
                                            console.error('Erro ao remover:', error);
                                            mostrarToast('âŒ Erro ao remover foto', 'erro');
                                        }
                                    }
                                };
                                
                                div.appendChild(img);
                                div.appendChild(btnRemover);
                                preview.appendChild(div);
                                
                                fotosCarregadasDeDados = true;
                                console.log(`   âœ… Foto ${fotoRef.driveId} carregada`);
                                
                            } catch(error) {
                                console.error(`   âŒ Erro ao carregar foto ${fotoRef.driveId}:`, error);
                                // Remove loading se houver
                                const loadings = preview.querySelectorAll('.foto-item');
                                loadings.forEach(l => {
                                    if (l.innerHTML.includes('Carregando')) {
                                        preview.removeChild(l);
                                    }
                                });
                            }
                        }
                        
                        console.log(`âœ… SeÃ§Ã£o ${secaoId}: ${fotosIDs.length} foto(s) carregada(s) dos dados salvos`);
                        
                    } catch(error) {
                        console.error(`âŒ Erro ao processar ${key}:`, error);
                    }
                }
            }
            
            // ğŸ†• SEGUNDO: Se nÃ£o carregou fotos dos dados, busca pela API (fallback)
            if (!fotosCarregadasDeDados) {
                console.log('ğŸ“¡ NÃ£o hÃ¡ referÃªncias salvas, buscando pela API do Drive...');
                await carregarFotosGoogleDriveNaEdicao(visitaId);
            } else {
                console.log('âœ… Fotos carregadas dos dados salvos no localStorage');
            }
            
        } else {
            console.log('ğŸ’¾ Carregando fotos do IndexedDB...');
            
            for (const secao of document.querySelectorAll(".section")) {
                const secaoId = secao.getAttribute("data-secao");
                if (!secaoId) continue;
                
                const preview = secao.querySelector('.fotos-preview');
                if (!preview) continue;
                
                try {
                    // Busca fotos desta seÃ§Ã£o no IndexedDB
                    const fotos = await buscarFotosSecao(visitaId, secaoId);
                    
                    if (fotos.length > 0) {
                        preview.innerHTML = ''; // Limpa preview
                        
                        fotos.forEach(foto => {
                            // Cria URL do Blob
                            const url = URL.createObjectURL(foto.blob);
                            
                            // Cria elemento visual
                            const div = document.createElement('div');
                            div.className = 'foto-item';
                            div.setAttribute('data-db-id', foto.id); // ID do banco
                            
                            const btnRemover = document.createElement('button');
                            btnRemover.className = 'remover-foto';
                            btnRemover.type = 'button';
                            btnRemover.innerHTML = 'Ã—';
                            btnRemover.onclick = async function(event){
                                event.stopPropagation();
                                event.preventDefault();
                                
                                if(!confirm('Deseja remover esta foto?')) return;
                                
                                try {
                                    await removerFotoDB(foto.id);
                                    URL.revokeObjectURL(url); // Libera memÃ³ria
                                    div.remove();
                                    console.log('âœ… Foto removida do IndexedDB');
                                } catch(error) {
                                    console.error('âŒ Erro ao remover foto:', error);
                                    alert('âš ï¸ Erro ao remover foto');
                                }
                            };
                            
                            const img = document.createElement('img');
                            img.src = url;
                            img.alt = 'Foto';
                            img.onclick = function(){
                                const modal = document.getElementById('modalFoto');
                                const modalImg = document.getElementById('imagemModal');
                                modalImg.src = url;
                                modal.style.display = 'flex';
                            };
                            
                            div.appendChild(btnRemover);
                            div.appendChild(img);
                            preview.appendChild(div);
                        });
                        
                        console.log(`âœ… ${fotos.length} fotos carregadas da seÃ§Ã£o ${secaoId} (IndexedDB)`);
                    }
                    
                } catch(error) {
                    console.error(`âŒ Erro ao carregar fotos da seÃ§Ã£o ${secaoId}:`, error);
                }
            }
        }
    } else {
        console.warn('âš ï¸ Visita sem visitaId - nÃ£o hÃ¡ fotos para carregar');
    }
    
    calcular();
    calcularPontuacaoSecao();
    alert("âœ… Visita carregada com fotos!");
}

// ğŸ†• FunÃ§Ã£o para carregar fotos do Google Drive ao editar
async function carregarFotosGoogleDriveNaEdicao(visitaId) {
    try {
        console.log('â˜ï¸ Buscando fotos no Google Drive para visita:', visitaId);
        mostrarToast('ğŸ“¥ Carregando fotos do Drive...', 'info');
        
        // ğŸ†• Busca mais ampla - procura por qualquer parte do visitaId
        // Formato do arquivo: visitaId_secaoId_timestamp_nome.jpg
        // Ex: visita_0_1738267890123_1_1738267891234_foto.jpg
        const searchQuery = `name contains '${visitaId}' and mimeType contains 'image/' and trashed=false`;
        
        console.log('ğŸ” Query de busca:', searchQuery);
        
        const response = await gapi.client.drive.files.list({
            q: searchQuery,
            fields: 'files(id, name, webViewLink, webContentLink, mimeType, createdTime)',
            pageSize: 100,
            orderBy: 'createdTime desc'
        });
        
        const arquivos = response.result.files || [];
        console.log(`ğŸ“¸ Encontradas ${arquivos.length} fotos para visita ${visitaId}`);
        
        // ğŸ†• Log detalhado dos arquivos encontrados
        if (arquivos.length > 0) {
            console.log('ğŸ“‹ Lista de arquivos encontrados:');
            arquivos.forEach((arquivo, index) => {
                console.log(`  ${index + 1}. ${arquivo.name} (ID: ${arquivo.id})`);
            });
        } else {
            console.log('âš ï¸ Nenhuma foto encontrada no Google Drive para esta visita');
            mostrarToast('âš ï¸ Nenhuma foto encontrada', 'aviso');
            return;
        }
        
        // Agrupa fotos por seÃ§Ã£o
        const fotosPorSecao = {};
        
        arquivos.forEach(arquivo => {
            console.log(`ğŸ“„ Processando arquivo: ${arquivo.name}`);
            
            // Nome do formato: visitaId_secaoId_timestamp_nome.jpg
            // Ex: visita_0_1738267890123_1_1738267891234_foto.jpg
            const partes = arquivo.name.split('_');
            console.log(`   Partes do nome: ${partes.join(' | ')}`);
            
            // Valida que comeÃ§a com o visitaId correto
            if (!arquivo.name.startsWith(visitaId)) {
                console.log(`   â­ï¸ Pulando: nÃ£o comeÃ§a com ${visitaId}`);
                return;
            }
            
            // ğŸ†• Extrai secaoId de forma mais robusta
            // O formato Ã©: visita_LOJA_TIMESTAMP_SECAOID_TIMESTAMP2_nome.jpg
            // EntÃ£o: [0]=visita, [1]=LOJA, [2]=TIMESTAMP, [3]=SECAOID
            let secaoId = partes[3];
            
            // Se nÃ£o encontrou na posiÃ§Ã£o 3, tenta encontrar um nÃºmero
            if (!secaoId || isNaN(secaoId)) {
                console.log(`   âš ï¸ secaoId nÃ£o encontrado em posiÃ§Ã£o 3, procurando nÃºmero...`);
                // Procura o primeiro nÃºmero nas partes (que seria a seÃ§Ã£o)
                for (let i = 0; i < partes.length; i++) {
                    if (!isNaN(partes[i]) && partes[i].length <= 2) { // SeÃ§Ã£o tem 1 ou 2 dÃ­gitos
                        secaoId = partes[i];
                        console.log(`   âœ… secaoId encontrado: ${secaoId} (posiÃ§Ã£o ${i})`);
                        break;
                    }
                }
            }
            
            if (!secaoId) {
                console.log(`   âŒ NÃ£o foi possÃ­vel extrair secaoId de: ${arquivo.name}`);
                return;
            }
            
            console.log(`   âœ… Foto da seÃ§Ã£o ${secaoId}`);
            
            if (!fotosPorSecao[secaoId]) {
                fotosPorSecao[secaoId] = [];
            }
            
            fotosPorSecao[secaoId].push(arquivo);
        });
        
        console.log('ğŸ“‚ Fotos agrupadas por seÃ§Ã£o:', Object.keys(fotosPorSecao));
        
        if (Object.keys(fotosPorSecao).length === 0) {
            console.log('âš ï¸ Nenhuma foto foi categorizada por seÃ§Ã£o');
            mostrarToast('âš ï¸ Fotos encontradas mas nÃ£o categorizadas', 'aviso');
            return;
        }
        
        // Exibe fotos em cada seÃ§Ã£o
        for (const [secaoId, fotos] of Object.entries(fotosPorSecao)) {
            const secao = document.querySelector(`[data-secao="${secaoId}"]`);
            if (!secao) {
                console.log(`âš ï¸ SeÃ§Ã£o ${secaoId} nÃ£o encontrada no DOM`);
                continue;
            }
            
            const preview = secao.querySelector('.fotos-preview');
            if (!preview) {
                console.log(`âš ï¸ Preview nÃ£o encontrado para seÃ§Ã£o ${secaoId}`);
                continue;
            }
            
            preview.innerHTML = ''; // Limpa preview
            
            for (const foto of fotos) {
                try {
                    // Cria elemento de loading
                    const divLoading = document.createElement('div');
                    divLoading.className = 'foto-item';
                    divLoading.innerHTML = '<div style="padding:20px;text-align:center;color:#666">ğŸ“¥ Carregando...</div>';
                    preview.appendChild(divLoading);
                    
                    // ğŸ†• BAIXA A IMAGEM DO DRIVE USANDO A API
                    const fileResponse = await fetch(
                        `https://www.googleapis.com/drive/v3/files/${foto.id}?alt=media`,
                        {
                            headers: {
                                'Authorization': 'Bearer ' + CONFIG_DRIVE.accessToken
                            }
                        }
                    );
                    
                    if (!fileResponse.ok) {
                        throw new Error('Erro ao baixar foto: ' + fileResponse.status);
                    }
                    
                    const blob = await fileResponse.blob();
                    const urlLocal = URL.createObjectURL(blob);
                    
                    // Remove loading
                    preview.removeChild(divLoading);
                    
                    // Cria preview da foto
                    const div = document.createElement('div');
                    div.className = 'foto-item';
                    div.setAttribute('data-drive-id', foto.id);
                    div.setAttribute('data-drive-url', foto.webViewLink || foto.webContentLink);
                    div.setAttribute('data-secao-id', secaoId);
                    
                    const btnRemover = document.createElement('button');
                    btnRemover.className = 'remover-foto';
                    btnRemover.type = 'button';
                    btnRemover.innerHTML = 'Ã—';
                    btnRemover.onclick = async (e) => {
                        e.stopPropagation();
                        if (confirm('Remover esta foto do Google Drive?')) {
                            try {
                                await removerFotoDrive(foto.id);
                                URL.revokeObjectURL(urlLocal); // Libera memÃ³ria
                                div.remove();
                                mostrarToast('âœ… Foto removida!', 'sucesso');
                            } catch(error) {
                                console.error('Erro ao remover:', error);
                                mostrarToast('âŒ Erro ao remover foto', 'erro');
                            }
                        }
                    };
                    
                    // Cria imagem usando o blob local
                    const img = document.createElement('img');
                    img.src = urlLocal;
                    img.alt = 'Foto do Drive';
                    
                    img.onclick = function(){
                        // Ao clicar, abre imagem em tamanho maior
                        const modal = document.getElementById('modalFoto');
                        const modalImg = document.getElementById('imagemModal');
                        modalImg.src = urlLocal;
                        modal.style.display = 'flex';
                    };
                    
                    div.appendChild(btnRemover);
                    div.appendChild(img);
                    preview.appendChild(div);
                    
                    console.log('âœ… Foto carregada:', foto.name);
                    
                } catch(error) {
                    console.error('âŒ Erro ao carregar foto individual:', foto.name, error);
                    // Remove loading se houver erro
                    const loadings = preview.querySelectorAll('.foto-item');
                    loadings.forEach(l => {
                        if (l.innerHTML.includes('Carregando')) {
                            preview.removeChild(l);
                        }
                    });
                    mostrarToast('âš ï¸ Erro ao carregar ' + foto.name, 'erro');
                }
            }
            
            console.log(`âœ… ${fotos.length} fotos carregadas da seÃ§Ã£o ${secaoId} (Google Drive)`);
        }
        
    } catch(error) {
        console.error('âŒ Erro ao carregar fotos do Google Drive:', error);
        mostrarToast('âš ï¸ Erro ao carregar fotos do Drive', 'erro');
    }
}
async function editarVisita(i){
    visitaEmEdicao=i;
    document.getElementById("btnCancelarEdicao").style.display="inline-block";
    document.getElementById("btnNovaVisita").style.background="#ff6600";
    
    // ğŸ†• Carrega visitaId da visita em ediÃ§Ã£o
    const h=JSON.parse(localStorage.getItem("hist_"+lojaAtual)||"[]");
    const visita=h[i];
    if (visita && visita.visitaId) {
        window.visitaIdTemporario = visita.visitaId;
        console.log('ğŸ“ Modo ediÃ§Ã£o: usando visitaId da visita:', visita.visitaId);
    }
    
    // Carrega a visita (agora com fotos)
    await carregarVisita(i);
    
    window.scrollTo(0,0);
    alert("âœï¸ Modo de EdiÃ§Ã£o ativado!\n\nğŸ’¾ Salvar = ATUALIZAR\nğŸ†• Nova Visita = CRIAR nova\nâŒ Cancelar EdiÃ§Ã£o = desistir");
}
function cancelarEdicao(){
    if(!confirm("Cancelar ediÃ§Ã£o? AlteraÃ§Ãµes nÃ£o salvas serÃ£o perdidas.")) return;
    
    visitaEmEdicao=null;
    window.visitaIdTemporario=null; // ğŸ†• Limpa visitaId temporÃ¡rio
    
    document.getElementById("btnCancelarEdicao").style.display="none";
    document.getElementById("btnNovaVisita").style.background="#f00";
    
    document.querySelectorAll("input,textarea,select").forEach(el=>{
        if(el.type==="radio") el.checked=false;
        else el.value="";
    });
    
    document.querySelectorAll('.fotos-preview').forEach(p=>p.innerHTML='');
    document.querySelectorAll('.pergunta').forEach(p=>{
        p.classList.remove('resposta-boa','resposta-ruim','resposta-neutra');
    });
    
    calcular();
    alert("âœ… EdiÃ§Ã£o cancelada!");
}
function excluirVisita(i){if(!confirm("Deseja excluir esta visita?"))return;const h=JSON.parse(localStorage.getItem("hist_"+lojaAtual)||"[]");h.splice(i,1);localStorage.setItem("hist_"+lojaAtual,JSON.stringify(h));atualizarHistorico()}
function exportarPDF(){window.print()}
async function exportarJSON(){
  mostrarToast('ğŸ“¦ Preparando exportaÃ§Ã£o...', 'info');
  console.log('ğŸ” Iniciando exportaÃ§Ã£o com fotos...');
  
  const todosHistoricos = {};
  
  // ğŸ†• Coleta os histÃ³ricos de todas as lojas
  for(let i = 0; i < lojas.length; i++) {
    const loja = lojas[i];
    const hist = localStorage.getItem("hist_"+i);
    
    if(hist) {
      const visitasArray = JSON.parse(hist);
      console.log(`ğŸ“‹ Loja ${loja}: ${visitasArray.length} visitas encontradas`);
      
      // ğŸ†• Para cada visita, busca as fotos no IndexedDB e converte para base64
      for(let visita of visitasArray) {
        const visitaId = visita.visitaId || visita.dados?.visitaId;
        console.log(`ğŸ” Processando visita ID: ${visitaId}`);
        
        if(visitaId) {
          try {
            // Busca todas as fotos dessa visita no IndexedDB
            const todasFotos = await buscarTodasFotosVisita(visitaId);
            console.log(`ğŸ“¸ Encontradas ${todasFotos.length} fotos para visita ${visitaId}`);
            
            if(todasFotos.length > 0) {
              visita.fotos = {}; // Objeto para armazenar fotos por seÃ§Ã£o
              
              for(let foto of todasFotos) {
                // Converte Blob para base64
                const base64 = await blobToBase64(foto.blob);
                
                // Organiza por seÃ§Ã£o (usando secaoId que Ã© o campo correto no DB)
                const secaoId = foto.secaoId || foto.secao || 'geral';
                console.log(`  ğŸ“ Foto da seÃ§Ã£o: ${secaoId}, tamanho: ${foto.blob.size} bytes`);
                
                if(!visita.fotos[secaoId]) {
                  visita.fotos[secaoId] = [];
                }
                
                visita.fotos[secaoId].push({
                  base64: base64,
                  nome: foto.nome || 'foto.jpg',
                  tipo: foto.blob.type || 'image/jpeg'
                });
              }
              
              console.log(`âœ… ${todasFotos.length} fotos exportadas da visita ${visitaId}`);
            }
          } catch(error) {
            console.error('âŒ Erro ao exportar fotos da visita', visitaId, ':', error);
          }
        } else {
          console.log('âš ï¸ Visita sem ID, pulando...');
        }
      }
      
      todosHistoricos[loja] = visitasArray;
    }
  }
  
  // ğŸ†• Coleta tambÃ©m os rascunhos ativos de cada loja
  const rascunhos = {};
  for(let i = 0; i < lojas.length; i++) {
    const rascunho = localStorage.getItem("shoemix_"+i);
    if(rascunho) {
      try {
        rascunhos[lojas[i]] = JSON.parse(rascunho);
        console.log(`ğŸ“ Rascunho da Loja ${lojas[i]}: encontrado`);
      } catch(e) {
        console.error('âŒ Erro ao parsear rascunho da loja', lojas[i], e);
      }
    }
  }

  if(Object.keys(todosHistoricos).length === 0 && Object.keys(rascunhos).length === 0) {
    alert("âš ï¸ Nenhum dado para exportar!");
    return;
  }
  
  // Monta objeto final com histÃ³ricos + rascunhos
  const exportacaoFinal = {
    historicos: todosHistoricos,
    rascunhos: rascunhos,
    metadados: {
      exportado_em: new Date().toLocaleString('pt-BR'),
      versao: 'shoemix_v2',
      total_lojas: lojas.length,
      lojas: lojas
    }
  };

  console.log('âœ… ExportaÃ§Ã£o concluÃ­da, gerando arquivo JSON...');
  const dataStr = JSON.stringify(exportacaoFinal, null, 2);
  const dataBlob = new Blob([dataStr], {type: 'application/json'});
  const url = URL.createObjectURL(dataBlob);
  const link = document.createElement('a');
  link.href = url;
  link.download = `shoemix_backup_completo_${new Date().toISOString().slice(0,10)}.json`;
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  URL.revokeObjectURL(url);
  
  console.log('ğŸ“¥ Arquivo JSON baixado');
  const totalLojas = Object.keys(todosHistoricos).length;
  const totalRascunhos = Object.keys(rascunhos).length;
  mostrarToast(`âœ… JSON exportado! ${totalLojas} loja(s) com histÃ³rico + ${totalRascunhos} rascunho(s)`, 'sucesso');
}

// ğŸ†• FunÃ§Ã£o auxiliar para converter Blob em base64
function blobToBase64(blob) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onloadend = () => resolve(reader.result);
    reader.onerror = reject;
    reader.readAsDataURL(blob);
  });
}

// ğŸ†• FunÃ§Ã£o auxiliar para converter base64 em Blob
function base64ToBlob(base64, mimeType) {
  return new Promise((resolve, reject) => {
    try {
      // Remove o prefixo "data:image/jpeg;base64," se existir
      const base64Data = base64.includes(',') ? base64.split(',')[1] : base64;
      
      // Decodifica base64
      const byteCharacters = atob(base64Data);
      const byteNumbers = new Array(byteCharacters.length);
      
      for (let i = 0; i < byteCharacters.length; i++) {
        byteNumbers[i] = byteCharacters.charCodeAt(i);
      }
      
      const byteArray = new Uint8Array(byteNumbers);
      const blob = new Blob([byteArray], { type: mimeType });
      
      resolve(blob);
    } catch(error) {
      reject(error);
    }
  });
}

// ğŸ†• FunÃ§Ã£o para buscar TODAS as fotos de uma visita
async function buscarTodasFotosVisita(visitaId) {
  return new Promise((resolve, reject) => {
    const request = indexedDB.open(DB_NAME, DB_VERSION);
    
    request.onsuccess = (event) => {
      const db = event.target.result;
      const transaction = db.transaction([STORE_FOTOS], 'readonly');
      const store = transaction.objectStore(STORE_FOTOS);
      const index = store.index('visitaId');
      
      const getRequest = index.getAll(visitaId);
      
      getRequest.onsuccess = () => {
        resolve(getRequest.result || []);
      };
      
      getRequest.onerror = () => {
        reject(getRequest.error);
      };
    };
    
    request.onerror = () => {
      reject(request.error);
    };
  });
}
async function carregarJSON(){
  const input=document.createElement('input');
  input.type='file';
  input.accept='application/json';
  input.onchange= async (e)=>{
    const file=e.target.files[0];
    if(!file){
      alert("âŒ Nenhum arquivo selecionado!");
      return;
    }
    const reader=new FileReader();
    reader.onload= async (evt)=>{
      try{
        const data=JSON.parse(evt.target.result);
        
        // Verifica se o JSON estÃ¡ no formato correto
        if(!data || typeof data !== 'object'){
          throw new Error("Formato de JSON invÃ¡lido!");
        }
        
        let carregadas = 0;
        let detalhes = [];
        let errosQuota = [];
        let totalFotosImportadas = 0; // ğŸ†• Contador de fotos
        
        // âœ… NOVO: Detecta automaticamente o formato do JSON
        let dadosParaImportar = {};
        
        console.log('ğŸ“¦ Analisando formato do JSON...');
        console.log('Chaves encontradas:', Object.keys(data));
        
        // Formato 0: Novo formato v2 com historicos + rascunhos + metadados
        if(data.metadados && data.metadados.versao === 'shoemix_v2') {
          console.log('ğŸ“¦ Formato detectado: Shoemix v2 (histÃ³ricos + rascunhos)');
          
          // Importa histÃ³ricos normalmente
          if(data.historicos) {
            dadosParaImportar = data.historicos;
          }
          
          // Restaura os rascunhos de cada loja
          if(data.rascunhos && typeof data.rascunhos === 'object') {
            for(const nomeLoja of Object.keys(data.rascunhos)) {
              const indice = lojas.indexOf(nomeLoja);
              if(indice !== -1) {
                try {
                  localStorage.setItem("shoemix_"+indice, JSON.stringify(data.rascunhos[nomeLoja]));
                  console.log(`ğŸ“ Rascunho restaurado: ${nomeLoja}`);
                  detalhes.push(`ğŸ“ ${nomeLoja}: rascunho restaurado`);
                } catch(e) {
                  console.error('âŒ Erro ao restaurar rascunho de', nomeLoja, e);
                }
              }
            }
          }
        }
        // Formato 1: JSON de sincronizaÃ§Ã£o {exportado_em, total_visitas, visitas: [...]}
        else if(data.visitas && Array.isArray(data.visitas)) {
          console.log('ğŸ“¦ Formato detectado: JSON de sincronizaÃ§Ã£o');
          
          // Agrupa as visitas por loja
          data.visitas.forEach(visita => {
            const nomeLoja = visita.loja;
            if(!dadosParaImportar[nomeLoja]) {
              dadosParaImportar[nomeLoja] = [];
            }
            
            // Converte formato de sincronizaÃ§Ã£o para formato de histÃ³rico
            dadosParaImportar[nomeLoja].push({
              data: visita.data || new Date().toLocaleString('pt-BR'),
              dados: visita.dados || {},
              visitaId: visita.dados?.visitaId || 'visita_' + Date.now(),
              fotos: visita.fotos || {} // ğŸ†• Preserva as fotos
            });
          });
          
          console.log('âœ… Visitas reagrupadas por loja:', Object.keys(dadosParaImportar));
        }
        // ğŸ”§ CORREÃ‡ÃƒO: Formato 2 - JSON com chaves genÃ©ricas (loja, data, visita, historico)
        // Este formato provavelmente Ã© um JSON mal formatado ou de sistema antigo
        else if(data.loja || data.data || data.visita || data.historico) {
          console.log('ğŸ“¦ Formato detectado: JSON com chaves genÃ©ricas (formato antigo/incorreto)');
          console.warn('âš ï¸ Este JSON nÃ£o estÃ¡ no formato correto.');
          console.log('Chaves encontradas:', Object.keys(data));
          
          // Tenta interpretar se for um JSON de uma Ãºnica visita
          if(data.loja && typeof data.loja === 'string') {
            console.log('Tentando interpretar como visita Ãºnica...');
            dadosParaImportar[data.loja] = [{
              data: data.data || new Date().toLocaleString('pt-BR'),
              dados: data.dados || data,
              visitaId: 'visita_' + Date.now()
            }];
          }
          // Se nÃ£o conseguiu interpretar, mostra aviso detalhado
          else {
            console.error('âŒ NÃ£o foi possÃ­vel interpretar este formato de JSON');
            alert(
              'âŒ Formato de JSON nÃ£o reconhecido!\n\n' +
              'O arquivo que vocÃª tentou carregar nÃ£o estÃ¡ no formato correto.\n\n' +
              'Formatos aceitos:\n\n' +
              '1ï¸âƒ£ JSON exportado pelo botÃ£o "Exportar JSON":\n' +
              '   {"LOJA 1-IBATE": [...], "LOJA 3-SÃƒO CARLOS": [...]}\n\n' +
              '2ï¸âƒ£ JSON de sincronizaÃ§Ã£o:\n' +
              '   {exportado_em: "...", visitas: [...]}\n\n' +
              'ğŸ’¡ SOLUÃ‡ÃƒO:\n' +
              'â€¢ Use o botÃ£o "Exportar JSON" para gerar um backup\n' +
              'â€¢ Ou exporte de uma loja especÃ­fica\n\n' +
              'Chaves encontradas no arquivo:\n' + Object.keys(data).join(', ')
            );
            return;
          }
        }
        // Formato 3: JSON normal {"LOJA 1-IBATE": [...], "LOJA 3-SÃƒO CARLOS": [...]}
        else {
          console.log('ğŸ“¦ Formato detectado: JSON padrÃ£o (por loja)');
          
          // Verifica se pelo menos uma chave Ã© um nome de loja vÃ¡lido
          const chavesJSON = Object.keys(data);
          const lojasValidas = chavesJSON.filter(chave => lojas.includes(chave));
          
          if(lojasValidas.length === 0 && chavesJSON.length > 0) {
            console.warn('âš ï¸ Nenhuma chave do JSON corresponde a uma loja do sistema');
            console.log('Chaves no JSON:', chavesJSON);
            console.log('Lojas esperadas:', lojas);
            
            // Tenta encontrar correspondÃªncia parcial (case-insensitive e sem acentos)
            const normalizarTexto = (texto) => {
              return texto.toLowerCase()
                .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
                .replace(/[^a-z0-9]/g, '');
            };
            
            console.log('ğŸ” Tentando correspondÃªncia flexÃ­vel...');
            chavesJSON.forEach(chaveJSON => {
              const chaveNormalizada = normalizarTexto(chaveJSON);
              const lojaEncontrada = lojas.find(l => normalizarTexto(l).includes(chaveNormalizada));
              
              if(lojaEncontrada) {
                console.log(`âœ… Mapeamento: "${chaveJSON}" â†’ "${lojaEncontrada}"`);
                dadosParaImportar[lojaEncontrada] = data[chaveJSON];
              } else {
                console.log(`âš ï¸ NÃ£o encontrado: "${chaveJSON}"`);
              }
            });
            
            // Se ainda nÃ£o encontrou nada, usa os dados diretamente
            if(Object.keys(dadosParaImportar).length === 0) {
              console.log('âš ï¸ Usando dados originais (pode nÃ£o funcionar)');
              dadosParaImportar = data;
            }
          } else {
            dadosParaImportar = data;
          }
        }
        
        // ğŸ†• Agora importa as lojas E AS FOTOS
        for(const nomeLoja of Object.keys(dadosParaImportar)) {
          const indice = lojas.indexOf(nomeLoja);
          if(indice !== -1) {
            // Valida se os dados sÃ£o um array
            if(Array.isArray(dadosParaImportar[nomeLoja])){
              const visitasArray = dadosParaImportar[nomeLoja];
              
              // ğŸ†• Para cada visita, importa as fotos base64 para o IndexedDB
              for(const visita of visitasArray) {
                const visitaId = visita.visitaId || visita.dados?.visitaId;
                console.log(`ğŸ” Importando visita ID: ${visitaId}`);
                
                if(visita.fotos && typeof visita.fotos === 'object') {
                  console.log(`ğŸ“¸ Fotos encontradas no JSON para visita ${visitaId}`);
                  console.log('SeÃ§Ãµes com fotos:', Object.keys(visita.fotos));
                  
                  if(visitaId) {
                    // Percorre cada seÃ§Ã£o que tem fotos
                    for(const secao of Object.keys(visita.fotos)) {
                      const fotosSecao = visita.fotos[secao];
                      console.log(`  ğŸ“‚ SeÃ§Ã£o ${secao}: ${fotosSecao.length} fotos`);
                      
                      if(Array.isArray(fotosSecao)) {
                        for(const fotoData of fotosSecao) {
                          try {
                            // Converte base64 de volta para Blob
                            const blob = await base64ToBlob(fotoData.base64, fotoData.tipo || 'image/jpeg');
                            console.log(`    ğŸ“ Convertendo foto para Blob: ${blob.size} bytes`);
                            
                            // Salva no IndexedDB (parÃ¢metros corretos: blob, visitaId, secaoId)
                            const dbId = await salvarFotoDB(blob, visitaId, secao);
                            console.log(`    âœ… Foto salva no IndexedDB com ID: ${dbId}`);
                            
                            totalFotosImportadas++;
                          } catch(errFoto) {
                            console.error('    âŒ Erro ao importar foto:', errFoto);
                          }
                        }
                      }
                    }
                    
                    console.log(`âœ… Fotos importadas da visita ${visitaId}`);
                  } else {
                    console.log('âš ï¸ Visita tem fotos mas nÃ£o tem ID vÃ¡lido');
                  }
                } else if(visitaId) {
                  console.log(`â„¹ï¸ Visita ${visitaId} sem fotos no JSON`);
                }
                
                // ğŸ†• Remove o campo "fotos" do objeto antes de salvar no localStorage
                // (jÃ¡ estÃ¡ no IndexedDB, nÃ£o precisa duplicar)
                delete visita.fotos;
              }
              
              try {
                // Tenta salvar
                localStorage.setItem("hist_"+indice, JSON.stringify(visitasArray));
                carregadas++;
                detalhes.push(`âœ… ${nomeLoja}: ${visitasArray.length} visita(s)`);
              } catch(e) {
                if(e.name === 'QuotaExceededError') {
                  // Quota excedida - tenta limpar espaÃ§o
                  console.log('âš ï¸ Quota excedida ao importar - tentando liberar espaÃ§o...');
                  
                  try {
                    // Remove rascunhos antigos para liberar espaÃ§o
                    lojas.forEach((l, idx) => {
                      localStorage.removeItem("shoemix_"+idx);
                    });
                    
                    // Tenta salvar novamente
                    localStorage.setItem("hist_"+indice, JSON.stringify(visitasArray));
                    carregadas++;
                    detalhes.push(`âœ… ${nomeLoja}: ${visitasArray.length} visita(s) (espaÃ§o liberado)`);
                  } catch(e2) {
                    errosQuota.push(nomeLoja);
                    detalhes.push(`âŒ ${nomeLoja}: erro de espaÃ§o (${visitasArray.length} visitas nÃ£o importadas)`);
                  }
                } else {
                  throw e;
                }
              }
            } else {
              detalhes.push(`âš ï¸ ${nomeLoja}: formato invÃ¡lido (ignorado)`);
            }
          } else {
            detalhes.push(`âš ï¸ ${nomeLoja}: loja nÃ£o encontrada no sistema`);
          }
        }
        
        if(carregadas === 0 && errosQuota.length === 0){
          // Mostra informaÃ§Ãµes detalhadas sobre o erro
          let mensagemErro = "âš ï¸ Nenhuma loja vÃ¡lida encontrada no JSON!\n\n";
          
          if(Object.keys(dadosParaImportar).length > 0) {
            mensagemErro += "Lojas no arquivo:\n" + Object.keys(dadosParaImportar).join('\n') + "\n\n";
          } else {
            mensagemErro += "O arquivo nÃ£o contÃ©m dados de lojas.\n\n";
            if(data.visitas) {
              mensagemErro += `Encontradas ${data.visitas.length} visitas, mas sem lojas vÃ¡lidas.\n\n`;
            }
          }
          
          mensagemErro += "Lojas esperadas pelo sistema:\n" + lojas.join('\n');
          
          alert(mensagemErro);
          return;
        }
        
        montarTela();
        atualizarHistorico();
        
        let mensagem = `âœ… JSON processado!\n\n` +
                      `ğŸ“Š ${carregadas} loja(s) restaurada(s)\n`;
        
        // ğŸ†• Adiciona informaÃ§Ã£o de fotos importadas
        if(totalFotosImportadas > 0) {
          mensagem += `ğŸ“¸ ${totalFotosImportadas} foto(s) restaurada(s)\n`;
        }
        
        mensagem += `\nDetalhes:\n${detalhes.join('\n')}`;
        
        if(errosQuota.length > 0) {
          mensagem += `\n\nâš ï¸ ATENÃ‡ÃƒO:\nAlgumas lojas nÃ£o puderam ser importadas por falta de espaÃ§o.\n\nğŸ’¡ SOLUÃ‡ÃƒO:\n1. Configure a sincronizaÃ§Ã£o em nuvem\n2. Ou limpe o histÃ³rico antigo\n3. Tente importar novamente`;
        }
        
        alert(mensagem);
        
        console.log('JSON carregado:', {
          carregadas: carregadas,
          fotosImportadas: totalFotosImportadas,
          errosQuota: errosQuota,
          detalhes: detalhes
        });
        
      }catch(err){
        console.error("Erro ao carregar JSON:", err);
        
        let mensagemErro = "âŒ Erro ao carregar JSON!\n\n" + err.message;
        
        if(err.message && err.message.includes('quota')) {
          mensagemErro += "\n\nâš ï¸ O armazenamento estÃ¡ cheio!\n\nğŸ’¡ SOLUÃ‡Ã•ES:\n1. Configure sincronizaÃ§Ã£o em nuvem (recomendado)\n2. Limpe visitas antigas (>90 dias)\n3. Exporte e limpe tudo";
        } else {
          mensagemErro += "\n\nVerifique se o arquivo Ã© um backup vÃ¡lido do sistema.";
        }
        
        alert(mensagemErro);

      }
    };
    reader.onerror = () => {
      alert("âŒ Erro ao ler o arquivo!\n\nTente novamente.");
    };
    reader.readAsText(file);
  };
  input.click();
}
function resumoMensal(){const h=JSON.parse(localStorage.getItem("hist_"+lojaAtual)||"[]");if(h.length===0){document.getElementById("resumoMensal").innerHTML="NÃ£o hÃ¡ visitas registradas.";return}let html='<table><thead><tr><th>Data</th><th>Total</th><th>Status</th></tr></thead><tbody>';h.forEach(v=>{const totalP=calculaTotalPontos(v.dados),status=getStatus(totalP);html+=`<tr><td>${v.data}</td><td>${totalP}</td><td>${status}</td></tr>`});html+='</tbody></table>';document.getElementById("resumoMensal").innerHTML=html}
function resumoGeral(){const h=JSON.parse(localStorage.getItem("hist_"+lojaAtual)||"[]");if(h.length===0){document.getElementById("resumoGeral").innerHTML="NÃ£o hÃ¡ visitas registradas.";return}let html='<table><thead><tr><th>Data</th><th>Total</th><th>Status</th><th>Comparativo</th></tr></thead><tbody>',ultimo=0;h.forEach(v=>{const totalP=calculaTotalPontos(v.dados),status=getStatus(totalP);let comparativo="-";if(ultimo!==0)comparativo=totalP>ultimo?"ğŸ”º Aumento":totalP<ultimo?"ğŸ”» Queda":"âº Igual";html+=`<tr><td>${v.data}</td><td>${totalP}</td><td>${status}</td><td>${comparativo}</td></tr>`;ultimo=totalP});html+='</tbody></table>';document.getElementById("resumoGeral").innerHTML=html}
function toggleResumo(tipo){if(tipo==='mensal'){const div=document.getElementById("resumoMensal"),isVisible=div.style.display==="block";div.style.display=isVisible?"none":"block";if(!isVisible){resumoMensal();alert("âœ… Resumo Mensal gerado!")}}else if(tipo==='geral'){const div=document.getElementById("resumoGeral"),isVisible=div.style.display==="block";div.style.display=isVisible?"none":"block";if(!isVisible){resumoGeral();alert("âœ… Resumo Geral gerado!")}}}
function calcular(){let t=0;document.querySelectorAll(".pts").forEach(p=>t+=Number(p.value||0));const totalDisplay=document.getElementById("totalDisplay"),statusEmoji=document.getElementById("statusEmoji"),statusText=document.getElementById("statusText"),summaryBox=document.getElementById("summaryBox");if(totalDisplay)totalDisplay.innerText=t;let emoji="âšª",texto="Aguardando avaliaÃ§Ã£o",corFundo="#f5f5f5",corTexto="#666";if(t>=18){emoji="ğŸŸ¢ ğŸ‰";texto="EXCELENTE";corFundo="#d4edda";corTexto="#155724"}else if(t>=14){emoji="ğŸ”µ ğŸ‘";texto="BOM";corFundo="#d1ecf1";corTexto="#0c5460"}else if(t>=10){emoji="ğŸŸ¡ âš ï¸";texto="REGULAR";corFundo="#fff3cd";corTexto="#856404"}else if(t>0){emoji="ğŸ”´ âš ï¸";texto="INSATISFATÃ“RIO";corFundo="#f8d7da";corTexto="#721c24"}if(statusEmoji)statusEmoji.innerText=emoji;if(statusText){statusText.innerText=texto;statusText.style.backgroundColor=corFundo;statusText.style.color=corTexto;statusText.style.border=`2px solid ${corTexto}`}if(summaryBox){summaryBox.style.borderColor=corTexto;summaryBox.style.backgroundColor=corFundo}}
function calcularPontuacaoSecao(){const regras={"1":{nf:["NÃ£o","Sim, dentro do prazo"],cx:["NÃ£o","Sim, dentro do prazo"],er:["NÃ£o"]},"2":{et:["NÃ£o","Sim, dentro do prazo"],imp:["Sim"],arg:["NÃ£o","Sim, solicitado conserto"]},"3":{limpo:["Sim"],pc:["Sim"],check:["Sim"]},"4":{c1:["Sim"],c2:["Sim"],c3:["Sim"],c4:["Sim"]},"5":{f1:["Sim"],f2:["Sim"]},"6":{g1:["Sim"],g2:["Sim"]},"7":{t1:["Sim"],t2:["Sim","Em Aberto, dentro do prazo"],t3:["Sim","Em Aberto, dentro do prazo"],t4:["Sim"]}};document.querySelectorAll(".section").forEach(sec=>{const secId=sec.getAttribute("data-secao");if(!secId||!regras[secId])return;const regraSecao=regras[secId],perguntas=Object.keys(regraSecao),totalPerguntas=perguntas.length;let respostasCorretas=0;perguntas.forEach(idPergunta=>{const respostasAceitas=regraSecao[idPergunta];let acertou=false;const radioMarcado=sec.querySelector(`input[type="radio"][name="${idPergunta}"]:checked`);const divPergunta=sec.querySelector(`input[type="radio"][name="${idPergunta}"]`)?.closest('.pergunta');if(divPergunta){divPergunta.classList.remove('resposta-boa','resposta-ruim','resposta-neutra')}if(radioMarcado){const valorMarcado=radioMarcado.value;respostasAceitas.forEach(resposta=>{if(resposta===valorMarcado)acertou=true});if(divPergunta){if(acertou){divPergunta.classList.add('resposta-boa')}else{const respostasNeutras=["Em Aberto, dentro do prazo"];if(respostasNeutras.includes(valorMarcado)){divPergunta.classList.add('resposta-neutra')}else{divPergunta.classList.add('resposta-ruim')}}}}if(acertou)respostasCorretas++});let pontuacao=0;if(totalPerguntas>0){const percentual=respostasCorretas/totalPerguntas;pontuacao=Math.round(percentual*3)}const selectPts=sec.querySelector(".pts");if(selectPts)selectPts.value=pontuacao});calcular()}
function calculaTotalPontos(dados){let t=0;if(dados)Object.keys(dados).forEach(k=>{if(k.startsWith("pts"))t+=Number(dados[k]||0)});return t}
function getStatus(t){return t>=18?"Excelente ğŸŸ¢":t>=14?"Bom ğŸ”µ":t>=10?"Regular ğŸŸ¡":"InsatisfatÃ³rio ğŸ”´"}
function gerarConclusaoAutomatica(){
    const descricoes={
        nf:{secao:"Recebimento de Mercadorias",texto:"GestÃ£o de Notas Fiscais pendentes",critico:true},
        cx:{secao:"Recebimento de Mercadorias",texto:"ConferÃªncia de volumes e caixas fechadas",critico:true},
        er:{secao:"Recebimento de Mercadorias",texto:"Controle de erros no recebimento",critico:true},
        et:{secao:"Etiquetagem de Produtos",texto:"Fila de produtos aguardando etiquetagem",critico:false},
        imp:{secao:"Etiquetagem de Produtos",texto:"Qualidade de impressÃ£o de etiquetas",critico:false},
        arg:{secao:"Etiquetagem de Produtos",texto:"Funcionamento do equipamento Argox",critico:true},
        limpo:{secao:"OrganizaÃ§Ã£o e Limpeza",texto:"PadrÃ£o de higienizaÃ§Ã£o do ambiente",critico:false},
        pc:{secao:"OrganizaÃ§Ã£o e Limpeza",texto:"OrganizaÃ§Ã£o da Ã¡rea administrativa",critico:false},
        check:{secao:"OrganizaÃ§Ã£o e Limpeza",texto:"AdesÃ£o ao checklist operacional online",critico:false},
        c1:{secao:"OrganizaÃ§Ã£o de Corredores",texto:"Alinhamento e padronizaÃ§Ã£o visual",critico:false},
        c2:{secao:"OrganizaÃ§Ã£o de Corredores",texto:"Sistema de numeraÃ§Ã£o e identificaÃ§Ã£o",critico:false},
        c3:{secao:"OrganizaÃ§Ã£o de Corredores",texto:"SetorizaÃ§Ã£o correta por categoria",critico:false},
        c4:{secao:"OrganizaÃ§Ã£o de Corredores",texto:"Acessibilidade e fluxo operacional",critico:true},
        f1:{secao:"ConfecÃ§Ãµes e AcessÃ³rios",texto:"SetorizaÃ§Ã£o por marca e modelo",critico:false},
        f2:{secao:"ConfecÃ§Ãµes e AcessÃ³rios",texto:"CondiÃ§Ãµes de armazenamento",critico:false},
        g1:{secao:"GestÃ£o de Defeitos",texto:"IdentificaÃ§Ã£o de produtos com defeito",critico:true},
        g2:{secao:"GestÃ£o de Defeitos",texto:"TransferÃªncia para loja 99 (central de defeitos)",critico:true},
        t1:{secao:"TransferÃªncias e Remanejamentos",texto:"PrecisÃ£o nas transferÃªncias entre unidades",critico:true},
        t2:{secao:"TransferÃªncias e Remanejamentos",texto:"ExecuÃ§Ã£o de remanejamentos via sistema",critico:true},
        t3:{secao:"TransferÃªncias e Remanejamentos",texto:"GestÃ£o de lotes em aberto",critico:true},
        t4:{secao:"TransferÃªncias e Remanejamentos",texto:"SeparaÃ§Ã£o de pÃ©s de vitrine",critico:false}
    };

    // Coleta respostas e organiza por seÃ§Ã£o
    const secoes = {};
    const problemasCriticos = [];
    const problemasModerados = [];
    const pontosFortes = [];
    
    Object.keys(descricoes).forEach(id=>{
        const radio=document.querySelector(`input[type="radio"][name="${id}"]:checked`);
        if(radio){
            const val=radio.value;
            const info=descricoes[id];
            const secaoNome=info.secao;
            
            if(!secoes[secaoNome]) secoes[secaoNome]={conforme:[],naoConforme:[],emAndamento:[]};
            
            const regras={"1":{nf:["NÃ£o","Sim, dentro do prazo"],cx:["NÃ£o","Sim, dentro do prazo"],er:["NÃ£o"]},"2":{et:["NÃ£o","Sim, dentro do prazo"],imp:["Sim"],arg:["NÃ£o","Sim, solicitado conserto"]},"3":{limpo:["Sim"],pc:["Sim"],check:["Sim"]},"4":{c1:["Sim"],c2:["Sim"],c3:["Sim"],c4:["Sim"]},"5":{f1:["Sim"],f2:["Sim"]},"6":{g1:["Sim"],g2:["Sim"]},"7":{t1:["Sim"],t2:["Sim","Em Aberto, dentro do prazo"],t3:["Sim","Em Aberto, dentro do prazo"],t4:["Sim"]}};
            
            let conforme=false;
            for(let secId in regras){
                if(regras[secId][id]){
                    if(regras[secId][id].includes(val)){
                        conforme=true;
                        break;
                    }
                }
            }
            
            const emAndamento=val.includes("Em Aberto, dentro do prazo")||val.includes("Sim, dentro do prazo")||val.includes("Sim, solicitado conserto");
            
            if(conforme){
                secoes[secaoNome].conforme.push(info.texto);
                pontosFortes.push({secao:secaoNome,item:info.texto});
            }else if(emAndamento){
                secoes[secaoNome].emAndamento.push({texto:info.texto,status:val});
            }else{
                secoes[secaoNome].naoConforme.push({texto:info.texto,status:val});
                if(info.critico){
                    problemasCriticos.push({secao:secaoNome,item:info.texto,status:val});
                }else{
                    problemasModerados.push({secao:secaoNome,item:info.texto,status:val});
                }
            }
        }
    });

    // Calcula pontuaÃ§Ã£o e classificaÃ§Ã£o
    let total=0;
    document.querySelectorAll(".pts").forEach(p=>total+=Number(p.value||0));
    
    let classificacao="",nivelDesempenho="",recomendacaoGeral="";
    if(total>=18){
        classificacao="EXCELENTE";
        nivelDesempenho="A loja demonstra excelÃªncia operacional";
        recomendacaoGeral="Manter o padrÃ£o atual e compartilhar melhores prÃ¡ticas com outras unidades.";
    }else if(total>=14){
        classificacao="BOM";
        nivelDesempenho="A loja apresenta desempenho satisfatÃ³rio";
        recomendacaoGeral="Implementar melhorias pontuais para alcanÃ§ar excelÃªncia operacional.";
    }else if(total>=10){
        classificacao="REGULAR";
        nivelDesempenho="A loja requer atenÃ§Ã£o em processos-chave";
        recomendacaoGeral="ImplementaÃ§Ã£o prioritÃ¡ria de planos de aÃ§Ã£o com acompanhamento semanal.";
    }else{
        classificacao="CRÃTICO";
        nivelDesempenho="A loja apresenta nÃ£o conformidades significativas";
        recomendacaoGeral="IntervenÃ§Ã£o imediata necessÃ¡ria com plano de aÃ§Ã£o emergencial.";
    }

    // Monta a conclusÃ£o profissional
    // Monta a conclusÃ£o RESUMIDA e PROFISSIONAL
    let conclusao="";
    
    // ============================================
    // CABEÃ‡ALHO SIMPLIFICADO
    // ============================================
    conclusao+="â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n";
    conclusao+="     RELATÃ“RIO DE AUDITORIA OPERACIONAL - SHOEMIX\n";
    conclusao+="â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n";
    
    conclusao+=`ğŸ“ Unidade: ${lojas[lojaAtual]}\n`;
    conclusao+=`ğŸ“… Data: ${document.getElementById('data')?.value||'NÃ£o informada'}\n`;
    conclusao+=`ğŸ‘¤ Encarregado: ${document.getElementById('encarregado')?.value||'NÃ£o informado'}\n`;
    conclusao+=`ğŸ‘” Gerente: ${document.getElementById('gerente')?.value||'NÃ£o informado'}\n\n`;
    
    // ============================================
    // RESULTADO GERAL
    // ============================================
    conclusao+="ğŸ¯ RESULTADO GERAL\n";
    conclusao+="â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n";
    conclusao+=`PontuaÃ§Ã£o: ${total}/21 pontos | ClassificaÃ§Ã£o: ${classificacao}\n`;
    conclusao+=`DiagnÃ³stico: ${nivelDesempenho}\n\n`;
    
    // ============================================
    // âœ… PONTOS POSITIVOS (mÃ¡ximo 8 itens)
    // ============================================
    if(pontosFortes.length>0){
        conclusao+="âœ… PONTOS POSITIVOS\n";
        conclusao+="â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n";
        pontosFortes.slice(0,8).forEach((pf,i)=>{
            conclusao+=`${i+1}. ${pf.item}\n`;
        });
        conclusao+="\n";
    }
    
    // ============================================
    // âŒ PONTOS NEGATIVOS (sem plano de aÃ§Ã£o)
    // ============================================
    if(problemasModerados.length>0){
        conclusao+="âš ï¸ PONTOS NEGATIVOS (NÃ£o CrÃ­ticos)\n";
        conclusao+="â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n";
        problemasModerados.forEach((prob,i)=>{
            conclusao+=`${i+1}. ${prob.item}\n`;
            conclusao+=`   SituaÃ§Ã£o: ${prob.status}\n\n`;
        });
    }
    
    // ============================================
    // ğŸš¨ PONTOS CRÃTICOS COM PLANO DE AÃ‡ÃƒO
    // ============================================
    if(problemasCriticos.length>0){
        conclusao+="ğŸš¨ PONTOS CRÃTICOS - REQUEREM PLANO DE AÃ‡ÃƒO IMEDIATO\n";
        conclusao+="â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n";
        
        const acoesDetalhadas={
            nf:{acao:"Priorizar recebimento no sistema em atÃ© 24h | Implementar conferÃªncia em determinados horÃ¡rios Ex:(9h as 15h)",prazo:"24h",resp:"Encarregado"},
            cx:{acao:"Estabelecer protocolo de abertura no mesmo dia | Designar responsÃ¡vel pela conferÃªncia",prazo:"Imediato",resp:"Encarregado"},
            er:{acao:"Revisar processo com equipe | Implementar dupla conferÃªncia",prazo:"48h",resp:"Ecarregado/Gerente"},
            et:{acao:"Organizar fila por prioridade (novidades primeiro) | Meta: etiquetagem em 24h",prazo:"24h",resp:"Encarregado"},
            imp:{acao:"Realizar teste antes de processar lotes | Verificar configuraÃ§Ãµes e calibragem",prazo:"Imediato",resp:"Encarregado"},
            arg:{acao:"Solicitar tÃ©cnico T.I urgente | Realizar limpeza preventiva | Providenciar backup",prazo:"24h",resp:"Gerente"},
            limpo:{acao:"Organizar limpeza completa | Cronograma semanal (sextas) | Definir responsÃ¡vel",prazo:"48h",resp:"Encarregado"},
            pc:{acao:"Reorganizar seguindo 5S | Sistema de arquivamento papÃ©is | Apenas docs do dia na mesa",prazo:"48h",resp:"Encarregado"},
            check:{acao:"ReforÃ§ar treinamento | HorÃ¡rios fixos (inÃ­cio e fim do dia) | Acompanhamento diÃ¡rio",prazo:"Imediato",resp:"Encarregado/Gerente"},
            c1:{acao:"Incluir alinhamento na rotina | Designar responsÃ¡vel | PadrÃ£o visual de referÃªncia",prazo:"Imediato",resp:"Encarregado"},
            c2:{acao:"Implementar numeraÃ§Ã£o padrÃ£o | Placas visÃ­veis | Desenvolver mapa visual",prazo:"5 dias",resp:"Encarregado/Gerente"},
            c3:{acao:"Reorganizar respeitando setorizaÃ§Ã£o | Revisar critÃ©rios | SinalizaÃ§Ã£o visual",prazo:"48h",resp:"Encarregado"},
            c4:{acao:"Remover obstruÃ§Ãµes IMEDIATAMENTE | PolÃ­tica: corredores sempre livres",prazo:"Imediato",resp:"Encarregado"},
            f1:{acao:"Reorganizar: marca > modelo > numeraÃ§Ã£o | IdentificaÃ§Ã£o visual | Capacitar equipe",prazo:"48h",resp:"Encarregado"},
            f2:{acao:"Adequar Ã s boas prÃ¡ticas | Providenciar araras e suportes | ProteÃ§Ã£o contra poeira",prazo:"5 dias",resp:"Gerente"},
            g1:{acao:"Criar Ã¡rea exclusiva | Rotina de verificaÃ§Ã£o",prazo:"24h",resp:"Encarregado"},
            g2:{acao:"Realizar transferÃªncia pendente urgente | Rotina semanal | Documentar itens",prazo:"48h",resp:"Encarregado"},
            t1:{acao:"Revisar procedimento | ConferÃªncia cruzada: documento x sistema | Checklist",prazo:"24h",resp:"Encarregado"},
            t2:{acao:"Priorizar pendentes mais antigos | Rotina semanal de acompanhamento | CapacitaÃ§Ã£o",prazo:"48h",resp:"Encarregado"},
            t3:{acao:"ConferÃªncia completa dos lotes | Finalizar dentro dos prazos | ReforÃ§ar capacitaÃ§Ã£o",prazo:"48h",resp:"Encarregado"},
            t4:{acao:"Identificar e separar pÃ©s de vitrine | Criar Ã¡rea especÃ­fica | Integrar no recebimento",prazo:"24h",resp:"Encarregado"}
        };
        
        problemasCriticos.forEach((prob,idx)=>{
            Object.keys(descricoes).forEach(id=>{
                if(descricoes[id].texto===prob.item && acoesDetalhadas[id]){
                    conclusao+=`${idx+1}. PROBLEMA: ${prob.item}\n`;
                    conclusao+=`   â””â”€ SeÃ§Ã£o: ${prob.secao}\n`;
                    conclusao+=`   â””â”€ Status Atual: ${prob.status}\n\n`;
                    conclusao+=`   ğŸ“‹ PLANO DE AÃ‡ÃƒO:\n`;
                    conclusao+=`   ${acoesDetalhadas[id].acao}\n\n`;
                    conclusao+=`   â° Prazo: ${acoesDetalhadas[id].prazo} | ğŸ‘¤ ResponsÃ¡vel: ${acoesDetalhadas[id].resp}\n`;
                    conclusao+=`   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\n`;
                }
            });
        });
    }
    
    // ============================================
    // RECOMENDAÃ‡ÃƒO FINAL
    // ============================================
    conclusao+="ğŸ“Œ RECOMENDAÃ‡ÃƒO GERAL\n";
    conclusao+="â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n";
    conclusao+=`${recomendacaoGeral}\n\n`;
    
    // Cronograma baseado na classificaÃ§Ã£o
    if(total>=18){
        conclusao+="ğŸ“… PrÃ³xima auditoria: 7 dias\n";
    }else if(total>=14){
        conclusao+="ğŸ“… PrÃ³xima auditoria: 7 dias | Acompanhamento semanal\n";
    }else if(total>=10){
        conclusao+="ğŸ“… ReuniÃ£o de alinhamento: 48h | Auditoria: 7 dias | Acompanhamento DIÃRIO\n";
    }else{
        conclusao+="ğŸš¨ URGENTE: ReuniÃ£o IMEDIATA com gerÃªncia | Acompanhamento DIÃRIO | Auditoria: 3 dias\n";
    }
    
    conclusao+="\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n";
    conclusao+=`Gerado em: ${new Date().toLocaleString('pt-BR')}\n`;
    conclusao+="Sistema de GestÃ£o de Qualidade - Shoemix CalÃ§ados\n";
    conclusao+="â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•";
    
    document.getElementById('conclusao').value=conclusao;
    
    let emoji=total>=18?"ğŸŸ¢":total>=14?"ğŸ”µ":total>=10?"ğŸŸ¡":"ğŸ”´";
    alert(`âœ… RelatÃ³rio Executivo Gerado!\n\n${emoji} ClassificaÃ§Ã£o: ${classificacao}\nğŸ“Š PontuaÃ§Ã£o: ${total}/21\n\nâœ… ${pontosFortes.length} pontos fortes\nğŸš¨ ${problemasCriticos.length} itens crÃ­ticos\nğŸ’¡ ${problemasModerados.length} melhorias sugeridas`);
}
function scrollParaConclusao(){const conclusaoEl=document.getElementById('conclusao');if(conclusaoEl){conclusaoEl.scrollIntoView({behavior:'smooth',block:'center'});setTimeout(()=>{gerarConclusaoAutomatica()},800)}else{alert('âš ï¸ Por favor, role a pÃ¡gina atÃ© a seÃ§Ã£o "ConclusÃ£o da Visita"');gerarConclusaoAutomatica()}}
// Inicializa IndexedDB antes de tudo
(async function() {
    try {
        await initDB();
        console.log('âœ… IndexedDB inicializado');
        
        criarTabs();
        montarTela();
        
        // ğŸ†• AUTO-RECUPERAÃ‡ÃƒO: Carrega rascunho automaticamente
        setTimeout(() => {
            const rascunho = localStorage.getItem("shoemix_"+lojaAtual);
            if (rascunho) {
                console.log('ğŸ“‹ Rascunho encontrado - recuperando automaticamente...');
                
                // Mostra indicador de recuperaÃ§Ã£o
                const indicador = document.createElement('div');
                indicador.style.cssText = `
                    position: fixed;
                    top: 20px;
                    left: 50%;
                    transform: translateX(-50%);
                    background: #17a2b8;
                    color: white;
                    padding: 12px 24px;
                    border-radius: 8px;
                    font-weight: 600;
                    z-index: 10000;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                `;
                indicador.innerHTML = 'ğŸ”„ Recuperando rascunho salvo...';
                document.body.appendChild(indicador);
                
                // Carrega o rascunho
                carregar();
                
                setTimeout(() => {
                    indicador.innerHTML = 'âœ… Rascunho recuperado!';
                    indicador.style.background = '#28a745';
                    setTimeout(() => {
                        indicador.style.opacity = '0';
                        indicador.style.transition = 'opacity 0.3s ease';
                        setTimeout(() => indicador.remove(), 300);
                    }, 2000);
                }, 500);
            }
            
            // ğŸ†• Mostra indicador de auto-save por 10 segundos
            const autosaveInfo = document.getElementById('autosaveInfo');
            if (autosaveInfo) {
                setTimeout(() => {
                    autosaveInfo.style.opacity = '0';
                    autosaveInfo.style.transition = 'opacity 0.5s ease';
                    setTimeout(() => autosaveInfo.style.display = 'none', 500);
                }, 10000); // Esconde apÃ³s 10 segundos
            }
        }, 500);
        
        // ğŸ†• AUTO-SAVE PERIÃ“DICO: Salva automaticamente a cada 30 segundos
        setInterval(() => {
            const dados = {};
            let temDados = false;
            
            // Verifica se tem algum dado preenchido
            document.querySelectorAll("input[type=text],input[type=number],textarea,select").forEach(el => {
                if (el.id && !el.classList.contains('pts') && el.value && el.value.trim()) {
                    temDados = true;
                }
            });
            
            // SÃ³ salva se tiver algum dado
            if (temDados) {
                console.log('ğŸ’¾ Auto-save periÃ³dico (30s)');
                salvar(false); // Salva sem mostrar alerta
            }
        }, 30000); // 30 segundos
        
    } catch(error) {
        console.error('âŒ Erro ao inicializar IndexedDB:', error);
        alert('âš ï¸ Seu navegador nÃ£o suporta armazenamento avanÃ§ado. Use um navegador moderno.');
        
        // Continua sem IndexedDB (fallback)
        criarTabs();
        montarTela();
    }
})();
criarTabs();
montarTela();

// ğŸ†• INICIALIZA INDICADOR DE ARMAZENAMENTO
setTimeout(() => {
    atualizarIndicadorArmazenamento();
}, 1000);

// ğŸ†• INICIALIZA INDICADOR DE SINCRONIZAÃ‡ÃƒO
setTimeout(() => {
    inicializarIndicadorSync();
}, 1500);


// SOLUÃ‡ÃƒO PARA IMPRESSÃƒO DA CONCLUSÃƒO
window.addEventListener('beforeprint', function() {
  const conclusao = document.getElementById('conclusao');
  if (conclusao && conclusao.value) {
    const divImpressao = document.createElement('div');
    divImpressao.id = 'conclusao-impressao';
    divImpressao.style.cssText = 'font-size:0.8em;font-family:Arial,sans-serif;line-height:1.4;padding:10px;border:2px solid #f00;margin:10px 0 20px 0;white-space:pre-wrap;word-wrap:break-word;page-break-inside:auto;background:white';
    divImpressao.textContent = conclusao.value;
    
    conclusao.style.display = 'none';
    conclusao.parentNode.insertBefore(divImpressao, conclusao);
    
    // ESCONDE TODOS OS LABELS DA SEÃ‡ÃƒO DE CONCLUSÃƒO
    const secaoConclusao = conclusao.closest('.section');
    if (secaoConclusao) {
      secaoConclusao.querySelectorAll('label').forEach(label => {
        label.style.display = 'none';
      });
    }
  }
});

window.addEventListener('afterprint', function() {
  const conclusao = document.getElementById('conclusao');
  const divImpressao = document.getElementById('conclusao-impressao');
  
  if (divImpressao) {
    divImpressao.remove();
  }
  if (conclusao) {
    conclusao.style.display = 'block';
    
    // RESTAURA OS LABELS
    const secaoConclusao = conclusao.closest('.section');
    if (secaoConclusao) {
      secaoConclusao.querySelectorAll('label').forEach(label => {
        label.style.display = 'block';
      });
    }
  }
});

window.addEventListener('afterprint', function() {
  const conclusao = document.getElementById('conclusao');
  const divImpressao = document.getElementById('conclusao-impressao');
  
  if (divImpressao) {
    divImpressao.remove();
  }
  if (conclusao) {
    conclusao.style.display = 'block';
  }
  
  // Restaura o comportamento da seÃ§Ã£o
  const secaoConclusao = conclusao?.closest('.section');
  if (secaoConclusao) {
    secaoConclusao.style.pageBreakBefore = '';
    secaoConclusao.style.pageBreakInside = '';
    secaoConclusao.style.pageBreakAfter = '';
  }
});

// Inicializa indicador de armazenamento ao carregar a pÃ¡gina
setTimeout(() => {
  atualizarIndicadorArmazenamento();
}, 1000);

// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// ğŸ†• MELHORIAS IMPLEMENTADAS v2.1 - CORRIGIDO
// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 1ï¸âƒ£ SISTEMA DE NOTIFICAÃ‡Ã•ES (TOAST)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function mostrarToast(msg, tipo = 'sucesso') {
    document.querySelectorAll('.toast').forEach(t => t.remove());
    const toast = document.createElement('div');
    toast.className = `toast ${tipo === 'erro' ? 'erro' : tipo === 'aviso' ? 'aviso' : ''}`;
    toast.textContent = msg;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
}

// ğŸ†• MODAL DE PROGRESSO DA TRANSFERÃŠNCIA
function mostrarModalTransferencia() {
    const modal = document.createElement('div');
    modal.id = 'modalTransferenciaFotos';
    modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        z-index: 99999;
        display: flex;
        align-items: center;
        justify-content: center;
    `;
    
    modal.innerHTML = `
        <div style="
            background: white;
            padding: 40px;
            border-radius: 16px;
            text-align: center;
            max-width: 400px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        ">
            <div style="font-size: 4em; margin-bottom: 20px; animation: pulse 1.5s infinite;">â˜ï¸</div>
            <h2 style="color: #4285f4; margin: 0 0 10px 0;">Transferindo Fotos</h2>
            <p style="color: #666; margin: 0 0 10px 0;" id="progressText">Preparando...</p>
            <p style="color: #999; margin: 0 0 20px 0; font-size: 0.9em;" id="progressCounter">0 de 0</p>
            <div style="
                width: 100%;
                height: 8px;
                background: #e0e0e0;
                border-radius: 4px;
                overflow: hidden;
                margin-bottom: 20px;
            ">
                <div id="progressBar" style="
                    width: 0%;
                    height: 100%;
                    background: linear-gradient(90deg, #4285f4, #34a853);
                    transition: width 0.3s ease;
                "></div>
            </div>
            <div style="font-size: 0.85em; color: #999; margin-bottom: 15px;">
                â±ï¸ Aguarde... (mÃ¡x. 30 segundos)
            </div>
            <button onclick="cancelarTransferencia()" style="
                background: #dc3545;
                color: white;
                border: none;
                padding: 10px 20px;
                border-radius: 6px;
                cursor: pointer;
                font-weight: 600;
                font-size: 0.9em;
            ">âœ• Cancelar e Manter Local</button>
        </div>
    `;
    
    // Adiciona animaÃ§Ãµes
    const style = document.createElement('style');
    style.textContent = `
        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.8; }
        }
    `;
    document.head.appendChild(style);
    
    document.body.appendChild(modal);
    return modal;
}

// ğŸ†• ATUALIZA PROGRESSO DO MODAL
function atualizarModalProgresso(modal, atual, total) {
    if (!modal) return;
    
    const progressText = modal.querySelector('#progressText');
    const progressCounter = modal.querySelector('#progressCounter');
    const progressBar = modal.querySelector('#progressBar');
    
    if (progressText) {
        progressText.textContent = `Enviando foto ${atual} de ${total}...`;
    }
    
    if (progressCounter) {
        progressCounter.textContent = `${atual} de ${total}`;
    }
    
    if (progressBar) {
        const porcentagem = (atual / total) * 100;
        progressBar.style.width = porcentagem + '%';
    }
}

// ğŸ†• CANCELAR TRANSFERÃŠNCIA
window.cancelarTransferencia = function() {
    const modal = document.getElementById('modalTransferenciaFotos');
    if (modal) {
        modal.remove();
    }
    console.log('âš ï¸ TransferÃªncia cancelada pelo usuÃ¡rio');
    alert(
        'âš ï¸ TransferÃªncia cancelada!\n\n' +
        'As fotos permanecem salvas no IndexedDB.\n\n' +
        'VocÃª pode transferi-las mais tarde salvando a visita novamente.'
    );
};


// ğŸ†• MODAL DE SUCESSO DA TRANSFERÃŠNCIA
function mostrarModalSucessoTransferencia(quantidade, espacoLiberado) {
    const espacoMB = (espacoLiberado / 1024 / 1024).toFixed(2);
    
    const modal = document.createElement('div');
    modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.85);
        z-index: 99999;
        display: flex;
        align-items: center;
        justify-content: center;
        animation: fadeIn 0.3s ease;
    `;
    
    modal.innerHTML = `
        <div style="
            background: white;
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            max-width: 500px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.4);
            animation: slideUp 0.4s ease;
        ">
            <div style="
                width: 80px;
                height: 80px;
                margin: 0 auto 20px;
                background: linear-gradient(135deg, #34a853, #0f9d58);
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 3em;
                animation: checkmark 0.6s ease;
            ">âœ“</div>
            
            <h2 style="color: #34a853; margin: 0 0 15px 0; font-size: 1.8em;">
                TransferÃªncia ConcluÃ­da!
            </h2>
            
            <div style="
                background: #f0f7f4;
                border-left: 4px solid #34a853;
                padding: 20px;
                margin: 20px 0;
                border-radius: 8px;
                text-align: left;
            ">
                <div style="display: flex; align-items: center; margin-bottom: 15px;">
                    <span style="font-size: 2em; margin-right: 15px;">â˜ï¸</span>
                    <div>
                        <strong style="color: #333; font-size: 1.2em;">${quantidade} foto${quantidade > 1 ? 's' : ''}</strong>
                        <div style="color: #666; font-size: 0.9em;">Enviada${quantidade > 1 ? 's' : ''} para o Google Drive</div>
                    </div>
                </div>
                
                <div style="display: flex; align-items: center;">
                    <span style="font-size: 2em; margin-right: 15px;">ğŸ’¾</span>
                    <div>
                        <strong style="color: #333; font-size: 1.2em;">${espacoMB} MB</strong>
                        <div style="color: #666; font-size: 0.9em;">Liberados no navegador</div>
                    </div>
                </div>
            </div>
            
            <div style="
                background: #e8f4fd;
                border-left: 4px solid #4285f4;
                padding: 15px;
                margin: 20px 0;
                border-radius: 8px;
                text-align: left;
                font-size: 0.9em;
            ">
                <strong style="color: #1967d2;">âœ¨ BenefÃ­cios:</strong>
                <ul style="margin: 10px 0 0 20px; color: #555;">
                    <li>Fotos seguras na nuvem</li>
                    <li>EspaÃ§o do navegador liberado</li>
                    <li>Acesso de qualquer dispositivo</li>
                </ul>
            </div>
            
            <button onclick="this.closest('div').parentElement.remove()" style="
                background: linear-gradient(135deg, #34a853, #0f9d58);
                color: white;
                border: none;
                padding: 15px 40px;
                border-radius: 8px;
                font-size: 1.1em;
                font-weight: 600;
                cursor: pointer;
                margin-top: 10px;
                box-shadow: 0 4px 12px rgba(52, 168, 83, 0.3);
                transition: all 0.3s ease;
            " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(52, 168, 83, 0.4)'" 
               onmouseout="this.style.transform=''; this.style.boxShadow='0 4px 12px rgba(52, 168, 83, 0.3)'">
                âœ“ Entendido
            </button>
        </div>
    `;
    
    // Adiciona animaÃ§Ãµes
    const style = document.createElement('style');
    style.textContent = `
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes slideUp {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        @keyframes checkmark {
            0% { transform: scale(0) rotate(-45deg); }
            50% { transform: scale(1.2) rotate(0deg); }
            100% { transform: scale(1) rotate(0deg); }
        }
    `;
    document.head.appendChild(style);
    
    document.body.appendChild(modal);
    
    // Auto-fecha apÃ³s 15 segundos
    setTimeout(() => {
        if (modal.parentNode) {
            modal.style.animation = 'fadeOut 0.3s ease';
            setTimeout(() => modal.remove(), 300);
        }
    }, 15000);
}


// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// ğŸ†• FUNÃ‡Ã•ES DE CONTROLE DO INDICADOR DE SINCRONIZAÃ‡ÃƒO
// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

/**
 * Atualiza o indicador visual de sincronizaÃ§Ã£o
 * @param {string} status - 'idle', 'syncing', 'success', 'error'
 * @param {string} message - Mensagem a exibir
 */
function atualizarIndicadorSync(status, message) {
    const indicator = document.getElementById('syncIndicator');
    const dot = document.getElementById('syncDot');
    const text = document.getElementById('syncText');
    
    if (!indicator || !dot || !text) return;
    
    // Mostra o indicador se estiver configurado
    if (CONFIG_SYNC && CONFIG_SYNC.metodo) {
        indicator.style.display = 'flex';
    }
    
    // Remove classes anteriores
    indicator.classList.remove('syncing', 'error');
    dot.classList.remove('syncing', 'error');
    
    // Aplica novo status
    switch (status) {
        case 'syncing':
            indicator.classList.add('syncing');
            dot.classList.add('syncing');
            break;
        case 'error':
            indicator.classList.add('error');
            dot.classList.add('error');
            break;
        case 'success':
            // Remove todas as classes (volta ao verde)
            break;
        case 'idle':
        default:
            // Estado padrÃ£o
            break;
    }
    
    text.textContent = message;
    console.log(`ğŸ”„ Sync Status: ${status} - ${message}`);
}

/**
 * Mostra/oculta o indicador de sincronizaÃ§Ã£o
 */
function toggleIndicadorSync(mostrar) {
    const indicator = document.getElementById('syncIndicator');
    if (indicator) {
        indicator.style.display = mostrar ? 'flex' : 'none';
    }
}

/**
 * Inicializa o indicador de sincronizaÃ§Ã£o
 */
function inicializarIndicadorSync() {
    if (CONFIG_SYNC && CONFIG_SYNC.metodo) {
        toggleIndicadorSync(true);
        atualizarIndicadorSync('idle', 'Conectado');
    } else {
        toggleIndicadorSync(false);
    }
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 2ï¸âƒ£ VALIDAÃ‡ÃƒO PREVENTIVA (OPCIONAL E INTELIGENTE)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function validarCamposObrigatorios() {
    // Busca os campos dinamicamente
    const campoData = document.querySelector('input[name="data"]') || document.getElementById('data');
    const campoResponsavel = document.querySelector('input[name="responsavel"]') || document.getElementById('responsavel');
    const campoLoja = document.querySelector('input[name="loja"]') || document.querySelector('select[name="loja"]');
    
    const camposParaValidar = [];
    
    // SÃ³ valida campos que existem e estÃ£o visÃ­veis
    if (campoData && campoData.offsetParent !== null) {
        camposParaValidar.push({ campo: campoData, nome: 'Data', valor: campoData.value });
    }
    if (campoResponsavel && campoResponsavel.offsetParent !== null) {
        camposParaValidar.push({ campo: campoResponsavel, nome: 'ResponsÃ¡vel', valor: campoResponsavel.value });
    }
    if (campoLoja && campoLoja.offsetParent !== null) {
        camposParaValidar.push({ campo: campoLoja, nome: 'Loja', valor: campoLoja.value });
    }
    
    // Se nÃ£o encontrou campos, nÃ£o valida (evita erro)
    if (camposParaValidar.length === 0) {
        console.log('â„¹ï¸ Nenhum campo obrigatÃ³rio encontrado para validar');
        return true;
    }
    
    const camposVazios = camposParaValidar.filter(item => !item.valor || item.valor.trim() === '');
    
    if (camposVazios.length > 0) {
        const nomes = camposVazios.map(item => item.nome).join(', ');
        
        // Destaca campos vazios
        camposVazios.forEach(item => {
            item.campo.classList.add('campo-obrigatorio');
            item.campo.classList.remove('campo-valido');
        });
        
        // Destaca campos preenchidos
        camposParaValidar.filter(item => item.valor && item.valor.trim() !== '').forEach(item => {
            item.campo.classList.remove('campo-obrigatorio');
            item.campo.classList.add('campo-valido');
        });
        
        mostrarToast(`âš ï¸ Preencha: ${nomes}`, 'aviso');
        
        // Scroll suave para o primeiro campo vazio
        if (camposVazios[0].campo) {
            camposVazios[0].campo.scrollIntoView({ behavior: 'smooth', block: 'center' });
            setTimeout(() => camposVazios[0].campo.focus(), 500);
        }
        
        return false;
    }
    
    // Remove destacaÃ§Ã£o de todos os campos se tudo OK
    camposParaValidar.forEach(item => {
        item.campo.classList.remove('campo-obrigatorio');
        item.campo.classList.add('campo-valido');
    });
    
    return true;
}

// Adiciona validaÃ§Ã£o em tempo real (opcional)
function adicionarValidacaoTempoReal() {
    const campos = [
        document.querySelector('input[name="data"]') || document.getElementById('data'),
        document.querySelector('input[name="responsavel"]') || document.getElementById('responsavel'),
        document.querySelector('input[name="loja"]') || document.querySelector('select[name="loja"]')
    ];
    
    campos.forEach(campo => {
        if (campo) {
            campo.addEventListener('input', () => {
                if (campo.value && campo.value.trim()) {
                    campo.classList.remove('campo-obrigatorio');
                    campo.classList.add('campo-valido');
                } else {
                    campo.classList.remove('campo-valido');
                }
            });
            
            campo.addEventListener('change', () => {
                if (campo.value && campo.value.trim()) {
                    campo.classList.remove('campo-obrigatorio');
                    campo.classList.add('campo-valido');
                } else {
                    campo.classList.remove('campo-valido');
                }
            });
        }
    });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 3ï¸âƒ£ BACKUP AUTOMÃTICO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let ultimoBackup = localStorage.getItem('ultimoBackup') ? new Date(localStorage.getItem('ultimoBackup')) : null;

function criarIndicadorBackup() {
    const indicador = document.createElement('div');
    indicador.className = 'backup-status';
    indicador.id = 'backup-status';
    indicador.innerHTML = 'ğŸ’¾ Backup: Nunca';
    document.body.appendChild(indicador);
    atualizarIndicadorBackup();
}

function atualizarIndicadorBackup() {
    const indicador = document.getElementById('backup-status');
    if (!indicador) return;
    
    if (ultimoBackup) {
        const diffMin = Math.floor((Date.now() - ultimoBackup.getTime()) / 60000);
        indicador.innerHTML = `ğŸ’¾ Backup: hÃ¡ ${diffMin} min`;
        indicador.classList.remove('erro');
    } else {
        indicador.innerHTML = 'ğŸ’¾ Backup: Nunca';
        indicador.classList.add('erro');
    }
    
    indicador.classList.add('show');
    setTimeout(() => indicador.classList.remove('show'), 3000);
}

async function realizarBackupAutomatico() {
    try {
        const dadosBackup = {
            timestamp: Date.now(),
            lojaAtual: window.lojaAtual || '',
            respostas: {}
        };
        
        // Captura todos os inputs e selects
        document.querySelectorAll('input[type="text"], input[type="number"], input[type="date"], textarea, select').forEach(campo => {
            if (campo.name || campo.id) {
                const chave = campo.name || campo.id;
                if (campo.value) {
                    dadosBackup.respostas[chave] = campo.value;
                }
            }
        });
        
        // Captura radios
        document.querySelectorAll('input[type="radio"]:checked').forEach(radio => {
            if (radio.name) {
                dadosBackup.respostas[radio.name] = radio.value;
            }
        });
        
        const chaveBackup = `backup_auditoria_${Date.now()}`;
        localStorage.setItem(chaveBackup, JSON.stringify(dadosBackup));
        localStorage.setItem('ultimoBackup', new Date().toISOString());
        
        limparBackupsAntigos();
        ultimoBackup = new Date();
        atualizarIndicadorBackup();
        
        console.log('âœ… Backup automÃ¡tico:', new Date().toLocaleTimeString());
    } catch (error) {
        console.error('âŒ Erro no backup:', error);
    }
}

function limparBackupsAntigos() {
    try {
        const chaves = Object.keys(localStorage).filter(k => k.startsWith('backup_auditoria_'));
        chaves.sort((a, b) => parseInt(b.split('_').pop()) - parseInt(a.split('_').pop()));
        chaves.slice(5).forEach(chave => {
            try {
                localStorage.removeItem(chave);
            } catch (e) {
                console.warn('Erro ao remover backup:', e);
            }
        });
    } catch (error) {
        console.error('Erro ao limpar backups:', error);
    }
}

function restaurarUltimoBackup() {
    try {
        const chaves = Object.keys(localStorage).filter(k => k.startsWith('backup_auditoria_'));
        if (chaves.length === 0) {
            mostrarToast('âš ï¸ Nenhum backup encontrado', 'aviso');
            return;
        }
        
        chaves.sort((a, b) => parseInt(b.split('_').pop()) - parseInt(a.split('_').pop()));
        const dadosBackup = JSON.parse(localStorage.getItem(chaves[0]));
        
        if (confirm(`ğŸ”„ Restaurar backup de ${new Date(dadosBackup.timestamp).toLocaleString()}?`)) {
            let restaurados = 0;
            
            Object.entries(dadosBackup.respostas).forEach(([chave, valor]) => {
                // Tenta por name primeiro, depois por id
                let campo = document.querySelector(`[name="${chave}"]`) || document.getElementById(chave);
                
                if (campo) {
                    if (campo.type === 'radio') {
                        const radio = document.querySelector(`[name="${chave}"][value="${valor}"]`);
                        if (radio) {
                            radio.checked = true;
                            restaurados++;
                        }
                    } else {
                        campo.value = valor;
                        restaurados++;
                        
                        // Dispara evento change para atualizar interface
                        campo.dispatchEvent(new Event('change', { bubbles: true }));
                        campo.dispatchEvent(new Event('input', { bubbles: true }));
                    }
                }
            });
            
            mostrarToast(`âœ… ${restaurados} campos restaurados!`, 'sucesso');
        }
    } catch (error) {
        console.error('Erro ao restaurar backup:', error);
        mostrarToast('âŒ Erro ao restaurar backup', 'erro');
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ¯ INICIALIZAÃ‡ÃƒO DAS MELHORIAS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
setTimeout(() => {
    console.log('ğŸš€ Inicializando melhorias v2.1...');
    
    try {
        // 1. Criar indicador de backup
        criarIndicadorBackup();
        
        // 2. Iniciar backup automÃ¡tico (5 minutos)
        setInterval(realizarBackupAutomatico, 5 * 60 * 1000);
        setTimeout(realizarBackupAutomatico, 30000); // Primeiro backup em 30s
        
        // 3. Adicionar botÃ£o de restaurar dentro da aba "Mais"
        const abaInterno = document.querySelector('.toolbar-mais-interno');
        if (abaInterno) {
            const btn = document.createElement('button');
            btn.className = 'action';
            btn.textContent = 'ğŸ”„ Restaurar Backup';
            btn.onclick = restaurarUltimoBackup;
            abaInterno.appendChild(btn);
        }
        
        // 4. Adicionar botÃ£o de validaÃ§Ã£o dentro da aba "Mais"
        if (abaInterno) {
            const btnValidar = document.createElement('button');
            btnValidar.className = 'action';
            btnValidar.textContent = 'âœ”ï¸ Validar Campos';
            btnValidar.style.background = '#ffc107';
            btnValidar.style.color = '#000';
            btnValidar.onclick = () => {
                if (validarCamposObrigatorios()) {
                    mostrarToast('âœ… Todos os campos OK!', 'sucesso');
                }
            };
            abaInterno.appendChild(btnValidar);
        }
        
        // 5. Adicionar validaÃ§Ã£o em tempo real (destaque visual)
        adicionarValidacaoTempoReal();
        
        console.log('âœ… Melhorias carregadas!');
        // Mensagem inicial removida - apenas indicador de conexÃ£o serÃ¡ mostrado
        
    } catch (error) {
        console.error('âŒ Erro ao inicializar melhorias:', error);
    }
    
}, 2000);



// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// ğŸŒ INDICADOR DE CONEXÃƒO ONLINE/OFFLINE
// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

function criarIndicadorConexao() {
    const indicador = document.createElement('div');
    indicador.id = 'indicador-conexao';
    indicador.className = 'indicador-conexao';
    
    // Define estado inicial
    const online = navigator.onLine;
    indicador.className = `indicador-conexao ${online ? 'online' : 'offline'}`;
    indicador.innerHTML = `
        <span class="status-icone">${online ? 'ğŸŸ¢' : 'ğŸ”´'}</span>
        <span class="status-texto">${online ? 'ONLINE' : 'OFFLINE'}</span>
    `;
    
    document.body.appendChild(indicador);
    
    // Mostra por 3 segundos ao carregar
    setTimeout(() => {
        indicador.classList.add('show');
    }, 500);
    
    setTimeout(() => {
        indicador.classList.remove('show');
    }, 5000);
}

function atualizarIndicadorConexao(online) {
    const indicador = document.getElementById('indicador-conexao');
    if (!indicador) return;
    
    // Remove classes anteriores
    indicador.classList.remove('online', 'offline');
    
    // Adiciona nova classe
    indicador.classList.add(online ? 'online' : 'offline');
    
    // Atualiza conteÃºdo
    indicador.innerHTML = `
        <span class="status-icone">${online ? 'ğŸŸ¢' : 'ğŸ”´'}</span>
        <span class="status-texto">${online ? 'ONLINE' : 'OFFLINE'}</span>
    `;
    
    // Mostra o indicador
    indicador.classList.add('show');
    
    // MantÃ©m visÃ­vel por mais tempo se ficar offline
    const tempoVisivel = online ? 4000 : 10000; // 4s online, 10s offline
    
    setTimeout(() => {
        indicador.classList.remove('show');
    }, tempoVisivel);
    
    // Mostra toast tambÃ©m
    if (online) {
        mostrarToast('ğŸŸ¢ Online - Sistema pronto', 'sucesso');
    } else {
        mostrarToast('ğŸ”´ Sem conexÃ£o - Trabalhando OFFLINE', 'erro');
    }
}

// Listeners para mudanÃ§as de conexÃ£o
window.addEventListener('online', () => {
    console.log('âœ… ConexÃ£o restaurada');
    atualizarIndicadorConexao(true);
});

window.addEventListener('offline', () => {
    console.log('âŒ ConexÃ£o perdida');
    atualizarIndicadorConexao(false);
});

// VerificaÃ§Ã£o periÃ³dica (a cada 30 segundos)
let ultimoEstadoConexao = navigator.onLine;

function verificarConexaoPeriodica() {
    const estadoAtual = navigator.onLine;
    
    // Se mudou de estado, atualiza
    if (estadoAtual !== ultimoEstadoConexao) {
        atualizarIndicadorConexao(estadoAtual);
        ultimoEstadoConexao = estadoAtual;
    }
}

// Verifica a cada 30 segundos
setInterval(verificarConexaoPeriodica, 30000);

// FunÃ§Ã£o para mostrar/esconder manualmente o indicador
function toggleIndicadorConexao() {
    const indicador = document.getElementById('indicador-conexao');
    if (indicador) {
        if (indicador.classList.contains('show')) {
            indicador.classList.remove('show');
        } else {
            indicador.classList.add('show');
            setTimeout(() => {
                indicador.classList.remove('show');
            }, 4000);
        }
    }
}

// Permite clicar no indicador de storage para mostrar status de conexÃ£o
setTimeout(() => {
    const storageIndicator = document.querySelector('.storage-indicator');
    if (storageIndicator) {
        storageIndicator.style.cursor = 'pointer';
        storageIndicator.title = 'Clique para ver status de conexÃ£o';
        storageIndicator.addEventListener('click', toggleIndicadorConexao);
    }
}, 3000);


// Inicializa indicador de conexÃ£o
setTimeout(() => {
    criarIndicadorConexao();
    console.log('âœ… Indicador de conexÃ£o inicializado');
    
    // Mostra toast de conexÃ£o inicial
    const online = navigator.onLine;
    mostrarToast(
        online ? 'ğŸŸ¢ Online' : 'ğŸ”´ Offline',
        online ? 'sucesso' : 'erro'
    );
}, 2500);



// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// ğŸ“Š DASHBOARD COM GRÃFICOS - DESABILITADO
// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// Dashboard removido conforme solicitaÃ§Ã£o do usuÃ¡rio
// O usuÃ¡rio prefere se basear em todas as visitas, nÃ£o nas Ãºltimas
// CÃ³digo comentado para possÃ­vel reativaÃ§Ã£o futura

/*
let chartEvolucao = null; // ReferÃªncia ao grÃ¡fico

// FunÃ§Ã£o para criar Dashboard com GrÃ¡fico de EvoluÃ§Ã£o
function criarDashboardGraficos() {
    const container = document.createElement('div');
    container.className = 'dashboard-moderno';
    container.innerHTML = `
        <div class="dashboard-header">
            <h2 class="dashboard-titulo">ğŸ“Š Dashboard de Performance</h2>
            <div class="dashboard-periodo">Ãšltimos 6 meses</div>
        </div>
        
        <!-- Cards de EstatÃ­sticas -->
        <div class="stats-grid">
            <div class="stat-card-moderno">
                <div class="stat-label-moderno">PontuaÃ§Ã£o Atual</div>
                <div class="stat-numero-grande" id="stat-atual">--</div>
                <div class="stat-tendencia">&nbsp;</div>
            </div>
            
            <div class="stat-card-moderno">
                <div class="stat-label-moderno">MÃ©dia Geral</div>
                <div class="stat-numero-grande" id="stat-media">--</div>
                <div class="stat-tendencia">de 21 pontos</div>
            </div>
            
            <div class="stat-card-moderno">
                <div class="stat-label-moderno">Melhor Score</div>
                <div class="stat-numero-grande" id="stat-melhor">--</div>
                <div class="stat-tendencia" id="stat-data-melhor">--</div>
            </div>
            
            <div class="stat-card-moderno">
                <div class="stat-label-moderno">Total Auditorias</div>
                <div class="stat-numero-grande" id="stat-total">--</div>
                <div class="stat-tendencia">este mÃªs</div>
            </div>
        </div>
        
        <!-- GrÃ¡fico de EvoluÃ§Ã£o -->
        <div class="grafico-container">
            <h3 class="grafico-titulo">ğŸ“ˆ EvoluÃ§Ã£o de PontuaÃ§Ãµes</h3>
            <canvas id="graficoEvolucao"></canvas>
        </div>
    `;
    
    return container;
}

// FunÃ§Ã£o para atualizar dados do Dashboard
async function atualizarDashboard() {
    try {
        // Busca dados do histÃ³rico
        const historico = await buscarHistoricoCompleto();
        
        if (!historico || historico.length === 0) {
            console.log('Nenhum histÃ³rico disponÃ­vel para Dashboard');
            return;
        }
        
        // Ordena por data
        historico.sort((a, b) => new Date(a.data) - new Date(b.data));
        
        // Calcula estatÃ­sticas
        const pontuacoes = historico.map(h => h.pontuacao || 0);
        const pontuacaoAtual = pontuacoes[pontuacoes.length - 1];
        const pontuacaoAnterior = pontuacoes.length > 1 ? pontuacoes[pontuacoes.length - 2] : pontuacaoAtual;
        const mediaPontuacao = pontuacoes.reduce((a, b) => a + b, 0) / pontuacoes.length;
        const melhorPontuacao = Math.max(...pontuacoes);
        const indexMelhor = pontuacoes.indexOf(melhorPontuacao);
        const dataMelhor = historico[indexMelhor].data;
        
        // Pega Ãºltimos 6 meses
        const ultimos6Meses = historico.slice(-6);
        
        // Atualiza cards de estatÃ­sticas
        document.getElementById('stat-atual').textContent = pontuacaoAtual;
        document.getElementById('stat-media').textContent = mediaPontuacao.toFixed(1);
        document.getElementById('stat-melhor').textContent = melhorPontuacao;
        document.getElementById('stat-total').textContent = historico.length;
        
        // Formata data corretamente - aceita vÃ¡rios formatos
        try {
            let dataObj;
            
            // Tenta vÃ¡rios formatos de data
            if (typeof dataMelhor === 'string') {
                // Formato dd/mm/yyyy
                if (dataMelhor.includes('/')) {
                    const partes = dataMelhor.split('/');
                    if (partes.length === 3) {
                        dataObj = new Date(partes[2], partes[1] - 1, partes[0]);
                    }
                } 
                // Formato ISO ou timestamp
                else {
                    dataObj = new Date(dataMelhor);
                }
            } else {
                dataObj = new Date(dataMelhor);
            }
            
            // Verifica se a data Ã© vÃ¡lida
            if (dataObj && !isNaN(dataObj.getTime())) {
                document.getElementById('stat-data-melhor').textContent = dataObj.toLocaleDateString('pt-BR');
            } else {
                document.getElementById('stat-data-melhor').textContent = 'Data nÃ£o disponÃ­vel';
            }
        } catch (e) {
            console.error('Erro ao formatar data:', e);
            document.getElementById('stat-data-melhor').textContent = 'Data nÃ£o disponÃ­vel';
        }
        
        // Cria/atualiza grÃ¡fico
        criarGraficoEvolucao(ultimos6Meses);
        
    } catch (error) {
        console.error('Erro ao atualizar dashboard:', error);
    }
}

// FunÃ§Ã£o para criar grÃ¡fico com Chart.js
function criarGraficoEvolucao(dados) {
    const ctx = document.getElementById('graficoEvolucao');
    if (!ctx) return;
    
    // DestrÃ³i grÃ¡fico anterior se existir
    if (chartEvolucao) {
        chartEvolucao.destroy();
    }
    
    // FunÃ§Ã£o auxiliar para converter data em mÃºltiplos formatos
    function converterData(dataInput) {
        if (!dataInput) return null;
        
        let dataObj;
        
        // Se for string com formato dd/mm/yyyy
        if (typeof dataInput === 'string' && dataInput.includes('/')) {
            const partes = dataInput.split(' ')[0].split('/'); // Remove hora se existir
            if (partes.length === 3) {
                const dia = parseInt(partes[0]);
                const mes = parseInt(partes[1]) - 1; // MÃªs Ã© 0-indexed
                const ano = parseInt(partes[2]);
                dataObj = new Date(ano, mes, dia);
            }
        } 
        // Outros formatos (ISO, timestamp, etc)
        else {
            dataObj = new Date(dataInput);
        }
        
        // Valida se a data Ã© vÃ¡lida
        if (dataObj && !isNaN(dataObj.getTime())) {
            return dataObj;
        }
        
        return null;
    }
    
    // Converte e valida todas as datas
    const labels = dados.map(d => {
        const dataObj = converterData(d.data);
        if (dataObj) {
            return dataObj.toLocaleDateString('pt-BR', { day: '2-digit', month: 'short' });
        }
        return 'Data invÃ¡lida';
    });
    
    const pontuacoes = dados.map(d => d.pontuacao || 0);
    
    chartEvolucao = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'PontuaÃ§Ã£o',
                data: pontuacoes,
                borderColor: '#f00',
                backgroundColor: 'rgba(255, 0, 0, 0.1)',
                borderWidth: 3,
                pointRadius: 6,
                pointHoverRadius: 8,
                pointBackgroundColor: '#f00',
                pointBorderColor: '#fff',
                pointBorderWidth: 2,
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    backgroundColor: '#000',
                    titleColor: '#fff',
                    bodyColor: '#fff',
                    borderColor: '#f00',
                    borderWidth: 2,
                    padding: 12,
                    displayColors: false,
                    callbacks: {
                        label: function(context) {
                            return `PontuaÃ§Ã£o: ${context.parsed.y}/21`;
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    max: 21,
                    ticks: {
                        stepSize: 3,
                        font: {
                            size: 12,
                            weight: 'bold'
                        }
                    },
                    grid: {
                        color: 'rgba(0, 0, 0, 0.1)'
                    }
                },
                x: {
                    ticks: {
                        font: {
                            size: 11,
                            weight: 'bold'
                        }
                    },
                    grid: {
                        display: false
                    }
                }
            },
            animation: {
                duration: 1000,
                easing: 'easeInOutQuart'
            }
        }
    });
}
*/

// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// ğŸ† RANKING DE LOJAS
// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

// FunÃ§Ã£o para buscar dados reais das lojas do localStorage ou Google Sheets
// ğŸ†• Agora aceita mesAtual e anoAtual para filtrar por perÃ­odo
async function buscarDadosRankingLojas(mesAtual = null, anoAtual = null) {
    const dadosLojas = [];
    const filtrarPorPeriodo = (mesAtual !== null && anoAtual !== null);
    
    console.log(`ğŸ“Š buscarDadosRankingLojas chamado - Filtro: ${filtrarPorPeriodo ? `${mesAtual+1}/${anoAtual}` : 'TODOS OS TEMPOS'}`);
    
    // Array de lojas do sistema (mesma ordem usada no sistema principal)
    const lojasConfig = [
        { indice: 0, nome: 'LOJA 1', cidade: 'IbatÃ©' },
        { indice: 1, nome: 'LOJA 3', cidade: 'SÃ£o Carlos' },
        { indice: 2, nome: 'LOJA 4', cidade: 'Araraquara' },
        { indice: 3, nome: 'LOJA 5', cidade: 'SÃ£o Carlos' },
        { indice: 4, nome: 'LOJA 6', cidade: 'Pirassununga' },
        { indice: 5, nome: 'LOJA 7', cidade: 'Araraquara' },
        { indice: 6, nome: 'LOJA 8', cidade: 'Araraquara' },
        { indice: 7, nome: 'LOJA 9', cidade: 'A. Brasiliense' }
    ];
    
    // ğŸ”„ Primeiro tenta carregar do Google Sheets (se configurado)
    if (CONFIG_SYNC.metodo === 'google_sheets' && CONFIG_SYNC.googleSheetsUrl) {
        try {
            const visitasSheets = await carregarDadosGoogleSheets();
            
            if (visitasSheets && visitasSheets.length > 0) {
                console.log('ğŸ“Š Usando dados do Google Sheets para ranking');
                
                // Agrupa visitas por loja
                lojasConfig.forEach(lojaInfo => {
                    const visitasLoja = visitasSheets.filter(v => v.loja === lojaInfo.nome);
                    
                    if (visitasLoja.length > 0) {
                        // Calcula a MÃ‰DIA de todas as visitas
                        let somaPontos = 0;
                        visitasLoja.forEach(visita => {
                            somaPontos += visita.pontuacao || 0;
                        });
                        const pontuacaoMedia = somaPontos / visitasLoja.length;
                        
                        // Pega informaÃ§Ãµes da Ãºltima visita
                        const ultimaVisita = visitasLoja[visitasLoja.length - 1];
                        
                        dadosLojas.push({
                            indice: lojaInfo.indice,
                            nome: lojaInfo.nome,
                            cidade: lojaInfo.cidade,
                            pontuacao: pontuacaoMedia,
                            encarregado: ultimaVisita.encarregado || 'NÃ£o informado',
                            totalVisitas: visitasLoja.length
                        });
                    }
                });
                
                return dadosLojas;
            }
        } catch (error) {
            console.warn('âš ï¸ Erro ao carregar ranking do Sheets, usando localStorage:', error);
        }
    }
    
    // ğŸ’¾ Fallback: usa localStorage
    console.log('ğŸ’¾ Usando dados do localStorage para ranking');
    lojasConfig.forEach((lojaInfo) => {
        // Busca histÃ³rico usando o Ã­ndice correto (posiÃ§Ã£o no array lojas)
        let historico = JSON.parse(localStorage.getItem(`hist_${lojaInfo.indice}`) || '[]');
        
        // ğŸ†• FILTRA POR MÃŠS/ANO se solicitado
        if (filtrarPorPeriodo) {
            historico = historico.filter(v => {
                let d;
                if(typeof v.data === 'string' && v.data.includes('/')) {
                    const p = v.data.split(' ')[0].split('/');
                    if(p.length === 3) d = new Date(parseInt(p[2]), parseInt(p[1])-1, parseInt(p[0]));
                } else {
                    d = new Date(v.data);
                }
                return d && !isNaN(d.getTime()) && d.getMonth() === mesAtual && d.getFullYear() === anoAtual;
            });
            console.log(`   ${lojaInfo.nome}: ${historico.length} visitas em ${mesAtual+1}/${anoAtual}`);
        }
        
        if (historico.length > 0) {
            // Calcula a MÃ‰DIA de todas as visitas (igual ao Ranking de Performance)
            let somaPontos = 0;
            historico.forEach(visita => {
                const pontos = visita.dados ? calculaTotalPontos(visita.dados) : 0;
                somaPontos += pontos;
            });
            const pontuacaoMedia = somaPontos / historico.length;
            
            // Pega informaÃ§Ãµes da Ãºltima visita
            const ultimaVisita = historico[historico.length - 1];
            
            dadosLojas.push({
                indice: lojaInfo.indice,
                nome: lojaInfo.nome,
                cidade: lojaInfo.cidade,
                pontuacao: pontuacaoMedia,  // MÃ‰DIA das visitas (filtradas ou nÃ£o)
                encarregado: ultimaVisita.dados?.encarregado || 'NÃ£o informado',
                totalVisitas: historico.length
            });
        } else {
            // Loja sem histÃ³rico - nÃ£o adiciona ao ranking
            if (!filtrarPorPeriodo) {
                console.log(`${lojaInfo.nome} sem histÃ³rico de visitas`);
            }
        }
    });
    
    return dadosLojas;
}

async function criarRankingLojas(mesAtual = null, anoAtual = null) {
    // Busca dados reais das lojas (agora filtra por mÃªs/ano se fornecido)
    const dadosLojas = await buscarDadosRankingLojas(mesAtual, anoAtual);
    
    // Ordena lojas por pontuaÃ§Ã£o (maior para menor)
    // Em caso de empate, mantÃ©m a ordem alfabÃ©tica do nome
    const lojasOrdenadas = [...dadosLojas].sort((a, b) => {
        if (b.pontuacao !== a.pontuacao) {
            return b.pontuacao - a.pontuacao; // Ordena por pontuaÃ§Ã£o (maior primeiro)
        }
        return a.nome.localeCompare(b.nome); // Em caso de empate, ordem alfabÃ©tica
    });
    
    const container = document.createElement('div');
    container.className = 'ranking-container';
    
    let html = `
        <div class="ranking-header">
            <h2 class="ranking-titulo">ğŸ† Ranking de Lojas</h2>
            <p class="ranking-subtitulo">ComparaÃ§Ã£o de Performance - Ãšltima Auditoria</p>
        </div>
        <div class="ranking-lista">
    `;
    
    // Agrupa lojas por posiÃ§Ã£o (empates)
    let posicaoAtual = 1;
    let pontuacaoAnterior = null;
    let lojasNaPosicao = [];
    
    lojasOrdenadas.forEach((loja, index) => {
        // Se a pontuaÃ§Ã£o mudou, renderiza o grupo anterior e comeÃ§a novo grupo
        if (pontuacaoAnterior !== null && loja.pontuacao < pontuacaoAnterior) {
            // Renderiza grupo de lojas empatadas
            html += renderizarGrupoPosicao(lojasNaPosicao, posicaoAtual);
            
            // Atualiza para prÃ³xima posiÃ§Ã£o: apenas incrementa 1
            posicaoAtual++;
            lojasNaPosicao = [];
        }
        
        lojasNaPosicao.push(loja);
        pontuacaoAnterior = loja.pontuacao;
        
        // Se for a Ãºltima loja, renderiza o grupo
        if (index === lojasOrdenadas.length - 1) {
            html += renderizarGrupoPosicao(lojasNaPosicao, posicaoAtual);
        }
    });
    
    html += '</div>';
    container.innerHTML = html;
    
    return container;
}

// FunÃ§Ã£o auxiliar para renderizar um grupo de lojas empatadas
function renderizarGrupoPosicao(lojas, posicao) {
    if (lojas.length === 0) return '';
    
    // Define a medalha/texto da posiÃ§Ã£o
    let tituloLinha = '';
    let classePosicao = '';
    
    if (posicao === 1) {
        tituloLinha = 'ğŸ¥‡ 1Âº LUGAR';
        classePosicao = 'posicao-1';
    } else if (posicao === 2) {
        tituloLinha = 'ğŸ¥ˆ 2Âº LUGAR';
        classePosicao = 'posicao-2';
    } else if (posicao === 3) {
        tituloLinha = 'ğŸ¥‰ 3Âº LUGAR';
        classePosicao = 'posicao-3';
    } else {
        tituloLinha = `${posicao}Âº LUGAR`;
        classePosicao = '';
    }
    
    // Se houver empate, adiciona informaÃ§Ã£o
    if (lojas.length > 1) {
        tituloLinha += ` <span style="font-size:0.7em;color:#666;">(${lojas.length} lojas empatadas)</span>`;
    }
    
    let html = `
        <div class="ranking-linha">
            <div class="ranking-linha-header">${tituloLinha}</div>
            <div class="ranking-cards-container">
    `;
    
    // Renderiza cada loja do grupo
    lojas.forEach(loja => {
        const percentual = (loja.pontuacao / 21) * 100;
        
        // Define badge de status
        let badge = '';
        if (loja.pontuacao >= 18) {
            badge = '<span class="badge-excelente">EXCELENTE</span>';
        } else if (loja.pontuacao >= 14) {
            badge = '<span class="badge-bom">BOM</span>';
        } else if (loja.pontuacao >= 10) {
            badge = '<span class="badge-regular">REGULAR</span>';
        } else {
            badge = '<span class="badge-insatisfatorio">INSATISFATÃ“RIO</span>';
        }
        
        // Removido identificaÃ§Ã£o "SUA LOJA" - nÃ£o mais necessÃ¡rio
        const minhaLoja = '';
        
        html += `
            <div class="ranking-item ${classePosicao} ${minhaLoja}">
                <div class="ranking-item-header">
                    <div>
                        <h3 class="ranking-loja-nome">${loja.nome}</h3>
                        <p class="ranking-loja-cidade" style="margin: 5px 0;">ğŸ“ ${loja.cidade}</p>
                        <p class="ranking-loja-encarregado" style="font-size: 0.9em; color: #666; margin: 5px 0;">ğŸ‘¤ ${loja.encarregado}</p>
                    </div>
                </div>
                
                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px;">
                    <div>
                        ${badge}
                    </div>
                    <div class="ranking-pontuacao" style="text-align: center;">
                        <div style="display: flex; align-items: baseline; justify-content: center; gap: 3px;">
                            <span class="ranking-pontos">${loja.pontuacao.toFixed(1)}</span>
                            <span class="ranking-pontos-max">/21</span>
                        </div>
                        <div class="ranking-progresso" style="width: 80px; margin: 5px auto 0;">
                            <div class="ranking-progresso-barra" style="width: ${percentual}%"></div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    
    html += `
            </div>
        </div>
    `;
    
    return html;
}

// FunÃ§Ã£o auxiliar para buscar histÃ³rico completo de todas as lojas
async function buscarHistoricoCompleto() {
    // ğŸ”„ Primeiro tenta carregar do Google Sheets (se configurado)
    if (CONFIG_SYNC.metodo === 'google_sheets' && CONFIG_SYNC.googleSheetsUrl) {
        try {
            const visitasSheets = await carregarDadosGoogleSheets();
            
            if (visitasSheets && visitasSheets.length > 0) {
                console.log('ğŸ“Š Usando dados do Google Sheets');
                
                // Converte para o formato esperado
                const historico = visitasSheets.map(visita => ({
                    data: visita.data,
                    pontuacao: visita.pontuacao || 0,
                    loja: visita.loja,
                    encarregado: visita.encarregado || 'NÃ£o informado',
                    gerente: visita.gerente || 'NÃ£o informado',
                    dados: visita.dados
                }));
                
                return historico;
            }
        } catch (error) {
            console.warn('âš ï¸ Erro ao carregar do Sheets, usando localStorage:', error);
        }
    }
    
    // ğŸ’¾ Fallback: usa localStorage
    console.log('ğŸ’¾ Usando dados do localStorage');
    const historico = [];
    
    // Array de lojas do sistema
    const lojasConfig = [
        { indice: 0, nome: 'LOJA 1' },
        { indice: 1, nome: 'LOJA 3' },
        { indice: 2, nome: 'LOJA 4' },
        { indice: 3, nome: 'LOJA 5' },
        { indice: 4, nome: 'LOJA 6' },
        { indice: 5, nome: 'LOJA 7' },
        { indice: 6, nome: 'LOJA 8' },
        { indice: 7, nome: 'LOJA 9' }
    ];
    
    // Busca histÃ³rico de cada loja
    lojasConfig.forEach(lojaInfo => {
        const historicoLoja = JSON.parse(localStorage.getItem(`hist_${lojaInfo.indice}`) || '[]');
        
        historicoLoja.forEach(visita => {
            if (visita.data && visita.dados) {
                const pontuacao = calculaTotalPontos(visita.dados);
                historico.push({
                    data: visita.data,
                    pontuacao: pontuacao,
                    loja: lojaInfo.nome,
                    indice: lojaInfo.indice
                });
            }
        });
    });
    
    return historico;
}

// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// ğŸš€ INTEGRAÃ‡ÃƒO COM RELATÃ“RIO DE DIRETORIA
// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

// Intercepta a funÃ§Ã£o de abrir RelatÃ³rio de Diretoria
const abrirRelatorioDiretoriaOriginal = window.abrirRelatorioDiretoria;

window.abrirRelatorioDiretoria = async function() {
    // Chama funÃ§Ã£o original
    if (abrirRelatorioDiretoriaOriginal) {
        abrirRelatorioDiretoriaOriginal();
    }
    
    // Aguarda o modal aparecer
    setTimeout(async () => {
        const modalBody = document.querySelector('.relatorio-diretoria-content');
        if (modalBody) {
            // âŒ DASHBOARD DE PERFORMANCE REMOVIDO - nÃ£o Ã© necessÃ¡rio
            // O usuÃ¡rio prefere se basear em todas as visitas, nÃ£o nas Ãºltimas
            
            // ğŸ†• Pega mÃªs/ano atual do seletor
            const mesAtual = new Date().getMonth();
            const anoAtual = new Date().getFullYear();
            
            // Adiciona apenas o Ranking de Lojas FILTRADO PELO MÃŠS/ANO
            const ranking = await criarRankingLojas(mesAtual, anoAtual);
            ranking.id = 'rankingDinamico'; // ID para poder atualizar depois
            const primeiroElemento = modalBody.querySelector('.dashboard-grid')?.parentElement;
            if (primeiroElemento) {
                primeiroElemento.parentNode.insertBefore(ranking, primeiroElemento);
            } else {
                modalBody.insertBefore(ranking, modalBody.firstChild);
            }
            
            console.log('âœ… Ranking de Lojas adicionado ao RelatÃ³rio de Diretoria');
        }
    }, 500);
};

// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// ğŸ¯ INICIALIZAÃ‡ÃƒO
// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

console.log('âœ… Ranking de Lojas inicializado!');
console.log('ğŸ† Abra o RelatÃ³rio de Diretoria para ver as novidades!');




// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// ğŸ†• SISTEMA GOOGLE DRIVE - VERSÃƒO CORRIGIDA v3.0
// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

// ConfiguraÃ§Ã£o do Google Drive
let CONFIG_DRIVE = {
    // âš ï¸âš ï¸âš ï¸ SUBSTITUA AQUI COM SUAS CREDENCIAIS DO GOOGLE CONSOLE âš ï¸âš ï¸âš ï¸
    // 
    // ğŸ“ PASSO 1: VÃ¡ em https://console.cloud.google.com/apis/credentials
    // ğŸ“ PASSO 2: Crie um "ID do cliente OAuth" (tipo: Aplicativo da Web)
    // ğŸ“ PASSO 3: Copie o Client ID e cole abaixo (deve terminar com .apps.googleusercontent.com)
    // ğŸ“ PASSO 4: Crie uma "Chave de API" e cole abaixo
    // ğŸ“ PASSO 5: Habilite "Google Drive API" e "Google Picker API" no Console
    //
    clientId: localStorage.getItem('drive_client_id') || 'COLE_SEU_CLIENT_ID_AQUI.apps.googleusercontent.com',
    apiKey: localStorage.getItem('drive_api_key') || 'COLE_SUA_API_KEY_AQUI',
    // âš ï¸âš ï¸âš ï¸ FIM DA CONFIGURAÃ‡ÃƒO - NÃƒO MEXA NO RESTO âš ï¸âš ï¸âš ï¸
    
    folderId: localStorage.getItem('drive_folder_id') || '',
    folderName: 'Shoemix_Relatorios_Fotos',
    conectado: false,
    accessToken: null,
    discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'],
    scope: 'https://www.googleapis.com/auth/drive.file',
    tentativasReconexao: 0,
    maxTentativas: 5
};

// ğŸ”§ IMPORTANTE: Substitua as credenciais acima antes de usar!
// As credenciais sÃ³ serÃ£o salvas apÃ³s vocÃª configurÃ¡-las corretamente

console.log('ğŸ” Verificando credenciais...');
if (CONFIG_DRIVE.clientId.includes('COLE_SEU_CLIENT_ID_AQUI')) {
    console.warn('âš ï¸âš ï¸âš ï¸ ATENÃ‡ÃƒO: VocÃª precisa configurar o Client ID! âš ï¸âš ï¸âš ï¸');
    console.warn('ğŸ‘‰ Edite o arquivo HTML e substitua "COLE_SEU_CLIENT_ID_AQUI" pelo seu Client ID real');
}
if (CONFIG_DRIVE.apiKey.includes('COLE_SUA_API_KEY_AQUI')) {
    console.warn('âš ï¸âš ï¸âš ï¸ ATENÃ‡ÃƒO: VocÃª precisa configurar a API Key! âš ï¸âš ï¸âš ï¸');
    console.warn('ğŸ‘‰ Edite o arquivo HTML e substitua "COLE_SUA_API_KEY_AQUI" pela sua API Key real');
}

// VariÃ¡veis globais
let tokenClient = null;
let gapiInited = false;
let gisInited = false;

console.log('ğŸ” Credenciais configuradas:', {
        clientId: '833309746071-bo41s8idd1j32nutqi2vou195fhbaqi8.apps.googleusercontent.com',
    apiKey: 'AIzaSyAYu9g7QcXrfU5b8SvsgFTo0lHozAGLSxs',
});

// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// FUNÃ‡Ã•ES DE ATUALIZAÃ‡ÃƒO DE STATUS
// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

function atualizarStatusDriveIndicador(status, mensagem) {
    const indicator = document.querySelector('.sync-indicator');
    const statusText = document.getElementById('syncText'); // ğŸ”§ CORREÃ‡ÃƒO: usar o ID correto
    const statusDot = indicator?.querySelector('.sync-dot');
    
    if (!indicator) {
        console.warn('âš ï¸ Indicador de sincronizaÃ§Ã£o nÃ£o encontrado no DOM');
        return;
    }
    
    // Remove TODAS as classes anteriores
    indicator.className = 'sync-indicator';
    if (statusDot) statusDot.className = 'sync-dot';
    
    // Adiciona nova classe e cor baseada no status
    switch(status) {
        case 'connected':
            // âœ… VERDE - Conectado e funcionando
            indicator.style.borderColor = '#28a745';
            if (statusDot) {
                statusDot.style.background = '#28a745';
                statusDot.style.animation = 'none';
            }
            break;
            
        case 'loading':
        case 'syncing':
            // ğŸŸ¡ AMARELO - Processando
            indicator.classList.add('syncing');
            indicator.style.borderColor = '#ffc107';
            if (statusDot) {
                statusDot.classList.add('syncing');
                statusDot.style.background = '#ffc107';
            }
            break;
            
        case 'error':
            // ğŸ”´ VERMELHO - Erro ou desconectado
            indicator.classList.add('error');
            indicator.style.borderColor = '#dc3545';
            if (statusDot) {
                statusDot.classList.add('error');
                statusDot.style.background = '#dc3545';
                statusDot.style.animation = 'none';
            }
            break;
            
        default:
            // âšª CINZA - Estado padrÃ£o/desconhecido
            indicator.style.borderColor = '#666';
            if (statusDot) {
                statusDot.style.background = '#666';
                statusDot.style.animation = 'none';
            }
    }
    
    if (statusText) statusText.textContent = mensagem;
    
    // ğŸ†• Atualiza tambÃ©m o painel detalhado de status
    atualizarPainelStatus(status, mensagem);
    
    console.log('ğŸ“Š Status Drive atualizado:', status, '-', mensagem);
}

// ğŸ†• NOVA FUNÃ‡ÃƒO: Atualiza o painel de status detalhado
function atualizarPainelStatus(status, mensagem) {
    // Mapeia qual componente atualizar baseado na mensagem
    let componente = 'apis';
    if (mensagem.includes('GAPI') || mensagem.includes('Google API')) componente = 'gapi';
    else if (mensagem.includes('GIS') || mensagem.includes('Identity')) componente = 'gis';
    else if (mensagem.includes('Drive') || mensagem.includes('conectado') || mensagem.includes('Conectado')) componente = 'drive';
    
    const mapeamento = {
        'apis': { dot: 'statusDotAPIs', text: 'statusTextAPIs' },
        'gapi': { dot: 'statusDotGAPI', text: 'statusTextGAPI' },
        'gis': { dot: 'statusDotGIS', text: 'statusTextGIS' },
        'drive': { dot: 'statusDotDrive', text: 'statusTextDrive' }
    };
    
    const elementos = mapeamento[componente];
    if (!elementos) return;
    
    const dot = document.getElementById(elementos.dot);
    const text = document.getElementById(elementos.text);
    
    if (!dot || !text) return;
    
    // Define cores baseadas no status
    const cores = {
        'loading': '#ffc107',
        'syncing': '#ffc107',
        'connected': '#28a745',
        'error': '#dc3545'
    };
    
    dot.style.background = cores[status] || '#6c757d';
    
    // Adiciona animaÃ§Ã£o se estiver carregando
    if (status === 'loading' || status === 'syncing') {
        dot.style.animation = 'pulse 1.5s infinite';
    } else {
        dot.style.animation = 'none';
    }
    
    text.textContent = mensagem;
}

// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// INICIALIZAÃ‡ÃƒO GAPI (Google API)
// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

function gapiLoaded() {
    console.log('âœ… GAPI script carregado');
    atualizarStatusDriveIndicador('loading', 'ğŸ”„ Inicializando GAPI...');
    
    // ğŸ†• Atualiza painel detalhado
    const dot = document.getElementById('statusDotGAPI');
    const text = document.getElementById('statusTextGAPI');
    if (dot) dot.style.background = '#ffc107';
    if (text) text.textContent = 'ğŸ”„ Carregando...';
    if (dot) dot.style.animation = 'pulse 1.5s infinite';
    
    // ğŸ”§ CORREÃ‡ÃƒO MOBILE: Verifica se gapi estÃ¡ realmente disponÃ­vel
    if (typeof gapi === 'undefined' || !gapi.load) {
        console.warn('âš ï¸ GAPI ainda nÃ£o disponÃ­vel, aguardando...');
        setTimeout(gapiLoaded, 500);
        return;
    }
    
    try {
        gapi.load('client', {
            callback: initializeGapiClient,
            onerror: (error) => {
                console.error('âŒ Erro ao carregar client GAPI:', error);
                atualizarStatusDriveIndicador('error', 'âŒ Erro ao carregar GAPI');
                if (dot) dot.style.background = '#dc3545';
                if (text) text.textContent = 'âŒ Erro ao carregar';
                if (dot) dot.style.animation = 'none';
            },
            timeout: 30000,
            ontimeout: () => {
                console.error('âŒ Timeout ao carregar GAPI (30s)');
                atualizarStatusDriveIndicador('error', 'âŒ Timeout GAPI');
                mostrarToast('âš ï¸ APIs do Google demorando. Verifique sua conexÃ£o.', 'aviso');
                if (dot) dot.style.background = '#dc3545';
                if (text) text.textContent = 'âŒ Timeout (30s)';
                if (dot) dot.style.animation = 'none';
            }
        });
    } catch (e) {
        console.error('âŒ Erro ao carregar GAPI:', e);
        atualizarStatusDriveIndicador('error', 'âŒ Erro ao carregar GAPI');
        if (dot) dot.style.background = '#dc3545';
        if (text) text.textContent = 'âŒ Erro: ' + e.message;
        if (dot) dot.style.animation = 'none';
    }
}

async function initializeGapiClient() {
    console.log('ğŸ”„ Inicializando cliente GAPI...');
    
    // ğŸ”§ CORREÃ‡ÃƒO MOBILE: Verifica se gapi.client estÃ¡ disponÃ­vel
    if (typeof gapi === 'undefined' || !gapi.client) {
        console.warn('âš ï¸ gapi.client ainda nÃ£o disponÃ­vel, aguardando...');
        setTimeout(initializeGapiClient, 1000);
        return;
    }
    
    if (!CONFIG_DRIVE.apiKey || CONFIG_DRIVE.apiKey === '') {
        console.warn('âš ï¸ API Key nÃ£o configurada');
        atualizarStatusDriveIndicador('error', 'âš ï¸ Configure API Key');
        setTimeout(abrirModalDrive, 2000);
        return;
    }
    
    try {
        await gapi.client.init({
            apiKey: CONFIG_DRIVE.apiKey,
            discoveryDocs: CONFIG_DRIVE.discoveryDocs,
        });
        
        gapiInited = true;
        console.log('âœ… GAPI inicializado');
        atualizarStatusDriveIndicador('loading', 'âœ… GAPI pronto');
        
        // ğŸ†• Atualiza painel detalhado
        const dot = document.getElementById('statusDotGAPI');
        const text = document.getElementById('statusTextGAPI');
        if (dot) { dot.style.background = '#28a745'; dot.style.animation = 'none'; }
        if (text) text.textContent = 'âœ… Pronto';
        
        maybeEnableButtons();
    } catch (e) {
        console.error('âŒ Erro ao inicializar GAPI:', e);
        atualizarStatusDriveIndicador('error', 'âŒ Erro GAPI: ' + e.message);
        
        if (CONFIG_DRIVE.tentativasReconexao < CONFIG_DRIVE.maxTentativas) {
            CONFIG_DRIVE.tentativasReconexao++;
            console.log('ğŸ”„ Tentativa', CONFIG_DRIVE.tentativasReconexao, 'de', CONFIG_DRIVE.maxTentativas);
            setTimeout(() => initializeGapiClient(), 3000);
        }
    }
}

// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// INICIALIZAÃ‡ÃƒO GIS (Google Identity Services)
// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

function gisLoaded() {
    console.log('âœ… GIS script carregado');
    atualizarStatusDriveIndicador('loading', 'ğŸ”„ Inicializando GIS...');
    
    // ğŸ†• Atualiza painel detalhado
    const dot = document.getElementById('statusDotGIS');
    const text = document.getElementById('statusTextGIS');
    if (dot) dot.style.background = '#ffc107';
    if (text) text.textContent = 'ğŸ”„ Carregando...';
    if (dot) dot.style.animation = 'pulse 1.5s infinite';
    
    if (!CONFIG_DRIVE.clientId || CONFIG_DRIVE.clientId === '') {
        console.warn('âš ï¸ Client ID nÃ£o configurado para GIS');
        atualizarStatusDriveIndicador('error', 'âš ï¸ Configure Client ID');
        if (dot) dot.style.background = '#ffc107';
        if (text) text.textContent = 'âš ï¸ Client ID faltando';
        if (dot) dot.style.animation = 'none';
        setTimeout(abrirModalDrive, 2000);
        return;
    }
    
    try {
        // ğŸ”§ CORREÃ‡ÃƒO: VerificaÃ§Ã£o adicional para evitar erros em ambientes locais
        if (typeof google === 'undefined' || !google.accounts || !google.accounts.oauth2) {
            throw new Error('Google Identity Services nÃ£o estÃ¡ disponÃ­vel');
        }
        
        tokenClient = google.accounts.oauth2.initTokenClient({
            client_id: CONFIG_DRIVE.clientId,
            scope: CONFIG_DRIVE.scope,
            callback: tokenResponse => {
                console.log('âœ… Token recebido');
                CONFIG_DRIVE.accessToken = tokenResponse.access_token;
                CONFIG_DRIVE.conectado = true;
                
                localStorage.setItem('google_access_token', tokenResponse.access_token);
                
                atualizarStatusDriveIndicador('connected', 'âœ… Drive conectado');
                
                // ğŸ†• Atualiza painel
                const dotDrive = document.getElementById('statusDotDrive');
                const textDrive = document.getElementById('statusTextDrive');
                if (dotDrive) { dotDrive.style.background = '#28a745'; dotDrive.style.animation = 'none'; }
                if (textDrive) textDrive.textContent = 'âœ… Conectado';
                
                verificarStatusDrive();
                atualizarIndicadorArmazenamento();
                mostrarToast('âœ… Conectado ao Google Drive!');
            },
            error_callback: (error) => {
                console.error('âŒ Erro no token:', error);
                atualizarStatusDriveIndicador('error', 'âŒ Erro de autenticaÃ§Ã£o');
                mostrarToast('âŒ Erro ao conectar com Google Drive', 'erro');
            }
        });
        
        gisInited = true;
        console.log('âœ… GIS inicializado');
        atualizarStatusDriveIndicador('loading', 'âœ… GIS pronto');
        
        // ğŸ†• Atualiza painel
        if (dot) { dot.style.background = '#28a745'; dot.style.animation = 'none'; }
        if (text) text.textContent = 'âœ… Pronto';
        
        maybeEnableButtons();
    } catch (e) {
        console.error('âŒ Erro ao inicializar GIS:', e);
        atualizarStatusDriveIndicador('error', 'âŒ Erro GIS: ' + e.message);
        if (dot) { dot.style.background = '#dc3545'; dot.style.animation = 'none'; }
        if (text) text.textContent = 'âŒ Erro: ' + e.message;
    }
}

// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// VERIFICAÃ‡ÃƒO E HABILITAÃ‡ÃƒO
// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

function maybeEnableButtons() {
    if (gapiInited && gisInited) {
        console.log('âœ… Ambos GAPI e GIS prontos');
        atualizarStatusDriveIndicador('loading', 'âœ… Pronto para conectar');
        
        const tokenSalvo = localStorage.getItem('google_access_token');
        if (tokenSalvo) {
            console.log('ğŸ”‘ Token encontrado no localStorage');
            CONFIG_DRIVE.accessToken = tokenSalvo;
            verificarTokenValido();
        } else {
            atualizarStatusDriveIndicador('error', 'âš ï¸ Clique para conectar');
            
            // ğŸ†• Verifica se deve mostrar botÃ£o flutuante - CONDIÃ‡ÃƒO SIMPLIFICADA
            setTimeout(() => {
                const temCredenciais = CONFIG_DRIVE.clientId && CONFIG_DRIVE.apiKey;
                const apisCarregadas = gapiInited && gisInited;
                const naoConectado = !CONFIG_DRIVE.conectado && !CONFIG_DRIVE.accessToken;
                const btnFlutante = document.getElementById('btnConectarDriveFlutante');
                
                console.log('ğŸ” Verificando botÃ£o flutuante em maybeEnableButtons...');
                console.log('  - Tem credenciais:', temCredenciais);
                console.log('    â€¢ Client ID:', CONFIG_DRIVE.clientId ? CONFIG_DRIVE.clientId.substring(0, 30) + '...' : 'VAZIO');
                console.log('    â€¢ API Key:', CONFIG_DRIVE.apiKey ? CONFIG_DRIVE.apiKey.substring(0, 20) + '...' : 'VAZIO');
                console.log('  - APIs carregadas:', apisCarregadas);
                console.log('    â€¢ GAPI:', gapiInited);
                console.log('    â€¢ GIS:', gisInited);
                console.log('  - NÃ£o conectado:', naoConectado);
                console.log('  - tokenClient:', tokenClient ? 'pronto' : 'nÃ£o pronto');
                
                // ğŸ”§ CORREÃ‡ÃƒO: Mostra o botÃ£o se tiver credenciais E APIs carregadas, mesmo sem tokenClient ainda
                if (temCredenciais && apisCarregadas && naoConectado && btnFlutante) {
                    btnFlutante.classList.add('mostrar');
                    console.log('âœ… BOTÃƒO FLUTUANTE EXIBIDO (maybeEnableButtons)!');
                    mostrarToast('âœ… Tudo pronto! Clique no botÃ£o azul ğŸ”‘ para conectar.', 'sucesso');
                    
                    // Atualiza painel detalhado
                    const dotAPIs = document.getElementById('statusDotAPIs');
                    const textAPIs = document.getElementById('statusTextAPIs');
                    if (dotAPIs) { dotAPIs.style.background = '#28a745'; dotAPIs.style.animation = 'none'; }
                    if (textAPIs) textAPIs.textContent = 'âœ… Pronto para conectar';
                } else {
                    console.log('âš ï¸ BotÃ£o nÃ£o exibido. Motivos:');
                    if (!temCredenciais) {
                        console.log('  âŒ Faltam credenciais');
                        mostrarToast('âš ï¸ Credenciais incompletas. Configure no botÃ£o â˜ï¸ CONFIGURAR GOOGLE DRIVE', 'aviso');
                    }
                    if (!apisCarregadas) {
                        console.log('  âŒ APIs nÃ£o carregadas');
                        mostrarToast('â³ Aguardando APIs do Google...', 'aviso');
                    }
                    if (!naoConectado) console.log('  â„¹ï¸ JÃ¡ estÃ¡ conectado');
                    if (!btnFlutante) console.log('  âŒ BotÃ£o nÃ£o encontrado no DOM');
                }
                
                verificarStatusDrive();
            }, 500);
        }
    }
}

async function verificarTokenValido() {
    if (!CONFIG_DRIVE.accessToken) {
        atualizarStatusDriveIndicador('error', 'âŒ Sem token de acesso');
        return false;
    }
    
    try {
        const response = await fetch('https://www.googleapis.com/drive/v3/about?fields=user', {
            headers: {
                'Authorization': 'Bearer ' + CONFIG_DRIVE.accessToken
            }
        });
        
        if (response.ok) {
            CONFIG_DRIVE.conectado = true;
            atualizarStatusDriveIndicador('connected', 'âœ… Drive conectado');
            verificarStatusDrive();
            atualizarIndicadorArmazenamento();
            return true;
        } else {
            localStorage.removeItem('google_access_token');
            CONFIG_DRIVE.accessToken = null;
            CONFIG_DRIVE.conectado = false;
            atualizarStatusDriveIndicador('error', 'âš ï¸ Token expirado');
            return false;
        }
    } catch (e) {
        console.error('âŒ Erro ao verificar token:', e);
        atualizarStatusDriveIndicador('error', 'âŒ Erro ao verificar');
        return false;
    }
}

// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// FUNÃ‡Ã•ES DE CONEXÃƒO
// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

function conectarDrive() {
    console.log('ğŸ” Iniciando autenticaÃ§Ã£o...');
    atualizarStatusDriveIndicador('loading', 'ğŸ” Autenticando...');
    
    // ğŸ”§ CORREÃ‡ÃƒO: VerificaÃ§Ãµes mais detalhadas antes de tentar conectar
    if (!gapiInited || !gisInited) {
        console.warn('âš ï¸ APIs nÃ£o inicializadas - GAPI:', gapiInited, 'GIS:', gisInited);
        mostrarToast('âš ï¸ Google API ainda nÃ£o inicializada. Aguarde alguns segundos.', 'aviso');
        atualizarStatusDriveIndicador('error', 'âš ï¸ API nÃ£o pronta');
        
        // Tenta reinicializar apÃ³s alguns segundos
        setTimeout(() => {
            if (!gapiInited && typeof gapi !== 'undefined' && gapi.load) {
                console.log('ğŸ”„ Tentando reinicializar GAPI...');
                gapiLoaded();
            }
            if (!gisInited && typeof google !== 'undefined' && google.accounts) {
                console.log('ğŸ”„ Tentando reinicializar GIS...');
                gisLoaded();
            }
        }, 2000);
        return;
    }

    if (!CONFIG_DRIVE.clientId) {
        mostrarToast('âš ï¸ Configure o Client ID primeiro!', 'aviso');
        abrirModalDrive();
        return;
    }
    
    // ğŸ”§ CORREÃ‡ÃƒO MOBILE: Verifica se tokenClient estÃ¡ realmente disponÃ­vel
    if (!tokenClient || typeof tokenClient.requestAccessToken !== 'function') {
        console.error('âŒ Token client nÃ£o inicializado corretamente');
        console.log('ğŸ” Debug - tokenClient:', tokenClient);
        console.log('ğŸ” Debug - typeof google:', typeof google);
        console.log('ğŸ” Debug - google.accounts:', typeof google !== 'undefined' ? google.accounts : 'undefined');
        atualizarStatusDriveIndicador('error', 'âŒ Token client nÃ£o pronto');
        mostrarToast('âŒ Erro ao autenticar. Aguarde ou recarregue a pÃ¡gina.', 'erro');
        
        // Tenta reinicializar GIS
        if (typeof google !== 'undefined' && google.accounts) {
            console.log('ğŸ”„ Tentando reinicializar GIS...');
            setTimeout(gisLoaded, 1000);
        }
        return;
    }

    try {
        // ğŸ”§ CORREÃ‡ÃƒO: Verifica se estÃ¡ em ambiente file:// e avisa o usuÃ¡rio com toast
        if (window.location.protocol === 'file:') {
            console.warn('âš ï¸ Rodando em file:// - OAuth pode ter problemas');
            mostrarToast('âš ï¸ ATENÃ‡ÃƒO: Executando localmente. OAuth pode ter limitaÃ§Ãµes.', 'aviso');
            
            // Aguarda 2 segundos antes de continuar
            setTimeout(() => {
                tokenClient.requestAccessToken({ prompt: 'consent' });
            }, 2000);
            return;
        }
        
        tokenClient.requestAccessToken({ prompt: 'consent' });
    } catch (e) {
        console.error('âŒ Erro ao solicitar token:', e);
        atualizarStatusDriveIndicador('error', 'âŒ Erro de autenticaÃ§Ã£o');
        
        // Mensagem de erro mais amigÃ¡vel dependendo do contexto
        let mensagemErro = 'âŒ Erro ao autenticar: ' + e.message;
        if (window.location.protocol === 'file:') {
            mensagemErro += '\n\nğŸ’¡ Tente usar um servidor web local.';
        }
        
        mostrarToast(mensagemErro, 'erro');
    }
}

function desconectarDrive() {
    if (CONFIG_DRIVE.accessToken) {
        google.accounts.oauth2.revoke(CONFIG_DRIVE.accessToken, () => {
            console.log('âœ… Token revogado');
        });
    }
    
    CONFIG_DRIVE.conectado = false;
    CONFIG_DRIVE.accessToken = null;
    localStorage.removeItem('google_access_token');
    
    verificarStatusDrive();
    atualizarStatusDriveIndicador('error', 'âŒ Desconectado');
    mostrarToast('âœ… Desconectado do Google Drive');
}

async function verificarStatusDrive() {
    console.log('ğŸ” verificarStatusDrive() chamada');
    console.log('  - gapiInited:', gapiInited);
    console.log('  - gisInited:', gisInited);
    console.log('  - CONFIG_DRIVE.clientId:', CONFIG_DRIVE.clientId);
    console.log('  - CONFIG_DRIVE.conectado:', CONFIG_DRIVE.conectado);
    console.log('  - CONFIG_DRIVE.accessToken:', CONFIG_DRIVE.accessToken ? 'existe' : 'null');
    
    const statusDiv = document.getElementById('driveStatus');
    const statusText = document.getElementById('driveStatusText');
    const quotaInfo = document.getElementById('driveQuotaInfo');
    const btnDesconectar = document.getElementById('btnDesconectar');
    const btnTestar = document.getElementById('btnTestar');
    const btnConectarManual = document.getElementById('btnConectarManual');
    const btnConectarFlutante = document.getElementById('btnConectarDriveFlutante'); // ğŸ†•

    console.log('  - btnConectarManual encontrado:', btnConectarManual ? 'SIM' : 'NÃƒO');
    console.log('  - btnConectarFlutante encontrado:', btnConectarFlutante ? 'SIM' : 'NÃƒO');

    if (!CONFIG_DRIVE.conectado || !CONFIG_DRIVE.accessToken) {
        if (statusDiv) statusDiv.className = 'drive-status inativo';
        
        // ğŸ†• Verifica se as credenciais estÃ£o configuradas
        const temCredenciais = CONFIG_DRIVE.clientId && CONFIG_DRIVE.apiKey;
        console.log('  - Tem credenciais:', temCredenciais);
        console.log('  - APIs prontas:', gapiInited && gisInited);
        
        if (temCredenciais && gapiInited && gisInited) {
            // Tem credenciais mas nÃ£o estÃ¡ conectado - mostra botÃ£o de conectar
            console.log('âœ… Mostrando botÃ£o CONECTAR AGORA');
            if (statusText) {
                statusText.innerHTML = 
                    '<p style="margin:5px 0">âš ï¸ <strong>Configurado mas nÃ£o conectado</strong></p>' +
                    '<p style="margin:5px 0;font-size:0.9em">Clique no botÃ£o abaixo para autorizar o acesso</p>';
            }
            if (btnConectarManual) {
                btnConectarManual.style.display = 'block';
                console.log('  âœ… BotÃ£o CONECTAR AGORA exibido!');
            } else {
                console.error('  âŒ BotÃ£o btnConectarManual nÃ£o encontrado no DOM!');
            }
            
            // ğŸ†• Mostra botÃ£o flutuante
            if (btnConectarFlutante) {
                btnConectarFlutante.classList.add('mostrar');
                console.log('  âœ… BotÃ£o flutuante CONECTAR exibido!');
            }
        } else {
            // NÃ£o tem credenciais OU APIs nÃ£o prontas
            console.log('âš ï¸ Credenciais incompletas ou APIs nÃ£o prontas');
            if (statusText) {
                if (!temCredenciais) {
                    statusText.innerHTML = 
                        '<p style="margin:5px 0">âŒ <strong>NÃ£o configurado</strong></p>' +
                        '<p style="margin:5px 0;font-size:0.9em">Configure o Client ID abaixo para comeÃ§ar</p>';
                } else {
                    statusText.innerHTML = 
                        '<p style="margin:5px 0">â³ <strong>Aguardando inicializaÃ§Ã£o...</strong></p>' +
                        '<p style="margin:5px 0;font-size:0.9em">Carregando APIs do Google...</p>';
                }
            }
            if (btnConectarManual) {
                btnConectarManual.style.display = 'none';
            }
            
            // ğŸ†• Esconde botÃ£o flutuante
            if (btnConectarFlutante) {
                btnConectarFlutante.classList.remove('mostrar');
            }
        }
        
        if (btnDesconectar) btnDesconectar.style.display = 'none';
        if (btnTestar) btnTestar.style.display = 'none';
        if (quotaInfo) quotaInfo.style.display = 'none';
        return;
    }

    if (statusDiv) statusDiv.className = 'drive-status ativo';
    if (btnConectarManual) btnConectarManual.style.display = 'none';
    
    // ğŸ†• Esconde botÃ£o flutuante quando conectado
    if (btnConectarFlutante) {
        btnConectarFlutante.classList.remove('mostrar');
        console.log('  âœ… BotÃ£o flutuante ESCONDIDO (jÃ¡ conectado)!');
    }
    
    try {
        gapi.client.setToken({ access_token: CONFIG_DRIVE.accessToken });
        
        const response = await gapi.client.drive.about.get({
            fields: 'user,storageQuota'
        });

        const user = response.result.user;
        const quota = response.result.storageQuota;
        
        const usadoGB = (quota.usage / (1024 * 1024 * 1024)).toFixed(2);
        const limiteGB = (quota.limit / (1024 * 1024 * 1024)).toFixed(2);
        const percentual = ((quota.usage / quota.limit) * 100).toFixed(1);

        if (statusText) {
            statusText.innerHTML = 
                '<p style="margin:5px 0">âœ… <strong>Conectado!</strong></p>' +
                '<p style="margin:5px 0;font-size:0.9em">ğŸ‘¤ ' + user.displayName + ' (' + user.emailAddress + ')</p>';
        }

        if (quotaInfo) {
            quotaInfo.style.display = 'block';
            quotaInfo.innerHTML = 
                '<div style="font-weight:600;margin-bottom:5px">ğŸ“Š EspaÃ§o no Drive:</div>' +
                '<div style="font-size:0.95em">ğŸ“¦ Usado: ' + usadoGB + ' GB / ' + limiteGB + ' GB (' + percentual + '%)</div>' +
                '<div style="font-size:0.9em;margin-top:5px">ğŸ’¾ Livre: ' + (limiteGB - usadoGB).toFixed(2) + ' GB</div>';
        }

        if (btnDesconectar) btnDesconectar.style.display = 'inline-block';
        if (btnTestar) btnTestar.style.display = 'inline-block';

    } catch (e) {
        console.error('âŒ Erro ao verificar status:', e);
        if (statusText) statusText.innerHTML = '<p style="margin:5px 0">âš ï¸ <strong>Erro: </strong>' + e.message + '</p>';
    }
}

function salvarConfigDrive() {
    const clientId = document.getElementById('driveClientId').value.trim();
    const apiKey = document.getElementById('driveApiKey')?.value.trim() || '';
    
    if (!clientId) {
        alert('âš ï¸ Digite o Client ID!');
        return;
    }

    if (!clientId.includes('.apps.googleusercontent.com')) {
        alert('âš ï¸ Client ID invÃ¡lido!\n\nDeve terminar com .apps.googleusercontent.com');
        return;
    }

    CONFIG_DRIVE.clientId = clientId;
    CONFIG_DRIVE.apiKey = apiKey;
    
    localStorage.setItem('drive_client_id', clientId);
    if (apiKey) localStorage.setItem('drive_api_key', apiKey);
    
    console.log('âœ… Credenciais salvas:', {clientId: clientId.substring(0, 20) + '...', apiKey: apiKey ? 'configurada' : 'vazia'});
    
    // ğŸ”§ CORREÃ‡ÃƒO: NÃƒO recarrega mais, tenta inicializar direto
    mostrarToast('âœ… Credenciais salvas! Inicializando APIs...', 'sucesso');
    
    fecharModalDrive();
    
    // ğŸ†• Tenta inicializar as APIs se ainda nÃ£o estiverem prontas
    setTimeout(() => {
        if (!gapiInited && typeof gapi !== 'undefined' && gapi.load) {
            console.log('ğŸ”„ Inicializando GAPI apÃ³s salvar...');
            gapiLoaded();
        }
        
        if (!gisInited && typeof google !== 'undefined' && google.accounts) {
            console.log('ğŸ”„ Inicializando GIS apÃ³s salvar...');
            gisLoaded();
        }
        
        // ğŸ†• Aguarda APIs ficarem prontas e mostra botÃ£o flutuante
        let tentativas = 0;
        const maxTentativas = 20; // 10 segundos
        
        const verificarEMostrarBotao = setInterval(() => {
            tentativas++;
            const btnFlutante = document.getElementById('btnConectarDriveFlutante');
            
            console.log(`â³ Verificando APIs... (${tentativas}/${maxTentativas})`);
            console.log('  - gapiInited:', gapiInited);
            console.log('  - gisInited:', gisInited);
            console.log('  - tokenClient:', tokenClient ? 'pronto' : 'nÃ£o pronto');
            
            if (gapiInited && gisInited) {
                clearInterval(verificarEMostrarBotao);
                console.log('âœ… APIs prontas! Mostrando botÃ£o...');
                
                // ğŸ”§ FORÃ‡A o botÃ£o a aparecer
                if (btnFlutante) {
                    btnFlutante.classList.add('mostrar');
                    console.log('âœ… BOTÃƒO FLUTUANTE FORÃ‡ADO A APARECER!');
                }
                
                // ğŸ†• Mostra toast bem visÃ­vel
                mostrarToast('ğŸ”µ BOTÃƒO AZUL APARECEU! Veja no canto inferior esquerdo.', 'sucesso');
                
                // ğŸ†• Atualiza status
                verificarStatusDrive();
                
                // ğŸ†• ApÃ³s 2 segundos, tenta conectar automaticamente
                setTimeout(() => {
                    if (tokenClient && !CONFIG_DRIVE.conectado) {
                        console.log('ğŸ”„ Tentando conectar automaticamente...');
                        mostrarToast('ğŸ” Conectando automaticamente...', 'aviso');
                        
                        setTimeout(() => {
                            conectarDrive();
                        }, 1000);
                    } else if (!tokenClient) {
                        console.warn('âš ï¸ tokenClient ainda nÃ£o pronto. Use o botÃ£o azul manualmente.');
                        mostrarToast('âš ï¸ Clique no BOTÃƒO AZUL para conectar', 'aviso');
                    }
                }, 2000);
                
            } else if (tentativas >= maxTentativas) {
                clearInterval(verificarEMostrarBotao);
                console.error('âŒ Timeout ao aguardar APIs (10s)');
                mostrarToast('âš ï¸ APIs demorando muito. Recarregando pÃ¡gina em 3s...', 'aviso');
                
                // Recarrega automaticamente apÃ³s 3 segundos
                setTimeout(() => {
                    console.log('ğŸ”„ Recarregando pÃ¡gina automaticamente...');
                    location.reload();
                }, 3000);
            }
        }, 500);
        
    }, 500);
}

async function testarConexaoDrive() {
    if (!CONFIG_DRIVE.conectado) {
        alert('âš ï¸ Conecte-se ao Drive primeiro!');
        return;
    }

    try {
        const response = await gapi.client.drive.files.list({
            pageSize: 1,
            fields: 'files(id, name)'
        });

        alert('âœ… ConexÃ£o OK!\n\n' + JSON.stringify(response.result, null, 2));
    } catch (e) {
        alert('âŒ Erro: ' + e.message);
    }
}

async function obterOuCriarPasta() {
    if (!CONFIG_DRIVE.conectado) return null;

    if (CONFIG_DRIVE.folderId) {
        try {
            await gapi.client.drive.files.get({
                fileId: CONFIG_DRIVE.folderId
            });
            return CONFIG_DRIVE.folderId;
        } catch (e) {
            console.log('âš ï¸ Pasta nÃ£o encontrada, criando nova...');
        }
    }

    try {
        const response = await gapi.client.drive.files.create({
            resource: {
                name: CONFIG_DRIVE.folderName,
                mimeType: 'application/vnd.google-apps.folder'
            },
            fields: 'id'
        });

        CONFIG_DRIVE.folderId = response.result.id;
        localStorage.setItem('drive_folder_id', CONFIG_DRIVE.folderId);
        
        console.log('âœ… Pasta criada:', CONFIG_DRIVE.folderId);
        return CONFIG_DRIVE.folderId;
        
    } catch (e) {
        console.error('âŒ Erro ao criar pasta:', e);
        return null;
    }
}

async function uploadFotoParaDrive(blob, nomeArquivo, tentativa = 1) {
    if (!CONFIG_DRIVE.conectado) {
        throw new Error('Drive nÃ£o conectado');
    }

    const folderId = await obterOuCriarPasta();
    if (!folderId) {
        throw new Error('NÃ£o foi possÃ­vel criar pasta');
    }

    return uploadFotoParaDriveComPasta(blob, nomeArquivo, folderId, tentativa);
}

// ğŸš€ FUNÃ‡ÃƒO OTIMIZADA: Recebe folderId pronto (nÃ£o busca novamente!)
async function uploadFotoParaDriveComPasta(blob, nomeArquivo, folderId, tentativa = 1) {
    if (!CONFIG_DRIVE.conectado) {
        throw new Error('Drive nÃ£o conectado');
    }

    if (!folderId) {
        throw new Error('Pasta nÃ£o informada');
    }

    const metadata = {
        name: nomeArquivo,
        parents: [folderId],
        mimeType: blob.type
    };

    const form = new FormData();
    form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
    form.append('file', blob);

    console.log(`ğŸ“¤ Tentativa ${tentativa} de upload: ${nomeArquivo} (${(blob.size/1024).toFixed(0)}KB)`);

    // ğŸ”¥ TIMEOUT REDUZIDO: 30 segundos (fotos comprimidas sÃ£o pequenas!)
    const controller = new AbortController();
    const timeoutId = setTimeout(() => {
        controller.abort();
        console.log('â±ï¸ Upload cancelado por timeout (30s)');
    }, 30000); // 30 segundos (foto jÃ¡ estÃ¡ comprimida!)

    try {
        const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id,webViewLink', {
            method: 'POST',
            headers: {
                'Authorization': 'Bearer ' + CONFIG_DRIVE.accessToken
            },
            body: form,
            signal: controller.signal
        });

        clearTimeout(timeoutId);

        if (!response.ok) {
            throw new Error('Upload falhou: ' + response.statusText);
        }

        const result = await response.json();
        console.log('âœ… Foto enviada:', result.id);
        
        return {
            id: result.id,
            url: result.webViewLink
        };
        
    } catch (error) {
        clearTimeout(timeoutId);
        
        // ğŸ”¥ RETRY AUTOMÃTICO (atÃ© 2 tentativas para uploads paralelos)
        if (tentativa < 2 && (error.name === 'AbortError' || error.message.includes('Failed to fetch'))) {
            console.log(`ğŸ”„ Tentando novamente (tentativa ${tentativa + 1})...`);
            
            // Aguarda 2 segundos antes de tentar novamente
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            return uploadFotoParaDriveComPasta(blob, nomeArquivo, folderId, tentativa + 1);
        }
        
        // Se falhou apÃ³s 2 tentativas, joga erro
        console.error('âŒ Upload falhou apÃ³s', tentativa, 'tentativa(s):', error);
        throw new Error(error.name === 'AbortError' ? 'Timeout: ConexÃ£o lenta' : error.message);
    }
}

async function removerFotoDrive(fileId) {
    if (!CONFIG_DRIVE.conectado) return;
    
    try {
        await gapi.client.drive.files.delete({
            fileId: fileId
        });
        console.log('âœ… Foto removida do Drive:', fileId);
    } catch (e) {
        console.error('âŒ Erro ao remover:', e);
    }
}

function abrirModalDrive() {
    const modal = document.getElementById('modalGoogleDrive');
    if (modal) {
        modal.style.display = 'flex';
        
        const inputClientId = document.getElementById('driveClientId');
        const inputApiKey = document.getElementById('driveApiKey');
        
        if (inputClientId && CONFIG_DRIVE.clientId) {
            inputClientId.value = CONFIG_DRIVE.clientId;
        }
        
        if (inputApiKey && CONFIG_DRIVE.apiKey) {
            inputApiKey.value = CONFIG_DRIVE.apiKey;
        }
        
        verificarStatusDrive();
    }
}

function fecharModalDrive() {
    const modal = document.getElementById('modalGoogleDrive');
    if (modal) {
        modal.style.display = 'none';
    }
}

// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// INICIALIZAÃ‡ÃƒO AUTOMÃTICA COM RETRY INTELIGENTE
// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

window.addEventListener('load', () => {
    console.log('ğŸš€ PÃ¡gina carregada, inicializando sistema Google Drive...');
    
    const clientIdSalvo = localStorage.getItem('drive_client_id');
    const apiKeySalva = localStorage.getItem('drive_api_key');
    
    if (clientIdSalvo) {
        CONFIG_DRIVE.clientId = clientIdSalvo;
        console.log('âœ… Client ID carregado do localStorage');
    }
    
    if (apiKeySalva) {
        CONFIG_DRIVE.apiKey = apiKeySalva;
        console.log('âœ… API Key carregada do localStorage');
    }
    
    let tentativas = 0;
    const maxTentativas = 30; // ğŸ”§ CORREÃ‡ÃƒO MOBILE: Aumentado de 20 para 30 tentativas (15 segundos)
    
    const verificarScripts = setInterval(() => {
        tentativas++;
        
        console.log('â³ Verificando scripts... tentativa', tentativas, 'de', maxTentativas);
        
        // ğŸ”§ CORREÃ‡ÃƒO MOBILE: VerificaÃ§Ã£o mais rigorosa dos scripts
        const gapiDisponivel = typeof gapi !== 'undefined' && gapi.load;
        const googleDisponivel = typeof google !== 'undefined' && google.accounts;
        
        if (gapiDisponivel && googleDisponivel) {
            console.log('âœ… Scripts do Google carregados!');
            console.log('  - gapi disponÃ­vel:', gapiDisponivel);
            console.log('  - google disponÃ­vel:', googleDisponivel);
            clearInterval(verificarScripts);
            
            // ğŸ”§ CORREÃ‡ÃƒO MOBILE: Aguarda um pouco antes de inicializar para garantir estabilidade
            setTimeout(() => {
                gapiLoaded();
                gisLoaded();
            }, 300);
            
            // ğŸ†• Verifica status apÃ³s carregar os scripts
            setTimeout(() => {
                verificarStatusDrive();
            }, 1000);
            
            // ğŸ†• VERIFICAÃ‡ÃƒO PERIÃ“DICA para garantir que o botÃ£o apareÃ§a
            const verificarBotaoFlutante = setInterval(() => {
                const temCredenciais = CONFIG_DRIVE.clientId && CONFIG_DRIVE.apiKey;
                const apisProtas = gapiInited && gisInited; // ğŸ”§ CORREÃ‡ÃƒO: Removido tokenClient da verificaÃ§Ã£o
                const naoConectado = !CONFIG_DRIVE.conectado && !CONFIG_DRIVE.accessToken;
                const btnFlutante = document.getElementById('btnConectarDriveFlutante');
                
                if (temCredenciais && apisProtas && naoConectado) {
                    console.log('ğŸ¯ CondiÃ§Ãµes atendidas para mostrar botÃ£o flutuante!');
                    console.log('  - Tem credenciais:', temCredenciais);
                    console.log('  - APIs prontas (gapi + gis):', apisProtas);
                    console.log('  - NÃ£o conectado:', naoConectado);
                    console.log('  - tokenClient:', tokenClient ? 'pronto' : 'nÃ£o pronto (mas nÃ£o impede)');
                    
                    if (btnFlutante && !btnFlutante.classList.contains('mostrar')) {
                        btnFlutante.classList.add('mostrar');
                        console.log('âœ… BOTÃƒO FLUTUANTE EXIBIDO!');
                        mostrarToast('âœ… Clique no botÃ£o azul no canto inferior esquerdo para conectar ao Drive!', 'sucesso');
                    }
                    
                    verificarStatusDrive();
                    clearInterval(verificarBotaoFlutante);
                } else {
                    console.log('â³ Aguardando condiÃ§Ãµes para botÃ£o... Creds:', temCredenciais, '| APIs:', apisProtas, '| NÃ£o conectado:', naoConectado);
                }
            }, 1000);
            
            // Para apÃ³s 30 segundos
            setTimeout(() => clearInterval(verificarBotaoFlutante), 30000);
            
            // ğŸ†• Verifica se acabou de salvar credenciais e precisa conectar
            setTimeout(() => {
                const precisaConectar = localStorage.getItem('drive_precisa_conectar');
                
                if (precisaConectar === 'true') {
                    console.log('ğŸ”„ Detectado que acabou de salvar credenciais. Conectando automaticamente...');
                    localStorage.removeItem('drive_precisa_conectar');
                    
                    // ğŸ”§ CORREÃ‡ÃƒO: Aguarda com verificaÃ§Ã£o robusta antes de conectar
                    const aguardarInicializacao = () => {
                        let tentativasConexao = 0;
                        const maxTentativasConexao = 15; // ğŸ”§ CORREÃ‡ÃƒO MOBILE: Aumentado de 10 para 15
                        
                        const verificarEConectar = setInterval(() => {
                            tentativasConexao++;
                            
                            if (gapiInited && gisInited && tokenClient) {
                                clearInterval(verificarEConectar);
                                console.log('âœ… APIs prontas para conectar');
                                
                                // Mostra alerta e conecta
                                alert('âœ… Credenciais salvas!\n\n' +
                                      'ğŸ”‘ Agora vamos conectar ao Google Drive.\n\n' +
                                      'ğŸ‘‰ Um popup do Google vai aparecer.\n' +
                                      'ğŸ‘‰ Clique em "Permitir" para autorizar o acesso.\n\n' +
                                      'Clique em OK para continuar...');
                                
                                conectarDrive();
                            } else if (tentativasConexao >= maxTentativasConexao) {
                                clearInterval(verificarEConectar);
                                console.warn('âš ï¸ Timeout ao aguardar inicializaÃ§Ã£o para auto-conexÃ£o');
                                mostrarToast('âš ï¸ APIs carregadas! Clique em "Conectar Agora" para continuar.', 'aviso');
                                verificarStatusDrive();
                            } else {
                                console.log('â³ Aguardando APIs ficarem prontas... (' + tentativasConexao + '/' + maxTentativasConexao + ')');
                            }
                        }, 500);
                    };
                    
                    aguardarInicializacao();
                }
            }, 1500); // ğŸ”§ CORREÃ‡ÃƒO MOBILE: Aumentado de 1000 para 1500ms
            
        } else if (tentativas >= maxTentativas) {
            console.error('âŒ Timeout: Scripts do Google nÃ£o carregaram apÃ³s 15 segundos');
            console.log('  - gapi disponÃ­vel:', gapiDisponivel);
            console.log('  - google disponÃ­vel:', googleDisponivel);
            clearInterval(verificarScripts);
            atualizarStatusDriveIndicador('error', 'âŒ Scripts nÃ£o carregaram');
            mostrarToast('âŒ Erro ao carregar API do Google. Verifique sua conexÃ£o e recarregue a pÃ¡gina.', 'erro');
            
            setTimeout(() => {
                if (confirm('Os scripts do Google Drive nÃ£o carregaram.\n\nDeseja recarregar a pÃ¡gina?')) {
                    location.reload();
                }
            }, 2000);
        } else {
            const mensagem = 'Carregando (' + Math.round((tentativas / maxTentativas) * 100) + '%)';
            atualizarStatusDriveIndicador('loading', mensagem);
        }
    }, 500);
});

console.log('âœ… MÃ³dulo Google Drive v3.0 CORRIGIDO carregado')

// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// ğŸ†• VERIFICAÃ‡ÃƒO PERIÃ“DICA DE CONEXÃƒO
// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

async function verificarConexaoDrive() {
    console.log('ğŸ” Verificando conexÃ£o com Google Drive...');
    
    // Verifica se as credenciais estÃ£o configuradas
    const clientId = localStorage.getItem('drive_client_id');
    const apiKey = localStorage.getItem('drive_api_key');
    
    if(!clientId || !apiKey) {
        console.log('âŒ Credenciais nÃ£o configuradas');
        atualizarStatusDriveIndicador('error', 'âš ï¸ Configure API');
        return false;
    }
    
    // Verifica se GAPI e GIS estÃ£o prontos
    if(!gapiInited || !gisInited) {
        console.log('â³ APIs ainda nÃ£o inicializadas');
        atualizarStatusDriveIndicador('loading', 'â³ Carregando...');
        return false;
    }
    
    // Verifica se tem token de acesso
    if(!accessToken) {
        console.log('ğŸ” Sem token de acesso');
        atualizarStatusDriveIndicador('error', 'ğŸ” Clique para conectar');
        return false;
    }
    
    // Testa a conexÃ£o fazendo uma chamada simples
    try {
        const response = await gapi.client.drive.about.get({fields: 'user'});
        
        if(response && response.result && response.result.user) {
            console.log('âœ… Drive conectado:', response.result.user.emailAddress);
            atualizarStatusDriveIndicador('connected', 'âœ… Conectado');
            return true;
        } else {
            console.log('âŒ Resposta invÃ¡lida do Drive');
            atualizarStatusDriveIndicador('error', 'âŒ Erro de conexÃ£o');
            return false;
        }
    } catch(error) {
        console.error('âŒ Erro ao verificar Drive:', error);
        
        // Se for erro 401, o token expirou
        if(error.status === 401) {
            accessToken = null;
            atualizarStatusDriveIndicador('error', 'ğŸ” Token expirado');
        } else {
            atualizarStatusDriveIndicador('error', 'âŒ Erro na conexÃ£o');
        }
        
        return false;
    }
}

// VerificaÃ§Ã£o periÃ³dica a cada 60 segundos
setInterval(() => {
    if(gapiInited && gisInited && accessToken) {
        verificarConexaoDrive();
    }
}, 60000);

// ğŸ†• VerificaÃ§Ã£o mais frequente nos primeiros 30 segundos para mostrar o botÃ£o
let tentativasVerificacao = 0;
const intervaloInicial = setInterval(() => {
    tentativasVerificacao++;
    
    // Se tem credenciais mas ainda nÃ£o conectou, atualiza o status
    if (CONFIG_DRIVE.clientId && CONFIG_DRIVE.apiKey && !CONFIG_DRIVE.conectado) {
        console.log('â³ Tentativa', tentativasVerificacao, '- Atualizando status do Drive...');
        verificarStatusDrive();
    }
    
    // Para apÃ³s 30 segundos (60 tentativas de 500ms)
    if (tentativasVerificacao >= 60) {
        clearInterval(intervaloInicial);
        console.log('âœ… Parou verificaÃ§Ã£o inicial apÃ³s 30 segundos');
    }
}, 500);



// ğŸ†• FunÃ§Ã£o auxiliar para anexar fotos via Google Drive
async function anexarFotosGoogleDrive(input) {
    console.log('ğŸ“± Iniciando anexarFotosGoogleDrive');
    console.log('   â€¢ Dispositivo:', /Mobi|Android/i.test(navigator.userAgent) ? 'MOBILE' : 'DESKTOP');
    
    const secao = input.closest('.section');
    const secaoId = secao.getAttribute('data-secao');
    const preview = secao.querySelector('.fotos-preview');
    
    console.log('   â€¢ SeÃ§Ã£o ID:', secaoId);
    console.log('   â€¢ Preview encontrado:', !!preview);
    
    if (!input.files || input.files.length === 0) {
        console.warn('âš ï¸ Nenhum arquivo selecionado');
        return;
    }
    
    const arquivos = Array.from(input.files);
    console.log('   â€¢ Total de arquivos:', arquivos.length);
    
    const progressDiv = document.getElementById('uploadProgress');
    const progressBar = document.getElementById('uploadProgressBar');
    const statusText = document.getElementById('uploadStatusText');
    const detailsText = document.getElementById('uploadDetails');
    
    if (progressDiv) progressDiv.style.display = 'block';
    
    let enviadas = 0;
    const total = arquivos.length;
    
    // ğŸ“¸ Inicia processamento rÃ¡pido
    mostrarToast('ğŸ“¸ Processando ' + total + ' foto(s)...', 'info');
    
    // ğŸ†• NÃƒO LIMPA O PREVIEW - mantÃ©m fotos anteriores
    console.log('   â€¢ Fotos jÃ¡ no preview:', preview.children.length);
    
    // ğŸš€ OTIMIZAÃ‡ÃƒO CRÃTICA: Busca a pasta UMA VEZ SÃ“ (nÃ£o em cada upload!)
    let folderId = null;
    try {
        console.log('ğŸ“ Obtendo pasta do Drive uma Ãºnica vez...');
        folderId = await obterOuCriarPasta();
        console.log('âœ… Pasta pronta:', folderId);
    } catch (error) {
        console.error('âŒ Erro ao obter pasta:', error);
        mostrarToast('âŒ Erro ao acessar pasta do Drive', 'erro');
        return;
    }
    
    // ğŸš€ PROCESSA TODAS AS FOTOS EM PARALELO (nÃ£o uma de cada vez!)
    const promessas = arquivos.map(async (file, index) => {
        try {
            // ValidaÃ§Ã£o de tipo de arquivo
            if(!file.type.startsWith('image/')) {
                mostrarToast('âš ï¸ Apenas imagens sÃ£o permitidas!', 'erro');
                return;
            }
            
            console.log('ğŸ“¸ Foto ' + (index+1) + ':', file.name, 'Tamanho:', (file.size/1024).toFixed(0)+'KB');
            
            // ğŸ”¥ SEMPRE COMPRIME (fotos de cÃ¢mera sÃ£o SEMPRE grandes, 3-8 MB)
            console.log('âš¡ Comprimindo foto ' + (index+1) + '...');
            if (statusText) statusText.textContent = 'âš¡ Processando foto ' + (index+1) + '/' + total + '...';
            
            // ğŸš€ COMPRESSÃƒO SUPER RÃPIDA para fotos da cÃ¢mera (qualidade 0.6)
            const blob = await comprimirImagemModerna(file, 0.6);
            
            console.log('âœ… Foto ' + (index+1) + ' comprimida:', (blob.size/1024).toFixed(0)+'KB');
            
            // ğŸ†• CRIA PREVIEW IMEDIATAMENTE (ANTES DO UPLOAD!)
            const urlLocal = URL.createObjectURL(blob);
            console.log('ğŸ–¼ï¸ URL da imagem criada:', urlLocal);
            
            const div = document.createElement('div');
            div.className = 'foto-item';
            div.setAttribute('data-secao-id', secaoId);
            div.setAttribute('data-upload-status', 'uploading'); // Marca como enviando
            // ğŸ†• Estilos inline para garantir visualizaÃ§Ã£o em mobile
            div.style.cssText = 'position:relative;border:2px solid #000;border-radius:6px;padding:5px;background:#f9f9f9;width:150px;min-height:130px;display:inline-block;margin:5px';
            
            const img = document.createElement('img');
            img.src = urlLocal;
            img.alt = 'Foto anexada';
            img.style.opacity = '0.6'; // Fica meio transparente enquanto envia
            img.style.display = 'block'; // ğŸ†• Garante que a imagem seja exibida
            img.style.width = '100%';
            img.style.height = '120px';
            img.style.objectFit = 'cover';
            img.style.borderRadius = '4px';
            img.style.cursor = 'pointer';
            
            // Adiciona evento de click para ampliar
            img.onclick = () => {
                const modal = document.getElementById('modalFoto');
                const modalImg = document.getElementById('imagemModal');
                if (modal && modalImg) {
                    modalImg.src = urlLocal;
                    modal.style.display = 'flex';
                } else {
                    // Fallback: abre em nova aba
                    window.open(urlLocal, '_blank');
                }
            };
            
            // Adiciona handler de erro na imagem
            img.onerror = (e) => {
                console.error('âŒ Erro ao carregar imagem:', e);
                img.style.display = 'none';
                const errorText = document.createElement('div');
                errorText.style.cssText = 'padding:10px;text-align:center;color:#f00';
                errorText.textContent = 'âŒ Erro ao carregar';
                div.appendChild(errorText);
            };
            
            img.onload = () => {
                console.log('âœ… Imagem carregada com sucesso');
            };
            
            const btnRemover = document.createElement('button');
            btnRemover.className = 'remover-foto';
            btnRemover.type = 'button';
            btnRemover.innerHTML = 'Ã—';
            btnRemover.style.display = 'flex'; // ğŸš€ MOSTRA DESDE O INÃCIO!
            
            // ğŸ†• BOTÃƒO X FUNCIONA IMEDIATAMENTE (remove preview mesmo antes do upload)
            btnRemover.onclick = async (e) => {
                e.stopPropagation();
                
                const driveId = div.getAttribute('data-drive-id');
                
                if (driveId) {
                    // Foto JÃ foi enviada para Drive
                    if (confirm('Remover esta foto do Google Drive?')) {
                        try {
                            await removerFotoDrive(driveId);
                            URL.revokeObjectURL(urlLocal);
                            div.remove();
                            mostrarToast('âœ… Foto removida do Drive!', 'sucesso');
                        } catch(error) {
                            console.error('Erro ao remover:', error);
                            mostrarToast('âŒ Erro ao remover foto', 'erro');
                        }
                    }
                } else {
                    // Foto AINDA NÃƒO foi enviada (estÃ¡ em upload)
                    if (confirm('Cancelar upload e remover foto?')) {
                        URL.revokeObjectURL(urlLocal);
                        div.remove();
                        mostrarToast('âœ… Upload cancelado', 'sucesso');
                    }
                }
            };
            
            // Badge de "Enviando..."
            const badge = document.createElement('div');
            badge.style.cssText = 'position:absolute;top:5px;left:5px;background:rgba(255,165,0,0.95);color:#fff;padding:4px 8px;border-radius:4px;font-size:0.7em;font-weight:bold;z-index:5;pointer-events:none';
            badge.textContent = 'ğŸ“¤ Enviando...';
            
            // ğŸ†• ORDEM CORRETA: img primeiro, depois badge e botÃ£o por cima
            div.appendChild(img);
            div.appendChild(badge);
            div.appendChild(btnRemover);
            preview.appendChild(div);
            
            console.log('âœ… Preview ' + (index+1) + ' criado - IMAGEM DEVE ESTAR VISÃVEL');
            console.log('   â€¢ Div className:', div.className);
            console.log('   â€¢ Img src:', img.src.substring(0, 50) + '...');
            console.log('   â€¢ Img display:', img.style.display);
            
            // ğŸš€ UPLOAD EM BACKGROUND PARALELO - Todas as fotos sobem ao mesmo tempo!
            const visitaId = window.visitaIdTemporario || 'sem_visita';
            const timestamp = Date.now() + index; // Garante nomes Ãºnicos
            const nomeArquivo = visitaId + '_' + secaoId + '_' + timestamp + '_' + file.name.replace(/[^a-zA-Z0-9._-]/g, '_');
            
            console.log('ğŸ“¤ Upload paralelo ' + (index+1) + '/' + total + ':', nomeArquivo);
            
            // ğŸ”¥ UPLOAD OTIMIZADO - Passa o folderId direto (nÃ£o busca novamente!)
            uploadFotoParaDriveComPasta(blob, nomeArquivo, folderId).then(resultado => {
                // âœ… Quando terminar (em background), atualiza o preview
                console.log('âœ… Upload ' + (index+1) + ' concluÃ­do:', nomeArquivo);
                
                div.setAttribute('data-drive-id', resultado.id);
                div.setAttribute('data-drive-url', resultado.url);
                div.setAttribute('data-upload-status', 'completed');
                
                // Remove badge e restaura opacidade
                badge.remove();
                img.style.opacity = '1';
                
                // ğŸš€ BOTÃƒO X JÃ ESTÃ CONFIGURADO - Apenas atualiza estado
                // (Agora o botÃ£o detecta se tem data-drive-id e age de acordo)
                
                enviadas++;
                const percentual = Math.round((enviadas / total) * 100);
                if (progressBar) {
                    progressBar.style.width = percentual + '%';
                    progressBar.textContent = percentual + '%';
                }
                if (detailsText) detailsText.textContent = enviadas + ' de ' + total + ' fotos enviadas';
                
                mostrarToast('âœ… Foto ' + enviadas + '/' + total + ' salva no Drive!');
                
            }).catch(uploadError => {
                // âŒ Se falhar, marca como erro mas mantÃ©m preview local
                console.error('âŒ Upload ' + (index+1) + ' falhou:', uploadError);
                
                // Altera badge para erro mas MANTÃ‰M a foto
                badge.textContent = 'âš ï¸ Erro';
                badge.style.background = 'rgba(220, 53, 69, 0.9)';
                img.style.opacity = '0.7';
                
                // ğŸš€ BOTÃƒO X JÃ FUNCIONA - NÃ£o precisa reconfigurar
                
                const mensagemErro = uploadError.message || 'Erro ao enviar';
                mostrarToast('âš ï¸ Foto ' + (index+1) + ': ' + mensagemErro, 'erro');
            });
            
        } catch (e) {
            console.error('âŒ Erro ao processar foto ' + (index+1) + ':', e);
            mostrarToast('âŒ Erro na foto ' + (index+1), 'erro');
        }
    });
    
    // Aguarda todas as compressÃµes terminarem (mas NÃƒO os uploads!)
    await Promise.all(promessas);
    
    if (progressDiv) {
        setTimeout(() => {
            progressDiv.style.display = 'none';
        }, 2000);
    }
    
    // ğŸ†• SOLUÃ‡ÃƒO DEFINITIVA: Limpa completamente o input e permite novas seleÃ§Ãµes
    try {
        // MÃ©todo 1: Reset do valor
        input.value = '';
        
        // MÃ©todo 2: Se nÃ£o funcionar, clona e substitui o input
        const novoInput = input.cloneNode(true);
        novoInput.value = '';
        
        // Remove eventos antigos e adiciona novos
        novoInput.onchange = function() { anexarFoto(this); };
        novoInput.onfocus = function() { salvarAntesDeFoto(); };
        novoInput.onclick = function() { salvarAntesDeFoto(); };
        
        // Substitui o input antigo pelo novo
        input.parentNode.replaceChild(novoInput, input);
        
        console.log('âœ… Input limpo e pronto para novas fotos');
    } catch(e) {
        console.error('Erro ao limpar input:', e);
        // Fallback: apenas reseta o valor
        input.value = '';
    }
    
    mostrarToast('âœ… ' + total + ' foto(s) prontas! Upload para Drive continua em background.', 'sucesso');
}

// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// ğŸ¯ LOG INICIAL DO SISTEMA
// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

console.log('%câ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'color: #4285f4; font-weight: bold');
// ğŸ“± GERAR MENSAGENS MOTIVACIONAIS PARA CADA LOJA
function gerarMensagensParaLojas(mesAtual, anoAtual) {
    const meses = ['Janeiro','Fevereiro','MarÃ§o','Abril','Maio','Junho','Julho','Agosto','Setembro','Outubro','Novembro','Dezembro'];
    const nomeMes = meses[mesAtual];

    // â”€â”€â”€ Mapeamento de nomes das seÃ§Ãµes â”€â”€â”€
    const nomeSecoes = {
        "1": "Recebimento de Mercadorias",
        "2": "Etiquetagem de Produtos",
        "3": "OrganizaÃ§Ã£o e Limpeza do Estoque",
        "4": "OrganizaÃ§Ã£o dos Corredores",
        "5": "ConfecÃ§Ãµes e AcessÃ³rios",
        "6": "Gatos e Defeitos",
        "7": "TransferÃªncias e Remanejamentos"
    };

    // â”€â”€â”€ Regras de respostas "corretas" por pergunta â”€â”€â”€
    const regrasGlobal = {
        "1":{nf:["NÃ£o","Sim, dentro do prazo"],cx:["NÃ£o","Sim, dentro do prazo"],er:["NÃ£o"]},
        "2":{et:["NÃ£o","Sim, dentro do prazo"],imp:["Sim"],arg:["NÃ£o","Sim, solicitado conserto"]},
        "3":{limpo:["Sim"],pc:["Sim"],check:["Sim"]},
        "4":{c1:["Sim"],c2:["Sim"],c3:["Sim"],c4:["Sim"]},
        "5":{f1:["Sim"],f2:["Sim"]},
        "6":{g1:["Sim"],g2:["Sim"]},
        "7":{t1:["Sim"],t2:["Sim","Em Aberto, dentro do prazo"],t3:["Sim","Em Aberto, dentro do prazo"],t4:["Sim"]}
    };

    // â”€â”€â”€ Texto legÃ­vel para cada pergunta â”€â”€â”€
    const textosPergunta = {
        nf:"Notas Fiscais pendentes no sistema",
        cx:"Volumes com caixas fechadas",
        er:"Erros de recebimento com cancelamento",
        et:"Mercadorias aguardando etiquetagem",
        imp:"ImpressÃ£o de etiquetas",
        arg:"Equipamento Argox com problema",
        limpo:"Estoque limpo e higienizado",
        pc:"Ãrea do computador organizada",
        check:"Checklist online utilizado corretamente",
        c1:"Corredores alinhados e puxados",
        c2:"Corredores numerados conforme padrÃ£o",
        c3:"Produtos organizados por setor",
        c4:"Acesso livre e sem obstruÃ§Ãµes",
        f1:"SetorizaÃ§Ã£o correta (Marcas e Modelos)",
        f2:"Armazenamento adequado",
        g1:"Gatos identificados e separados",
        g2:"Defeitos transferidos para loja 99",
        t1:"TransferÃªncias realizadas corretamente",
        t2:"Remanejamentos via sistema corretos",
        t3:"Lotes em aberto corretos",
        t4:"SeparaÃ§Ã£o de pÃ©s de vitrine correta"
    };

    // â”€â”€â”€ FunÃ§Ã£o: analisa uma visita e retorna detalhes por seÃ§Ã£o â”€â”€â”€
    function analisarVisita(dados) {
        const resultado = {};
        for (let secId in regrasGlobal) {
            const perguntasSecao = regrasGlobal[secId];
            // âœ… Chave correta: "pts1", "pts2"... (sem underscore)
            const ptsSecao = Number(dados["pts" + secId] || 0);
            const detalhes = { pontos: ptsSecao, corretas: [], incorretas: [] };

            Object.keys(perguntasSecao).forEach(idPerg => {
                const respostaCorreta = perguntasSecao[idPerg];
                const valorMarcado = dados[idPerg];
                if (valorMarcado) {
                    if (respostaCorreta.includes(valorMarcado)) {
                        detalhes.corretas.push({ id: idPerg, texto: textosPergunta[idPerg], resposta: valorMarcado });
                    } else {
                        detalhes.incorretas.push({ id: idPerg, texto: textosPergunta[idPerg], resposta: valorMarcado });
                    }
                }
            });
            resultado[secId] = detalhes;
        }
        return resultado;
    }

    // â”€â”€â”€ FunÃ§Ã£o: agrega anÃ¡lises de mÃºltiplas visitas â”€â”€â”€
    // MÃ©dia por seÃ§Ã£o Ã© calculada pelos pontos (pts1..pts7).
    // Para os itens falhos, conta quantas vezes cada pergunta falhou vs total de visitas.
    // SÃ³ aparece como "perdido" se falhou em pelo menos uma visita.
    function agregarVisitas(visitasMes) {
        const agregado = {};
        for (let secId in nomeSecoes) {
            agregado[secId] = { somaP: 0, count: 0, falhasPorPergunta: {} };
        }

        visitasMes.forEach(v => {
            const analise = analisarVisita(v.dados);
            for (let secId in analise) {
                agregado[secId].somaP += analise[secId].pontos;
                agregado[secId].count++;

                // Registra falhas por pergunta (chave = id da pergunta)
                analise[secId].incorretas.forEach(item => {
                    if (!agregado[secId].falhasPorPergunta[item.id]) {
                        agregado[secId].falhasPorPergunta[item.id] = { texto: item.texto, falhas: 0, ultimaResposta: item.resposta };
                    }
                    agregado[secId].falhasPorPergunta[item.id].falhas++;
                    agregado[secId].falhasPorPergunta[item.id].ultimaResposta = item.resposta;
                });
            }
        });

        // Monta resumo final
        const totalVisitas = visitasMes.length;
        const resumo = {};
        for (let secId in agregado) {
            const mediaSecao = agregado[secId].count > 0 ? agregado[secId].somaP / agregado[secId].count : 0;

            // Converte falhasPorPergunta em array com info de frequÃªncia
            const incorretas = [];
            Object.keys(agregado[secId].falhasPorPergunta).forEach(idPerg => {
                const info = agregado[secId].falhasPorPergunta[idPerg];
                incorretas.push({
                    id: idPerg,
                    texto: info.texto,
                    resposta: info.ultimaResposta,
                    falhas: info.falhas,
                    totalVisitas: totalVisitas
                });
            });

            resumo[secId] = {
                nome: nomeSecoes[secId],
                media: mediaSecao,
                mediaInt: Math.round(mediaSecao * 10) / 10,
                incorretas: incorretas
            };
        }
        return resumo;
    }

    // Coleta dados de todas as lojas
    const dadosLojas = [];
    
    lojas.forEach((loja, index) => {
        const hist = JSON.parse(localStorage.getItem("hist_"+index) || "[]");
        const visitasMes = hist.filter(v => {
            let d;
            if(typeof v.data === 'string' && v.data.includes('/')) {
                const p = v.data.split(' ')[0].split('/');
                if(p.length === 3) d = new Date(parseInt(p[2]), parseInt(p[1])-1, parseInt(p[0]));
            } else {
                d = new Date(v.data);
            }
            return d && !isNaN(d.getTime()) && d.getMonth() === mesAtual && d.getFullYear() === anoAtual;
        });
        
        if(visitasMes.length > 0) {
            let somaPontos = 0;
            visitasMes.forEach(v => somaPontos += calculaTotalPontos(v.dados));
            const media = somaPontos / visitasMes.length;
            
            dadosLojas.push({
                nome: loja,
                visitas: visitasMes.length,
                media: media,
                pontos: Math.round(media),
                visitasMes: visitasMes
            });
        } else {
            dadosLojas.push({
                nome: loja,
                visitas: 0,
                media: 0,
                pontos: 0,
                visitasMes: []
            });
        }
    });
    
    // Ordena por mÃ©dia para calcular posiÃ§Ã£o no ranking
    const ranking = [...dadosLojas].filter(l => l.visitas > 0).sort((a,b) => b.media - a.media);
    
    // Calcula posiÃ§Ãµes SEQUENCIAIS considerando EMPATES
    const rankingComPosicoes = [];
    let posicaoAtual = 1;
    let mediaAnterior = null;
    
    ranking.forEach((loja, idx) => {
        if (mediaAnterior !== null && loja.media < mediaAnterior) {
            posicaoAtual++;
        }
        rankingComPosicoes.push({ ...loja, posicao: posicaoAtual });
        mediaAnterior = loja.media;
    });
    
    // Gera mensagens para cada loja
    const mensagens = [];
    
    dadosLojas.forEach(loja => {
        let mensagem = '';
        
        const lojaNoRanking = rankingComPosicoes.find(r => r.nome === loja.nome);
        const posicao = lojaNoRanking ? lojaNoRanking.posicao : 0;
        
        // CABEÃ‡ALHO
        mensagem += `ğŸ“Š *RESULTADO ${nomeMes.toUpperCase()}/${anoAtual} - ${loja.nome}*\n`;
        mensagem += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n`;
        
        if(loja.visitas === 0) {
            mensagem += `âš ï¸ *ATENÃ‡ÃƒO: Nenhuma auditoria realizada*\n\n`;
            mensagem += `NÃ£o foram registradas visitas de auditoria em ${nomeMes}.\n\n`;
            mensagem += `ğŸ“Œ *AÃ§Ã£o necessÃ¡ria:*\n`;
            mensagem += `â€¢ Agendar auditoria com urgÃªncia\n`;
            mensagem += `â€¢ Garantir cumprimento dos processos\n`;
            mensagem += `â€¢ Aguardamos contato da equipe\n\n`;
            mensagem += `_"A excelÃªncia comeÃ§a com o compromisso diÃ¡rio!"_`;
            
        } else {
            const percentual = ((loja.media / 21) * 100).toFixed(0);
            const lojasEmpatadas = rankingComPosicoes.filter(r => r.posicao === posicao).length;
            const textoEmpate = lojasEmpatadas > 1 ? ` (empatado com ${lojasEmpatadas - 1} ${lojasEmpatadas === 2 ? 'loja' : 'lojas'})` : '';
            
            mensagem += `ğŸ¯ *PontuaÃ§Ã£o: ${loja.pontos}/21 pontos (${percentual}%)*\n`;
            mensagem += `ğŸ“ *PosiÃ§Ã£o no Ranking: ${posicao}Âº lugar${textoEmpate}*\n`;
            mensagem += `ğŸ“‹ *Total de Auditorias: ${loja.visitas}*\n\n`;

            // â”€â”€â”€ ANÃLISE DETALHADA POR SEÃ‡ÃƒO â”€â”€â”€
            const resumoSecoes = agregarVisitas(loja.visitasMes);

            // Separa seÃ§Ãµes perfeitas (media >= 3) e seÃ§Ãµes com perda
            const secoesPerfeit = [];
            const secoesComPerda = [];
            for (let secId in resumoSecoes) {
                const sec = resumoSecoes[secId];
                if (sec.media >= 3) {
                    secoesPerfeit.push(sec);
                } else {
                    secoesComPerda.push({ ...sec, secId: secId });
                }
            }

            // Monta bloco de pontos positivos (seÃ§Ãµes com nota mÃ¡xima)
            let blocoPositivos = '';
            if (secoesPerfeit.length > 0) {
                blocoPositivos += `âœ… *PONTOS POSITIVOS (nota mÃ¡xima 3/3):*\n`;
                secoesPerfeit.forEach(sec => {
                    blocoPositivos += `â€¢ ${sec.nome}\n`;
                });
                blocoPositivos += `\n`;
            }

            // Monta bloco de pontos perdidos (seÃ§Ãµes abaixo da nota mÃ¡xima)
            let blocoPerda = '';
            if (secoesComPerda.length > 0) {
                blocoPerda += `âš ï¸ *PONTOS PERDIDOS (abaixo de 3/3):*\n`;
                secoesComPerda.forEach(sec => {
                    blocoPerda += `\nğŸ“Œ ${sec.nome} â€” Nota mÃ©dia: ${sec.mediaInt}/3\n`;
                    if (sec.incorretas.length > 0) {
                        sec.incorretas.forEach(item => {
                            blocoPerda += `   âŒ ${item.texto}\n`;
                            blocoPerda += `       SituaÃ§Ã£o: ${item.resposta}\n`;
                            // Se hÃ¡ mais de uma visita no mÃªs, mostra frequÃªncia da falha
                            if (item.totalVisitas > 1) {
                                blocoPerda += `       Ocorreu em ${item.falhas} de ${item.totalVisitas} visita${item.totalVisitas > 1 ? 's' : ''}\n`;
                            }
                        });
                    }
                });
                blocoPerda += `\n`;
            }

            // â”€â”€â”€ CÃLCULO DA PREMIAÃ‡ÃƒO ACUMULADA (3 meses) â”€â”€â”€
            function getMediaMes(lojaIndex, mes, ano) {
                const hist = JSON.parse(localStorage.getItem("hist_" + lojaIndex) || "[]");
                const visitas = hist.filter(v => {
                    let d;
                    if (typeof v.data === 'string' && v.data.includes('/')) {
                        const p = v.data.split(' ')[0].split('/');
                        if (p.length === 3) d = new Date(parseInt(p[2]), parseInt(p[1]) - 1, parseInt(p[0]));
                    } else {
                        d = new Date(v.data);
                    }
                    return d && !isNaN(d.getTime()) && d.getMonth() === mes && d.getFullYear() === ano;
                });
                if (visitas.length === 0) return null;
                let soma = 0;
                visitas.forEach(v => soma += calculaTotalPontos(v.dados));
                return soma / visitas.length;
            }

            const lojaIndex = lojas.indexOf(loja.nome);

            // Monta os 3 meses: mÃªs atual + 2 anteriores
            const mesesAcumulados = [];
            for (let i = 0; i < 3; i++) {
                let m = mesAtual - i;
                let a = anoAtual;
                if (m < 0) { m += 12; a--; }
                const mediaM = getMediaMes(lojaIndex, m, a);
                let bonusM = 0;
                if (mediaM !== null) {
                    if (mediaM >= 18) bonusM = 300;
                    else if (mediaM >= 14) bonusM = 150;
                }
                mesesAcumulados.push({ mes: m, ano: a, media: mediaM, bonus: bonusM });
            }

            const bonusMesAtual = mesesAcumulados[0].bonus;
            const totalAcumulado = mesesAcumulados.reduce((s, m) => s + m.bonus, 0);
            const mesesComBonus = mesesAcumulados.filter(m => m.bonus > 0).length;

            // â”€â”€â”€ MENSAGENS POR CLASSIFICAÃ‡ÃƒO (com detalhes) â”€â”€â”€
            if(loja.media >= 18) {
                // EXCELENTE (18-21)
                mensagem += `ğŸŸ¢ *DESEMPENHO EXCELENTE!*\n\n`;
                mensagem += `ğŸ† ParabÃ©ns Ã  toda equipe pela dedicaÃ§Ã£o!\n\n`;

                if(posicao === 1) {
                    mensagem += `ğŸ‘‘ *LÃDER DO RANKING!*\n`;
                    mensagem += `VocÃªs sÃ£o referÃªncia para toda a rede!\n\n`;
                } else if(posicao <= 3) {
                    mensagem += `ğŸ¥‡ *TOP 3 DA REDE!*\n`;
                    mensagem += `Excelente trabalho!\n\n`;
                }

                // â”€â”€ PremiaÃ§Ã£o â”€â”€
                mensagem += `ğŸ’° *PREMIAÃ‡ÃƒO MENSAL:*\n`;
                mensagem += `Pelo resultado EXCELENTE, o encarregado de estoque conquista a premiaÃ§Ã£o de *R$ ${bonusMesAtual.toFixed(2)}* este mÃªs!\n\n`;
                
                if (mesesComBonus > 0) {
                    mensagem += `ğŸ“ˆ *PREMIAÃ‡ÃƒO ACUMULADA (Ãºltimos 3 meses):*\n`;
                    // Mostra os meses do mais antigo para o mais recente
                    for (let i = mesesAcumulados.length - 1; i >= 0; i--) {
                        if (mesesAcumulados[i].bonus > 0) {
                            mensagem += `${meses[mesesAcumulados[i].mes]}/${mesesAcumulados[i].ano}: R$ ${mesesAcumulados[i].bonus.toFixed(2)}\n`;
                        }
                    }
                    mensagem += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
                    mensagem += `*Acumulado: R$ ${totalAcumulado.toFixed(2)}*\n\n`;
                }

                // Mostra positivos
                mensagem += blocoPositivos;

                // Mesmo sendo excelente, se hÃ¡ perda, mostra
                if (secoesComPerda.length > 0) {
                    mensagem += `ğŸ“‰ *Mesmo com resultado excelente, houve perda de pontos:*\n`;
                    mensagem += blocoPerda;
                    mensagem += `ğŸ’¡ *Para chegar Ã  nota mÃ¡xima (21/21), atenÃ§Ã£o nesses pontos no prÃ³ximo ciclo.*\n\n`;
                } else {
                    mensagem += `ğŸ… *Nota mÃ¡xima em TODAS as Ã¡reas! PerfeiÃ§Ã£o atingida!*\n\n`;
                }

                mensagem += `ğŸ’¡ *Para manter a excelÃªncia:*\n`;
                mensagem += `â€¢ Compartilhar boas prÃ¡ticas com outras lojas\n`;
                mensagem += `â€¢ Manter consistÃªncia nas prÃ³ximas auditorias\n`;
                mensagem += `â€¢ Continuar com o alto padrÃ£o de qualidade\n\n`;
                mensagem += `_"O sucesso Ã© a soma de pequenos esforÃ§os repetidos!"_`;
                
            } else if(loja.media >= 14) {
                // BOM (14-17)
                mensagem += `ğŸ”µ *BOM DESEMPENHO!*\n\n`;
                mensagem += `ğŸ‘ ParabÃ©ns pelo trabalho da equipe!\n\n`;

                // â”€â”€ PremiaÃ§Ã£o â”€â”€
                mensagem += `ğŸ’° *PREMIAÃ‡ÃƒO MENSAL:*\n`;
                mensagem += `Pelo resultado BOM, o encarregado de estoque conquista a premiaÃ§Ã£o de *R$ ${bonusMesAtual.toFixed(2)}* este mÃªs!\n\n`;
                
                if (mesesComBonus > 0) {
                    mensagem += `ğŸ“ˆ *PREMIAÃ‡ÃƒO ACUMULADA (Ãºltimos 3 meses):*\n`;
                    // Mostra os meses do mais antigo para o mais recente
                    for (let i = mesesAcumulados.length - 1; i >= 0; i--) {
                        if (mesesAcumulados[i].bonus > 0) {
                            mensagem += `${meses[mesesAcumulados[i].mes]}/${mesesAcumulados[i].ano}: R$ ${mesesAcumulados[i].bonus.toFixed(2)}\n`;
                        }
                    }
                    mensagem += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
                    mensagem += `*Acumulado: R$ ${totalAcumulado.toFixed(2)}*\n\n`;
                }

                // Positivos
                mensagem += blocoPositivos;

                // Pontos perdidos com detalhes
                if (secoesComPerda.length > 0) {
                    mensagem += blocoPerda;
                }

                mensagem += `ğŸ’ª *PrÃ³ximo objetivo: 18+ pontos (Excelente)!*\n`;
                mensagem += `VocÃªs tÃªm potencial para chegar Ã  excelÃªncia. Foque nas Ã¡reas acima.\n\n`;
                mensagem += `_"Bom Ã© bom, mas excelente Ã© melhor!"_`;
                
            } else if(loja.media >= 10) {
                // REGULAR (10-13)
                mensagem += `ğŸŸ¡ *ATENÃ‡ÃƒO: Desempenho Regular*\n\n`;
                mensagem += `âš ï¸ A equipe precisa de melhorias!\n\n`;

                // Positivos (se houver)
                mensagem += blocoPositivos;

                // Pontos perdidos com detalhes
                if (secoesComPerda.length > 0) {
                    mensagem += blocoPerda;
                }
                
                mensagem += `ğŸ”§ *AÃ‡Ã•ES NECESSÃRIAS:*\n`;
                mensagem += `â€¢ ReuniÃ£o com encarregado e gerente\n`;
                mensagem += `â€¢ Revisar os processos com perda de pontos\n`;
                mensagem += `â€¢ Treinamento da equipe nas Ã¡reas crÃ­ticas\n`;
                mensagem += `â€¢ Acompanhamento semanal\n\n`;
                
                mensagem += `ğŸ¯ *Meta: 14+ pontos no prÃ³ximo mÃªs!*\n\n`;
                mensagem += `_"Cada dia Ã© uma nova oportunidade de melhorar!"_`;
                
            } else {
                // CRÃTICO (0-9)
                mensagem += `ğŸ”´ *SITUAÃ‡ÃƒO CRÃTICA!*\n\n`;
                mensagem += `ğŸš¨ *ATENÃ‡ÃƒO MÃXIMA NECESSÃRIA!*\n\n`;

                // Positivos (se houver algum)
                mensagem += blocoPositivos;

                // Pontos perdidos com detalhes
                if (secoesComPerda.length > 0) {
                    mensagem += blocoPerda;
                }
                
                mensagem += `ğŸ”§ *PLANO DE AÃ‡ÃƒO URGENTE:*\n`;
                mensagem += `1ï¸âƒ£ ReuniÃ£o IMEDIATA com gerente e encarregado\n`;
                mensagem += `2ï¸âƒ£ RevisÃ£o completa dos processos com perda\n`;
                mensagem += `3ï¸âƒ£ Treinamento intensivo da equipe\n`;
                mensagem += `4ï¸âƒ£ Acompanhamento DIÃRIO\n`;
                mensagem += `5ï¸âƒ£ Auditoria de revisÃ£o em 15 dias\n\n`;
                
                mensagem += `ğŸ¯ *Meta URGENTE: 14+ pontos!*\n\n`;
                mensagem += `_"Ã‰ hora de virar o jogo! Contem com nosso apoio!"_`;
            }
        }
        
        mensagem += `\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
        mensagem += `ğŸ“ DÃºvidas? Entre em contato com a coordenaÃ§Ã£o.\n`;
        mensagem += `ğŸª *Shoemix CalÃ§ados - ExcelÃªncia em GestÃ£o*`;
        
        mensagens.push({
            loja: loja.nome,
            mensagem: mensagem,
            status: loja.media >= 18 ? 'excelente' : loja.media >= 14 ? 'bom' : loja.media >= 10 ? 'regular' : loja.visitas === 0 ? 'sem_visita' : 'critico'
        });
    });
    
    return mensagens;
}

// ğŸ“± ABRIR MODAL COM MENSAGENS
function abrirModalMensagens() {
    const mes = parseInt(document.getElementById('seletorMesDiretoria')?.value || new Date().getMonth());
    const ano = parseInt(document.getElementById('seletorAnoDiretoria')?.value || new Date().getFullYear());
    
    const mensagens = gerarMensagensParaLojas(mes, ano);
    const meses = ['Janeiro','Fevereiro','MarÃ§o','Abril','Maio','Junho','Julho','Agosto','Setembro','Outubro','Novembro','Dezembro'];
    
    const modal = document.createElement('div');
    modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.9);z-index:10000;overflow-y:auto;padding:20px';
    
    let html = `
        <div style="max-width:800px;margin:0 auto;background:#fff;border-radius:12px;padding:30px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:30px;border-bottom:3px solid #f00;padding-bottom:15px">
                <h2 style="margin:0;color:#f00">ğŸ“± Mensagens para as Lojas - ${meses[mes]}/${ano}</h2>
                <button onclick="this.closest('div').parentElement.parentElement.remove()" 
                        style="background:#dc3545;color:#fff;border:none;padding:10px 20px;border-radius:5px;cursor:pointer;font-size:1.1em">
                    âœ• Fechar
                </button>
            </div>
            
            <div style="margin-bottom:20px;padding:15px;background:#e3f2fd;border-left:4px solid #2196f3;border-radius:4px">
                <strong>ğŸ’¡ Como usar:</strong><br>
                â€¢ Clique em "ğŸ“‹ Copiar" para copiar a mensagem<br>
                â€¢ Cole no WhatsApp, e-mail ou sistema da empresa<br>
                â€¢ Envie para a equipe da loja correspondente
            </div>
    `;
    
    mensagens.forEach((item, idx) => {
        let corStatus = '#dc3545';
        let icone = 'ğŸ”´';
        
        if(item.status === 'excelente') {
            corStatus = '#28a745';
            icone = 'ğŸŸ¢';
        } else if(item.status === 'bom') {
            corStatus = '#17a2b8';
            icone = 'ğŸ”µ';
        } else if(item.status === 'regular') {
            corStatus = '#ffc107';
            icone = 'ğŸŸ¡';
        } else if(item.status === 'sem_visita') {
            corStatus = '#6c757d';
            icone = 'âš ï¸';
        }
        
        html += `
            <div style="margin-bottom:20px;border:2px solid ${corStatus};border-radius:8px;overflow:hidden">
                <div style="background:${corStatus};color:#fff;padding:15px;display:flex;justify-content:space-between;align-items:center">
                    <strong style="font-size:1.2em">${icone} ${item.loja}</strong>
                    <button onclick="copiarMensagem(${idx})" id="btnCopiar${idx}"
                            style="background:#fff;color:${corStatus};border:none;padding:8px 16px;border-radius:5px;cursor:pointer;font-weight:600">
                        ğŸ“‹ Copiar Mensagem
                    </button>
                </div>
                <div style="padding:20px;background:#f9f9f9">
                    <pre id="mensagem${idx}" style="white-space:pre-wrap;font-family:Arial,sans-serif;font-size:0.95em;line-height:1.6;margin:0">${item.mensagem}</pre>
                </div>
            </div>
        `;
    });
    
    html += `
            <div style="text-align:center;margin-top:30px;padding-top:20px;border-top:2px solid #ddd">
                <button onclick="copiarTodasMensagens()" 
                        style="background:#000;color:#fff;border:none;padding:15px 30px;border-radius:8px;cursor:pointer;font-size:1.1em;font-weight:600">
                    ğŸ“‹ Copiar TODAS as Mensagens
                </button>
            </div>
        </div>
    `;
    
    modal.innerHTML = html;
    document.body.appendChild(modal);
    
    // FunÃ§Ãµes auxiliares
    window.copiarMensagem = function(idx) {
        const texto = document.getElementById('mensagem' + idx).textContent;
        navigator.clipboard.writeText(texto).then(() => {
            const btn = document.getElementById('btnCopiar' + idx);
            const textoOriginal = btn.textContent;
            btn.textContent = 'âœ… Copiado!';
            btn.style.background = '#28a745';
            btn.style.color = '#fff';
            setTimeout(() => {
                btn.textContent = textoOriginal;
                btn.style.background = '#fff';
                btn.style.color = '';
            }, 2000);
        });
    };
    
    window.copiarTodasMensagens = function() {
        let todasMensagens = '';
        mensagens.forEach((item, idx) => {
            todasMensagens += item.mensagem + '\n\n\n';
        });
        
        navigator.clipboard.writeText(todasMensagens).then(() => {
            alert('âœ… Todas as mensagens foram copiadas!\n\nCole no seu aplicativo de mensagens preferido.');
        });
    };
}
console.log('%cğŸš€ SISTEMA SHOEMIX CARREGADO', 'color: #4285f4; font-weight: bold; font-size: 16px');
console.log('%câ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'color: #4285f4; font-weight: bold');
console.log('');
console.log('%câœ… Credenciais Google Drive:', 'color: #28a745; font-weight: bold');
console.log('  â€¢ Client ID:', CONFIG_DRIVE.clientId ? 'âœ… Configurado (' + CONFIG_DRIVE.clientId.substring(0, 30) + '...)' : 'âŒ NÃƒO CONFIGURADO');
console.log('  â€¢ API Key:', CONFIG_DRIVE.apiKey ? 'âœ… Configurada (' + CONFIG_DRIVE.apiKey.substring(0, 20) + '...)' : 'âŒ NÃƒO CONFIGURADA');
console.log('');
console.log('%cğŸ“¡ Aguardando carregamento das APIs do Google...', 'color: #ffc107; font-weight: bold');
console.log('  â³ GAPI: Aguardando...');
console.log('  â³ GIS: Aguardando...');
console.log('');
console.log('%cğŸ’¡ DICA:', 'color: #17a2b8; font-weight: bold');
console.log('  â€¢ Clique no botÃ£o â„¹ï¸ (canto superior esquerdo) para ver o status em tempo real');
console.log('  â€¢ Use o botÃ£o "ğŸ” Executar DiagnÃ³stico" se tiver problemas');
console.log('');
console.log('%câ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'color: #4285f4; font-weight: bold');

</script>
</body>
</html>